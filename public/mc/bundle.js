!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mcloud={})}(this,(function(t){"use strict";class View{constructor(t){this.parentView=void 0,this._position=void 0,this._domctx=new BuildDOMCtx,this._dom=void 0,this._baseView=void 0,this._mountState=e.Unmounted,this._onActive=void 0,this._childViews=void 0,this._domctx.view=this,t&&this.domExprCreated(t)}static getView(t){return t instanceof View?t:new View(t)}get position(){return this._position}get dom(){return this.ensureDom(),this._dom}get domCreated(){return!!this._dom}get baseView(){return this._baseView}get mountState(){return this._mountState}get hidden(){return this.dom.hidden}set hidden(t){this.dom.hidden=t}ensureDom(){if(!this._dom){var t=this.createDom();this.domExprCreated(t)}}domExprCreated(t){var e=buildView(t,this._domctx);e instanceof View?(this._baseView=e,this._dom=e.dom):this._dom=e,this.postCreateDom(),this.updateDom()}createDom(){return document.createElement("div")}postCreateDom(){View.debugging&&this.dom.dataset&&(this.dom.dataset.webfx=e[this._mountState])}updateDom(){this._domctx.update()}mountStateChanged(t){if(t!=this._mountState){if(this._mountState=t,View.debugging&&!this._baseView&&this.domCreated&&this.dom.dataset&&(this.dom.dataset.webfx==e[t]&&console.trace("mountState on the DOM is changed by other view",t,this),this.dom.dataset.webfx=e[t]),this._baseView)this._baseView.mountStateChanged(t);else if(this._childViews)for(const e of this._childViews)e.mountStateChanged(t)}else console.trace("mountState unchanged",t,this)}getDomById(t){var e,i;return this.ensureDom(),null!==(i=null===(e=this._domctx.dict)||void 0===e?void 0:e[t])&&void 0!==i?i:null}updateWith(t){objectApply(this,t),this.updateDom()}updateAllWith(t){objectApply(this,t),this.updateAll()}toggleClass(t,e){toggleClass(this.dom,t,e)}getDOM(){return this.dom}addChild(t){const e=buildView(t,this._domctx);e instanceof View?this.appendView(e):this.dom.appendChild(e)}get onActive(){return this._onActive||(this._onActive=new a,this.dom.addEventListener("click",(t=>{this._onActive.invoke(t)})),this.dom.addEventListener("keydown",(t=>{this.handleKeyDown(t)}))),this._onActive}handleKeyDown(t){var e;if("Enter"===t.code){const i=this.dom.getBoundingClientRect();null===(e=this._onActive)||void 0===e||e.invoke(new MouseEvent("click",{clientX:i.x,clientY:i.y,relatedTarget:this.dom})),t.preventDefault()}}get childViews(){return this._baseView?this._baseView.childViews:(this._childViews||(this._childViews=[]),this._childViews)}appendView(t){this.addView(t)}addView(t,i){this._registerChild(t,i,!1),this._mountState==e.Mounted&&t.mountStateChanged(e.Mounting),this._insertToDom(t,i),this._mountState!=e.Unmounted&&t.mountStateChanged(this._mountState)}_registerChild(t,i,n=!0){const s=this.childViews;if(t.parentView)throw new Error("the view is already in a container view");if(t.parentView=this,void 0===i)t._position=s.length,s.push(t);else{s.splice(i,0,t);for(let t=i;t<s.length;t++)s[t]._position=t}n&&this._mountState!=e.Unmounted&&t.mountStateChanged(this._mountState)}removeView(t){t=this._ensureItem(t),this._removeFromDom(t);var i=t._position;t.parentView=t._position=void 0,this.childViews.splice(i,1);for(let t=i;t<this.childViews.length;t++)this.childViews[t]._position=t;this._mountState!=e.Unmounted&&t.mountStateChanged(e.Unmounted)}removeAllView(){for(;this.childViews.length;)this.removeView(this.childViews.length-1)}updateAll(){if(this.updateDom(),this.baseView)return this.baseView.updateAll();this.updateChildren()}updateChildren(){if(this._childViews)for(const t of this._childViews)t.updateAll()}_insertToDom(t,e){var i;null==e?this.dom.appendChild(t.dom):this.dom.insertBefore(t.dom,(null===(i=this.childViews[e+1])||void 0===i?void 0:i.dom)||null)}_removeFromDom(t){t.domCreated&&t.dom.remove()}_ensureItem(t){if("number"==typeof t)t=this.childViews[t];else{if(!t)throw new Error("item is null or undefined.");if(t.parentView!==this)throw new Error("the item is not in this listview.")}return t}}function tryGetDOM(t){return t?t instanceof View?t.getDOM():t instanceof Node?t:t&&"getDOM"in t?t.getDOM():void 0:t}function getDOM(t){var e=tryGetDOM(t);if(!e)throw console.error("getDOM():",t),new Error("getDOM(): unsupported parameter: "+t);return e}function appendView(t,e){warnMountingView(t,e),getDOM(t).appendChild(e.dom)}function addChild(t,e){if(t instanceof View)t.addChild(e);else if(t instanceof Node)warnMountingView(t,e),t.appendChild(buildDOM(e));else{if(!("addChild"in t))throw console.error("addChild():",{parent:t,child:e}),new Error("addChild(): unsupported parent");t.addChild(e)}}function warnMountingView(t,e){if(e instanceof View){const i={parent:t,child:e};t instanceof Node?console.trace("Should use `mountView()` to mount a view to DOM.",i):console.trace("Should use `View.addChild()` or `View.appendView()` to add a view into another view.",i)}}function mountView(t,i){i.mountStateChanged(e.Mounting),t.appendChild(i.dom),i.mountStateChanged(e.Mounted)}function unmountView(t,i){i.dom.remove(),i.mountStateChanged(e.Unmounted)}View.debugging=!1,Node.prototype.getDOM=function(){return console.trace("webfx: Node.getDOM() is deprecated. Please use the exported function `getDOM()` instead."),this},Node.prototype.addChild=function(t){console.trace("webfx: Node.addChild() is deprecated. Please use the exported function `addChild()` instead."),addChild(this,t)},Node.prototype.appendView=function(t){console.trace("webfx: Node.appendView() is deprecated. Please use the exported function `appendView()` instead."),appendView(this,t)};class ContainerView extends View{addView(t,e){return super.addView(t,e)}removeView(t){super.removeView(t)}_insertToDom(t,e){super._insertToDom(t,e)}_removeFromDom(t){super._removeFromDom(t)}_ensureItem(t){return super._ensureItem(t)}get items(){return this.childViews}[Symbol.iterator](){return this.childViews[Symbol.iterator]()}get length(){return this.childViews.length}get(t){return this.childViews[t]}map(t){return arrayMap(this,t)}find(t){return arrayFind(this,t)}forEach(t){return arrayForeach(this,t)}}var e;!function(t){t[t.Unmounted=0]="Unmounted",t[t.Mounting=1]="Mounting",t[t.Mounted=2]="Mounted"}(e||(e={}));class BuildDOMCtx{constructor(){this.dict=void 0,this.actions=void 0,this.view=void 0}setDict(t,e){this.dict||(this.dict={}),this.dict[t]=e}addUpdateAction(t){this.actions||(this.actions=[]),this.actions.push(t)}update(){if(this.actions)for(const t of this.actions)t.run()}}class TextAction{constructor(t,e){this.node=t,this.func=e}run(){this.node.textContent=this.func()}}class HiddenAction{constructor(t,e){this.node=t,this.func=e}run(){this.node.hidden=this.func()}}class UpdateAction{constructor(t,e){this.node=t,this.func=e}run(){this.func(this.node)}}function tryHandleValues(t,e){if("string"==typeof t)return document.createTextNode(t);if("function"==typeof t){const i=t();if(i&&"object"==typeof i)throw new Error("Unexpected function return value");{const n=document.createTextNode(i);return null==e||e.addUpdateAction(new TextAction(n,t)),n}}return Node&&t instanceof Node?t:null}var buildDomCore=function(t,e,i){var n;if(e--<0)throw new Error("ran out of TTL");var s=tryHandleValues(t,i);if(s)return s;if(t instanceof JsxNode&&!((t=t.buildView(i,e))instanceof View))return t;if(t instanceof View)return null===(n=null==i?void 0:i.view)||void 0===n||n._registerChild(t),t.getDOM();const r=t.tag;if(!r)throw new Error("no tag");var o=function(t){for(var e,i,n=/[#\.^]?[\w\-]+/y;e=n.exec(t);){var s=e[0],r=s[0];if("."===r)i.classList.add(s.substr(1));else if("#"===r)i.id=s.substr(1);else{if(i)throw new Error("unexpected multiple tags");i=document.createElement(s)}}return i}(r);for(var a in t)if(t.hasOwnProperty(a)){var l=t[a];buildDOMHandleKey(a,l,o,i,e)}const d=t.init;return d&&d(o),o},buildDOMHandleKey=function(t,e,i,n,s){"child"===t?e instanceof Array?foreachFlaten(e,(function(t){i.appendChild(buildDomCore(t,s,n))})):i.appendChild(buildDomCore(e,s,n)):"_id"===t||"_key"===t?n.setDict(e,i):"ref"===t?e.value=i:"text"===t?"function"==typeof e?n.addUpdateAction(new TextAction(i,e)):i.textContent=e:"class"===t?i.className=e:"hidden"===t&&"function"==typeof e?n.addUpdateAction(new HiddenAction(i,e)):"update"===t&&"function"==typeof e?n.addUpdateAction(new UpdateAction(i,e)):"init"===t||(i[t]=e)};function buildDOM(t,e){return buildDomCore(t,32,e||null)}function buildView(t,e){return t instanceof View?t:t instanceof JsxNode?t.buildView(e,64):buildDOM(t,e)}class JsxNode{constructor(t,e,i){this.tag=t,this.attrs=e,this.child=i}getDOM(){return this.buildDom(null,64)}buildDom(t,e){return getDOM(this.buildView(t,e))}buildView(t,e){if(e--<0)throw new Error("ran out of TTL");let i;if("string"==typeof this.tag){const n=document.createElement(this.tag);if(i=n,this.attrs){for(const i in this.attrs)if(Object.prototype.hasOwnProperty.call(this.attrs,i)){const s=this.attrs[i];buildDOMHandleKey(i,s,n,t,e)}const i=this.attrs.init;i&&i(n)}}else if(i=this.tag,this.attrs){let t=null;for(const e in this.attrs)if(Object.prototype.hasOwnProperty.call(this.attrs,e)){const n=this.attrs[e];"init"==e?t=n:"ref"==e?n.value=i:e.startsWith("on")&&i[e]instanceof a?i[e].add(n):i[e]=n}t&&t(i)}return this.child&&foreachFlaten(this.child,i instanceof View?t=>{i.addChild(jsxBuildCore(t,e,i._domctx))}:n=>{var s;const r=jsxBuildCore(n,e,t);r instanceof View?(i.appendChild(r.dom),null===(s=null==t?void 0:t.view)||void 0===s||s._registerChild(r)):addChild(i,r)}),i}addChild(t){null==this.child&&(this.child=[]),this.child.push(t)}}function jsxBuildCore(t,e,i){if(e--<0)throw new Error("ran out of TTL");if(t instanceof View)return t;var n=tryHandleValues(t,i);if(n)return n;if(t instanceof JsxNode)return t.buildView(i,e);throw console.error("Unknown node type",t),new Error("Unknown node type")}function jsxBuild(t,e){return jsxBuildCore(t,64,e||new BuildDOMCtx)}function jsxFactory(t,e,...i){if("string"==typeof t)return new JsxNode(t,e,i);{const n=(null==e?void 0:e.args)?new t(...e.args):new t;return new JsxNode(n,e,i)}}const i=jsxFactory;var n=window&&window.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function fulfilled(t){try{step(n.next(t))}catch(t){r(t)}}function rejected(t){try{step(n.throw(t))}catch(t){r(t)}}function step(t){t.done?s(t.value):function adopt(t){return t instanceof i?t:new i((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((n=n.apply(t,e||[])).next())}))};const s=Object.assign,r=Object.prototype.hasOwnProperty;function strPadLeft(t,e,i=" "){for(;t.length<e;)t=i+t;return t}function formatTime(t){if("number"!=typeof t||isNaN(t))return"--:--";t=Math.round(t);var e=Math.floor(t/60);return t%=60,strPadLeft(e.toString(),2,"0")+":"+strPadLeft(t.toString(),2,"0")}const o=["B","KB","MB","GB"];function formatFileSize(t){if("number"!=typeof t||isNaN(t))return"NaN";for(var e=0;e<o.length-1&&t>=1024;)e++,t/=1024;return t.toFixed(2)+" "+o[e]}function formatDateTime(t){var e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()?t.toLocaleTimeString():t.toLocaleString()}function numLimit(t,e,i){return t<e||"number"!=typeof t||isNaN(t)?e:t>i?i:t}function createName(t,e){for(let i=0;;i++){let n=t(i);if(!e(n))return n}}function base64EncodeUtf8(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(function toSolidBytes(t,e){return String.fromCharCode("0x"+e)})))}function sleepAsync(t){return new Promise((e=>{setTimeout(e,t)}))}function clearChildren(t){for(;t.lastChild;)t.removeChild(t.lastChild)}function replaceChild(t,e){clearChildren(t),e&&t.appendChild(e)}function toggleClass(t,e,i){var n=t.classList;return n.toggle?n.toggle(e,i):(void 0===i&&(i=!n.contains(e)),i?n.add(e):n.remove(e),i)}function fadeout(t,e){const{className:i="fading-out",duration:n=500,waitTransition:s=!0}=e||{};t.classList.add(i);var r=null,end=()=>{end&&(end=null,s&&t.removeEventListener("transitionend",onTransitionend),t.classList.remove(i),t.remove(),r&&r())};if(s){var onTransitionend=function(t){t.eventPhase===Event.AT_TARGET&&end()};t.addEventListener("transitionend",onTransitionend)}return setTimeout(end,n),{get finished(){return!end},onFinished(t){return end?r=t:t(),this},cancel(){null==end||end()}}}function listenPointerEvents(t,e,i){var n=!1,mouseDown=function(t){if("track"===e({type:"mouse",ev:t,point:t,action:"down"})){var mousemove=function(t){e({type:"mouse",ev:t,point:t,action:"move"})},mouseup=function(t){document.removeEventListener("mousemove",mousemove,!0),document.removeEventListener("mouseup",mouseup,!0),e({type:"mouse",ev:t,point:t,action:"up"})};document.addEventListener("mousemove",mousemove,!0),document.addEventListener("mouseup",mouseup,!0)}},touchStart=function(s){var r=s.changedTouches[0],o=e({type:"touch",touch:"start",ev:s,point:r,action:n?"move":"down"});if(!n&&"track"===o){n=!0;var touchmove=function(t){var i=t.changedTouches[0];e({type:"touch",touch:"move",ev:t,point:i,action:"move"})},touchend=function(i){0===i.touches.length&&(n=!1,t.removeEventListener("touchmove",touchmove),t.removeEventListener("touchend",touchend),t.removeEventListener("touchcancel",touchend));var s=i.changedTouches[0];e({type:"touch",touch:"end",ev:i,point:s,action:n?"move":"up"})};t.addEventListener("touchmove",touchmove,i),t.addEventListener("touchend",touchend,i),t.addEventListener("touchcancel",touchend,i)}};return t.addEventListener("mousedown",mouseDown,i),t.addEventListener("touchstart",touchStart,i),{remove:()=>{t.removeEventListener("mousedown",mouseDown,i),t.removeEventListener("touchstart",touchStart,i)}}}function listenEvent(t,e,i){return t.addEventListener(e,i),{remove:()=>t.removeEventListener(e,i)}}function listenEvents(t,e,i){return e.forEach((e=>t.addEventListener(e,i))),{remove:()=>e.forEach((e=>t.removeEventListener(e,i)))}}function injectCss(t,e){var i;document.head.appendChild(buildDOM({tag:null!==(i=null==e?void 0:e.tag)&&void 0!==i?i:"style",text:t}))}function arrayRemove(t,e){for(let i=0;i<t.length;i++)t[i]===e&&(t.splice(i,1),i--)}function arrayInsert(t,e,i){void 0===i?t.push(e):t.splice(i,0,e)}function arrayMap(t,e){if(t instanceof Array)return t.map(e);var i=0,n=new Array(t.length);for(var s of t)n[i]=e(s,i),i++;return n}function arrayForeach(t,e){var i=0;for(var n of t)e(n,i++)}function foreachFlaten(t,e){for(const i of t)i instanceof Array?foreachFlaten(i,e):e(i)}function arrayFind(t,e){if(t instanceof Array)return t.find(e);var i=0;for(var n of t)if(e(n,i++))return n;return null}function arraySum(t,e){var i=0;return arrayForeach(t,(t=>{var n=e(t);n&&(i+=n)})),i}function objectApply(t,e,i){if(e){if(!i)return s(t,e);for(const n in e)if(r.call(e,n)&&(!i||i.indexOf(n)>=0)){const i=e[n];t[n]=i}}return t}function objectInit(t,e,i){if(e)for(const n in e)if(r.call(e,n)&&(!i||i.indexOf(n)>=0)){const i=e[n];n.startsWith("on")&&t[n]instanceof a?t[n].add(i):t[n]=i}return t}function mod(t,e){return t<0&&(t=e+t),t%e}function readBlobAsDataUrl(t){return new Promise(((e,i)=>{var n=new FileReader;n.onload=t=>{e(n.result)},n.onerror=t=>i(),n.readAsDataURL(t)}))}function startBlockingDetect(t=20){var e=Date.now(),i=Date.now();setInterval((()=>{var n=Date.now();n-i>=t&&console.info(`[Blocking] ${(n-e)/1e3}s: blocked for ${n-i} ms`),i=n}),1)}Array.prototype.remove=function(t){arrayRemove(this,t)};class Timer{constructor(t){this.callback=t,this.cancelFunc=void 0}timeout(t){this.tryCancel();var e=setTimeout(this.callback,t);this.cancelFunc=()=>window.clearTimeout(e)}interval(t){this.tryCancel();var e=setInterval(this.callback,t);this.cancelFunc=()=>window.clearInterval(e)}animationFrame(){this.tryCancel();var t=requestAnimationFrame(this.callback);this.cancelFunc=()=>cancelAnimationFrame(t)}tryCancel(){this.cancelFunc&&(this.cancelFunc(),this.cancelFunc=void 0)}}class SettingItem{constructor(t,e,i){if(this.onRender=null,this.key=t,!(e=this.type="string"==typeof e?SettingItem.types[e]:e)||!e.serialize||!e.deserialize)throw new Error("invalid 'type' arugment");this.readFromStorage(i)}readFromStorage(t){var e=this.key?localStorage.getItem(this.key):null;this.isInitial=!e,this.set(e?this.type.deserialize(e):t,!0)}render(t,e){e||t(this.data);const i=this.onRender,n=t;return i&&(t=function(t){i(t),n(t)}),this.onRender=t,this}bindToBtn(t,e){if(this.type!==SettingItem.types.bool)throw new Error("only for bool type");var i=document.createElement("span");t.insertBefore(i,t.firstChild),this.render((function(n){t.classList.toggle("disabled",!n),e=e||["❌","✅"],i.textContent=e[+n]}));var n=this;return t.addEventListener("click",(function(){n.toggle()})),this}remove(){localStorage.removeItem(this.key)}save(){this.isInitial=!1,localStorage.setItem(this.key,this.type.serialize(this.data))}set(t,e){this.data=t,this.isInitial=!1,this.onRender&&this.onRender(t),!e&&this.key&&this.save()}get(){return this.data}toggle(){if(this.type!==SettingItem.types.bool)throw new Error("only for bool type");this.set(!this.data)}loop(t){var e=this.data,i=t.findIndex((function(t){return t===e})),n=t[(i+1)%t.length];this.set(n)}}SettingItem.types={bool:{serialize:function(t){return t?"true":"false"},deserialize:function(t){return"true"===t||"false"!==t&&void 0}},str:{serialize:function(t){return t},deserialize:function(t){return t}},json:{serialize:function(t){return JSON.stringify(t)},deserialize:function(t){return JSON.parse(t)}}};const a=class CallbacksImpl extends Array{constructor(){super(...arguments),this._hook=void 0}get onChanged(){var t;return null!==(t=this._hook)&&void 0!==t||(this._hook=new a),this._hook}invoke(...t){this.forEach((e=>{try{e.apply(this,t)}catch(t){console.error("Error in callback",t)}}))}add(t){var e;return this.push(t),null===(e=this._hook)||void 0===e||e.invoke(!0,t),t}remove(t){var e;super.remove(t),null===(e=this._hook)||void 0===e||e.invoke(!1,t)}};class Ref{constructor(){this._value=void 0,this._onChanged=void 0}get onChanged(){return this._onChanged||(this._onChanged=new a),this._onChanged}get value(){return this._value}set value(t){this._value=t,this._onChanged&&this.onChanged.invoke(this)}}class Lazy{constructor(t){this._func=t,this._value=void 0}get computed(){return!this._func}get rawValue(){return this._value}get value(){return this._func&&(this._value=this._func(),this._func=void 0),this._value}}class Semaphore{constructor(t){this.queue=new Array,this.maxCount=1,this.runningCount=0,objectInit(this,t)}enter(){if(this.runningCount===this.maxCount){var t,e=new Promise((e=>{t=e}));return this.queue.push(t),e}return this.runningCount++,Promise.resolve()}exit(){this.runningCount===this.maxCount&&this.queue.length?window.queueMicrotask?window.queueMicrotask(this.queue.shift()):setTimeout(this.queue.shift(),0):this.runningCount--}run(t){return n(this,void 0,void 0,(function*(){yield this.enter();try{yield t()}finally{this.exit()}}))}}class CancelToken{constructor(){this.cancelled=!1,this.onCancelled=new a}cancel(){this.cancelled||(this.cancelled=!0,this.onCancelled.invoke())}throwIfCancelled(){if(this.cancelled)throw new Error("operation cancelled.")}}class DataUpdatingHelper{update(t){const e=this.items;var i={};for(const e of t)i[this.dataSelectId(e)]=e;var n={},s=[];for(const t of e){const e=this.selectId(t);void 0!==i[e]?n[e]=t:s.push(t)}for(let t=s.length-1;t>=0;t--)this.removeItem(s[t]);var r=0;for(const e of t){const t=n[this.dataSelectId(e)];void 0!==t?this.updateItem(t,e):this.addItem(e,r),r++}}updateOrRebuildAll(t){this.update(t),this.isSame(t)||this.rebuildAll(t)}isSame(t){var e=this.items[Symbol.iterator]();for(const n of t){var i=e.next();if(i.done)return!1;if(this.selectId(i.value)!==this.dataSelectId(n))return!1}return!!e.next().done}rebuildAll(t){var e=this.items;if(e instanceof Array)for(let t=e.length-1;t>=0;t--)this.removeItem(e[t]);else for(const t of e)this.removeItem(t);let i=0;for(const e of t)this.addItem(e,i++)}selectId(t){return t.id}dataSelectId(t){return t.id}addItem(t,e){}updateItem(t,e){}removeItem(t){}}class EventRegistrations{constructor(){this.list=[]}add(t,e){return this.list.push({event:t,func:e}),t.add(e),e}removeAll(){for(;this.list.length;){var t=this.list.pop();t.event.remove(t.func)}}}class TextCompositionWatcher{constructor(t){this.onCompositingChanged=new a,this._isCompositing=!1,this.dom=getDOM(t),this.dom.addEventListener("compositionstart",(t=>{this.isCompositing=!0})),this.dom.addEventListener("compositionend",(t=>{this.isCompositing=!1}))}get isCompositing(){return this._isCompositing}set isCompositing(t){this._isCompositing=t,this.onCompositingChanged.invoke()}}class InputStateTracker{constructor(t){this.dom=t,this.state={mouseDown:!1,mouseIn:!1,focusIn:!1},this._removeEvents=null,this._removePointerEvents=null,this.onChanged=new a,this._removeEvents=listenEvents(t,["mouseenter","mouseleave","focusin","focusout"],(t=>{switch(t.type){case"mouseenter":this.stateChanged("mouseIn",!0);break;case"mouseleave":this.stateChanged("mouseIn",!1);break;case"focusin":this.stateChanged("focusIn",!0);break;case"focusout":this.stateChanged("focusIn",!1)}})).remove,this._removePointerEvents=listenPointerEvents(t,(t=>{if("down"==t.action)return this.stateChanged("mouseDown",!0),"track";"up"==t.action&&this.stateChanged("mouseDown",!1)})).remove}stateChanged(t,e){this.state[t]=e,this.onChanged.invoke(t)}removeListeners(){var t,e;null===(t=this._removeEvents)||void 0===t||t.call(this),null===(e=this._removePointerEvents)||void 0===e||e.call(this),this._removePointerEvents=this._removeEvents=null}}const l={strPadLeft:strPadLeft,formatTime:formatTime,formatFileSize:formatFileSize,formatDateTime:formatDateTime,numLimit:numLimit,createName:createName,base64EncodeUtf8:base64EncodeUtf8,sleepAsync:sleepAsync,clearChildren:clearChildren,replaceChild:replaceChild,toggleClass:toggleClass,fadeout:fadeout,listenPointerEvents:listenPointerEvents,listenEvent:listenEvent,listenEvents:listenEvents,injectCss:injectCss,arrayRemove:arrayRemove,arrayInsert:arrayInsert,arrayMap:arrayMap,arrayForeach:arrayForeach,arrayFind:arrayFind,arraySum:arraySum,objectApply:objectApply,objectInit:objectInit,mod:mod,readBlobAsDataUrl:readBlobAsDataUrl,buildDOM:buildDOM,Timer:Timer};class I18n{constructor(){this.data={},this.curLang="en",this.missing=new Map}get(t,e){return this.get2(t,e)||t}get2(t,e,i){i=i||this.curLang;var n=this.data[i];if(!n)return console.log("i18n missing lang: "+i),null;var s=n[t];if(!s)return this.missing.has(t)||(this.missing.set(t,1),console.log("i18n missing key: "+t)),null;if(e)for(const t in e)if(e.hasOwnProperty(t)){const i=e[t];s=s.replace("{"+t+"}",i)}return s}add2dArray(t){const e=[],i=t[0];for(const t of i)e.push(this.data[t]=this.data[t]||{});for(let i=1;i<t.length;i++){const n=t[i],s=n[0];for(let t=0;t<n.length;t++){const i=n[t];e[t][s]=i}}}renderElements(t){console.log("i18n elements rendering"),t.forEach((t=>{for(const i of t.childNodes)if(i.nodeType===Node.TEXT_NODE){var e=this.get2(i.beforeI18n||i.textContent);e?(i.beforeI18n=i.beforeI18n||i.textContent,i.textContent=e):(i.beforeI18n&&(i.textContent=i.beforeI18n),console.log("missing key for node",i))}}))}static detectLanguage(t){var e=null,i=-1,n=[];return(navigator.languages||[navigator.language]).forEach((t=>{n.push(t),t.indexOf("-")>0&&n.push(t.substr(0,t.indexOf("-")))})),t.forEach((t=>{var s=n.indexOf(t);(!e||-1!==s&&s<i)&&(e=t,i=s)})),e||t[0]}}function createStringBuilder(t){var e=createArrayBuilder(t);return function(i,...n){return 0===n.length?t.get(i[0]):e(i,...n).join("")}}function createArrayBuilder(t){var e=new WeakMap,i=new Map;return function(n,...s){if(0===s.length)return[t.get(n[0])];let r=e.get(n);if(void 0===r){r="";for(let t=0;t<n.length;t++){r+=n[t],t<s.length&&(r+="{"+t+"}")}e.set(n,r)}const o=t.get(r);let a=i.get(o);return void 0===a&&(a=function parseTemplate(t){const e=[];let i=0,n="";for(let s=0;s<t.length;s++){const r=t[s];switch(r){case"{":if(0==i)i=1;else{if(1!=i)throw new Error(`Expected number, got '${r}' at ${s}`);i=0,n+="{"}break;case"}":if(3==i)i=0,e.push(+n),n="";else if(0==i)i=2;else{if(2!=i)throw new Error(`Expected number, got '${r}' at ${s}`);i=0,n+="}"}break;default:if(2==i)throw new Error(`Expected '}', got '${r}' at ${s}`);1==i&&(i=3,n&&e.push(n),n=""),n+=r}}if(0!=i)throw new Error("Unexpected end of template string");n&&e.push(n);return e}(o)),a.map((t=>"number"==typeof t?s[t]:t))}}var d=new I18n;const h=createStringBuilder(d);function getWebfxCss(){return':root {\n    --color-bg: white;\n    --color-text: black;\n    --color-text-gray: #666;\n    --color-bg-selection: hsl(5, 100%, 85%);\n    --color-primary: hsl(5, 100%, 67%);\n    --color-primary-darker: hsl(5, 100%, 60%);\n    --color-primary-dark: hsl(5, 100%, 40%);\n    --color-primary-dark-depends: hsl(5, 100%, 40%);\n    --color-primary-verydark: hsl(5, 100%, 20%);\n    --color-primary-light: hsl(5, 100%, 83%);\n    --color-primary-lighter: hsl(5, 100%, 70%);\n    --color-fg-11: #111111;\n    --color-fg-22: #222222;\n    --color-fg-33: #333333;\n    --color-bg-cc: #cccccc;\n    --color-bg-dd: #dddddd;\n    --color-bg-ee: #eeeeee;\n    --color-bg-f8: #f8f8f8;\n    --color-shadow: rgba(0, 0, 0, .5);\n}\n\n.no-selection {\n    user-select: none;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n}\n\n/* listview item */\n\n.item {\n    display: block;\n    position: relative;\n    padding: 10px;\n    /* background: #ddd; */\n    /* animation: showing .3s forwards; */\n    text-decoration: none;\n    line-height: 1.2;\n}\n\na.item {\n    color: inherit;\n}\n\n.clickable, .item {\n    cursor: pointer;\n    transition: transform .3s;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.item:hover, .dragover {\n    background: var(--color-bg-ee);\n}\n\n.keyboard-input .item:focus {\n    outline-offset: -2px;\n}\n\n.dragover-placeholder {\n    /* border-top: 2px solid gray; */\n    position: relative;\n}\n\n.dragover-placeholder::before {\n    content: "";\n    display: block;\n    position: absolute;\n    transform: translate(0, -1px);\n    height: 2px;\n    width: 100%;\n    background: gray;\n    z-index: 100;\n    pointer-events: none;\n}\n\n.clickable:active, .item:active {\n    transition: transform .07s;\n    transform: scale(.97);\n}\n\n.item:active {\n    background: var(--color-bg-dd);\n}\n\n.item.no-transform:active {\n    transform: none;\n}\n\n.item.active {\n    background: var(--color-bg-dd);\n}\n\n.loading-indicator {\n    position: relative;\n    margin: .3em;\n    margin-top: 3em;\n    margin-bottom: 1em;\n    text-align: center;\n    white-space: pre-wrap;\n    cursor: default;\n    animation: loading-fadein .3s;\n}\n\n.loading-indicator-text {\n    margin: 0 auto;\n}\n\n.loading-indicator.running .loading-indicator-inner {\n    display: inline-block;\n    position: relative;\n    vertical-align: bottom;\n}\n\n.loading-indicator.running .loading-indicator-inner::after {\n    content: "";\n    height: 1px;\n    margin: 0%;\n    background: var(--color-text);\n    display: block;\n    animation: fadein .5s 1s backwards;\n}\n\n.loading-indicator.running .loading-indicator-text {\n    margin: 0 .5em;\n    animation: fadein .3s, loading-first .3s .5s cubic-bezier(0.55, 0.055, 0.675, 0.19) reverse, loading-second .3s .8s cubic-bezier(0.55, 0.055, 0.675, 0.19), loading .25s 1.1s cubic-bezier(0.55, 0.055, 0.675, 0.19) alternate-reverse infinite;\n}\n\n.loading-indicator.error {\n    color: red;\n}\n\n.loading-indicator.fading-out {\n    transition: max-height;\n    animation: loading-fadein .3s reverse;\n}\n\n@keyframes loading-fadein {\n    0% {\n        opacity: 0;\n        max-height: 0;\n    }\n    100% {\n        opacity: 1;\n        max-height: 200px;\n    }\n}\n\n@keyframes fadein {\n    0% {\n        opacity: 0;\n    }\n    100% {\n        opacity: 1;\n    }\n}\n\n@keyframes loading-first {\n    0% {\n        transform: translate(0, -2em) scale(1) rotate(360deg);\n    }\n    100% {\n        transform: translate(0, 0) scale(1) rotate(0deg);\n    }\n}\n\n@keyframes loading-second {\n    0% {\n        transform: translate(0, -2em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes loading {\n    0% {\n        transform: translate(0, -1em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes showing {\n    0% {\n        opacity: .3;\n        transform: translate(-20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-top {\n    0% {\n        opacity: .3;\n        transform: translate(0, -20px)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-right {\n    0% {\n        opacity: .3;\n        transform: translate(20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n.overlay {\n    background: rgba(0, 0, 0, .2);\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    animation: fadein .3s;\n    z-index: 10001;\n    overflow: hidden;\n    contain: strict;\n    will-change: transform;\n}\n\n.overlay.fixed {\n    position: fixed;\n}\n\n.overlay.nobg {\n    background: none;\n    will-change: auto;\n}\n\n.overlay.centerChild {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.overlay.clickThrough {\n    pointer-events: none;\n}\n\n.dialog * {\n    box-sizing: border-box;\n}\n\n.dialog {\n    font-size: 14px;\n    position: relative;\n    overflow: auto;\n    background: var(--color-bg);\n    border-radius: 5px;\n    box-shadow: 0 0 12px var(--color-shadow);\n    animation: dialogin .2s ease-out;\n    z-index: 10001;\n    display: flex;\n    flex-direction: column;\n    max-height: 100%;\n    contain: content;\n    will-change: transform;\n    pointer-events: auto;\n}\n\n.dialog.resize {\n    resize: both;\n}\n\n.fading-out .dialog {\n    transition: transform .3s ease-in;\n    transform: scale(.85);\n}\n\n.dialog-title, .dialog-content, .dialog-bottom {\n    padding: 10px;\n}\n\n.dialog-title {\n    background: var(--color-bg-ee);\n}\n\n.dialog-content {\n    flex: 1;\n    padding: 5px 10px;\n    overflow: auto;\n}\n\n.dialog-content.flex {\n    display: flex;\n    flex-direction: column;\n}\n\n.dialog-bottom {\n    padding: 5px 10px;\n}\n\n@keyframes dialogin {\n    0% {\n        transform: scale(.85);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n.input-label {\n    font-size: 80%;\n    color: var(--color-text-gray);\n    margin: 5px 0 3px 0;\n}\n\n.input-text {\n    display: block;\n    width: 100%;\n    padding: 5px;\n    border: solid 1px gray;\n    background: var(--color-bg);\n    color: var(--color-text);\n}\n\n.dialog .input-text {\n    margin: 5px 0;\n}\n\ntextarea.input-text {\n    resize: vertical;\n}\n\n.labeled-input {\n    display: flex;\n    flex-direction: column;\n}\n\n.labeled-input .input-text {\n    flex: 1;\n}\n\n.labeled-input:focus-within .input-label {\n    color: var(--color-primary-darker);\n}\n\n.input-text:focus {\n    border-color: var(--color-primary-darker);\n}\n\n.input-text:active {\n    border-color: var(--color-primary-dark);\n}\n\n.btn {\n    display: block;\n    text-align: center;\n    transition: all .2s;\n    padding: 0 .4em;\n    min-width: 3em;\n    line-height: 1.5em;\n    background: var(--color-primary);\n    color: white;\n    text-shadow: 0 0 4px var(--color-primary-verydark);\n    box-shadow: 0 0 3px var(--color-shadow);\n    cursor: pointer;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    user-select: none;\n    position: relative;\n    overflow: hidden;\n}\n\n.btn:hover {\n    transition: all .05s;\n    background: var(--color-primary-darker);\n}\n\n.btn.btn-down, .btn:active {\n    transition: all .05s;\n    background: var(--color-primary-dark);\n    box-shadow: 0 0 1px var(--color-shadow);\n}\n\n.btn.disabled {\n    background: var(--color-primary-light);\n}\n\n.dialog .btn {\n    margin: 10px 0;\n}\n\n.btn-big {\n    padding: 5px;\n}\n\n.btn-inline {\n    display: inline;\n}\n\n.textbtn {\n    display: inline-block;\n    color: var(--color-text-gray);\n    margin: 0 5px;\n}\n\n.textbtn.active {\n    color: var(--color-text);\n}\n\n*[hidden] {\n    display: none !important;\n}\n\n.context-menu {\n    position: absolute;\n    overflow-y: auto;\n    background: var(--color-bg);\n    border: solid 1px #777;\n    box-shadow: 0 0px 12px var(--color-shadow);\n    min-width: 100px;\n    max-width: 450px;\n    outline: none;\n    z-index: 10001;\n    animation: context-menu-in .2s ease-out forwards;\n    will-change: transform;\n}\n\n.context-menu .item.dangerous {\n    transition: color .3s, background .3s;\n    color: red;\n}\n\n.context-menu .item.dangerous:hover {\n    transition: color .1s, background .1s;\n    background: red;\n    color: white;\n}\n\n@keyframes context-menu-in {\n    0% {\n        transform: scale(.9);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n*.menu-shown {\n    background: var(--color-bg-dd);\n}\n\n.menu-info {\n    white-space: pre-wrap;\n    color: var(--color-text-gray);\n    padding: 5px 10px;\n    /* animation: showing .3s; */\n    cursor: default;\n}\n\n.toasts-container {\n    position: fixed;\n    bottom: 0;\n    right: 0;\n    padding: 5px;\n    width: 300px;\n    z-index: 10001;\n    overflow: hidden;\n}\n\n.toast {\n    margin: 5px;\n    padding: 10px;\n    border-radius: 5px;\n    box-shadow: 0 0 10px var(--color-shadow);\n    background: var(--color-bg);\n    white-space: pre-wrap;\n    animation: showing-right .3s;\n}\n\n.fading-out {\n    transition: opacity .3s;\n    opacity: 0;\n    pointer-events: none;\n}\n\n.anchor-bottom {\n    transform: translate(-50%, -100%);\n}\n\n.tooltip {\n    position: absolute;\n    background: var(--color-bg);\n    box-shadow: 0 0 5px var(--color-shadow);\n    border-radius: 5px;\n    padding: .2em .25em;\n}\n'}let c=!1;function injectWebfxCss(){c||(injectCss(':root {\n    --color-bg: white;\n    --color-text: black;\n    --color-text-gray: #666;\n    --color-bg-selection: hsl(5, 100%, 85%);\n    --color-primary: hsl(5, 100%, 67%);\n    --color-primary-darker: hsl(5, 100%, 60%);\n    --color-primary-dark: hsl(5, 100%, 40%);\n    --color-primary-dark-depends: hsl(5, 100%, 40%);\n    --color-primary-verydark: hsl(5, 100%, 20%);\n    --color-primary-light: hsl(5, 100%, 83%);\n    --color-primary-lighter: hsl(5, 100%, 70%);\n    --color-fg-11: #111111;\n    --color-fg-22: #222222;\n    --color-fg-33: #333333;\n    --color-bg-cc: #cccccc;\n    --color-bg-dd: #dddddd;\n    --color-bg-ee: #eeeeee;\n    --color-bg-f8: #f8f8f8;\n    --color-shadow: rgba(0, 0, 0, .5);\n}\n\n.no-selection {\n    user-select: none;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n}\n\n/* listview item */\n\n.item {\n    display: block;\n    position: relative;\n    padding: 10px;\n    /* background: #ddd; */\n    /* animation: showing .3s forwards; */\n    text-decoration: none;\n    line-height: 1.2;\n}\n\na.item {\n    color: inherit;\n}\n\n.clickable, .item {\n    cursor: pointer;\n    transition: transform .3s;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.item:hover, .dragover {\n    background: var(--color-bg-ee);\n}\n\n.keyboard-input .item:focus {\n    outline-offset: -2px;\n}\n\n.dragover-placeholder {\n    /* border-top: 2px solid gray; */\n    position: relative;\n}\n\n.dragover-placeholder::before {\n    content: "";\n    display: block;\n    position: absolute;\n    transform: translate(0, -1px);\n    height: 2px;\n    width: 100%;\n    background: gray;\n    z-index: 100;\n    pointer-events: none;\n}\n\n.clickable:active, .item:active {\n    transition: transform .07s;\n    transform: scale(.97);\n}\n\n.item:active {\n    background: var(--color-bg-dd);\n}\n\n.item.no-transform:active {\n    transform: none;\n}\n\n.item.active {\n    background: var(--color-bg-dd);\n}\n\n.loading-indicator {\n    position: relative;\n    margin: .3em;\n    margin-top: 3em;\n    margin-bottom: 1em;\n    text-align: center;\n    white-space: pre-wrap;\n    cursor: default;\n    animation: loading-fadein .3s;\n}\n\n.loading-indicator-text {\n    margin: 0 auto;\n}\n\n.loading-indicator.running .loading-indicator-inner {\n    display: inline-block;\n    position: relative;\n    vertical-align: bottom;\n}\n\n.loading-indicator.running .loading-indicator-inner::after {\n    content: "";\n    height: 1px;\n    margin: 0%;\n    background: var(--color-text);\n    display: block;\n    animation: fadein .5s 1s backwards;\n}\n\n.loading-indicator.running .loading-indicator-text {\n    margin: 0 .5em;\n    animation: fadein .3s, loading-first .3s .5s cubic-bezier(0.55, 0.055, 0.675, 0.19) reverse, loading-second .3s .8s cubic-bezier(0.55, 0.055, 0.675, 0.19), loading .25s 1.1s cubic-bezier(0.55, 0.055, 0.675, 0.19) alternate-reverse infinite;\n}\n\n.loading-indicator.error {\n    color: red;\n}\n\n.loading-indicator.fading-out {\n    transition: max-height;\n    animation: loading-fadein .3s reverse;\n}\n\n@keyframes loading-fadein {\n    0% {\n        opacity: 0;\n        max-height: 0;\n    }\n    100% {\n        opacity: 1;\n        max-height: 200px;\n    }\n}\n\n@keyframes fadein {\n    0% {\n        opacity: 0;\n    }\n    100% {\n        opacity: 1;\n    }\n}\n\n@keyframes loading-first {\n    0% {\n        transform: translate(0, -2em) scale(1) rotate(360deg);\n    }\n    100% {\n        transform: translate(0, 0) scale(1) rotate(0deg);\n    }\n}\n\n@keyframes loading-second {\n    0% {\n        transform: translate(0, -2em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes loading {\n    0% {\n        transform: translate(0, -1em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes showing {\n    0% {\n        opacity: .3;\n        transform: translate(-20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-top {\n    0% {\n        opacity: .3;\n        transform: translate(0, -20px)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-right {\n    0% {\n        opacity: .3;\n        transform: translate(20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n.overlay {\n    background: rgba(0, 0, 0, .2);\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    animation: fadein .3s;\n    z-index: 10001;\n    overflow: hidden;\n    contain: strict;\n    will-change: transform;\n}\n\n.overlay.fixed {\n    position: fixed;\n}\n\n.overlay.nobg {\n    background: none;\n    will-change: auto;\n}\n\n.overlay.centerChild {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.overlay.clickThrough {\n    pointer-events: none;\n}\n\n.dialog * {\n    box-sizing: border-box;\n}\n\n.dialog {\n    font-size: 14px;\n    position: relative;\n    overflow: auto;\n    background: var(--color-bg);\n    border-radius: 5px;\n    box-shadow: 0 0 12px var(--color-shadow);\n    animation: dialogin .2s ease-out;\n    z-index: 10001;\n    display: flex;\n    flex-direction: column;\n    max-height: 100%;\n    contain: content;\n    will-change: transform;\n    pointer-events: auto;\n}\n\n.dialog.resize {\n    resize: both;\n}\n\n.fading-out .dialog {\n    transition: transform .3s ease-in;\n    transform: scale(.85);\n}\n\n.dialog-title, .dialog-content, .dialog-bottom {\n    padding: 10px;\n}\n\n.dialog-title {\n    background: var(--color-bg-ee);\n}\n\n.dialog-content {\n    flex: 1;\n    padding: 5px 10px;\n    overflow: auto;\n}\n\n.dialog-content.flex {\n    display: flex;\n    flex-direction: column;\n}\n\n.dialog-bottom {\n    padding: 5px 10px;\n}\n\n@keyframes dialogin {\n    0% {\n        transform: scale(.85);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n.input-label {\n    font-size: 80%;\n    color: var(--color-text-gray);\n    margin: 5px 0 3px 0;\n}\n\n.input-text {\n    display: block;\n    width: 100%;\n    padding: 5px;\n    border: solid 1px gray;\n    background: var(--color-bg);\n    color: var(--color-text);\n}\n\n.dialog .input-text {\n    margin: 5px 0;\n}\n\ntextarea.input-text {\n    resize: vertical;\n}\n\n.labeled-input {\n    display: flex;\n    flex-direction: column;\n}\n\n.labeled-input .input-text {\n    flex: 1;\n}\n\n.labeled-input:focus-within .input-label {\n    color: var(--color-primary-darker);\n}\n\n.input-text:focus {\n    border-color: var(--color-primary-darker);\n}\n\n.input-text:active {\n    border-color: var(--color-primary-dark);\n}\n\n.btn {\n    display: block;\n    text-align: center;\n    transition: all .2s;\n    padding: 0 .4em;\n    min-width: 3em;\n    line-height: 1.5em;\n    background: var(--color-primary);\n    color: white;\n    text-shadow: 0 0 4px var(--color-primary-verydark);\n    box-shadow: 0 0 3px var(--color-shadow);\n    cursor: pointer;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    user-select: none;\n    position: relative;\n    overflow: hidden;\n}\n\n.btn:hover {\n    transition: all .05s;\n    background: var(--color-primary-darker);\n}\n\n.btn.btn-down, .btn:active {\n    transition: all .05s;\n    background: var(--color-primary-dark);\n    box-shadow: 0 0 1px var(--color-shadow);\n}\n\n.btn.disabled {\n    background: var(--color-primary-light);\n}\n\n.dialog .btn {\n    margin: 10px 0;\n}\n\n.btn-big {\n    padding: 5px;\n}\n\n.btn-inline {\n    display: inline;\n}\n\n.textbtn {\n    display: inline-block;\n    color: var(--color-text-gray);\n    margin: 0 5px;\n}\n\n.textbtn.active {\n    color: var(--color-text);\n}\n\n*[hidden] {\n    display: none !important;\n}\n\n.context-menu {\n    position: absolute;\n    overflow-y: auto;\n    background: var(--color-bg);\n    border: solid 1px #777;\n    box-shadow: 0 0px 12px var(--color-shadow);\n    min-width: 100px;\n    max-width: 450px;\n    outline: none;\n    z-index: 10001;\n    animation: context-menu-in .2s ease-out forwards;\n    will-change: transform;\n}\n\n.context-menu .item.dangerous {\n    transition: color .3s, background .3s;\n    color: red;\n}\n\n.context-menu .item.dangerous:hover {\n    transition: color .1s, background .1s;\n    background: red;\n    color: white;\n}\n\n@keyframes context-menu-in {\n    0% {\n        transform: scale(.9);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n*.menu-shown {\n    background: var(--color-bg-dd);\n}\n\n.menu-info {\n    white-space: pre-wrap;\n    color: var(--color-text-gray);\n    padding: 5px 10px;\n    /* animation: showing .3s; */\n    cursor: default;\n}\n\n.toasts-container {\n    position: fixed;\n    bottom: 0;\n    right: 0;\n    padding: 5px;\n    width: 300px;\n    z-index: 10001;\n    overflow: hidden;\n}\n\n.toast {\n    margin: 5px;\n    padding: 10px;\n    border-radius: 5px;\n    box-shadow: 0 0 10px var(--color-shadow);\n    background: var(--color-bg);\n    white-space: pre-wrap;\n    animation: showing-right .3s;\n}\n\n.fading-out {\n    transition: opacity .3s;\n    opacity: 0;\n    pointer-events: none;\n}\n\n.anchor-bottom {\n    transform: translate(-50%, -100%);\n}\n\n.tooltip {\n    position: absolute;\n    background: var(--color-bg);\n    box-shadow: 0 0 5px var(--color-shadow);\n    border-radius: 5px;\n    padding: .2em .25em;\n}\n',{tag:"style.webfx-injected-style"}),c=!0)}class TextView extends View{constructor(){super(...arguments),this._text="",this.textFunc=null}get text(){var t,e;return null!==(e=null===(t=this.dom)||void 0===t?void 0:t.textContent)&&void 0!==e?e:this._text}set text(t){"function"==typeof t?(this._text=t(),this.textFunc=t):(this._text=t,this.textFunc=null),this.domCreated&&(this.dom.textContent=this._text)}postCreateDom(){super.postCreateDom(),this.dom.textContent=this._text}updateDom(){super.updateDom(),this.textFunc&&(this.dom.textContent=this.textFunc())}}class ButtonView extends TextView{constructor(t){super(),this.disabled=!1,this.type="normal",objectInit(this,t),this.updateDom()}createDom(){return{tag:"div.btn",tabIndex:0}}updateDom(){super.updateDom(),this.toggleClass("disabled",this.disabled),this.toggleClass("btn-big","big"===this.type),this.toggleClass("btn-inline","inline"===this.type)}}class TextBtn extends TextView{constructor(t){super(),this.clickable=!0,this.active=!1,this.right=!1,objectInit(this,t)}createDom(){return{tag:"span.textbtn.no-selection"}}updateDom(){super.updateDom(),this.dom.tabIndex=this.clickable?0:-1,this.toggleClass("clickable",this.clickable),this.toggleClass("active",this.active),this.dom.style.float=this.right?"right":"left"}}const u=TextBtn;function setPosition(t,e){let{x:i=0,y:n=0,anchor:s="bottom"}=e;t.style.left=i+"px",t.style.top=n+"px",t.classList.contains("anchor-"+s)||(t.classList.forEach((e=>{e.startsWith("anchor-")&&t.classList.remove(e)})),t.classList.add("anchor-"+s))}var p,m=new class DragManager{constructor(){this._currentItem=null,this._currentArray=null,this.onDragStart=new a,this.onDragEnd=new a}get currentItem(){var t,e,i;return null!==(i=null!==(t=this._currentItem)&&void 0!==t?t:null===(e=this._currentArray)||void 0===e?void 0:e[0])&&void 0!==i?i:null}get currentArray(){return this._currentItem?[this._currentItem]:this._currentArray}start(t){this._currentItem=t,console.log("drag start",t),this.onDragStart.invoke()}startArray(t){this._currentArray=t,console.log("drag start array",t),this.onDragStart.invoke()}end(){this._currentItem=null,this._currentArray=null,console.log("drag end"),this.onDragEnd.invoke()}};class EditableHelper{constructor(t){this.editing=!1,this.beforeEdit=null,this.onComplete=null,this.element=t}startEdit(t){if(!this.editing){this.editing=!0;var e=this.element,i=this.beforeEdit=e.textContent;toggleClass(e,"editing",!0);for(var n=buildDOM({tag:"input",type:"text",value:i});e.firstChild;)e.removeChild(e.firstChild);e.appendChild(n),n.select(),n.focus();var stopEdit=()=>{var i;this.editing=!1,toggleClass(e,"editing",!1),s.forEach((t=>t.remove())),n.remove(),null===(i=this.onComplete)||void 0===i||i.call(this,n.value),null==t||t(n.value)},s=[listenEvent(n,"keydown",(t=>{"Enter"===t.code&&(stopEdit(),t.preventDefault())})),listenEvent(n,"focusout",(t=>{stopEdit()}))]}}startEditAsync(){return new Promise((t=>this.startEdit(t)))}}class ViewToggle{constructor(t){this.shownKeys=[],this.toggleMode="remove",this.container=null,objectInit(this,t),this.setShownKeys(this.shownKeys)}add(t,e){const i=this.items[t];i?i instanceof Array?this.items[t].push(e):this.items[t]=[i,e]:this.items[t]=e,this.toggleView(e,this.shownKeys.indexOf(t)>=0)}setShownKeys(t){this.shownKeys=t;const e=this.items;for(const i in e){const n=t.indexOf(i)>=0;if(Object.prototype.hasOwnProperty.call(e,i)){const t=e[i];if(t)if(t instanceof Array)for(const e of t)this.toggleView(e,n);else t&&this.toggleView(t,n)}}}toggleView(t,e,i){if(i||(i=this.toggleMode),"display"==i)t.dom.style.display=e?"":"none";else if("hidden"==i)t.dom.hidden=!e;else{if("remove"!=i)throw new Error("Unknown toggle mode");e!=!!t.parentView&&(e?this.container.appendView(t):this.container.removeView(t))}}}class ItemActiveHelper{constructor(t){this.funcSetActive=(t,e)=>t.toggleClass("active",e),this.current=null,objectInit(this,t)}set(t){this.current!==t&&(this.current&&this.funcSetActive(this.current,!1),this.current=t,this.current&&this.funcSetActive(this.current,!0))}}class ToolTip extends TextView{constructor(){super(...arguments),this._shown=!1,this._timer=new Timer((()=>this.close())),this._cancelClose=null}createDom(){return{tag:"div.tooltip"}}get shown(){return this._shown}show(t){var e;if(this.shown)return;this._shown=!0,null===(e=this._cancelClose)||void 0===e||e.call(this);let{parent:i=document.body,timeout:n}=t;n&&this._timer.timeout(n);const s=this.dom;setPosition(s,t),i.appendChild(s)}close(t){this.shown&&(this._timer.tryCancel(),this._shown=!1,this._cancelClose=fadeout(this.dom,t).cancel)}}!function(t){t.FlagsInput=class FlagsInput extends ContainerView{constructor(t){super(),null==t||t.forEach((t=>{var e=t instanceof Flag?t:new Flag({text:Object.prototype.toString.call(t)});this.addView(e)}))}createDom(){return{tag:"div.flags-input"}}};class Flag extends TextView{get parentInput(){return this.parentView}constructor(t){super(),objectInit(this,t)}createDom(){return{tag:"div.flags-input-item"}}}t.Flag=Flag}(p||(p={}));class Overlay extends View{createDom(){return{tag:"div.overlay"}}setCenterChild(t){return this.setFlags({centerChild:t})}setNoBg(t){return this.setFlags({nobg:t})}setFixed(t){return this.setFlags({fixed:t})}setFlags(t){for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&this.toggleClass(e,t[e]);return this}}var g=window&&window.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function fulfilled(t){try{step(n.next(t))}catch(t){r(t)}}function rejected(t){try{step(n.throw(t))}catch(t){r(t)}}function step(t){t.done?s(t.value):function adopt(t){return t instanceof i?t:new i((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((n=n.apply(t,e||[])).next())}))};class Dialog extends View{constructor(){super(),this.parent=Dialog.defaultParent,this.overlay=(new Overlay).setFlags({centerChild:!0,nobg:!0}),this.header=new View({tag:"div.dialog-title.clearfix"}),this.content=new View({tag:"div.dialog-content"}),this.shown=!1,this.btnTitle=new TextBtn({active:!0,clickable:!1}),this.btnClose=new TextBtn({text:h`Close`,right:!0}),this.title="Dialog",this.allowClose=!0,this.showCloseButton=!0,this.onShown=new a,this.onClose=new a,this.focusTrap=new View({tag:"div.focustrap",tabIndex:0}),this.btnClose.onActive.add((()=>this.allowClose&&this.close()))}get domheader(){return this.header.dom}static get defaultParent(){return Dialog._defaultParent||(Dialog._defaultParent=new DialogParent),Dialog._defaultParent}static set defaultParent(t){Dialog._defaultParent=t}get width(){return this.dom.style.width}set width(t){this.dom.style.width=t}get contentFlex(){return this.content.dom.classList.contains("flex")}set contentFlex(t){this.content.toggleClass("flex",!!t)}get resizable(){return this.dom.classList.contains("resize")}set resizable(t){this.toggleClass("resize",!!t)}createDom(){return{tag:"div.dialog",tabIndex:0,style:"width: 300px",child:[this.header,this.content,this.focusTrap]}}postCreateDom(){super.postCreateDom(),this.addBtn(this.btnTitle),this.addBtn(this.btnClose),this.overlay.appendView(this),this.overlay.dom.addEventListener("mousedown",(t=>{this.allowClose&&0===t.button&&t.target===this.overlay.dom&&(t.preventDefault(),this.close())})),this.overlay.dom.addEventListener("keydown",(t=>{if(this.allowClose&&27===t.keyCode)t.preventDefault(),this.close();else if(t.target===this.dom&&"Tab"===t.code&&t.shiftKey){t.preventDefault();let e=this.dom.querySelectorAll("a, [tabindex]");e.length>=2&&e[e.length-2].focus&&e[e.length-2].focus()}}));{let t;listenPointerEvents(this.header.dom,(e=>{if("down"===e.action){if(e.ev.target!==this.header.dom&&e.ev.target!==this.btnTitle.dom)return;e.ev.preventDefault();const i=this.overlay.dom.getBoundingClientRect(),n=this.dom.getBoundingClientRect();return t={x:e.point.pageX-i.x-n.x,y:e.point.pageY-i.y-n.y},"track"}if("move"===e.action){e.ev.preventDefault();const i=this.overlay.dom.getBoundingClientRect(),n=numLimit(e.point.pageX,i.left,i.right),s=numLimit(e.point.pageY,i.top,i.bottom);this.setOffset(n-t.x,s-t.y)}}))}this.focusTrap.dom.addEventListener("focus",(t=>{this.dom.focus()}))}updateDom(){super.updateDom(),this.btnTitle.updateWith({text:this.title}),this.btnTitle.hidden=!this.title,this.btnClose.hidden=!(this.allowClose&&this.showCloseButton)}addBtn(t){this.ensureDom(),this.header.appendView(t)}addContent(t,e){this.ensureDom(),e&&this.content.removeAllView(),this.content.addChild(t)}addChild(t){this.addContent(t)}setOffset(t,e){this.dom.style.left=t?t+"px":"",this.dom.style.top=e?e+"px":"",this.overlay.setCenterChild(!1)}getOffset(){return{x:this.dom.style.left?parseFloat(this.dom.style.left):0,y:this.dom.style.top?parseFloat(this.dom.style.top):0}}center(){this.setOffset(0,0),this.overlay.setCenterChild(!0)}show(t){var e;this.shown||(this.shown=!0,null===(e=this._cancelFadeout)||void 0===e||e.call(this),this.ensureDom(),this.parent.onDialogShowing(this),this.setTransformOrigin(t),this.dom.focus(),(this.autoFocus||this).dom.focus(),this.onShown.invoke())}setTransformOrigin(t){if(t){const e=this.dom.getBoundingClientRect();this.dom.style.transformOrigin=`${t.x-e.x}px ${t.y-e.y}px`}else this.dom.style.transformOrigin=""}close(){this.shown&&(this.shown=!1,this.setTransformOrigin(void 0),this.onClose.invoke(),this._cancelFadeout=fadeout(this.overlay.dom).onFinished((()=>{var t;return null===(t=this.overlay.parentView)||void 0===t?void 0:t.removeView(this.overlay)})).cancel,Dialog.defaultParent.onDialogClosing(this))}waitClose(){return new Promise((t=>{var e=this.onClose.add((()=>{this.onClose.remove(e),t()}))}))}}Dialog._defaultParent=null;class MessageBox extends Dialog{constructor(){super(...arguments),this.allowClose=!1,this.title="Message",this.result="none"}addResultBtns(t){for(const e of t)this.addBtnWithResult(new TextBtn({text:d.get("msgbox_"+e),right:!0}),e);return this}setTitle(t){return this.title=t,this.domCreated&&this.updateDom(),this}addText(t){return this.addContent(new TextView({tag:"div.messagebox-text",textContent:t})),this}allowCloseWithResult(t,e){return this.result=t,this.allowClose=!0,this.showCloseButton=!!e,this.domCreated&&this.updateDom(),this}addBtnWithResult(t,e){return t.onActive.add((()=>{this.result=e,this.close()})),this.addBtn(t),this}showAndWaitResult(){return g(this,void 0,void 0,(function*(){return this.show(),yield this.waitClose(),this.result}))}}class DialogParent{constructor(t=document.body){this.bgOverlay=new Overlay,this.dialogCount=0,this.fixed=!1,this._cancelFadeout=null,this.view=View.getView(t),t===document.body&&(this.fixed=!0,this.view.mountStateChanged(e.Mounted))}onDialogShowing(t){var e;0==this.dialogCount++&&(null===(e=this._cancelFadeout)||void 0===e||e.call(this),this.bgOverlay.setFlags({fixed:this.fixed,clickThrough:!0}),this.view.appendView(this.bgOverlay)),t.overlay.setFlags({fixed:this.fixed}),this.view.appendView(t.overlay)}onDialogClosing(t){0==--this.dialogCount&&(this._cancelFadeout=fadeout(this.bgOverlay.dom).onFinished((()=>this.view.removeView(this.bgOverlay))).cancel)}}class InputView extends View{constructor(t){super(),this.multiline=!1,this.type="text",this.placeholder="",objectInit(this,t)}get value(){return this.dom.value}set value(t){this.dom.value=t}createDom(){return this.multiline?{tag:"textarea.input-text"}:{tag:"input.input-text"}}updateDom(){super.updateDom(),this.dom instanceof HTMLInputElement&&(this.dom.type=this.type,this.dom.placeholder=this.placeholder)}}class LabeledInputBase extends View{constructor(t){super(),this.label="",objectInit(this,t)}get dominput(){return this.input.dom}createDom(){return{tag:"div.labeled-input",child:[{tag:"div.input-label",text:()=>this.label},this.input]}}updateDom(){super.updateDom(),this.input.domCreated&&this.input.updateDom()}}class LabeledInput extends LabeledInputBase{constructor(t){super(),objectInit(this,t),this.input||(this.input=new InputView)}get value(){return this.dominput.value}set value(t){this.dominput.value=t}updateDom(){this.input.type=this.type,super.updateDom()}}class ListViewItem extends View{constructor(){super(...arguments),this.dragging=void 0,this._selected=!1,this.onSelectedChanged=new a,this.enterctr=0,this.dragoverPlaceholder=null}get listview(){return this.parentView instanceof ListView?this.parentView:null}get selectionHelper(){var t;return null===(t=this.listview)||void 0===t?void 0:t.selectionHelper}get dragData(){return this.dom.textContent}get selected(){return this._selected}set selected(t){this._selected=t,this.domCreated&&this.updateDom(),this.onSelectedChanged.invoke()}remove(){this.listview&&this.listview.remove(this)}postCreateDom(){super.postCreateDom(),this.dom.setAttribute("role","listitem"),this.dom.addEventListener("click",(t=>{var e,i,n;(null===(e=this.listview)||void 0===e?void 0:e.selectionHelper.handleItemClicked(this,t))||null===(n=null===(i=this.listview)||void 0===i?void 0:i.onItemClicked)||void 0===n||n.call(i,this)})),this.dom.addEventListener("keydown",(t=>{var e,i,n,s,r,o;if("Enter"===t.code){if(t.altKey){const t=this.dom.getBoundingClientRect(),s=new MouseEvent("contextmenu",{clientX:t.left,clientY:t.top,relatedTarget:this.dom});null===(n=null!==(e=this.onContextMenu)&&void 0!==e?e:null===(i=this.listview)||void 0===i?void 0:i.onContextMenu)||void 0===n||n(this,s)}else{if(null===(s=this.listview)||void 0===s?void 0:s.selectionHelper.handleItemClicked(this,t))return;null===(o=null===(r=this.listview)||void 0===r?void 0:r.onItemClicked)||void 0===o||o.call(r,this)}t.preventDefault()}else if(!this.listview||"ArrowUp"!==t.code&&"ArrowDown"!==t.code)if(!this.listview||"PageUp"!==t.code&&"PageDown"!==t.code)!this.listview||"Home"!==t.code&&"End"!==t.code?this.listview&&this.listview.selectionHelper.handleItemKeyDown(this,t):(this.listview.get("Home"==t.code?0:this.listview.length-1).dom.focus(),t.preventDefault());else{const e="PageUp"===t.code?-1:1,i=this.listview.scrollBox,n=e>0?this.dom.offsetTop+i.offsetHeight:this.dom.offsetTop+this.dom.offsetHeight-i.offsetHeight,s=this.listview.length;let r=this;for(;e>0?n>r.dom.offsetTop+r.dom.offsetHeight:n<r.dom.offsetTop;){const t=r.position+e;if(t<0||t>=s)break;r=this.listview.get(t)}r&&r!==this&&(r.dom.focus(),t.preventDefault())}else{const e="ArrowUp"===t.code?-1:1,i=this.listview.get(this.position+e);i&&(i.dom.focus(),t.preventDefault())}})),this.dom.addEventListener("contextmenu",(t=>{var e,i,n;null===(n=null!==(e=this.onContextMenu)&&void 0!==e?e:null===(i=this.listview)||void 0===i?void 0:i.onContextMenu)||void 0===n||n(this,t)})),this.dom.addEventListener("dragstart",(t=>{var e,i;if(null!==(e=this.dragging)&&void 0!==e?e:null===(i=this.listview)||void 0===i?void 0:i.dragging){var n=[];this.selected&&this.selectionHelper?(n=[...this.selectionHelper.selectedItems]).sort(((t,e)=>t.position-e.position)):n=[this],m.startArray(n),t.dataTransfer.setData("text/plain",n.map((t=>t.dragData)).join("\r\n")),n.forEach((t=>t.dom.style.opacity=".5"))}else t.preventDefault()})),this.dom.addEventListener("dragend",(t=>{var e=m.currentArray;m.end(),t.preventDefault(),e.forEach((t=>t.dom.style.opacity=""))})),this.dom.addEventListener("dragover",(t=>{this.dragHandler(t,"dragover")})),this.dom.addEventListener("dragenter",(t=>{this.dragHandler(t,"dragenter")})),this.dom.addEventListener("dragleave",(t=>{this.dragHandler(t,"dragleave")})),this.dom.addEventListener("drop",(t=>{this.dragHandler(t,"drop")}))}dragHandler(t,e){var i,n,s,r,o,a,l,d;const h=m.currentItem;let c=m.currentArray;const u="drop"===e,p={source:h,target:this,sourceItems:c,event:t,drop:u,accept:!1};if(h instanceof ListViewItem&&(null===(i=this.listview)||void 0===i?void 0:i.moveByDragging)&&h.listview===this.listview){t.preventDefault();const e=c.indexOf(this)>=0,i=t.clientY-this.dom.getBoundingClientRect().top>this.dom.offsetHeight/2;if(e&&u||(p.accept=i?"move-after":"move"),u){if(-1===c.indexOf(this)){let t=this.position;i&&t++;for(const e of c)e!==this&&(t>e.position&&t--,this.listview.move(e,t),t++)}}else t.dataTransfer.dropEffect="move"}const g=null!==(n=this.onDragover)&&void 0!==n?n:null===(s=this.listview)||void 0===s?void 0:s.onDragover;!p.accept&&g&&(g(p),(u||p.accept)&&t.preventDefault());const v=null!==(r=this.onContextMenu)&&void 0!==r?r:null===(o=this.listview)||void 0===o?void 0:o.onContextMenu;if(!p.accept&&c&&c.indexOf(this)>=0&&v&&(u?v(this,t):t.preventDefault()),"dragenter"===e||"dragover"==e||"dragleave"===e||u){"dragenter"===e?this.enterctr++:"dragleave"===e?this.enterctr--:"drop"===e&&(this.enterctr=0);let t=this.enterctr>0;this.toggleClass("dragover",t);let i=t&&("move"===p.accept||"move-after"===p.accept)&&p.accept;if(i!=(null!==(l=null===(a=this.dragoverPlaceholder)||void 0===a?void 0:a[1])&&void 0!==l&&l)&&(null===(d=this.dragoverPlaceholder)||void 0===d||d[0].remove(),this.dragoverPlaceholder=null,i)){this.dragoverPlaceholder=[buildDOM({tag:"div.dragover-placeholder"}),i];var w=this.dom;"move-after"===p.accept&&(w=w.nextElementSibling),this.dom.parentElement.insertBefore(this.dragoverPlaceholder[0],w)}}}}class ListView extends ContainerView{constructor(t){super(t),this.onItemClicked=null,this.dragging=!1,this.moveByDragging=!1,this.selectionHelper=new SelectionHelper,this._scrollBox=null,this.onItemMoved=null,this.onDragover=null,this.onContextMenu=null,this.selectionHelper.itemProvider=this}get scrollBox(){return this._scrollBox||this.dom}set scrollBox(t){this._scrollBox=t}postCreateDom(){super.postCreateDom(),this.dom.setAttribute("role","list")}add(t,e){this.addView(t,e),this.dragging&&(t.dom.draggable=!0)}remove(t,e){t=this._ensureItem(t),!e&&t.selected&&this.selectionHelper.toggleItemSelection(t),this.removeView(t)}move(t,e){var i;t=this._ensureItem(t),this.remove(t,!0),this.add(t,e),null===(i=this.onItemMoved)||void 0===i||i.call(this,t,t.position)}removeAll(){for(;this.length;)this.remove(this.length-1)}clear(){this.removeAll(),clearChildren(this.dom)}ReplaceChild(t){this.clear(),this.dom.appendChild(t.getDOM())}}class SelectionHelper{constructor(){this._enabled=!1,this.onEnabledChanged=new a,this.itemProvider=null,this.ctrlForceSelect=!1,this.selectedItems=[],this.onSelectedItemsChanged=new a,this.lastToggledItem=null}get enabled(){return this._enabled}set enabled(t){if(!!t!=!!this._enabled){for(this._enabled=t;this.selectedItems.length;)this.toggleItemSelection(this.selectedItems[0],!1);this.lastToggledItem=null,this.onEnabledChanged.invoke()}}get count(){return this.selectedItems.length}handleItemClicked(t,e){if(!this.enabled){if(!this.ctrlForceSelect||!e.ctrlKey)return!1;this.enabled=!0}if(e.shiftKey&&this.lastToggledItem&&this.itemProvider){var i=!!this.lastToggledItem.selected,n=t.position,s=this.lastToggledItem.position;n>s&&([n,s]=[s,n]);for(let t=n;t<=s;t++)this.toggleItemSelection(this.itemProvider.get(t),i);this.lastToggledItem=t}else this.toggleItemSelection(t);return e.preventDefault(),!0}handleItemKeyDown(t,e){if(!this.enabled)return!1;if(this.itemProvider&&e.ctrlKey&&"KeyA"===e.code){const t=this.itemProvider.length;for(let e=0;e<t;e++)this.toggleItemSelection(this.itemProvider.get(e),!0);return e.preventDefault(),!0}return!1}toggleItemSelection(t,e){void 0!==e&&e===!!t.selected||(t.selected?(t.selected=!1,this.selectedItems.remove(t),this.onSelectedItemsChanged.invoke("remove",t)):(t.selected=!0,this.selectedItems.push(t),this.onSelectedItemsChanged.invoke("add",t)),this.lastToggledItem=t,0===this.count&&this.ctrlForceSelect&&(this.enabled=!1))}}class LazyListView extends ListView{constructor(){super(...arguments),this._loaded=0,this._lazy=!1,this._slowLoading=null,this._autoLoad=null}get loaded(){return this.loaded}get slowLoading(){return this._slowLoading}get autoLoad(){return this._autoLoad}get lazy(){return this._lazy}set lazy(t){this._lazy=t,t||this.ensureLoaded(this.length-1)}ensureLoaded(t){for(t>=this.length&&(t=this.length-1);this._loaded<=t;)this.dom.appendChild(this.items[this._loaded].dom),this._loaded++}loadNext(t=50){return this._loaded<this.length&&(this.ensureLoaded(Math.min(this.length-1,this._loaded+t-1)),!0)}slowlyLoad(t=30,e=50,i=!1){return i&&this.enableAutoLoad(t,e),this._slowLoading?this._slowLoading:this._loaded>=this.length?Promise.resolve(!0):this._slowLoading=new Promise((i=>{var n,s,callback=()=>{this._slowLoading&&this.loadNext(e)?s():(this.lazy=!!this._autoLoad,n(),i(!!this._slowLoading),this._slowLoading=null)};if(-1==t&&window.requestIdleCallback){let t;n=()=>window.cancelIdleCallback(t),(s=()=>{t=window.requestIdleCallback(callback)})()}else{-1==t&&(t=30);let e=setInterval(callback,t);n=()=>clearInterval(e),s=()=>{}}}))}enableAutoLoad(t=30,e=50){this._autoLoad={interval:t,batchSize:e},this.slowlyLoad(t,e)}stopLoading(){this._slowLoading=null,this._autoLoad=null}unload(){this.stopLoading();for(let t=this._loaded-1;t>=0;t--)this.items[t].dom.remove();this.lazy=!0,this._loaded=0}_insertToDom(t,e){!this.lazy||e<this._loaded?(super._insertToDom(t,e),this._loaded++):this._autoLoad&&this.slowlyLoad(this._autoLoad.interval,this._autoLoad.batchSize)}_removeFromDom(t){t.position<this._loaded&&(super._removeFromDom(t),this._loaded--)}}var v=window&&window.__awaiter||function(t,e,i,n){return new(i||(i=Promise))((function(s,r){function fulfilled(t){try{step(n.next(t))}catch(t){r(t)}}function rejected(t){try{step(n.throw(t))}catch(t){r(t)}}function step(t){t.done?s(t.value):function adopt(t){return t instanceof i?t:new i((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((n=n.apply(t,e||[])).next())}))};class LoadingIndicator extends View{constructor(t){super(),this._status="running",this.onclick=null,t&&objectInit(this,t)}get state(){return this._status}set state(t){this._status=t,["running","error","normal"].forEach((e=>this.toggleClass(e,t===e)))}get content(){return this._text}set content(t){this._text=t,this.ensureDom(),this._textdom.textContent=t}reset(){this.state="running",this.content=h`Loading`,this.onclick=null}error(t,e){this.state="error",this.content=h`Oh no! Something just goes wrong:`+"\r\n"+t,e&&(this.content+="\r\n"+h`[Click here to retry]`),this.onclick=e}action(t){return v(this,void 0,void 0,(function*(){try{yield t()}catch(e){this.error(e,(()=>this.action(t)))}}))}createDom(){return{tag:"div.loading-indicator",child:[{tag:"div.loading-indicator-inner",child:[{tag:"div.loading-indicator-text",_id:"text"}]}],onclick:t=>{var e;return null===(e=this.onclick)||void 0===e?void 0:e.call(this,t)}}}postCreateDom(){this._textdom=this.getDomById("text"),this.reset()}}class MenuItem extends ListViewItem{constructor(t){super(),this.text="",this.cls="normal",this.keepOpen=!1,objectInit(this,t)}createDom(){return{tag:"div.item.no-selection",tabIndex:0}}postCreateDom(){super.postCreateDom(),this.onActive.add((t=>{this.parentView instanceof ContextMenu&&(this.keepOpen||this.parentView.keepOpen||this.parentView.close())}))}updateDom(){super.updateDom(),this.dom.textContent=this.text,this.cls!==this._lastcls&&(this._lastcls&&this.dom.classList.remove(this._lastcls),this.cls&&this.dom.classList.add(this.cls))}}class MenuLinkItem extends MenuItem{constructor(t){super(t),this.link="",this.download="",objectInit(this,t)}createDom(){var t=super.createDom();return t.tag="a.item.no-selection",t.target="_blank",t}updateDom(){super.updateDom(),this.dom.href=this.link,this.dom.download=this.download}}class MenuInfoItem extends MenuItem{constructor(t){super(t),this.text="",this.keepOpen=!0,objectInit(this,t)}createDom(){return{tag:"div.menu-info"}}updateDom(){super.updateDom(),this.dom.textContent=this.text}}class ContextMenu extends ListView{constructor(t){super({tag:"div.context-menu",tabIndex:0}),this.keepOpen=!1,this.useOverlay=!0,this._visible=!1,this.overlay=null,this.onClose=new a,this._originalFocused=null,null==t||t.forEach((t=>this.add(t)))}get visible(){return this._visible}postCreateDom(){super.postCreateDom(),this.dom.addEventListener("focusout",(t=>{!this.dom.contains(t.relatedTarget)&&this.close()})),this.dom.addEventListener("keydown",(t=>{"Escape"===t.code&&(t.preventDefault(),this.close())}))}show(t){this._visible?console.trace("[ContextMenu] show() called when it's already visible."):("ev"in t&&(t={x:t.ev.clientX,y:t.ev.clientY}),this._visible=!0,this.useOverlay?(this.overlay||(this.overlay=(new Overlay).setFixed(!0),this.overlay.dom.style.background="rgba(0, 0, 0, .1)",this.overlay.dom.addEventListener("mousedown",(t=>{t.eventPhase===Event.AT_TARGET&&(t.preventDefault(),this.close())}))),this.overlay.appendView(this),mountView(document.body,this.overlay)):mountView(document.body,this),this._originalFocused=document.activeElement,this.setPosition(t),this.dom.focus())}setPosition(t){if(this._visible){this.dom.style.left="0",this.dom.style.top="0";var e=document.body.offsetWidth,i=document.body.offsetHeight;if(this.useOverlay){const t=this.overlay.dom;e=t.offsetWidth,i=t.offsetHeight}this.dom.style.maxHeight=i+"px";var n=this.dom.offsetWidth,s=this.dom.offsetHeight,r=t.x,o=t.y;r+n>e&&(r-=n),o+s>i&&(o-=s),r<0&&(r=t.x>e/2?0:e-n),o<0&&(o=t.y>i/2?0:i-s),this.dom.style.left=r+"px",this.dom.style.top=o+"px",this.dom.style.transformOrigin=`${t.x-r}px ${t.y-o}px`}else console.trace("[ContextMenu] setPosition() called when it's not visible.")}close(){var t,e;this._visible&&(this._visible=!1,this.onClose.invoke(),null===(e=null===(t=this._originalFocused)||void 0===t?void 0:t.focus)||void 0===e||e.call(t),this._originalFocused=null,this.overlay&&fadeout(this.overlay.dom).onFinished((()=>unmountView(document.body,this.overlay))),fadeout(this.dom).onFinished((()=>!this.overlay&&unmountView(document.body,this))))}}class Section extends View{constructor(t){super(),this.titleView=new TextView({tag:"span.section-title"}),this.headerView=new View({tag:"div.section-header",child:[this.titleView]}),this.ensureDom(),t&&(t.title&&this.setTitle(t.title),t.content&&this.setContent(t.content),t.actions&&t.actions.forEach((t=>this.addAction(t))))}createDom(){return{tag:"div.section",child:[this.headerView]}}setTitle(t){this.titleView.removeAllView(),this.titleView.addChild(t)}setContent(t){this.content&&this.removeView(this.content),this.content=View.getView(t),this.appendView(this.content)}addAction(t){var e=t instanceof View?t:new SectionAction({text:t.text,onActive:t.onclick});this.headerView.appendView(e)}}class SectionAction extends TextView{constructor(t){super(),objectInit(this,t)}createDom(){return{tag:"div.section-action.clickable",tabIndex:0}}}class ToastsContainer extends View{constructor(){super(...arguments),this.parentDom=null,this.toasts=[]}createDom(){return{tag:"div.toasts-container"}}addToast(t){0===this.toasts.length&&this.show(),this.toasts.push(t)}removeToast(t){this.toasts.remove(t),0===this.toasts.length&&this.remove()}show(){(this.parentDom||document.body).appendChild(this.dom)}remove(){this.dom.remove()}}ToastsContainer.default=new ToastsContainer;class Toast extends View{constructor(t){super(),this.text="",this.shown=!1,this.timer=new Timer((()=>this.close())),objectInit(this,t),this.container||(this.container=ToastsContainer.default)}show(t){this.shown||(this.container.addToast(this),this.container.appendView(this),this.shown=!0),t?this.timer.timeout(t):this.timer.tryCancel()}close(){this.shown&&(this.shown=!1,fadeout(this.dom).onFinished((()=>this.container.removeToast(this))))}createDom(){return{tag:"div.toast"}}updateDom(){super.updateDom(),this.dom.textContent=this.text}static show(t,e){var i=new Toast({text:t});return i.show(e),i}}var w=Object.freeze({__proto__:null,AutoResetEvent:class AutoResetEvent{constructor(){this._whenNotify=null,this._callback=null}wait(){return this._whenNotify||(this._whenNotify=new Promise((t=>{this._callback=()=>{this._callback=this._whenNotify=null,t()}}))),this._whenNotify}set(){this._callback&&this._callback()}},BuildDOMCtx:BuildDOMCtx,ButtonView:ButtonView,Callbacks:a,CancelToken:CancelToken,ContainerView:ContainerView,ContextMenu:ContextMenu,DataUpdatingHelper:DataUpdatingHelper,Dialog:Dialog,DialogParent:DialogParent,EditableHelper:EditableHelper,EventRegistrations:EventRegistrations,get FlagsInput(){return p},I:h,I18n:I18n,InputStateTracker:InputStateTracker,InputView:InputView,ItemActiveHelper:ItemActiveHelper,JsxNode:JsxNode,LabeledInput:LabeledInput,LabeledInputBase:LabeledInputBase,Lazy:Lazy,LazyListView:LazyListView,ListView:ListView,ListViewItem:ListViewItem,LoadingIndicator:LoadingIndicator,MenuInfoItem:MenuInfoItem,MenuItem:MenuItem,MenuLinkItem:MenuLinkItem,MessageBox:MessageBox,get MountState(){return e},Overlay:Overlay,Ref:Ref,Section:Section,SectionAction:SectionAction,SelectionHelper:SelectionHelper,Semaphore:Semaphore,SettingItem:SettingItem,TabBtn:u,TextBtn:TextBtn,TextCompositionWatcher:TextCompositionWatcher,TextView:TextView,Timer:Timer,Toast:Toast,ToastsContainer:ToastsContainer,ToolTip:ToolTip,View:View,ViewToggle:ViewToggle,addChild:addChild,appendView:appendView,arrayFind:arrayFind,arrayForeach:arrayForeach,arrayInsert:arrayInsert,arrayMap:arrayMap,arrayRemove:arrayRemove,arraySum:arraySum,base64EncodeUtf8:base64EncodeUtf8,buildDOM:buildDOM,buildView:buildView,clearChildren:clearChildren,createArrayBuilder:createArrayBuilder,createName:createName,createStringBuilder:createStringBuilder,dragManager:m,fadeout:fadeout,foreachFlaten:foreachFlaten,formatDateTime:formatDateTime,formatFileSize:formatFileSize,formatTime:formatTime,getDOM:getDOM,getWebfxCss:getWebfxCss,i18n:d,injectCss:injectCss,injectWebfxCss:injectWebfxCss,jsx:i,jsxBuild:jsxBuild,jsxFactory:jsxFactory,listenEvent:listenEvent,listenEvents:listenEvents,listenPointerEvents:listenPointerEvents,mod:mod,mountView:mountView,numLimit:numLimit,objectApply:objectApply,objectInit:objectInit,readBlobAsDataUrl:readBlobAsDataUrl,replaceChild:replaceChild,setPosition:setPosition,sleepAsync:sleepAsync,startBlockingDetect:startBlockingDetect,strPadLeft:strPadLeft,toggleClass:toggleClass,tryGetDOM:tryGetDOM,unmountView:unmountView,utils:l,version:"1.9.6"});
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function __awaiter(t,e,i,n){return new(i||(i=Promise))((function(s,r){function fulfilled(t){try{step(n.next(t))}catch(t){r(t)}}function rejected(t){try{step(n.throw(t))}catch(t){r(t)}}function step(t){t.done?s(t.value):function adopt(t){return t instanceof i?t:new i((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((n=n.apply(t,e||[])).next())}))}var f=JSON.parse('[[["en","zh"],["English","中文"],["Language: {0}","语言：{0}"],[" (auto-detected)","（自动检测）"],["Reload to fully apply changes","刷新以完全应用更改"],["Pin","固定"],["Unpin","浮动"],["Pause","暂停"],["Pause...","暂停..."],["Play","播放"],[" (logging in...)"," （登录中...）"],["Guest (click to login)","游客（点击登录）"],["Login","登录"],["Create account","创建账户"],["Close","关闭"],["Username","用户名"],["Password","密码"],["Change password","更改密码"],["New password","新密码"],["Confirm password","确认密码"],["Requesting...","请求中……"],[" (error!)","（错误！）"],["Username or password is not correct.","用户名或密码不正确。"],["Logged in with previous working account.","已登录为之前的用户。"],["Please input the username!","请输入用户名！"],["Please input the password!","请输入密码！"],["Please input the new password!","请输入新密码！"],["Password confirmation does not match!","确认密码不相同！"],["Playlist","播放列表"],["Playlists","播放列表"],["New Playlist","新建播放列表"],["New Playlist ({0})","新播放列表（{0}）"],["Click to edit","点击编辑"],["(Empty)","（空）"],["Logging in","登录中"],["Loading","加载中"],["Oh no! Something just goes wrong:","发生错误："],["[Click here to retry]","[点击重试]"],["My Uploads","我的上传"],["Click here to select files to upload","点此选择文件并上传"],["or drag files to this zone...","或拖放文件到此处..."],["Comments","评论"],["Copy link","复制链接"],["Remove","移除"],["Remove {0} tracks","移除 {0} 首歌曲"],["List ID","列表 ID"],["Track ID","歌曲 ID"],["Name","名称"],["Artist","艺术家"],["Album","专辑"],["Album artist","专辑艺术家"],["Duration","时长"],["Size","大小"],["Search","搜索"],["Discussion","灌水区"],["Notes","便签"],["Submit","提交"],["Submitting","提交中"],["Download","下载"],["Convert","转换"],["Converting \\"{0}\\"...","正在转换 \\"{0}\\"..."],["Error converting \\"{0}\\".","转换 \\"{0}\\" 时发生错误."],["Edit","编辑"],["Details","详细信息"],["Discard","放弃更改"],["Lyrics View","歌词视图"],["Source View","源码视图"],["Failed to switch view.","切换视图失败。"],["Done","完成"],["Save","保存"],["Saving...","保存中..."],["Error","错误"],["User {0}","用户 {0}"],["You\'ve logged in as \\"{0}\\".","你已登录为 \\"{0}\\"。"],["Switch user","切换用户"],["Logout","注销"],["Logging out...","正在注销..."],["Failed to create playlist \\"{0}\\".","创建播放列表 \\"{0}\\" 失败。"],["Failed to sync playlist \\"{0}\\".","同步播放列表 \\"{0}\\" 失败。"],["Login to create playlists.","登录以创建播放列表。"],["Failed to login.","登录失败。"],["Failed to upload file \\"{0}\\".","上传文件 \\"{0}\\" 失败。"],["Failed to remove track.","移除歌曲失败。"],["Failed to logout.","注销失败。"],["Player error:","播放器错误："],["Unknown error.","未知错误。"],["Retry after {0} sec...","{0} 秒后重试..."],["Removing of a uploading track is currently not supported.","目前不支持移除上传中的歌曲。"],["Changing password...","正在更改密码..."],["Failed to change password.","更改密码失败。"],["Password changed successfully.","已成功更改密码。"],["Server: ","服务器："],["Volume","音量"],["(Scroll whell or drag to adjust volume)","（滚动滚轮或拖动调整音量）"],["Warning","警告"],["Are you sure to delete the track permanently?","确定要永久删除此歌曲吗？"],["Are you sure to delete {0} tracks permanently?","确定要永久删除 {0} 首歌曲吗？"],["Question","询问"],["Did you mean to upload 1 file?","是否要上传 1 个文件？"],["Did you mean to upload {0} files?","是否要上传 {0} 个文件？"],["Refresh","刷新"],["Select","选择"],["Select all","全选"],["Cancel","取消"],["Settings","设置"],["UI theme: {0}","界面主题：{0}"],["Preferred bitrate (0: original file)","首选码率（0：原始文件）"],["Enable notification","启用通知"],["Disable notification","禁用通知"],["Now Playing","正在播放"],["Lyrics","歌词"],["Edit Lyrics","编辑歌词"],["Error parsing lyrics","歌词解析错误"],["No lyrics","无歌词"],["Source code","源代码"],["Client updated:\\\\n{0}\\\\n  =>\\\\n{1}","客户端已更新:\\\\n{0}\\\\n  =>\\\\n{1}"],["[Unknown version]","[未知版本]"],["About","关于"],["Build Date","编译时间"],["This project is {0} under MIT license.","此项目以 MIT 协议 {0}。"],["This project is based on {0}.","此项目基于 {0}。"],["open-sourced","开源"],["Recent changes:","最近更改:"],["Music Cloud","Music Cloud"]],[["_key_","en","zh"],["uploads_pending","Pending","队列中"],["uploads_uploading","Uploading","上传中"],["uploads_processing","Processing","处理中"],["uploads_error","Error","错误"],["uploads_done","Done","完成"],["prev_track","Prev","上一首"],["next_track","Next","下一首"],["loopmode_list-seq","List-seq","顺序播放"],["loopmode_list-loop","List-loop","列表循环"],["loopmode_list-shuffle","List-shuffle","乱序播放"],["loopmode_track-loop","Track-loop","单曲循环"],["msgbox_no","No","否"],["msgbox_yes","Yes","是"],["msgbox_ok","OK","确定"],["msgbox_cancel","Cancel","取消"],["colortheme_light","light","亮色"],["colortheme_dark","dark","暗色"],["colortheme_light-rounded","light rounded","圆角亮色"],["colortheme_dark-rounded","dark rounded","圆角暗色"],["visibility_0","Private","私有"],["visibility_1","Public","公开"],["my_visibility_0","My private","我的私有"],["my_visibility_1","My public","我的公开"],["make_it_visibility_0","Make it private","转为私有"],["make_it_visibility_1","Make it public","转为公开"],["make_{0}_visibility_0","Make {0} items private","转换 {0} 个项目为私有"],["make_{0}_visibility_1","Make {0} items public","转换 {0} 个项目为公开"]]]');const b=createArrayBuilder(d);f.forEach((t=>d.add2dArray(t)));const y={apiBaseUrl:"https://mc.yuuza.net/api/",debug:!0,apiDebugDelay:0,showDownloadOptions:!1,showDiscussion:!1,showNotes:!1};const x=new class{constructor(){this.appBaseUrl=function getAppBaseUrl(){var t=window.location.href,e=t.indexOf("?");if(e>=0)return t.substring(0,e);var i=t.indexOf("#");return i>=0?t.substring(0,i):t}(),this.storageUrlBase="",this.debugSleep=y.debug?y.apiDebugDelay:0,this.defaultAuth=null,this.onTrackInfoChanged=new a,this.onTrackDeleted=new a}get baseUrl(){return y.apiBaseUrl}_fetch(t,e){return __awaiter(this,void 0,void 0,(function*(){return this.debugSleep&&(yield sleepAsync(this.debugSleep*(Math.random()+1))),yield fetch(t,Object.assign({credentials:"same-origin"},e))}))}getHeaders(t){var e,i={},n=null!==(e=(t=t||{}).auth)&&void 0!==e?e:this.defaultAuth;return n&&(i.Authorization=n),1!=t.cache&&(i["Cache-Control"]="no-store"),i}get(t,e){return __awaiter(this,void 0,void 0,(function*(){e=e||{};var i=yield this._fetch(this.baseUrl+t,{headers:Object.assign({},this.getHeaders(e))});return yield this.checkResp(e,i),yield i.json()}))}post(t){var e;return __awaiter(this,void 0,void 0,(function*(){var i=t.obj;if(void 0===t.mode&&(t.mode=void 0!==i?"json":"empty"),"json"===t.mode)i=void 0!==i?JSON.stringify(i):void 0;else if("raw"===t.mode);else{if("empty"!==t.mode)throw new Error("Unknown arg.mode");i=null}var n=this.getHeaders(t);"json"===t.mode&&(n["Content-Type"]="application/json"),n=Object.assign(Object.assign({},n),t.headers);var s=yield this._fetch(this.baseUrl+t.path,{body:i,method:null!==(e=t.method)&&void 0!==e?e:"POST",headers:n});yield this.checkResp(t,s);var r=s.headers.get("Content-Type");return r&&/^application\/json;?/.test(r)?yield s.json():null}))}put(t){return this.post(Object.assign(Object.assign({},t),{method:"PUT"}))}delete(t){return this.post(Object.assign(Object.assign({},t),{method:"DELETE"}))}upload(t){const e=t.cancelToken;if(e)var i=e.onCancelled.add((function(){n.abort()}));const n=new XMLHttpRequest,s=new Promise(((t,e)=>{n.onload=e=>t(),n.onerror=t=>e("XHR error"),n.onabort=t=>e("XHR abort")}));n.upload.onprogress=t.onprogerss||null,n.open(t.method,this.processUrl(t.url)),t.auth&&n.setRequestHeader("Authorization",t.auth),t.contentType&&n.setRequestHeader("Content-Type",t.contentType),n.send(t.body);const r=function(t){return __awaiter(this,void 0,void 0,(function*(){try{yield s}finally{e&&(e.onCancelled.remove(i),e.throwIfCancelled())}if(n.status<200||n.status>=300)throw new Error("HTTP status "+n.status);return n}))}();return{xhr:n,complete:r}}checkResp(t,e){return __awaiter(this,void 0,void 0,(function*(){if(!1!==t.status&&(void 0!==t.status&&e.status!=t.status||e.status>=400)){if(450===e.status){try{var i=(yield e.json()).error}catch(t){}if(i)throw new Error(i)}throw new Error("HTTP status "+e.status)}}))}getListAsync(t){return __awaiter(this,void 0,void 0,(function*(){return yield this.get("lists/"+t)}))}getListIndexAsync(){return __awaiter(this,void 0,void 0,(function*(){return yield this.get("lists/index")}))}putListAsync(t,e=!1){return __awaiter(this,void 0,void 0,(function*(){return yield this.post({path:"lists/"+t.id,method:e?"POST":"PUT",obj:t})}))}getTrack(t){return this.get("tracks/"+t)}getList(t){return this.get("lists/"+t)}processUrl(t){return t.match("^(https?:/)?/")?t:this.storageUrlBase&&t.startsWith("storage/")?this.storageUrlBase+t.substr(8):this.baseUrl+t}},k=new class PlayerCore{constructor(){this.track=null,this.trackProfile=null,this.audioLoaded=!1,this.objectUrl=null,this.onTrackChanged=new a,this.siPlayer=new SettingItem("mcloud-player","json",{loopMode:"list-loop",volume:1,preferBitrate:256}),this.onLoopModeChanged=new a,this._state="none",this.onStateChanged=new a,this._loadRetryCount=0,this._loadRetryTimer=new Timer((()=>{this.play()})),this.onProgressChanged=new a,this.onVolumeChanged=new a}get loopMode(){return this.siPlayer.data.loopMode}set loopMode(t){this.siPlayer.data.loopMode=t,this.siPlayer.save(),this.onLoopModeChanged.invoke()}get preferBitrate(){return this.siPlayer.data.preferBitrate}get state(){return this._state}set state(t){t!==this._state&&(console.info(`[PlayerCore] state '${this._state}' -> '${t}'`),this._state=t,this.onStateChanged.invoke())}get currentTime(){var t;return null===(t=this.audio)||void 0===t?void 0:t.currentTime}set currentTime(t){this.audio.currentTime=t}get duration(){var t;return this.audio&&this.audioLoaded&&this.audio.readyState>=HTMLMediaElement.HAVE_METADATA?this.audio.duration:null===(t=this.track)||void 0===t?void 0:t.length}get volume(){var t,e;return null!==(e=null===(t=this.audio)||void 0===t?void 0:t.volume)&&void 0!==e?e:1}set volume(t){this.audio.volume=t,t!==this.siPlayer.data.volume&&(this.siPlayer.data.volume=t,this.siPlayer.save())}get playbackRate(){return this.audio.playbackRate}get isPlaying(){return!!this.audio.duration&&!this.audio.paused}get isPaused(){return this.audio.paused}get canPlay(){return this.audio.readyState>=2}init(){var t=new SettingItem("mcloud-loop","str",null);null!==t.data&&(this.loopMode=t.data,t.remove()),this.audio=document.createElement("audio"),this.audio.crossOrigin="anonymous",this.audio.addEventListener("timeupdate",(()=>this.onProgressChanged.invoke())),this.audio.addEventListener("canplay",(()=>{this._loadRetryCount=0,this.onProgressChanged.invoke()})),this.audio.addEventListener("seeking",(()=>{this.audio.paused||(this.state="stalled")})),this.audio.addEventListener("stalled",(()=>{this.audio.paused||(this.state="stalled")})),this.audio.addEventListener("play",(()=>{this.state="stalled"})),this.audio.addEventListener("playing",(()=>{this.state="playing"})),this.audio.addEventListener("pause",(()=>{this.state="paused"})),this.audio.addEventListener("error",(t=>{console.error("[PlayerCore] audio error",t);var e="paused"!==this.state&&"stalled"!==this.state;if(this.state="paused",this.audioLoaded=!1,this.track&&this.track.url){let i=h`Player error:`+"\n"+(t.message||h`Unknown error.`);e&&this._loadRetryCount++<3&&(i+="\n"+h`Retry after ${3} sec...`,this._loadRetryTimer.timeout(3e3)),Toast.show(i,3e3),!H.isVisible()&&H.notification.isEnabledFor("nowPlaying")&&H.notification.show(h`Music Cloud`,{body:i,requireInteraction:!1})}})),this.audio.addEventListener("ended",(()=>{this.next()})),this.audio.addEventListener("volumechange",(()=>this.onVolumeChanged.invoke())),this.audio.volume=this.siPlayer.data.volume}prev(){return this.next(-1)}next(t){var e=this.getNextTrack(t);e?this.playTrack(e,!0):this.setTrack(null)}getNextTrack(t){var e,i,n;return null===(n=null===(i=null===(e=this.track)||void 0===e?void 0:e._bind)||void 0===i?void 0:i.list)||void 0===n?void 0:n.getNextTrack(this.track,this.loopMode,t)}loadUrl(t){this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null),this.audioLoaded=!!t,t?(t instanceof Blob&&(t=this.objectUrl=URL.createObjectURL(t)),this.audio.src=t):(this.audio.pause(),this.audio.removeAttribute("src")),this.audio.load()}setTrack(t,e=!1){return __awaiter(this,void 0,void 0,(function*(){console.info("[PlayerCore] set track: "+(t?`id ${t.id}: ${t.name} - ${t.artist}`:"(null)"));var i=this.track;this.track=t,this._loadRetryTimer.tryCancel(),i===t||(null==i?void 0:i.url)===(null==t?void 0:t.url)||(null==t?void 0:t.blob)&&t.blob===(null==i?void 0:i.blob)||(e&&t?yield this.loadTrack(t):this.loadUrl(null),this.state=t?e?"stalled":"paused":"none"),this.onTrackChanged.invoke(),this.onProgressChanged.invoke(),e&&t&&(yield this.playTrack(t))}))}playTrack(t,e){return __awaiter(this,void 0,void 0,(function*(){t===this.track?(e&&(this.audio.currentTime=0),yield this.play()):yield this.setTrack(t,!0)}))}loadTrack(t){var e;return __awaiter(this,void 0,void 0,(function*(){null===(e=this._loadct)||void 0===e||e.cancel();var i=this._loadct=new CancelToken;if(t.blob)this.loadUrl(null),i.throwIfCancelled(),this.trackProfile=null,this.loadUrl(t.blob);else{let e={profile:"",bitrate:0,size:t.size};var n=this.preferBitrate;let s;n&&t.files&&t.files.forEach((t=>{(!e.bitrate||Math.abs(e.bitrate-n)>Math.abs(t.bitrate-n))&&(e=t)})),-1==e.size?(this.loadUrl(null),s=yield t.requestFileUrl(e),i.throwIfCancelled()):s=yield t.requestFileUrl(e),this.trackProfile=e,this.loadUrl(x.processUrl(s))}}))}play(){return __awaiter(this,void 0,void 0,(function*(){yield this.ensureLoaded();try{this.audio.play()}catch(t){console.error("audio.play() error",t),this.state="none"}}))}ensureLoaded(){return __awaiter(this,void 0,void 0,(function*(){var t=this.track;t&&!this.audioLoaded&&(yield this.loadTrack(t))}))}pause(){this.audio.pause()}},C=["list-seq","list-loop","list-shuffle","track-loop"];if(navigator.mediaSession){let t=navigator.mediaSession;k.onTrackChanged.add((()=>{try{var e=k.track;if(!e)return;t.metadata=new MediaMetadata({title:null==e?void 0:e.name,artist:null==e?void 0:e.artist})}catch(t){}})),k.onStateChanged.add((()=>{try{t.playbackState="playing"===k.state||"stalled"===k.state?"playing":"none"===k.state?"none":"paused"}catch(t){}})),t.setActionHandler("play",(()=>k.play())),t.setActionHandler("pause",(()=>k.pause())),t.setActionHandler("previoustrack",(()=>k.prev())),t.setActionHandler("nexttrack",(()=>k.next()))}window.addEventListener("beforeunload",(t=>{if(k.track&&!k.audio.paused)return t.preventDefault(),t.returnValue="The player is running. Are you sure to leave?"}));var V={version:"1.0.10",buildDate:"2021-10-20T22:46:07.694Z",commits:[{id:"4def2e7",date:"2021-08-16T21:39:35+08:00",message:"Merge remote-tracking branch 'upstream/dev' into carbox"},{id:"898d37b",date:"2021-08-08T11:13:57+08:00",message:"fix theme"},{id:"2233a52",date:"2021-08-08T06:54:03+08:00",message:"hide dev features by default"},{id:"84c666e",date:"2021-08-02T21:26:26+08:00",message:"add rounded theme setting into UI"},{id:"ee0bea5",date:"2021-08-01T04:24:16+08:00",message:"style: pointer cursor on lyrics spans and trackinfo"},{id:"64842eb",date:"2021-08-01T04:23:32+08:00",message:"update deps"},{id:"77a15eb",date:"2021-07-28T18:52:22+08:00",message:"Merge branch 'dev' into carbox"},{id:"fdd964f",date:"2021-07-28T18:35:17+08:00",message:"update readme"},{id:"948b6a3",date:"2021-07-24T03:08:08+08:00",message:"update webfx"},{id:"4cb6600",date:"2021-07-24T03:07:33+08:00",message:"style: relocate comment-editor sumbit button"},{id:"0f57a55",date:"2021-07-24T03:05:19+08:00",message:"fix i18n hot updating on some views"},{id:"aa8f612",date:"2021-07-24T03:00:07+08:00",message:"get rid of webfx warnings"},{id:"c07b5d0",date:"2021-07-24T02:59:50+08:00",message:'fix sidebar not hiding after clicking "Notes"'},{id:"ebef4e3",date:"2021-07-24T01:15:21+08:00",message:"style updates"},{id:"22f1aac",date:"2021-07-23T17:43:15+08:00",message:"update deps"},{id:"7967ae2",date:"2021-07-23T17:43:05+08:00",message:"style: rounded corners"},{id:"71b846a",date:"2021-07-05T23:27:51+08:00",message:"wip: ListenTogether"},{id:"474704a",date:"2021-07-05T22:37:33+08:00",message:'update the "Playlists" section title as well'},{id:"d37a6a7",date:"2021-07-05T22:33:31+08:00",message:"update deps"},{id:"eac390e",date:"2021-07-05T22:17:51+08:00",message:"refine language changing"}]};const L=new class{constructor(){this.siVersion=new SettingItem("mcloud-ver","str",""),this.currentVersion=V.version,this.currentDate=V.buildDate,this.prevDate="",this.versionChanged=!1}init(){this.prevDate=this.siVersion.data,this.versionChanged=!!this.prevDate&&this.prevDate!=this.currentDate,this.siVersion.set(this.currentDate)}showUpdatedToast(){if(this.versionChanged){const[t,e]=[this.prevDate,this.currentDate].map((t=>t?new Date(t).toLocaleString(H.lang.curLang):h`[Unknown version]`));Toast.show(h`Client updated:\n${t}\n  =>\n${e}`,5e3)}}};L.init();const I=new class PlayerFX{get webAudioInited(){return!!this.ctx}init(){}initWebAudio(){this.webAudioInited||(this.ctx=new AudioContext,this.source=this.ctx.createMediaElementSource(k.audio),function chainNodes(t,e){let i=t;for(let t of e)("function"!=typeof t||(t=t(),t))&&(i.connect(t),i=t)}(this.source,[()=>(this.analyser=this.ctx.createAnalyser(),this.analyser.fftSize=8192,this.analyser),this.ctx.destination]))}showUI(t){this.initWebAudio(),(new FXDialog).show(t)}},T=800,_=600;class FXDialog extends Dialog{constructor(){super(),this.canvas=new View({tag:"canvas",height:_,width:T}),this.width="830px",this.addContent(this.canvas),this.overlay.setFlags({clickThrough:!0})}postCreateDom(){super.postCreateDom();const t=this.canvas.dom.getContext("2d"),e=t.createImageData(T,_),i=e.data,n=[];console.info(n);const update=()=>{if(!this.shown)return;requestAnimationFrame(update);const s=I.analyser,r=new Uint8Array(T);s.getByteFrequencyData(r),n.unshift(r),n.length>_&&n.pop();const o=i;for(let t=0;t<n.length;t++)for(let e=0;e<T;e++){const i=n[t][e],s=4*(e+T*(_-t-1));o[s+0]=o[s+1]=o[s+2]=i,o[s+3]=255}t.putImageData(e,0,0)};requestAnimationFrame(update)}}const S=new class{openUI(t){this.dialog||(this.dialog=new SettingsDialog),this.dialog.center(),this.dialog.show(t)}};class SettingsDialog extends Dialog{constructor(){super(),this.btnSwitchTheme=new ButtonView({type:"big"}),this.btnSwitchLang=new ButtonView({type:"big"}),this.inputPreferBitrate=new LabeledInput,this.btnNotification=new ButtonView({type:"big"}),this.addContent(this.btnSwitchTheme),this.btnSwitchTheme.onActive.add((()=>{const t=(H.theme.all.indexOf(H.theme.current)+1)%H.theme.all.length;H.theme.set(H.theme.all[t]),this.updateDom()})),this.addContent(this.btnSwitchLang),this.btnSwitchLang.onActive.add((()=>{H.lang.curLang;var t=H.lang.siLang.data,e=["",...H.lang.availableLangs];t=e[(e.indexOf(t)+1)%e.length],H.lang.siLang.set(t)})),this.addContent(this.inputPreferBitrate),this.onShown.add((()=>{var t;this.inputPreferBitrate.value=(null!==(t=k.siPlayer.data.preferBitrate)&&void 0!==t?t:"0").toString()})),this.onClose.add((()=>{var t=parseInt(this.inputPreferBitrate.value);isNaN(t)||(k.siPlayer.data.preferBitrate=t,k.siPlayer.save())})),this.addContent(this.btnNotification),this.btnNotification.onActive.add((()=>{H.notification.setEnable(!H.notification.config.enabled).then((()=>this.updateDom()))}));const t=new View(i("div",null,i(ButtonView,{onActive:t=>{I.showUI(t)}},"Test: Player FX")));t.hidden=!0;let e=0;this.addContent(t),this.addContent(i("div",{style:"margin: 5px 0; display: flex; flex-wrap: wrap; justify-content: space-between;"},i("div",{onclick:()=>{5==++e&&(t.hidden=!1)}},"MusicCloud "+L.currentVersion),i(TextBtn,{onActive:t=>{(new AboutDialog).show(t),this.close()}},(()=>h`About`))))}updateDom(){this.title=h`Settings`,this.btnClose.updateWith({text:h`Close`}),super.updateDom(),this.btnSwitchTheme.text=h`UI theme: ${d.get("colortheme_"+H.theme.current)}`,this.btnSwitchLang.text=h`Language: ${h`English`}`,H.lang.siLang.data||(this.btnSwitchLang.text+=h` (auto-detected)`),this.inputPreferBitrate.updateWith({label:h`Preferred bitrate (0: original file)`}),this.btnNotification.text=H.notification.config.enabled?h`Disable notification`:h`Enable notification`}}class AboutDialog extends Dialog{constructor(){super(),this.title=h`About`,this.width="500px",this.addContent(new View(i("div",null,i("h2",null,h`MusicCloud`+" "+L.currentVersion),i("p",null,L.currentDate?h`Build Date`+": "+new Date(L.currentDate).toLocaleString(H.lang.curLang):""),i("p",null,b`This project is ${i("a",{href:"https://github.com/lideming/MusicCloud",class:"clickable",target:"_blank"},(()=>h`open-sourced`))} under MIT license.`),i("p",null,b`This project is based on ${i("a",{href:"https://github.com/lideming/webfx",class:"clickable",target:"_blank"},"webfx")}.`),i("h3",null,h`Recent changes:`),i("div",{style:"max-height: 300px; overflow-y: auto;"},i("table",null,i("tr",null,i("th",null,"Id"),i("th",null,"Message")),V.commits.map((t=>i("tr",null,i("td",null,i("a",{href:`https://github.com/lideming/MusicCloud/commit/${t.id}`,target:"_blank"},i("code",null,t.id))),i("td",null,t.message)))))))))}}class Sidebar extends View{constructor(){super(...arguments),this.header=new View(i("div",{id:"sidebar-header"},i(SettingsBtn,null))),this.features=new ListView(i("div",{id:"sidebar-features"})),this.list=new View(i("div",{id:"sidebar-list"}))}createDom(){return i("nav",{id:"sidebar",class:"no-selection"},this.header,this.features,this.list)}}class SidebarItem extends ListViewItem{constructor(t){super(),this._text="",this.contentView=null,objectInit(this,t)}get text(){return getFuncVal(this._text)}set text(t){this._text=t}createDom(){return{tag:"li.item.no-selection",tabIndex:0,text:()=>getFuncVal(this.text)}}bindContentView(t){return this}}class SettingsBtn extends View{createDom(){return i("div",{class:"item",id:"settings-btn"},i(Icon,{icon:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24"><g><path d="M0,0h24v24H0V0z" fill="none"/><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></g></svg>'}))}postCreateDom(){super.postCreateDom(),this.onActive.add((t=>{S.openUI(t)}))}}class ContentView extends View{constructor(){super(...arguments),this._isVisible=!1,this._lastRenderedLanguage="",this._shownEvents=null}get isVisible(){return this._isVisible}onShow(){this._isVisible=!0,this.domCreated&&this._lastRenderedLanguage!=H.lang.curLang&&this.updateAll()}onDomInserted(){}updateDom(){super.updateDom(),this._lastRenderedLanguage=H.lang.curLang}onRemove(){var t;this._isVisible=!1,null===(t=this._shownEvents)||void 0===t||t.removeAll()}onDomRemoved(){}onSidebarItemReactived(){}get shownEvents(){return this._shownEvents?this._shownEvents:this._shownEvents=new EventRegistrations}}class ContentHeader extends View{constructor(t){super(),this.titleEditable=!1,this.actions=new ContainerView({tag:"div.actions"}),this.scrollbox=null,this.scrollboxScrollHandler=null,this.titleView=new View({tag:"span.title.no-selection",text:()=>getFuncVal(this.title),update:t=>{toggleClass(t,"editable",!!this.titleEditable),this.titleEditable?t.title=h`Click to edit`:t.removeAttribute("title"),t.tabIndex=this.titleEditable?0:-1}}),this.titlebar=new View({tag:"div.titlebar.clearfix",child:[{tag:"span.catalog.no-selection",text:()=>getFuncVal(this.catalog),hidden:()=>!this.catalog},this.titleView,this.actions]}),t&&objectInit(this,t),this.titleView.onActive.add((()=>__awaiter(this,void 0,void 0,(function*(){if(this.titleEditable&&(this.editHelper=this.editHelper||new EditableHelper(this.titleView.dom),!this.editHelper.editing)){var t=yield this.editHelper.startEditAsync();t!==this.editHelper.beforeEdit&&""!=t&&this.onTitleEdit(t),this.updateDom()}}))))}createDom(){return{tag:"div.content-header",child:[this.titlebar]}}bindScrollBox(t){this.scrollbox&&(this.scrollbox.removeEventListener("scroll",this.scrollboxScrollHandler),this.scrollboxScrollHandler=null),this.scrollbox=t,null==t||t.addEventListener("scroll",this.scrollboxScrollHandler=t=>{t.eventPhase==Event.AT_TARGET&&this.onScrollboxScroll()})}onScrollboxScroll(){var t,e;setScrollableShadow(this.dom,null!==(e=null===(t=this.scrollbox)||void 0===t?void 0:t.scrollTop)&&void 0!==e?e:0)}updateDom(){super.updateDom(),this.titlebar.updateDom(),this.titleView.updateDom()}}function getFuncVal(t){return"function"==typeof t?t():t}class ActionBtn extends TextView{get active(){return this.dom.classList.contains("active")}set active(t){this.toggleClass("active",t)}constructor(t){super(),objectInit(this,t)}createDom(){return{tag:"span.action.clickable.no-selection",tabIndex:0}}}function setScrollableShadow(t,e){t.style.boxShadow=`0 0 ${numLimit(2*Math.log(e),0,10)}px var(--color-light-shadow)`}class CopyMenuItem extends MenuItem{constructor(t){super(t),this.textView=null,this.onActive.add((()=>{this.dom.textContent="",this.textView||(this.textView=new InputView,this.addChild(this.textView),this.textView.value=this.textToCopy),this.textView.dom.select(),document.execCommand("copy")}))}}class Icon extends View{get icon(){return this.dom.innerHTML}set icon(t){this.dom.innerHTML=t}constructor(t){super({tag:"span.icon"}),objectInit(this,t)}}const D=new class{constructor(){this.routes=[],this.onNavCompleted=new a}init(){window.addEventListener("popstate",(t=>{this.navByLocation()})),this.navByLocation()}navByLocation(){var t=window.location.hash;this.nav(t?t.substr(1):"",!1)}addRoute(t){this.routes.push(t),t.sidebarItem&&t.sidebarItem().onActive.add((()=>{t.contentView&&t.contentView().isVisible?t.contentView().onSidebarItemReactived():this.nav([...t.path])}))}nav(t,e){"string"==typeof t&&(t=function parsePath(t){return t.split("/").map((t=>decodeURIComponent(t)))}(t));for(const e of this.routes)if(match(t,e)){e.contentView&&H.content.setCurrent(e.contentView()),e.sidebarItem&&H.sidebarList.setActive(e.sidebarItem()),e.onNav&&e.onNav({path:t,remaining:t.slice(e.path.length)});break}var i=t.map((t=>encodeURIComponent(t))).join("/");if(this.current=t,this.currentStr=i,void 0===e||e){const t=[{},i,"#"+i];"replace"==e?window.history.replaceState(...t):window.history.pushState(...t)}this.onNavCompleted.invoke({path:t})}};function match(t,e){var i=e.path;for(let e=0;e<i.length;e++)if(t[e]!==i[e])return!1;return!0}class ListContentView extends ContentView{constructor(){super(...arguments),this._scrollPos=0}get rendered(){return this.domCreated}get canMultiSelect(){return this._canMultiSelect}set canMultiSelect(t){this._canMultiSelect=t,this.selectBtn&&(this.selectBtn.hidden=!this.canMultiSelect),this.listView&&(this.listView.selectionHelper.ctrlForceSelect=this.canMultiSelect)}createDom(){return buildDOM({tag:"div.listcontentview"})}postCreateDom(){super.postCreateDom(),this.appendHeader(),this.appendScrollBox()}createHeader(){return new ContentHeader({title:this.title})}appendHeader(){this.header=this.createHeader(),this.header.actions.addView(this.refreshBtn=new ActionBtn({text:()=>h`Refresh`})),this.header.actions.addView(this.selectAllBtn=new ActionBtn({text:()=>h`Select all`})),this.header.actions.addView(this.selectBtn=new ActionBtn({text:()=>h`Select`})),this.selectBtn.onActive.add((()=>{this.listView.selectionHelper.enabled=!this.listView.selectionHelper.enabled})),this.selectAllBtn.onActive.add((()=>{this.listView.forEach((t=>this.listView.selectionHelper.toggleItemSelection(t,!0)))})),this.appendView(this.header)}appendScrollBox(){this.scrollBox=this.createScrollBox(),this.appendView(this.scrollBox),this.appendListView()}createScrollBox(){var t=new View({tag:"div.scrollbox"});return this.header.bindScrollBox(t.dom),t}appendListView(){this.listView=new LazyListView({tag:"ul.listview"}),this.listView.lazy=!0,this.listView.selectionHelper.onEnabledChanged.add((()=>{this.selectBtn.hidden=!this.canMultiSelect&&!this.listView.selectionHelper.enabled,this.selectBtn.text=this.listView.selectionHelper.enabled?()=>h`Cancel`:()=>h`Select`,this.selectAllBtn.hidden=!this.listView.selectionHelper.enabled}))(),this.listView.selectionHelper.ctrlForceSelect=this.canMultiSelect,this.listView.scrollBox=this.scrollBox.dom,this.scrollBox.appendView(this.listView)}onShow(){super.onShow(),this.ensureDom(),this.listView.unload()}onDomInserted(){super.onDomInserted(),this.listView.ensureLoaded(50),this.scrollBox&&this._scrollPos&&(this.listView.dom.style.minHeight=this._scrollPos+this.scrollBox.dom.offsetHeight+"px",this.scrollBox.dom.scrollTop=this._scrollPos),this.listView.slowlyLoad(-1,30,!0).then((()=>{this.listView.dom.style.minHeight=""})),this.header.onScrollboxScroll()}onRemove(){this.scrollBox&&(this._scrollPos=this.scrollBox.dom.scrollTop),this.listView.stopLoading(),super.onRemove()}useLoadingIndicator(t){t!==this.loadingIndicator&&(this.rendered&&(this.loadingIndicator&&this.loadingIndicator.dom.remove(),t&&this.insertLoadingIndicator(t)),this.loadingIndicator=t),this.updateView()}insertLoadingIndicator(t){this.scrollBox.dom.insertBefore(t.dom,this.listView.dom)}updateView(){this.rendered&&(0===this.listView.length?this.loadingIndicator||(this.emptyIndicator=this.emptyIndicator||new LoadingIndicator({state:"normal",content:h`(Empty)`}),this.useLoadingIndicator(this.emptyIndicator)):this.emptyIndicator&&this.loadingIndicator===this.emptyIndicator&&this.useLoadingIndicator(null))}loadingAction(t){return __awaiter(this,void 0,void 0,(function*(){var e=this.loadingIndicator||new LoadingIndicator;this.useLoadingIndicator(e);try{yield t()}catch(i){throw e.error(i,(()=>this.loadingAction(t))),i}this.useLoadingIndicator(null)}))}}function parse(t){var e=Date.now(),i=new Parser(t).parse();return console.log(`[Lyrics] parsed ${t.length} chars in ${Date.now()-e} ms`,i),i}class LookaheadBuffer{constructor(){this.consumed=0,this.buf=[]}consume(){var t=this.peek(0);return this.buf.shift(),this.consumed++,t}peek(t){for(void 0===t&&(t=0);this.buf.length<=t;)this.buf.push(this.provider());return this.buf[t]}}const E={["[".charCodeAt(0)]:1,["]".charCodeAt(0)]:2,["{".charCodeAt(0)]:3,["}".charCodeAt(0)]:4,["\r".charCodeAt(0)]:null,["\n".charCodeAt(0)]:6};class Lexer{constructor(t){this.buf=new LookaheadBuffer,this.cur=0,this.str=t,this.buf.provider=()=>this.read()}get len(){return this.str.length}toArray(){for(var t=0;7!==this.buf.peek(t).type;t++);return this.buf.buf.map((t=>t))}read(){var t=this.readCore();return this.lastToken=t,t}readCore(){var t=this.str,e=this.cur,i=this.cur;try{if(i===t.length)return new Token(7,"[eof]",i);for(;;){var n=t.charCodeAt(i),s=i++;if(!(n>=0))return new Token(7,"[eof]",s);const r=E[n];if(void 0!==r){if(null===r)continue;return new Token(r,n,s)}for(;(n=t.charCodeAt(i))>=0&&void 0===E[n];)i++;return new Token(5,t.substring(e,i),e)}}finally{this.cur=i}}peek(t){return this.buf.peek(t)}consume(){return this.buf.consume()}tryExpect(t,e){var i=this.peek(e);return i.type===t?i:null}tryExpectSeq(t){var e=0;for(const i of t)if(!this.tryExpect(i,e++))return!1;return!0}expect(t){var e=this.tryExpect(t);return e||this.error(`expected token type '${A[t]}'`),e}error(t){throw new Error((null!=t?t:"error")+" at "+this.peek())}tryExpectAndConsume(t){return this.tryExpect(t)&&this.consume()}expectAndConsume(t){return this.expect(t),this.consume()}}var A;!function(t){t[t.tagBegin=1]="tagBegin",t[t.tagEnd=2]="tagEnd",t[t.bracketBegin=3]="bracketBegin",t[t.bracketEnd=4]="bracketEnd",t[t.text=5]="text",t[t.lineFeed=6]="lineFeed",t[t.eof=7]="eof"}(A||(A={}));class Token{constructor(t,e,i){this.type=t,this.val="number"==typeof e?String.fromCharCode(e):e,this.pos=i}toString(){return`{${A[this.type]}|${this.val}}`}}class Parser{constructor(t){this.lines=[],this.bpm=null,this.offset=0,this.curTime=0,this.lang="",this.tlang="",this.haveReadLyrics=!1,this.lex=new Lexer(t),this.tokens=this.lex.buf}parse(){var t,e=this.lex;for(this.skipLineFeeds();7!==e.peek().type;)t=e.buf.consumed,this.parseLine(),this.haveReadLyrics||this.skipLineFeeds(),e.buf.consumed===t&&e.error("parseLine() doesn't consume tokens");return this.lines.sort(((t,e)=>t.orderTime-e.orderTime)),{lines:this.lines,lang:this.lang,translationLang:this.tlang,bpm:this.bpm}}parseLine(){var t,e=this.lex,i=null,n=[],s=[],r=null,o=null,a=null,l=null;const d=e.peek().pos;for(;;)if(e.tryExpectAndConsume(1)){let r,h=null;if(e.tryExpect(2))r={time:-1,beats:null,beatsDiv:null};else{if(!e.tryExpect(5))return void this.pushRawLine(i,d);h=e.expectAndConsume(5).val,r=this.parseTimestamp(h,null!=a&&a>=0?a:null!==(t=this.curTime)&&void 0!==t?t:0)}if(e.tryExpectSeq([2,3])){e.consume(),e.consume();let t=e.expectAndConsume(5).val;e.expectAndConsume(4),s.push(o={text:h||"",ruby:t,startTime:a,timeStamp:l}),l=null;continue}if(null!=r){e.expectAndConsume(2),o||null==i?(l&&s.push(o={text:"",ruby:null,startTime:a,timeStamp:l}),l=r,-1!=r.time&&(a=r.time,null===i&&(i=r.time))):n.push(r);continue}if(null===h)continue;if(h.startsWith("bpm:"))this.bpm=parseFloat(h.substr(4)),e.expectAndConsume(2);else if(h.startsWith("offset:"))this.offset=parseFloat(h.substr(7))/1e3,e.expectAndConsume(2);else if(h.startsWith("lang:")){let t=/^([\w\-]+)(\/([\w\-]+))?$/.exec(h.substr(5));t&&(this.lang=t[1],this.tlang=t[3]||""),e.expectAndConsume(2)}else{if(!o)return void this.pushRawLine(i,d);s.push(o={text:"["+h+"]",ruby:null,startTime:a,timeStamp:null}),e.tryExpect(2)&&e.consume()}}else{if(!e.tryExpect(5)){if(e.tryExpect(6)){if(e.consume(),s.length>0&&e.tryExpect(5)){let t=e.peek().val;t.startsWith("/")&&(r=t.substr(1),e.consume(),e.tryExpectAndConsume(7)||e.expectAndConsume(6))}break}if(e.tryExpect(7))break;return void this.pushRawLine(i,d)}{let t=e.consume().val;s.push(o={text:t,ruby:null,startTime:a,timeStamp:l}),l=null}}if(l&&(s.push(o={text:"",ruby:null,startTime:a,timeStamp:l}),l=null),0===s.length){if(!this.haveReadLyrics)return;s.push(o={text:"",ruby:null,startTime:null,timeStamp:null})}this.haveReadLyrics=!0,null!=a&&(this.curTime=a),this.lines.push({startTime:i,orderTime:null!=i?i:this.curTime,translation:r,spans:s,rawLine:null}),n.forEach((t=>{var e=t.time-i;this.lines.push({startTime:t.time,orderTime:t.time,translation:r,spans:s.map((t=>({text:t.text,ruby:t.ruby,startTime:t.startTime>=0?t.startTime+e:t.startTime,timeStamp:t.timeStamp?{time:t.timeStamp.time>=0?t.timeStamp.time+e:t.timeStamp.time,beats:t.timeStamp.beats,beatsDiv:t.timeStamp.beatsDiv}:null}))),rawLine:null})}))}skipLine(){for(;!this.lex.tryExpect(6)&&!this.lex.tryExpect(7);)this.lex.consume();this.lex.consume()}skipLineFeeds(){for(;this.lex.tryExpect(6);)this.lex.consume()}pushRawLine(t,e){this.skipLine(),this.lines.push({startTime:t,orderTime:null!=t?t:this.curTime,translation:null,spans:null,rawLine:this.lex.str.substring(e,this.lex.peek().pos)})}parseTimestamp(t,e){var i=/^((\d+)\:)?(\d+)(\.(\d+))?$/.exec(t);if(e||(e=0),i){let t=0;return i[2]&&(t+=60*parseInt(i[2])),i[3]&&(t+=parseInt(i[3])),i[4]&&(t+=parseFloat(i[4])),t+=this.offset,t<0&&(t=0),{time:t,beats:null,beatsDiv:null}}if(i=/^b([\d\.]+)?(\/(\d+))?$/.exec(t)){let t={time:60/this.bpm,beats:1,beatsDiv:1};return i[1]&&(t.beats=parseFloat(i[1]),t.time*=t.beats),i[3]&&(t.beatsDiv=parseInt(i[3]),t.time/=t.beatsDiv),t.time+=e,t}return null}}function serialize(t,e=!1){var i="",n=e&&(!!t.lang||null!=t.bpm);return t.lines.forEach((s=>{s.spans&&n&&(n=!1,t.lang&&(i+="[lang:"+t.lang,t.translationLang&&(i+="/"+t.translationLang),i+="]\n"),null!=t.bpm&&(i+="[bpm:"+t.bpm+"]\n"),i+="\n"),s.rawLine?i+=s.rawLine:s.spans&&(s.spans.forEach((t=>{if(t.timeStamp)if(e)null!=t.timeStamp.beats?(i+="[b",1!=t.timeStamp.beats&&(i+=t.timeStamp.beats),1!=t.timeStamp.beatsDiv&&(i+="/"+t.timeStamp.beatsDiv),i+="]"):-1===t.timeStamp.time?i+="[]":i+="["+t.timeStamp.time.toFixed(3)+"]";else{const e=t.timeStamp.time;if(-1===t.timeStamp.time);else{const t=padLeft(Math.floor(e/60),2,"0"),n=padLeft((e%60).toFixed(2),5,"0");i+=`[${t}:${n}]`}}e&&null!=t.ruby?i+="["+t.text+"]{"+t.ruby+"}":i+=t.text})),e&&s.translation&&(i+="\n/"+s.translation),i+="\n")})),i}function padLeft(t,e,i){for("number"==typeof t&&(t=t.toString());t.length<e;)t=i+t;return t}var P=Object.freeze({__proto__:null,parse:parse,Parser:Parser,serialize:serialize});class LyricsView extends View{constructor(){super(),this.lines=new ContainerView({tag:"div.lyrics"}),this.lyrics=null,this.hasVisibleLyrics=!1,this.track=null,this.curLine=new ItemActiveHelper,this.curTime=0,this.scrollingTarget=null,this.onSpanClick=new a,this.onFontSizeChanged=new a,this.onLyricsChanged=new a,this.scrollAnimator={view:this,duration:300,beginTime:-1,beginPos:0,lastPos:0,targetPos:0,rafHandle:-1,cancel(){this.rafHandle>=0&&(cancelAnimationFrame(this.rafHandle),this.rafHandle=-1)},scrollTo(t){this.targetPos=t,this.lastPos=this.beginPos=this.view.getCenterPos(),this.rafHandle<0&&this._startRaf(),this.beginTime=performance.now()},_rafCallback:null,_startRaf(){this._rafCallback||(this._rafCallback=t=>{this._render(t)?this.rafHandle=requestAnimationFrame(this._rafCallback):this.rafHandle=-1}),this.rafHandle=requestAnimationFrame(this._rafCallback)},_render(t){if(Math.abs(this.view.getCenterPos()-this.lastPos)>10)return!1;const e=numLimit((t-this.beginTime)/this.duration,0,1),i=this.beginPos+(this.targetPos-this.beginPos)*this._easeInOutQuad(e);return this.lastPos=i,this.view.setCenterPos(i),1!==e},_easeInOutQuad:t=>t<.5?2*t*t:(4-2*t)*t-1},this._posChanged=!1,this._fontSize=100,this.scrollPos=0,this._resize=()=>{this.resize()},this.timer=new Timer((()=>this.onProgressChanged())),this.lastChangedRealTime=0,this.onProgressChanged=()=>{if(this.isTrackPlaying()){var t=k.currentTime,e=Date.now();t!=this.curTime&&(this.lastChangedRealTime=e,this.setCurrentTime(t,"smooth")),e-this.lastChangedRealTime<250?this.timer.cancelFunc||this.timer.interval(30):this.timer.tryCancel()}},this.pauseScrollTime=null,this.setLyrics("")}createDom(){return{tag:"div.lyricsview",tabIndex:0,child:[this.lines]}}postCreateDom(){var t,e;function dist(t,e){var i=t.screenX-e.screenX,n=t.screenY-e.screenY;return Math.sqrt(i*i+n*n)}this.dom.addEventListener("touchstart",(i=>{i.touches.length>=2&&(i.preventDefault(),t=this.scale,e=dist(i.touches[0],i.touches[1]))})),this.dom.addEventListener("touchmove",(i=>{if(i.touches.length>=2){i.preventDefault();var n=dist(i.touches[0],i.touches[1]),s=numLimit(t*n/e,20,500);this.scale=s}})),this.dom.addEventListener("wheel",(t=>{if(t.ctrlKey&&t.deltaY){t.preventDefault();var e=this.scale+(t.deltaY>0?-20:20);e=numLimit(e,20,500),this.scale=e}})),this.dom.addEventListener("scroll",(t=>{this._posChanged||this.setScrollingPause(5e3),this._posChanged=!1}),{passive:!0})}setLyrics(t){let e,i="";try{e="string"==typeof t?parse(t):t}catch(t){console.error("[Lyrics] parsing error",t),i=h`Error parsing lyrics`,e=null}this.lyrics=e,this.hasVisibleLyrics=!1,this.curLine.set(null),this.lines.removeAllView(),(null==e?void 0:e.lang)?this.lines.dom.lang=e.lang:this.lines.dom.removeAttribute("lang");const n=Date.now();e&&e.lines.forEach((t=>{t.spans&&(this.lines.addView(new LineView(t,this)),this.hasVisibleLyrics=!0)})),this.hasVisibleLyrics||this.lines.addView(new LineView({orderTime:0,spans:[{text:i||h`No lyrics`}]},this)),console.log(`[LyricsView] rendered ${[this.lines.length]} lines in ${Date.now()-n} ms`),this.onLyricsChanged.invoke(),this.resize()}setCurrentTime(t,e){var i,n;if(this.hasVisibleLyrics){t>=0||(t=0),this.curTime=t;var s=this.curLine.current,r=this.getLineByTime(t,s),o=this.getLineByTime(t+5e-4*this.scrollAnimator.duration*k.playbackRate,r);null==r||r.setCurrentTime(t),this.curLine.set(r),e&&"smooth"!==e&&r&&(s!==r||"force"===e)?(this.scrollAnimator.cancel(),this.setCenterPos(r.dom.offsetTop+r.dom.offsetHeight/2)):"smooth"!==e||this.isScrollingPaused()||o===this.scrollingTarget||(this.scrollingTarget=o,this.scrollAnimator.duration=300/k.playbackRate,o?this.scrollAnimator.scrollTo(o.dom.offsetTop+o.dom.offsetHeight/2):this.scrollAnimator.scrollTo(null!==(n=null===(i=this.lines.get(0))||void 0===i?void 0:i.dom.offsetTop)&&void 0!==n?n:0))}}getCenterPos(){return this.dom.scrollTop+this.dom.offsetHeight/2}setCenterPos(t){var e=t-this.dom.offsetHeight/2;this.dom.scrollTop!=e&&(this._posChanged=!0,this.dom.scrollTop=e)}resize(){if(this.domCreated){const t=this.dom.offsetHeight,e=this.lines.dom.scrollHeight;this.lines.dom.style.margin=e>t/2?t/2+"px 0":(t-e)/2+"px 0"}this.isScrollingPaused()||this.centerLyrics()}get scale(){return this._fontSize}set scale(t){this._fontSize=t,this.lines.dom.style.fontSize=t+"%",this.onFontSizeChanged.invoke()}reset(){this.dom.scrollTop=this.scrollPos=0}onShow(){this.setCenterPos(this.scrollPos),this.isTrackPlaying()&&this.setCurrentTime(k.currentTime),requestAnimationFrame(this._resize),window.addEventListener("resize",this._resize)}onHide(){this.scrollPos=this.getCenterPos(),window.removeEventListener("resize",this._resize),this.timer.tryCancel()}centerLyrics(){"playing"===k.state&&this.isTrackPlaying()&&this.setCurrentTime(k.currentTime,"force")}isTrackPlaying(){return k.track&&k.track===this.track&&k.track.id===this.track.id}isScrollingPaused(){return!!(this.pauseScrollTime&&Date.now()<this.pauseScrollTime)}setScrollingPause(t){null==t?this.pauseScrollTime=null:(this.pauseScrollTime=Math.max(this.pauseScrollTime||0,Date.now()+t),this.scrollingTarget=null)}getLineByTime(t,e){var i;if(e&&t>=e.line.startTime){i=e;for(let n=e.position+1;n<this.lines.length;n++){let e=this.lines.get(n);if(null!=e.line.startTime){if(!(e.line.startTime<=t))break;i=e}}}else i=null,this.lines.forEach((e=>{null!=e.line.startTime&&e.line.startTime<=t&&(i=e)}));return i}}class LineView extends ContainerView{constructor(t,e){var i;if(super({tag:"p.line"}),this.currentIndex=0,this.line=t,this.lyricsView=e,this.line.spans.forEach((t=>{this.addView(new SpanView(t,this))})),this.line.translation){var n=null===(i=this.lyricsView)||void 0===i?void 0:i.lyrics,s=n&&(n.translationLang||n.lang);this.dom.appendChild(buildDOM({tag:"div.trans",lang:s,text:this.line.translation}))}}get spans(){return this.items}setCurrentTime(t){const e=this.items;let i=this.currentIndex;for(;;)if(i<e.length&&e[i].startTime<=t)e[i].toggleClass("active",!0),i++;else{if(!(i>0&&e[i-1].startTime>t))break;e[i-1].toggleClass("active",!1),i--}this.currentIndex=i}}class SpanView extends View{constructor(t,e){super(),this.span=t,this.lineView=e}get timeStamp(){return this.span.timeStamp}set timeStamp(t){this.span.timeStamp=t}get startTime(){return this.span.startTime}set startTime(t){this.span.startTime=t}get isNext(){return this.dom.classList.contains("next")}set isNext(t){this.toggleClass("next",t)}createDom(){var t=this.span;return buildDOM({tag:"span.span",child:t.ruby?{tag:"ruby",child:[t.text,{tag:"rp",text:"("},{tag:"rt",text:t.ruby},{tag:"rp",text:")"}]}:t.text})}postCreateDom(){var t,e;super.postCreateDom(),this.dom.addEventListener("mousedown",(i=>{t=i.offsetX,e=i.offsetY})),this.dom.addEventListener("click",(i=>{Math.abs(i.offsetX-t)<=3&&Math.abs(i.offsetY-e)<=3&&(i.preventDefault(),this.lineView.lyricsView.onSpanClick.invoke(this))}))}}const M=new class{startEdit(t,e){this.view||(this.sidebarItem=new SidebarItem({text:()=>h`Edit Lyrics`}),this.view=new LyricsEditContentView,H.sidebarList.addFeatureItem(this.sidebarItem),D.addRoute({path:["lyricsEdit"],contentView:()=>this.view,sidebarItem:()=>this.sidebarItem,onNav:()=>{this.sidebarItem.hidden=!1}})),this.view.setTrack(t,e),D.nav("lyricsEdit")}};class LyricsEditContentView extends ContentView{constructor(){super(),this.header=new ContentHeader({title:h`Edit Lyrics`}),this.lyricsView=new EditableLyricsView,this.sourceView=new LyricsSourceView,this.currentView=null,this._mode="lyrics",this.track=null,this.lyrics=null,this.originalLyrics=null,this.header.actions.addView(this.btnLyrics=new ActionBtn({text:h`Lyrics View`,onActive:()=>{this.setMode("lyrics")}})),this.header.actions.addView(this.btnSource=new ActionBtn({text:h`Source View`,onActive:()=>{this.setMode("source")}})),this.header.actions.addView(new ActionBtn({text:h`Discard`,onActive:()=>{this.lyrics=this.originalLyrics,this.close()}})),this.header.actions.addView(new ActionBtn({text:h`Done`,onActive:()=>{this.serializeLyricsFromView(),this.close()}}))}get mode(){return this._mode}set mode(t){this.setMode(t)}setMode(t,e){if(e||t!==this._mode){try{e||this.serializeLyricsFromView();var i=this.currentView;if("lyrics"===t){try{var n=parse(this.lyrics)}catch(t){throw new Error(h`Error parsing lyrics`)}this.lyricsView.setLyrics(n),i=this.lyricsView}else{if("source"!==t)throw new Error("unknown mode");this.sourceView.value=this.lyrics,i=this.sourceView}this.setCurrentView(i)}catch(t){return void Toast.show(h`Failed to switch view.`+"\n"+t,3e3)}this.btnLyrics.active="lyrics"===t,this.btnSource.active="source"===t,this._mode=t}}setCurrentView(t){this.currentView&&(this.currentView.onHide(),this.removeView(this.currentView),this.currentView=null),t&&(this.currentView=t,this.appendView(t),t.onShow())}serializeLyricsFromView(){if("lyrics"===this.mode)this.lyricsView.modified&&(this.lyrics=serialize(this.lyricsView.lyrics,!0));else{if("source"!==this.mode)throw new Error("unknown mode");this.lyrics=this.sourceView.value}}close(){M.sidebarItem.hidden=!0,window.history.back(),this.track.startEdit().inputLyrics.value=this.lyrics}createDom(){return{tag:"div.lyricsedit",child:[this.header]}}setTrack(t,e){this.track=t,this.originalLyrics=e,this.lyrics=e,this.lyricsView.reset(),this.lyricsView.track=t,this.sourceView.reset(),this.setMode(e?this.mode:"source",!0)}onShow(){this.ensureDom(),this.shownEvents.add(k.onProgressChanged,(()=>{this.currentView===this.lyricsView&&this.lyricsView.onProgressChanged()}))}onDomInserted(){var t;super.onDomInserted(),null===(t=this.currentView)||void 0===t||t.onShow()}onRemove(){var t;super.onRemove(),null===(t=this.currentView)||void 0===t||t.onHide()}}class EditableLyricsView extends LyricsView{constructor(){super(),this.nextSpans=[],this.modified=!1,this.onLyricsChanged.add((()=>{this.modified=!1,this.lines.forEach((t=>{var e;if(null===(e=t.spans)||void 0===e?void 0:e.length){let e=t.spans[0].span;e.timeStamp||(e.timeStamp={time:-1,beats:null,beatsDiv:null}),t.spans.forEach((t=>{t.timeStamp&&t.toggleClass("ts",!0)}))}})),this.nextSpans=[],this.setNextSpans(this.getSpans())})),this.onSpanClick.add((t=>{null!=t.span.startTime&&t.span.startTime>=0&&(k.currentTime=numLimit(t.span.startTime-3,0,1/0)),this.setNextSpans(this.getSpans(t,"here"))})),this.dom.addEventListener("keydown",(t=>{if("ArrowRight"==t.code||"KeyF"==t.code||"KeyD"==t.code){if(t.preventDefault(),this.nextSpans.length){const t=k.currentTime;this.nextSpans[0].timeStamp.time=t,this.nextSpans.forEach((e=>{e.startTime=t})),0===this.nextSpans[0].position&&(this.nextSpans[0].lineView.line.startTime=t),this.modified=!0}let e=this.getSpans(null,"forward");e.length&&this.setNextSpans(e)}else if("ArrowLeft"==t.code){t.preventDefault();let e=this.getSpans(null,"backward");e.length&&this.setNextSpans(e)}})),this.toggleClass("edit",!0)}getSpans(t,e){if(!t)if(this.nextSpans.length)t=this.nextSpans["backward"===e?0:this.nextSpans.length-1];else{if(!this.lines.length)return[];t=this.lines.get(0).spans[0]}var i=t.position,n=t.lineView;if(null==e||"here"===e)for(;n.spans&&!n.spans[i].timeStamp;)0==i--&&(i=(n=this.lines.get(n.position-1)).length-1);else if("forward"===e)do{n&&++i===n.length&&(n=this.lines.get(n.position+1),i=0)}while(n&&n.spans&&!n.spans[i].timeStamp);else if("backward"===e)do{n&&0==i--&&(i=(n=this.lines.get(n.position-1)).length-1)}while(n&&n.spans&&!n.spans[i].timeStamp);var s=[];if(n)do{s.push(n.spans[i]),i++}while(i<n.length&&!n.spans[i].timeStamp);return s}setNextSpans(t){for(;this.nextSpans.length;)this.nextSpans.pop().isNext=!1;t.forEach((t=>{t.isNext=!0,this.nextSpans.push(t)}))}}class LyricsSourceEditView extends InputView{get value(){return this.dom.value}set value(t){this.dom.value=t}createDom(){return{tag:"textarea.input-text"}}postCreateDom(){super.postCreateDom(),this.dom.addEventListener("keydown",(t=>{if(t.ctrlKey&&"r"===t.key){t.preventDefault();const e=this.dom.selectionStart,i=this.dom.selectionEnd,n=this.dom.value;this.dom.value=n.substring(0,e)+"["+n.substring(e,i)+"]{}"+n.substring(i);const s=e==i?e+1:i+3;this.dom.setSelectionRange(s,s)}}))}}class LyricsSourceView extends LyricsSourceEditView{constructor(){super(),this.scrollPos=0,this.dom.style.border="none",this.dom.style.height="100%",this.dom.style.padding="10px",this.dom.style.resize="none"}reset(){this.scrollPos=0}onShow(){this.dom.scrollTop=this.scrollPos}onHide(){this.scrollPos=this.dom.scrollTop}}class Track{constructor(t){this.infoObj=null,this.blob=null,this._bind=void 0,this._lyricsFetchTask=null,objectApply(this,t)}get id(){return this.infoObj.id}get owner(){return this.infoObj.owner}get name(){return this.infoObj.name}get artist(){return this.infoObj.artist}get url(){return this.infoObj.url}get files(){return this.infoObj.files}get length(){return this.infoObj.length}get size(){return this.infoObj.size}get lyrics(){return this.infoObj.lyrics}get visibility(){return this.infoObj.visibility}get displayName(){return this.artist+" - "+this.name}get canEdit(){return"admin"==z.role||z.info.id==this.owner}toString(){return`${h`Track ID`}: ${this.id}\r\n${h`Name`}: ${this.name}\r\n${h`Artist`}: ${this.artist}`}toApiTrack(){return this.infoObj}getExtensionName(){var t;return null===(t=/\.([\w\-_]{1,6})$/.exec(this.url))||void 0===t?void 0:t[1]}updateFromApiTrack(t){if(this.id!==t.id)throw new Error("Bad track id");this.infoObj=t}startEdit(t){var e=new TrackDialog;return e.setTrack(this),e.show(t),e}getFileUrl(t){return(null==t?void 0:t.profile)?-1!=t.size&&this.url+"."+t.profile:this.url}requestFileUrl(t){return __awaiter(this,void 0,void 0,(function*(){var e=this.getFileUrl(t);if(!1!==e)return e;var i=Toast.show(h`Converting "${this.displayName}"...`);try{return t.size=(yield x.post({path:`tracks/${this.id}/convert`,obj:{profile:t.profile}})).size,i.close(),this.getFileUrl(t)}catch(t){throw i.updateWith({text:h`Error converting "${this.displayName}".`+"\n"+t}),i.show(3e3),t}}))}isLyricsGotten(){return null!=this.lyrics}getLyrics(){return this.isLyricsGotten()?Promise.resolve(this.lyrics):this.id?(this._lyricsFetchTask||(this._lyricsFetchTask=(()=>__awaiter(this,void 0,void 0,(function*(){try{var t=yield x.get("tracks/"+this.id+"/lyrics");return this.infoObj.lyrics=t.lyrics,this.lyrics}catch(t){throw this._lyricsFetchTask=null,console.error(`[Track] id ${this.id} fetching lyrics error`,t),t}})))()),this._lyricsFetchTask):Promise.resolve("")}}class TrackDialog extends Dialog{constructor(){super(),this.inputName=new LabeledInput({label:h`Name`}),this.inputArtist=new LabeledInput({label:h`Artist`}),this.inputAlbum=new LabeledInput({label:h`Album`}),this.inputAlbumArtist=new LabeledInput({label:h`Album artist`}),this.inputLyrics=new LabeledInputWithLoading({label:h`Lyrics`}),this.btnSave=new TextBtn({text:h`Save`,right:!0}),this.btnEditLyrics=new TextBtn({text:h`Edit Lyrics`,right:!0}),this.autoFocus=this.inputName.input,this.width="500px",this.resizable=!0,this.contentFlex=!0,this.inputLyrics.input=new LyricsSourceEditView,this.inputLyrics.input.dom.style.resize="none",this.inputLyrics.dom.style.flex="1",this.inputLyrics.dominput.style.minHeight="3em",this.inputLyrics.dominput.style.height="6em",[this.inputName,this.inputArtist,this.inputAlbum,this.inputAlbumArtist,this.inputLyrics].forEach((t=>this.addContent(t))),this.addBtn(this.btnSave),this.btnSave.onActive.add((()=>this.save())),this.addBtn(this.btnEditLyrics),this.btnEditLyrics.onActive.add((()=>{this.close(),M.startEdit(this.track,this.inputLyrics.value)})),this.compositionWatcher=new TextCompositionWatcher(this.dom),this.dom.addEventListener("keydown",(t=>{!this.track.canEdit||this.compositionWatcher.isCompositing||"Enter"!==t.code||!t.ctrlKey&&t.target===this.inputLyrics.input.dom||(t.preventDefault(),this.save())}))}setTrack(t){var e,i;this.track=t,this.title=h`Track ID`+" "+t.id,t.canEdit||(this.title+=h` (read-only)`),this.btnSave.hidden=!t.canEdit,this.inputName.updateWith({value:t.name}),this.inputArtist.updateWith({value:t.artist}),this.inputAlbum.value=(null===(e=t.infoObj)||void 0===e?void 0:e.album)||"",this.inputAlbumArtist.value=(null===(i=t.infoObj)||void 0===i?void 0:i.albumArtist)||"",t.isLyricsGotten()?(this.inputLyrics.loaded=!0,this.inputLyrics.updateWith({value:t.lyrics})):(this.inputLyrics.loaded=!1,t.getLyrics().then((e=>{this.inputLyrics.loaded=!0,this.inputLyrics.updateWith({value:t.lyrics})}))),this.updateDom()}save(){var t;return __awaiter(this,void 0,void 0,(function*(){if(!this.btnSave.clickable)throw new Error("btnSave is not clickable.");this.btnSave.updateWith({clickable:!1,text:h`Saving...`});try{var e=yield x.put({path:"tracks/"+this.track.id,obj:{id:this.track.id,name:this.inputName.value,artist:this.inputArtist.value,album:this.inputAlbum.value,albumArtist:this.inputAlbumArtist.value,lyrics:this.inputLyrics.loaded?this.inputLyrics.value:void 0,version:null===(t=this.track.infoObj)||void 0===t?void 0:t.version}});if(e.error){if("track_changed"!=e.error)throw new Error("Unknown track update error");if(Toast.show(h`The track was changed from somewhere else.`,5e3),(e=e.track).id!=this.track.id)throw new Error("Bad ID in response");this.track.updateFromApiTrack(e),x.onTrackInfoChanged.invoke(e),this.setTrack(this.track)}else{if(e.id!=this.track.id)throw new Error("Bad ID in response");x.onTrackInfoChanged.invoke(e),this.close()}}catch(t){console.error("[Track] saving error",t),this.btnSave.updateWith({clickable:!1,text:h`Error`}),yield sleepAsync(3e3)}this.btnSave.updateWith({clickable:!0,text:h`Save`})}))}}class LabeledInputWithLoading extends LabeledInput{constructor(){super(...arguments),this.loadingIndicator=new LoadingIndicator}get loaded(){return this.loadingIndicator.hidden}set loaded(t){this.loadingIndicator.hidden=t,this.input.hidden=!t}postCreateDom(){super.postCreateDom(),this.appendView(this.loadingIndicator),this.loaded=!1}}const B=new class{constructor(){this.ws=null,this.loginState="",this.onConnected=new a,this.onLogin=new a,this.lastQueryId=0,this.queries={},this.events={},this.permEvents={}}get connected(){var t;return(null===(t=this.ws)||void 0===t?void 0:t.readyState)===WebSocket.OPEN}init(){z.onSwitchedUser.add((()=>{this.connected&&x.defaultAuth&&this.login(x.defaultAuth)})),this.onConnected.add((()=>{"logged"===z.state&&this.login(x.defaultAuth),this.listenPermEvents()})),this.connect()}listenPermEvents(){var t=[];for(const e in this.permEvents)this.permEvents.hasOwnProperty(e)&&(this.events[e]=this.permEvents[e],t.push(e));0!==t.length&&this.sendQuery({cmd:"listenEvent",events:t},null)}getUrl(){var t=x.baseUrl.match(/^(?:(https?:)?\/\/([\w\-\.:]+))?(\/)?(.*)$/);if(!t)throw new Error("cannot generate websocket URL");var[e,i,n,s,r]=t;return(i="https:"===(i=i||window.location.protocol)?"wss://":"ws://")+(n=n||window.location.host)+(r=s?"/"+r:window.location.pathname+r)+"ws"}connect(){this.ws=new WebSocket(this.getUrl()),this.ws.onopen=t=>{this.onConnected.invoke()},this.ws.onclose=t=>{console.warn("[MsgCli] ws close",{code:t.code,reason:t.reason}),this.ws=null,this.loginState="",this.events={};var e=this.queries;for(const t in e)if(e.hasOwnProperty(t))try{e[t]({queryId:+t,resp:"wsclose"})}catch(t){console.error("[MsgCli] error",t)}this.queries={},setTimeout((()=>{this.connect()}),1e4)},this.ws.onmessage=t=>{if("string"==typeof t.data){var e=JSON.parse(t.data);if(e.resp&&e.queryId)console.debug("[MsgCli] ws query answer",e),this.queries[e.queryId]&&(this.queries[e.queryId](e),delete this.queries[e.queryId]);else if("event"===e.cmd){var i=e.event;console.debug("[MsgCli] ws received event",e),this.events[i]?this.events[i](e.data):console.debug("[MsgCli] ws unknown event",e)}else console.debug("[MsgCli] ws unknown json",e)}else console.debug("[MsgCli] ws unknwon data",t.data)}}login(t){this.loginState="sent",this.sendQueryAsync({cmd:"login",token:t}).then((t=>{"ok"===t.resp?(console.info("[MsgCli] ws login ok"),this.loginState="done",this.onLogin.invoke()):(console.warn("[MsgCli] ws login result: ",t.resp),this.loginState="")}))}sendQuery(t,e){if(!this.connected)throw new Error("not connected");var i=++this.lastQueryId;const n=Object.assign({queryId:i},t);console.debug("[MsgCli] ws send",function printFilter(t){if(t.token)return Object.assign(Object.assign({},t),{token:"***"});return t}(n)),this.ws.send(JSON.stringify(n)),e&&(this.queries[i]=e)}sendQueryAsync(t){return new Promise((e=>{this.sendQuery(t,e)}))}listenEvent(t,e,i){var n,s;if("string"==typeof t&&(t={events:[t],remove:[]}),t.events=(null!==(n=t.events)&&void 0!==n?n:[]).filter((t=>!this.events[t])),t.remove=null!==(s=t.remove)&&void 0!==s?s:[],this.connected)this.sendQuery(Object.assign({cmd:"listenEvent"},t),null);else if(!i)throw new Error("not connected");for(const n of t.events)this.events[n]=e,i&&(this.permEvents[n]=e);for(const e of t.remove)delete this.events[e],delete this.permEvents[e]}};class TrackList{constructor(){this.info=null,this.id=null,this.tracks=[],this.tracksSuffled=null,this.fetching=null,this.posting=null,this.eventListening=!1,this.putDelaying=null,this.putInProgress=null}get apiid(){var t,e;return null!==(e=null===(t=this.info)||void 0===t?void 0:t.id)&&void 0!==e?e:null}get name(){var t,e;return null!==(e=null===(t=this.info)||void 0===t?void 0:t.name)&&void 0!==e?e:null}get version(){var t,e;return null!==(e=null===(t=this.info)||void 0===t?void 0:t.version)&&void 0!==e?e:null}get canEdit(){return z.info.id==this.info.owner}setLoadIndicator(t){this.loadIndicator=t,this.contentView&&this.contentView.useLoadingIndicator(t)}loadInfo(t){var e;this.id=t.id,this.info=objectApply(null!==(e=this.info)&&void 0!==e?e:{},t,["id","owner","name","version","visibility"]),this.info.id<0&&(this.info.id=0),this.updateCanEdit()}updateCanEdit(){this.contentView&&this.contentView.header.updateWith({titleEditable:this.canEdit})}loadApiId(t){this.loadInfo({id:t,owner:0,name:"",version:0,visibility:0})}loadFromGetResult(t){var e;this.loadInfo(t),this.onInfoChanged();const i=this;return this.listView&&(this.listView.lazy=!0),this.tracks||(this.tracks=[]),(new class extends DataUpdatingHelper{constructor(){super(...arguments),this.items=i.tracks}addItem(t,e){i.addTrack_NoUpdating(t,e)}updateItem(t,e){t.updateFromApiTrack(e)}removeItem(t){i.remove_NoUpdating(t)}}).updateOrRebuildAll(t.tracks),this.updateTracksState(),null===(e=this.contentView)||void 0===e||e.updateView(),this.listView&&this.listView.slowlyLoad(1,30),this}addTrack(t,e){var i,n=this.addTrack_NoUpdating(t,e);return void 0!==e&&e!==this.tracks.length-1&&this.updateTracksState(),null===(i=this.contentView)||void 0===i||i.updateView(),n}addTrack_NoUpdating(t,e){var i,n,s=new Track({infoObj:t,_bind:{list:this,position:this.tracks.length}});return arrayInsert(this.tracks,s,e),null===(i=this.tracksSuffled)||void 0===i||i.push(s),null===(n=this.contentView)||void 0===n||n.addItem(s,e,!1),s}loadEmpty(){var t;return null===(t=this.contentView)||void 0===t||t.updateView(),this.fetching=Promise.resolve()}fetch(t){var e;return t&&(this.fetching=null),this.fetching=null!==(e=this.fetching)&&void 0!==e?e:this.fetchImpl()}postToUser(){return this.posting=this.posting||this._post()}_post(){return __awaiter(this,void 0,void 0,(function*(){if(yield z.waitLogin(),this.apiid)throw new Error("cannot post: apiid exists");var t=this.getTrackListPutInfo(),e=yield x.post({path:"users/me/lists/new",obj:t});this.info.id=e.id}))}getTrackListPutInfo(){return Object.assign(Object.assign({},this.info),{trackids:this.fetching?this.tracks.map((t=>t.id)):void 0})}getRealId(){return __awaiter(this,void 0,void 0,(function*(){return this.apiid||(yield this.postToUser()),this.apiid}))}put(){if(this.putDelaying)return this.putDelaying;this.putDelaying=this.putCore()}putCore(){return __awaiter(this,void 0,void 0,(function*(){try{if(this.putInProgress&&(yield this.putInProgress),yield sleepAsync(10),yield z.waitLogin(!0),this.fetching&&(yield this.fetching),this.posting&&(yield this.posting),!this.apiid)throw new Error("cannot put: no apiid")}catch(t){this.putDelaying=null,console.error("[TrackList] pre-put error",t)}const t=this.info.version;try{[this.putInProgress,this.putDelaying]=[this.putDelaying,null];var e=this.getTrackListPutInfo();this.info.version++,yield x.put({path:"lists/"+this.apiid,obj:e})}catch(e){if(this.info.version=t,console.error("[TrackList] put error",this,e),!(e instanceof Error&&"list_changed"==e.message))throw Toast.show(h`Failed to sync playlist "${this.name}".`+"\n"+e,3e3),e;Toast.show(h`Failed to sync playlist "${this.name}": the list was changed by other client. Please refresh and try again.`+"\n"+e,3e3)}finally{this.putInProgress=null}}))}fetchImpl(){return __awaiter(this,void 0,void 0,(function*(){const t=new LoadingIndicator;this.setLoadIndicator(t);try{if(!this.apiid)throw new Error("Cannot fetch: no apiid");const t=yield x.getListAsync(this.apiid);this.loadFromGetResult(t),this.setLoadIndicator(null)}catch(e){throw t.error(e,(()=>this.fetch(!0))),e}this.eventListening||null==this.apiid||B.listenEvent("l-"+this.apiid,(t=>{console.info(t,this.version),"number"==typeof t.version&&t.version==this.version||this.fetch(!0)}),!0)}))}rename(t){return __awaiter(this,void 0,void 0,(function*(){this.info.name=t,this.onInfoChanged(),yield this.put()}))}onInfoChanged(){var t,e=this.name,i=null===(t=this.contentView)||void 0===t?void 0:t.header;i&&i.updateWith({title:e}),U.onInfoChanged(this.id,this.info)}createView(){return this.contentView=this.contentView||new TrackListView(this)}getNextTrack(t,e,i){var n,s,r,o,a,l;i=null!=i?i:1;var d=t._bind;if(!d)return null;var h=d.position;if((null==d?void 0:d.list)!==this)return null;if(this.listView&&(h=null!==(s=null!=h?h:null===(n=this.listView.find((e=>e.track===t)))||void 0===n?void 0:n.position)&&void 0!==s?s:null===(r=this.listView.find((e=>e.track.id===t.id)))||void 0===r?void 0:r.position),(null==(h=null!=h?h:this.tracks.indexOf(t))||h<0)&&(h=this.tracks.findIndex((e=>e.id===t.id))),null==h||h<0)return null;if("list-seq"===e)return null!==(o=this.tracks[h+i])&&void 0!==o?o:null;if("list-loop"===e)return null!==(a=this.tracks[mod(h+i,this.tracks.length)])&&void 0!==a?a:null;if("list-shuffle"===e){this.tracksSuffled||(this.tracksSuffled=this.tracks.slice(0),function shuffleArray(t){for(var e=t.length-1;e>0;e--){var i=Math.floor(Math.random()*(e+1)),n=t[e];t[e]=t[i],t[i]=n}}(this.tracksSuffled));var c=this.tracksSuffled;return(!(h=c.indexOf(t))||h<0)&&(h=c.findIndex((e=>e.id===t.id))),null!==(l=c[mod(h+i,c.length)])&&void 0!==l?l:null}return"track-loop"===e?t:(console.warn("[TrackList] unknown loopMode",e),null)}updateTracksFromListView(){this.updateTracksState(),this.put()}updateTracksState(){this.listView?this.tracks=this.listView.map((t=>(t.track._bind.position=t.position,t.updateDom(),t.track))):this.tracks.forEach(((t,e)=>t._bind.position=e))}updateTrackInfo(t,e){t.updateFromApiTrack(e),this.listView&&this.listView.get(t._bind.position).updateDom()}remove(t,e){var i;this.remove_NoUpdating(t),this.updateTracksState(),null===(i=this.contentView)||void 0===i||i.updateView(),(void 0===e||e)&&this.put()}remove_NoUpdating(t){var e,i=t._bind.position;null!=i&&(t._bind=void 0,this.tracks.splice(i,1),null===(e=this.tracksSuffled)||void 0===e||e.remove(t),this.listView&&this.listView.remove(i))}}class TrackListView extends ListContentView{constructor(t){super(),this.curPlaying=new ItemActiveHelper({funcSetActive:function(t,e){t.updateWith({playing:e})}}),this.trackActionHandler={},this.trackChanged=()=>{this.updateCurPlaying()},this.canMultiSelect=!0,this.list=t,this.trackActionHandler.onTrackRemove=t=>t.forEach((t=>this.list.remove(t.track))),this.trackActionHandler.canRemove=t=>this.list.canEdit}createHeader(){var t;return new ContentHeader({catalog:()=>h`Playlist`,title:null!==(t=this.list.name)&&void 0!==t?t:"",titleEditable:!!this.list.rename,onTitleEdit:t=>this.list.rename(t)})}appendHeader(){super.appendHeader(),this.refreshBtn.onActive.add((()=>{this.list.fetch(!0)}))}onShow(){super.onShow(),this.shownEvents.add(k.onTrackChanged,this.trackChanged),this.shownEvents.add(z.onSwitchedUser,(()=>{this.list.updateCanEdit()}))(),this.list.fetch(),this.trackChanged()}onRemove(){super.onRemove()}onSidebarItemReactived(){var t;null===(t=this.curPlaying.current)||void 0===t||t.dom.scrollIntoView({behavior:"smooth",block:"center"})}appendListView(){super.appendListView();var t=this.listView;t.dom.classList.add("tracklistview"),this.list.listView=t,t.dragging=!0,this.list.canEdit&&(t.moveByDragging=!0),t.onItemMoved=()=>this.list.updateTracksFromListView(),t.onItemClicked=t=>{t.track===k.track&&k.isPlaying?D.nav("nowplaying"):k.playTrack(t.track)},this.list.tracks.forEach((t=>this.addItem(t,void 0,!1))),this.list.loadIndicator&&this.useLoadingIndicator(this.list.loadIndicator),this.updateView()}addItem(t,e,i){var n=this.createViewItem(t);this.listView.add(n,e),this.updateCurPlaying(n),(null==i||i)&&this.updateView()}createViewItem(t){var e=new TrackViewItem(t);return e.actionHandler=this.trackActionHandler,e}updateCurPlaying(t){var e,i;const n=k.track;if(void 0===t)if(n){const t=(null===(e=n._bind)||void 0===e?void 0:e.list)===this.list&&null!=n._bind.position?this.listView.get(n._bind.position):null!==(i=n&&this.listView.find((t=>t.track===n)))&&void 0!==i?i:this.listView.find((t=>t.track.id===n.id));this.curPlaying.set(t)}else this.curPlaying.set(null);else if(n){const e=t.track;(e===n||!this.curPlaying.current&&e.id===n.id)&&this.curPlaying.set(t)}}}class TrackViewItem extends ListViewItem{constructor(t){super(),this.actionHandler=null,this.noPos=!1,this.playing=!1,this.onContextMenu=(t,e)=>{var i,n,s,r,o,a,l;e.preventDefault();var c=this.selected&&this.selectionHelper?this.selectionHelper.selectedItems:[this],u=new ContextMenu;if(1==c.length&&(t.track.id&&"none"!=z.state&&!1!==z.serverOptions.trackCommentsEnabled&&u.add(new MenuItem({text:h`Comments`,onActive:()=>{D.nav(["track-comments",t.track.id.toString()])}})),y.showDownloadOptions&&this.track.url)){var p=this.track.getExtensionName();p=p?p.toUpperCase()+", ":"";var m=formatFileSize(this.track.size),g=[...null!==(i=this.track.files)&&void 0!==i?i:[]];g.sort(((t,e)=>e.bitrate-t.bitrate)),g.find((t=>""===t.profile))||u.add(new MenuLinkItem({text:h`Download`+" ("+p+m+")",link:x.processUrl(this.track.url),download:this.track.artist+" - "+this.track.name+"."+p})),g.forEach((t=>{var e,i=null===(e=t.format)||void 0===e?void 0:e.toUpperCase(),n=this.track.getFileUrl(t);n?u.add(new MenuLinkItem({text:h`Download`+" ("+i+", "+t.bitrate+" Kbps)",link:x.processUrl(n),download:this.track.artist+" - "+this.track.name+"."+i})):this.track.canEdit&&u.add(new MenuItem({text:h`Convert`+" ("+i+", "+t.bitrate+" Kbps)",onActive:()=>{this.track.requestFileUrl(t)}}))}))}this.track.canEdit&&[0,1].forEach((t=>{var e=0;for(const i of c)i.track.visibility!=t&&e++;e&&u.add(new MenuItem({text:d.get(1==e?"make_it_visibility_"+t:"make_{0}_visibility_"+t,[e]),onActive:()=>{x.post({path:"tracks/visibility",obj:{trackids:c.map((t=>t.track.id)),visibility:t}}).then((e=>{c.forEach((e=>{e.track.infoObj.visibility=t,x.onTrackInfoChanged.invoke(e.track.infoObj)}))}))}}))})),1==c.length&&(1==this.track.visibility&&u.add(new CopyMenuItem({text:h`Copy link`,textToCopy:x.appBaseUrl+"#track/"+this.track.id})),u.add(new MenuItem({text:this.track.canEdit?h`Edit`:h`Details`,onActive:t=>this.track.startEdit(t)})),(null===(n=this.actionHandler)||void 0===n?void 0:n.onTrackRemove)&&0!=(null===(r=null===(s=this.actionHandler)||void 0===s?void 0:s.canRemove)||void 0===r?void 0:r.call(s,[this]))&&u.add(new MenuItem({text:h`Remove`,cls:"dangerous",onActive:()=>{var t,e;return null===(e=(t=this.actionHandler).onTrackRemove)||void 0===e?void 0:e.call(t,[this])}}))),(null===(o=this.actionHandler)||void 0===o?void 0:o.onTrackRemove)&&c.length>1&&0!=(null===(l=null===(a=this.actionHandler)||void 0===a?void 0:a.canRemove)||void 0===l?void 0:l.call(a,[...c]))&&u.add(new MenuItem({text:h`Remove ${c.length} tracks`,cls:"dangerous",onActive:()=>{var t,e;null===(e=(t=this.actionHandler).onTrackRemove)||void 0===e||e.call(t,[...c])}}));let v=h`Track ID`+": "+c.map((t=>t.track.id)).join(", ")+"\n"+h`Duration`+": "+formatTime(arraySum(c,(t=>t.track.length)))+"\n"+h`Size`+": "+formatFileSize(arraySum(c,(t=>t.track.size)));if(1==c.length){const t=this.track.owner==z.info.id?"my_":"";v+="\n"+d.get(t+"visibility_"+c[0].track.visibility)}u.add(new MenuInfoItem({text:v})),H.showContextMenuForItem(c,u,{ev:e})},this.track=t}get dragData(){return`${this.track.name} - ${this.track.artist}`}createDom(){return{tag:"li.item.trackitem.no-selection",tabIndex:0,child:[{tag:"span.pos",update:t=>{var e;this.playing?(clearChildren(t),t.appendChild(new Icon({icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M8 5v14l11-7z"/></svg>'}).dom)):this.noPos||(t.textContent=null!=(null===(e=this.track._bind)||void 0===e?void 0:e.position)?(this.track._bind.position+1).toString():""),t.hidden=this.noPos&&!this.playing}},{tag:"span.name",text:()=>this.track.name},{tag:"span.artist",text:()=>this.track.artist},{tag:"span.duration",text:()=>formatTime(this.track.length)}],draggable:!0,_item:this}}updateDom(){super.updateDom(),this.toggleClass("selected",!!this.selected)}}class UploadTrack extends Track{constructor(t){super(t),this._bind={list:F}}get canEdit(){return"done"===this._upload.state}setState(t){var e;this._upload.state=t,null===(e=this._upload.view)||void 0===e||e.updateDom()}}const F=new class extends TrackList{constructor(){super(...arguments),this.tracks=[],this.state=!1,this.inprogress=0,this.unreadError=!1,this.uploadSemaphore=new Semaphore({maxCount:2}),this.view=new class extends TrackListView{constructor(){super(...arguments),this.usage=new TextView({tag:"span.uploads-usage"})}appendHeader(){this.title=()=>h`My Uploads`,super.appendHeader(),this.uploadArea=new UploadArea({onfile:t=>F.uploadFile(t)}),this.header.appendView(this.uploadArea),this.trackActionHandler.canRemove=()=>!0,this.trackActionHandler.onTrackRemove=t=>{1===t.length?this.removeTrack(t[0]):(new MessageBox).setTitle(h`Warning`).addText(h`Are you sure to delete ${t.length} tracks permanently?`).addResultBtns(["cancel","ok"]).allowCloseWithResult("cancel").showAndWaitResult().then((e=>{"ok"===e&&t.forEach((t=>this.removeTrack(t,!0)))}))}}createHeader(){var t=new ContentHeader({title:this.title});return t.titlebar.appendView(this.usage),t}onShow(){super.onShow(),F.unreadError&&(F.unreadError=!1,F.updateSidebarItem())}appendListView(){super.appendListView(),F.state||F.fetch()}updateUsage(){var t=0,e=0;F.tracks.forEach((i=>{var n;null===(n=i.files)||void 0===n||n.forEach((i=>{var n,s;i.profile?e+=null!==(s=i.size)&&void 0!==s?s:0:t+=null!==(n=i.size)&&void 0!==n?n:0}))})),this.usage.text=t?`(${formatFileSize(t)} + ${formatFileSize(e)})`:""}updateView(){super.updateView(),this.updateUsage()}createViewItem(t){const e=new UploadViewItem(t);return e.actionHandler=this.trackActionHandler,e}removeTrack(t,e){return __awaiter(this,void 0,void 0,(function*(){const i=t.track;if("uploading"===i._upload.state||"pending"===i._upload.state)i._upload.state="cancelled",i._upload.cancelToken.cancel(),F.remove(i);else if("error"===i._upload.state)F.remove(i);else{if("done"!==i._upload.state)return void console.error("[Uploads] Unexpected track._upload.state",i._upload.state);if(!e&&"ok"!==(yield(new MessageBox).setTitle(h`Warning`).addText(h`Are you sure to delete the track permanently?`).addResultBtns(["cancel","ok"]).allowCloseWithResult("cancel").showAndWaitResult()))return;try{yield x.delete({path:"tracks/"+i.id})}catch(t){return void Toast.show(h`Failed to remove track.`+"\n"+t)}x.onTrackDeleted.invoke(i)}}))}}(this)}get canEdit(){return!1}init(){this.sidebarItem=new ListIndexViewItem({text:()=>h`My Uploads`}),D.addRoute({path:["uploads"],sidebarItem:()=>this.sidebarItem,contentView:()=>this.view}),H.sidebarList.addFeatureItem(this.sidebarItem),z.onSwitchedUser.add((()=>{!1!==this.state&&"waiting"!==this.state&&(this.tracks=[],this.state=!1,this.view.rendered&&(this.view.listView.removeAll(),this.view.updateView()),setTimeout((()=>this.fetch(!0)),1))})),z.onSwitchedUser.add((()=>{this.sidebarItem.hidden="logged"!=z.state}))(),k.onTrackChanged.add((()=>{this.sidebarItem.updateWith({playing:!!this.tracks.find((t=>t===k.track))})})),x.onTrackInfoChanged.add((t=>{this.tracks.forEach((e=>{var i;e.id===t.id&&(e.updateFromApiTrack(t),null===(i=e._upload.view)||void 0===i||i.updateDom())}))})),x.onTrackDeleted.add((t=>{var e=this.tracks.find((e=>e.id===t.id));e&&this.remove(e)}))}insertTrack(t,e=0,i){this.tracks.splice(e,0,t),this.view.rendered&&this.view.addItem(t,e,i)}remove(t){var e,i=this.tracks.indexOf(t);-1!==i&&(this.tracks.splice(i,1),null===(e=t._upload.view)||void 0===e||e.remove())}fetchImpl(){return __awaiter(this,void 0,void 0,(function*(){this.state="waiting";var t=new LoadingIndicator;t.content=h`Logging in`,this.view.useLoadingIndicator(t);try{yield z.waitLogin(!0),this.state="fetching",t.reset();var e=(yield x.get("my/uploads")).tracks.map((t=>new UploadTrack({infoObj:t,_upload:{state:"done"}})));this.state="fetched"}catch(e){return void t.error(e,(()=>this.fetchImpl()))}const i=this;var n=this.tracks.filter((t=>"done"===t._upload.state)),s=this.tracks.findIndex((t=>"done"!==t._upload.state))+1;(new class extends DataUpdatingHelper{constructor(){super(...arguments),this.items=n}addItem(t,e){i.insertTrack(t,s,!1)}updateItem(t,e){t.updateFromApiTrack(e.infoObj)}removeItem(t){var e;null===(e=t._upload.view)||void 0===e||e.remove()}}).update(e),this.view.useLoadingIndicator(null),this.view.updateView()}))}uploadFile(t){return __awaiter(this,void 0,void 0,(function*(){var e={id:void 0,url:void 0,artist:"Unknown",name:t.name},i=new UploadTrack({infoObj:e,blob:t,_upload:{state:"pending",cancelToken:new CancelToken}});this.insertTrack(i),this.inprogress++,this.updateSidebarItem(),yield this.uploadSemaphore.enter();try{if("cancelled"===i._upload.state)return null;yield this.uploadCore(e,i,t)}catch(e){if("cancelled"===i._upload.state)return null;throw i.setState("error"),Toast.show(h`Failed to upload file "${t.name}".`+"\n"+e,3e3),console.warn("[Uploads] uploads failed: ",t.name,e),0==F.view.isVisible&&(this.unreadError=!0),e}finally{this.inprogress--,this.updateSidebarItem(),this.uploadSemaphore.exit()}return this.view.rendered&&this.view.updateUsage(),i}))}uploadCore(t,e,i){return __awaiter(this,void 0,void 0,(function*(){e.setState("uploading");const n=e._upload.cancelToken,s=yield x.post({path:"tracks/uploadrequest",obj:{filename:i.name,size:i.size}});var r;n.throwIfCancelled();var onprogerss=t=>{var i;t.lengthComputable&&(e._upload.progress=t.loaded/t.total,null===(i=e._upload.view)||void 0===i||i.updateDom())};if("direct"===s.mode){const e=new Blob([JSON.stringify(t)]),s=new Blob([O.encodeBlock(e),O.encodeBlock(i)]),o=yield x.upload({method:"POST",url:"tracks/newfile",body:s,auth:x.defaultAuth,contentType:"application/x-mcloud-upload",cancelToken:n,onprogerss:onprogerss}).complete;n.throwIfCancelled(),r=JSON.parse(o.responseText)}else{if("put-url"!==s.mode)throw new Error("Unknown upload mode");console.info("[Uploads] uploading to url",s),yield x.upload({method:s.method,url:s.url,body:i,cancelToken:n,onprogerss:onprogerss}).complete,console.info("[Uploads] posting result to api"),e.setState("processing"),r=yield x.post({path:"tracks/uploadresult",obj:{url:s.url,filename:i.name,tag:s.tag}}),n.throwIfCancelled()}e.infoObj=r,e.setState("done")}))}updateSidebarItem(){this.sidebarItem.text=this.inprogress?h`My Uploads`+` (${this.inprogress})`:h`My Uploads`,this.unreadError&&(this.sidebarItem.text+=" (!!)"),this.sidebarItem.updateDom()}};class UploadViewItem extends TrackViewItem{constructor(t){super(t),t._upload.view=this}postCreateDom(){super.postCreateDom(),this.dom.classList.add("uploads-item"),this.dom.appendChild(this.domstate=buildDOM({tag:"span.uploads-state"}))}updateDom(){super.updateDom();var t=this.track._upload.state;this._lastUploadState!=t&&(this._lastUploadState&&this.dom.classList.remove("state-"+this._lastUploadState),t&&this.dom.classList.add("state-"+t),"uploading"===this.track._upload.state&&void 0!==this.track._upload.progress?this.domstate.textContent=(100*this.track._upload.progress).toFixed(0)+"%":this.domstate.textContent=d.get("uploads_"+t),this.dragging="done"===t)}}class UploadArea extends View{constructor(t){super(),this.domfile=new Ref,objectApply(this,t)}createDom(){return{tag:"div.upload-area.clickable",tabIndex:0,child:[{tag:"div.text.no-selection",text:()=>h`Click here to select files to upload`},{tag:"div.text.no-selection",text:()=>h`or drag files to this zone...`},{tag:"input",type:"file",ref:this.domfile,style:"visibility: collapse; height: 0;",accept:"audio/*",multiple:!0}]}}postCreateDom(){this.domfile.value.addEventListener("change",(t=>{this.domfile.value.files&&this.handleFiles(this.domfile.value.files)})),this.onActive.add((t=>{this.domfile.value.click()})),this.dom.addEventListener("dragover",(t=>{t.dataTransfer&&t.dataTransfer.types.indexOf("Files")>=0&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy")})),this.dom.addEventListener("drop",(t=>{t.dataTransfer&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer.types.indexOf("Files")>=0&&this.handleFiles(t.dataTransfer.files))}))}handleFiles(t){var e;for(let i=0;i<t.length;i++){const n=t[i];console.log("[Uploads] drop file",{name:n.name,size:n.size}),null===(e=this.onfile)||void 0===e||e.call(this,n)}}}var O={encodeBlock:t=>new Blob([O.encodeLen(t.size),t]),encodeLen(t){for(var e="",i=0;i<8;i++)e="0123456789aBcDeF"[t>>4*i&15]+e;return e+="\r\n"}};class ListIndexViewItem extends SidebarItem{constructor(t){super({}),this.playing=!1,this.onContextMenu=(t,e)=>{var i=new ContextMenu;if(this.index&&this.listInfo){if(1==this.listInfo.visibility&&i.add(new CopyMenuItem({text:h`Copy link`,textToCopy:x.appBaseUrl+"#list/"+this.listInfo.id})),this.listInfo.owner==z.id){const e=this.listInfo.visibility?0:1;i.add(new MenuItem({text:d.get("make_it_visibility_"+e),onActive:()=>{const i=this.index.getList(t.listInfo.id);i.info.visibility=e,i.onInfoChanged(),i.put()}}))}i.add(new MenuItem({text:h`Remove`,cls:"dangerous",onActive:()=>{this.index.removeList(this.listInfo.id)}}))}this.listInfo&&i.add(new MenuInfoItem({text:h`List ID`+": "+this.listInfo.id})),i.length&&(e.preventDefault(),H.showContextMenuForItem([t],i,{ev:e}))},objectApply(this,t)}createDom(){return{tag:"li.item.indexitem.no-selection",tabIndex:0,child:[{_id:"tag",tag:"span.tag"},{tag:"span.name.flex-1",text:()=>{var t,e;return null!==(e=null===(t=this.listInfo)||void 0===t?void 0:t.name)&&void 0!==e?e:this.text}},{tag:"span.state",update:t=>{var e=this.playing?new Icon({icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>'}):null;clearChildren(t),e&&t.appendChild(e.dom),t.hidden=!e}}]}}updateDom(){super.updateDom();var t=this.getDomById("tag"),e=this.listInfo&&0!=this.listInfo.visibility?this.listInfo.owner==z.id&&1==this.listInfo.visibility?h`my_visibility_1`:h`visibility_1`:"";t.textContent=e,t.style.display=e?"block":"none",this.dom.style.paddingTop=e?".3em":"",this.dom.style.paddingBottom=e?"1.2em":""}}const U=new class ListIndex{constructor(){this.loadedList={},this.loadIndicator=new LoadingIndicator,this.playing=null,this.nextId=-100,this.listView=new ListView({tag:"ul"}),this.listView.dragging=!0,this.listView.moveByDragging=!0,this.listView.onItemMoved=(t,e)=>{this.putUser()},this.listView.onDragover=t=>{const e=t.source,i=t.event.dataTransfer;if(i)if(e instanceof TrackViewItem){if(t.accept=!0,i.dropEffect="copy",t.drop){const e=this.getList(t.target.listInfo.id);e.fetch().then((i=>{for(const i of t.sourceItems)e.addTrack(i.track.toApiTrack(),t.event.altKey?void 0:0);return e.put()})).catch((t=>{console.error("[ListIndex] error adding track:",t)}))}}else if(i.files.length>0&&(i.effectAllowed="copy",t.accept=!0,t.drop)){const e=this.getList(t.target.listInfo.id);for(let n=0;n<i.files.length;n++){const s=i.files[n];F.uploadFile(s).then((i=>__awaiter(this,void 0,void 0,(function*(){i&&(yield e.fetch(),e.addTrack(i.toApiTrack(),t.event.altKey?void 0:0),yield e.put())})))).catch((t=>{console.error("[ListIndex] error adding track:",t)}))}}},this.listView.onItemClicked=t=>{var e;H.sidebarList.currentActive.current!==t?(H.sidebarList.setActive(t),this.showTracklist(t.listInfo.id)):null===(e=t.contentView)||void 0===e||e.onSidebarItemReactived()}}putUser(){z.setListids(this.listView.map((t=>t.listInfo.id)))}init(){k.onTrackChanged.add((()=>{var t,e,i,n,s,r,o=null!==(i=null===(e=null===(t=k.track)||void 0===t?void 0:t._bind)||void 0===e?void 0:e.list)&&void 0!==i?i:null;o!=this.playing&&((null==o?void 0:o.id)&&(null===(n=this.getViewItem(o.id))||void 0===n||n.updateWith({playing:!0})),(null===(s=this.playing)||void 0===s?void 0:s.id)&&(null===(r=this.getViewItem(this.playing.id))||void 0===r||r.updateWith({playing:!1})),this.playing=o)})),x.onTrackInfoChanged.add((t=>{for(const e in this.loadedList)if(this.loadedList.hasOwnProperty(e)){const i=this.loadedList[e];i.tracks.forEach((e=>{e.id===t.id&&i.updateTrackInfo(e,t)}))}})),x.onTrackDeleted.add((t=>{for(const e in this.loadedList)if(this.loadedList.hasOwnProperty(e)){const i=this.loadedList[e];i.tracks.forEach((e=>{e.id===t.id&&i.remove(e,!1)}))}})),this.section=new Section({title:()=>h`Playlists`,content:this.listView});const t=new Icon({icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>'});t.dom.style.fontSize="1.4em",this.section.addAction(jsxBuild(i(SectionAction,{onActive:()=>{this.newTracklist()}},[t]))),H.sidebarList.container.appendView(this.section),H.sidebar.dom.addEventListener("scroll",(t=>{if(t.eventPhase===Event.AT_TARGET){var e=this.section.headerView.dom;setScrollableShadow(e,e.offsetTop+e.offsetHeight-this.listView.dom.offsetTop)}})),this.listView.scrollBox=H.sidebar.dom,D.addRoute({path:["list"],onNav:t=>__awaiter(this,void 0,void 0,(function*(){yield z.waitLogin(!1);var e=window.parseInt(t.remaining[0]),i=this.getList(e),n=i.createView();H.content.setCurrent(n);var s=this.getViewItem(e);H.sidebarList.setActive(s),s||(yield i.fetch(),s=this.addListInfo(i.info),"logged"==z.state&&this.putUser()),s.contentView=n}))}),D.addRoute({path:[""],onNav:t=>__awaiter(this,void 0,void 0,(function*(){(yield z.waitLogin(!1))&&this.listView.length>0&&D.nav(["list",this.listView.get(0).listInfo.id.toString()],!1)}))})}setIndex(t){var e;this.listView.clear();for(const i of null!==(e=null==t?void 0:t.lists)&&void 0!==e?e:[])this.addListInfo(i)}addListInfo(t){var e,i,n,s,r=new ListIndexViewItem({index:this,listInfo:t,playing:t.id===(null===(n=null===(i=null===(e=k.track)||void 0===e?void 0:e._bind)||void 0===i?void 0:i.list)||void 0===n?void 0:n.id)});this.listView.add(r);var o=H.content.current;return o instanceof TrackListView&&(null===(s=o.list)||void 0===s?void 0:s.id)===t.id&&H.sidebarList.setActive(r),r}getListInfo(t){var e;return null===(e=this.getViewItem(t))||void 0===e?void 0:e.listInfo}getList(t){var e=this.loadedList[t];if(!e){e=new TrackList;const i=this.getListInfo(t);i?(e.loadInfo(i),e.apiid||e.loadEmpty()):e.loadApiId(t),this.loadedList[t]=e}return e}getViewItem(t){return this.listView.find((e=>e.listInfo.id===t))}showTracklist(t){D.nav(["list",t.toString()])}onInfoChanged(t,e){var i=this.getViewItem(t);i&&(objectApply(i.listInfo,e),i.updateDom())}removeList(t){var e;return __awaiter(this,void 0,void 0,(function*(){t<0&&(t=yield this.getList(t).getRealId()),yield x.delete({path:"my/lists/"+t}),null===(e=this.getViewItem(t))||void 0===e||e.remove();const i=H.content.current;i instanceof TrackListView&&i.list.id===t&&H.content.setCurrent(null)}))}newTracklist(){return __awaiter(this,void 0,void 0,(function*(){if(!(yield z.waitLogin(!1)))return this._toastLogin=this._toastLogin||new Toast({text:h`Login to create playlists.`}),void this._toastLogin.show(3e3);var t=this.nextId--,e={id:t,owner:z.id,name:createName((t=>t?h`New Playlist (${t+1})`:h`New Playlist`),(t=>!!this.listView.find((e=>e.listInfo.name===t)))),visibility:0,version:0};this.addListInfo(e);var i=this.getList(t);i.postToUser().then((()=>{e.id=i.apiid}),(t=>{Toast.show(h`Failed to create playlist "${e.name}".`+"\n"+t,5e3)}))}))}},z=new class User{constructor(){this.siLogin=new SettingItem("mcloud-login","json",{id:-1,username:null,passwd:void 0,token:null,lastBaseUrl:null}),this.info=this.siLogin.data,this._serverOptions={},this.state="none",this.onSwitchedUser=new a,this.loggingin=null,this.pendingInfo=null,this._ignore_track_once=null}get id(){return this.info.id}get isAdmin(){return"admin"===this.role}get serverOptions(){return this._serverOptions}setState(t){this.state=t,H.sidebarLogin.update()}init(){var t;k.onTrackChanged.add((()=>this.playingTrackChanged()));const e=null===(t=window.preload)||void 0===t?void 0:t.preLoginTask;this.info.username||e?this.login(e?{preLogin:e}:{info:this.info}).then(null,(t=>{Toast.show(h`Failed to login.`+"\n"+t,5e3)})):(this.setState("none"),this.openUI())}openUI(t,e){(t=null!=t?t:"logged"!==this.state)?(this.loginDialog||(this.loginDialog=new LoginDialog),this.loginDialog.show(e)):(new MeDialog).show(e)}closeUI(){var t;null===(t=this.loginDialog)||void 0===t||t.close()}getBasicAuth(t){return"Basic "+base64EncodeUtf8(t.username+":"+t.passwd)}getBearerAuth(t){return"Bearer "+t}login(t){return __awaiter(this,void 0,void 0,(function*(){"logged"!==this.state&&this.setState("logging");var e=(()=>__awaiter(this,void 0,void 0,(function*(){let e;try{if(t.info){const i=t.info,n=i.token;e=n?yield x.get("users/me",{auth:this.getBearerAuth(n)}):yield x.post({path:"users/me/login",auth:this.getBasicAuth(i)})}else{if(!t.preLogin)throw new Error("Unexpected login argument");e=yield t.preLogin}}catch(t){if("logged"!==this.state&&this.setState("error"),"user_not_found"===t.message)throw new Error(h`Username or password is not correct.`);throw t}finally{this.pendingInfo=null}yield this.handleLoginResult(e)})))();this.loggingin=e,yield e}))}register(t){return __awaiter(this,void 0,void 0,(function*(){this.setState("logging");var e=(()=>__awaiter(this,void 0,void 0,(function*(){var e=yield x.post({path:"users/new",obj:t});if(e.error){if(this.setState("error"),"dup_user"===e.error)throw new Error(h`A user with the same username exists`);throw new Error(e.error)}yield this.handleLoginResult(e)})))();this.loggingin=e,yield e}))}handleLoginResult(t){return __awaiter(this,void 0,void 0,(function*(){if(!t.username||!t.id)throw new Error(h`iNTernEL eRRoR`);if(this.info.username,t.username,this.info.id=t.id,this.info.username=t.username,this.info.passwd=void 0,t.token&&(this.info.token=t.token),this.info.lastBaseUrl=x.baseUrl,this.role=t.role,this.siLogin.save(),t.serverOptions){const e=this._serverOptions=t.serverOptions;e.msg&&Toast.show(h`Server: `+e.msg,3e3),x.storageUrlBase=e.storageUrlBase||""}x.defaultAuth=this.getBearerAuth(this.info.token),H.sidebarLogin.update(),U.setIndex(t),this.setState("logged"),this.loggingin=null,this.onSwitchedUser.invoke(),t.playing&&!k.track&&this.tryRestorePlaying(t.playing)}))}logout(){return __awaiter(this,void 0,void 0,(function*(){if(this.info.token){var t=Toast.show(h`Logging out...`);try{yield x.post({path:"users/me/logout"}),t.close()}catch(e){return t.text=h`Failed to logout.`+"\n"+e,void t.show(5e3)}}objectApply(this.info,{id:-1,username:void 0,passwd:void 0,token:void 0}),this.role=void 0,this.siLogin.save(),x.defaultAuth=null,H.content.setCurrent(null),U.setIndex(null),this.setState("none"),this.loggingin=null,this.onSwitchedUser.invoke()}))}setListids(t){return __awaiter(this,void 0,void 0,(function*(){var e={id:this.info.id,username:this.info.username,listids:t};yield x.put({path:"users/me",obj:e})}))}waitLogin(t){return __awaiter(this,void 0,void 0,(function*(){do{if("logged"===this.state)return!0;if("logging"===this.state)try{if(yield this.loggingin,"logged"!=this.state)break;return!0}catch(t){break}}while(0);if(t)throw new Error("No login");return!1}))}playingTrackChanged(){var t,e,i,n,s,r,o,a,l=k.track;if(l&&this._ignore_track_once===l)this._ignore_track_once=null;else{var d={listid:null!==(i=null===(e=null===(t=null==l?void 0:l._bind)||void 0===t?void 0:t.list)||void 0===e?void 0:e.id)&&void 0!==i?i:0,position:null!==(s=null===(n=null==l?void 0:l._bind)||void 0===n?void 0:n.position)&&void 0!==s?s:0,trackid:null!==(r=null==l?void 0:l.id)&&void 0!==r?r:0,profile:null!==(a=null===(o=k.trackProfile)||void 0===o?void 0:o.profile)&&void 0!==a?a:""};this.postPlaying(d).then((()=>console.info("[User] post playing OK")),(t=>console.warn("[User] post playing error",t)))}}tryRestorePlaying(t){return __awaiter(this,void 0,void 0,(function*(){if(t.trackid){var e=null;t.track&&(e=new Track({infoObj:t.track}),this._ignore_track_once=e,k.setTrack(e));var i=t.listid?U.getList(t.listid):F;yield i.fetch();var n=i.tracks[t.position];(null==n?void 0:n.id)!==t.trackid&&(n=i.tracks.find((e=>e.id===t.trackid))||null),(!e&&null==k.track||e&&k.track==e)&&(this._ignore_track_once=n,k.setTrack(n))}}))}getPlaying(){return __awaiter(this,void 0,void 0,(function*(){return yield this.waitLogin(!0),yield x.get("my/playing")}))}postPlaying(t){return __awaiter(this,void 0,void 0,(function*(){yield this.waitLogin(!0),yield x.post({path:"my/playing",obj:t})}))}changePassword(t){return __awaiter(this,void 0,void 0,(function*(){var e=Toast.show(h`Changing password...`);try{yield x.put({path:"users/me",obj:{id:this.info.id,username:this.info.username,passwd:t}}),this.info.passwd=t,x.defaultAuth=this.getBasicAuth(this.info),this.siLogin.save()}catch(t){return e.updateWith({text:h`Failed to change password.`+"\n"+t}),void e.show(3e3)}e.updateWith({text:h`Password changed successfully.`}),e.show(3e3)}))}};class LoginDialog extends Dialog{constructor(){super(),this.tabLogin=new TextBtn({text:h`Login`,active:!0}),this.tabCreate=new TextBtn({text:h`Create account`}),this.inputUser=new LabeledInput({label:h`Username`}),this.inputPasswd=new LabeledInput({label:h`Password`,type:"password"}),this.inputPasswd2=new LabeledInput({label:h`Confirm password`,type:"password"}),this.viewStatus=new TextView({tag:"div.input-label",style:"white-space: pre-wrap; color: red;"}),this.btn=new ButtonView({text:h`Login`,type:"big"}),this.isRegistering=!1;var t=this;t.title="",[this.tabLogin,this.tabCreate].forEach((e=>{t.addBtn(e),e.onActive.add((()=>toggle(e)))})),[this.inputUser,this.inputPasswd,this.inputPasswd2].forEach((e=>t.addContent(e))),t.addContent(buildDOM({tag:"div",child:[this.viewStatus,this.btn]})),this.compositionWatcher=new TextCompositionWatcher(this.dom),t.dom.addEventListener("keydown",(t=>{this.compositionWatcher.isCompositing||"Enter"!==t.code||(this.btnClicked(),t.preventDefault())})),t.autoFocus=this.inputUser.input,this.btn.toggleClass("bigbtn",!0),this.btn.dom.addEventListener("click",(()=>this.btnClicked()));var toggle=t=>{t.active||(this.isRegistering=!this.isRegistering,this.inputPasswd2.hidden=!this.isRegistering,this.btn.text=t.text,this.tabLogin.updateWith({active:!this.isRegistering}),this.tabCreate.updateWith({active:this.isRegistering}))};this.inputPasswd2.hidden=!0,this.addBtn(new TextBtn({text:h`Settings`,right:!0,onActive:t=>{S.openUI(t),this.close()}}))}show(...t){this.center(),super.show(...t)}btnClicked(){if(!this.btn.dom.classList.contains("disabled")){var t=[];this.inputUser.value||t.push(h`Please input the username!`),this.inputPasswd.value?this.isRegistering&&this.inputPasswd.value!==this.inputPasswd2.value&&t.push(h`Password confirmation does not match!`):t.push(h`Please input the password!`),this.viewStatus.dom.textContent=t.join("\r\n"),t.length||(()=>{__awaiter(this,void 0,void 0,(function*(){this.viewStatus.text=h`Requesting...`,this.btn.updateWith({disabled:!0});var t={username:this.inputUser.value,passwd:this.inputPasswd.value};try{z.pendingInfo=t,this.isRegistering?yield z.register(t):yield z.login({info:t}),this.viewStatus.text="",[this.inputUser,this.inputPasswd,this.inputPasswd2].forEach((t=>t.value="")),z.closeUI()}catch(t){this.viewStatus.text=t,"logged"===z.state&&z.info.username&&(this.viewStatus.text+="\r\n"+h`Logged in with previous working account.`)}finally{z.pendingInfo=null,this.btn.updateWith({disabled:!1})}}))})()}}}class MeDialog extends Dialog{constructor(){super(),this.btnChangePassword=new ButtonView({text:h`Change password`,type:"big"}),this.btnSwitch=new ButtonView({text:h`Switch user`,type:"big"}),this.btnLogout=new ButtonView({text:h`Logout`,type:"big"});var t=z.info.username;this.title=h`User ${t}`,this.addContent(new View({tag:"p",textContent:h`You've logged in as "${t}".`})),z.isAdmin&&this.addContent(new View({tag:"p",textContent:h`You are admin.`})),this.addContent(this.btnChangePassword),this.addContent(this.btnSwitch),this.addContent(this.btnLogout),this.btnChangePassword.onActive.add((t=>{(new ChangePasswordDialog).show(t),this.close()})),this.btnSwitch.onActive.add((t=>{z.openUI(!0,t),this.close()})),this.btnLogout.onActive.add((()=>{z.logout(),this.close()})),this.addBtn(new TextBtn({text:h`Settings`,right:!0,onActive:t=>{S.openUI(t),this.close()}}))}}class ChangePasswordDialog extends Dialog{constructor(){super(),this.inputPasswd=new LabeledInput({label:h`New password`,type:"password"}),this.inputPasswd2=new LabeledInput({label:h`Confirm password`,type:"password"}),this.status=new TextView({tag:"div.input-label",style:"white-space: pre-wrap; color: red;"}),this.btnChangePassword=new ButtonView({text:h`Change password`,type:"big"}),this.title=h`Change password`,[this.inputPasswd,this.inputPasswd2,this.status,this.btnChangePassword].forEach((t=>this.addContent(t))),this.btnChangePassword.onActive.add((()=>{this.inputPasswd.value?this.inputPasswd.value!==this.inputPasswd2.value?this.status.text=h`Password confirmation does not match!`:(z.changePassword(this.inputPasswd.value),this.close()):this.status.text=h`Please input the new password!`}))}}View.debugging=!0,SidebarItem.prototype.bindContentView=function(t){return this.onActive.add((()=>{this.contentView||(this.contentView=t()),H.content.current!==this.contentView?(H.content.setCurrent(this.contentView),H.sidebarList.setActive(this)):this.contentView.onSidebarItemReactived()})),this};const j=new class MainContainer extends View{constructor(){super(...arguments),this.sidebar=new Sidebar,this.contentOuter=new View(i("main",{id:"content-outer"}))}createDom(){return i("div",{id:"main-container",class:"no-transition"},this.sidebar,this.contentOuter)}},R=new class BottomBar extends View{constructor(){super(...arguments),this.btnPlay=new Ref,this.btnPrev=new Ref,this.btnNext=new Ref}createDom(){return i("div",{id:"bottombar"},i("div",{id:"progress-outer"},i("div",{class:"no-selection",id:"progressbar-label-cur"},"--:--"),i("div",{class:"no-selection",id:"progressbar-label-total"},"--:--")),i("div",{class:"btn-progress",id:"progressbar"},i("div",{class:"btn-fill",id:"progressbar-fill"})),i("div",{id:"playcontrol"},i("div",{id:"btn-prevtrack",class:"prev_n_next clickable",tabindex:"0",ref:this.btnPrev},i(Icon,{icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/></svg>'})),i("div",{id:"btn-play",class:"clickable",tabindex:"0",ref:this.btnPlay}),i("div",{id:"btn-nexttrack",class:"prev_n_next clickable",tabindex:"0",ref:this.btnNext},i(Icon,{icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/></svg>'}))),i("div",{id:"bottombar-btns",class:"flexbox-h"},i("div",{id:"bottombar-trackinfo",class:"flex-1 no-selection clickable"})))}setPlayIcon(t){const e=this.btnPlay.value;clearChildren(e),e.appendChild(new Icon({icon:t?'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24"><g><rect fill="none" height="24" width="24"/></g><g><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M9.5,16.5v-9l7,4.5L9.5,16.5z"/></g></svg>':'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24"><g><rect fill="none" height="24" width="24"/></g><g><g><path d="M12,2C6.48,2,2,6.48,2,12s4.48,10,10,10s10-4.48,10-10S17.52,2,12,2z M11,16H9V8h2V16z M15,16h-2V8h2V16z"/></g></g></svg>'}).dom)}};mountView(document.body,j),mountView(document.body,R);const H=new class{constructor(){this.usingKeyboardInput=!1,this.theme=new class{constructor(){this.all=["light","dark","dark-rounded","light-rounded"],this.current="light",this.timer=new Timer((()=>toggleClass(document.body,"changing-theme",!1))),this.rendered=!1,this.siTheme=new SettingItem("mcloud-theme","str","light-rounded").render((t=>{if(this.current!==t){this.current=t,this.rendered&&toggleClass(document.body,"changing-theme",!0);const[e,i]=t.split("-");toggleClass(document.body,"dark","dark"===e),toggleClass(document.body,"rounded","rounded"===i),document.getElementById("meta-theme-color").content="dark"===e?"black":"",this.rendered&&this.timer.timeout(500)}this.rendered=!0}))}set(t){this.siTheme.set(t)}},this.lang=new class{constructor(){this.availableLangs=["en","zh"],this.siLang=new SettingItem("mcloud-lang","str","")}init(){this.siLang.render((t=>{t||(t=I18n.detectLanguage(this.availableLangs)),this.curLang=t,d.curLang=t,document.body.lang=t,console.info(`[UI] Current language: '${d.curLang}' - '${h`English`}'`),H.updateAllViews()})),d.renderElements(document.querySelectorAll(".i18ne"))}setLang(t,e){this.siLang.set(null!=t?t:""),(void 0===e||e)&&window.location.reload()}},this.bottomBar=new class{constructor(){this.container=document.getElementById("bottombar"),this.btnPin=new TextView(document.getElementById("btnPin")),this.pinned=!0,this.InputStateTracker=new InputStateTracker(this.container),this.hideTimer=new Timer((()=>{this.toggle(!1)})),this.shown=!1,this.inTransition=!1}setPinned(t){void 0===t?this.siPin.toggle():t!==this.siPin.data?this.siPin.set(t):(this.pinned=t,toggleClass(document.body,"bottompinned",t),this.btnPin.text=t?h`Unpin`:h`Pin`,t&&this.toggle(!0))}toggle(t,e){this.shown=toggleClass(this.container,"show",t),t&&e&&!this.pinned&&this.updateState(e)}updateState(t=200){this.pinned||this.InputStateTracker.state.mouseIn||this.InputStateTracker.state.mouseDown||this.InputStateTracker.state.focusIn&&H.usingKeyboardInput?(this.hideTimer.tryCancel(),this.toggle(!0)):(this.hideTimer.tryCancel(),this.pinned||this.hideTimer.timeout(t))}init(){var t=this.container;this.InputStateTracker.onChanged.add((()=>this.updateState())),t.addEventListener("transitionstart",(e=>{e.target===t&&"transform"===e.propertyName&&(this.inTransition=!0)})),t.addEventListener("transitionend",(e=>{e.target===t&&"transform"===e.propertyName&&(this.inTransition=!1)})),t.addEventListener("transitioncancel",(e=>{e.target===t&&"transform"===e.propertyName&&(this.inTransition=!1)})),t.addEventListener("keydown",(t=>{this.updateState()}),!0),this.siPin=new SettingItem("mcloud-bottompin","bool",this.pinned),this.siPin.render((t=>this.setPinned(t))),this.btnPin.onActive.add((()=>this.siPin.toggle()))}},this.playerControl=new class{constructor(){this.progbar=document.getElementById("progressbar"),this.fill=document.getElementById("progressbar-fill"),this.labelCur=document.getElementById("progressbar-label-cur"),this.labelTotal=document.getElementById("progressbar-label-total"),this.btnPlay=new TextView(document.getElementById("btn-play")),this.btnLoop=new TextView(document.getElementById("btn-loop")),this.btnPrev=new View(document.getElementById("btn-prevtrack")),this.btnNext=new View(document.getElementById("btn-nexttrack"))}init(){this.setState("none"),this.btnPlay.onActive.add((t=>{t.preventDefault(),"paused"===k.state?k.play():k.pause()})),this.btnLoop.onActive.add((()=>{var t=C,e=t[(t.indexOf(k.loopMode)+1)%t.length];k.loopMode=e})),this.btnPrev.onActive.add((t=>{t.preventDefault(),k.prev()})),this.btnNext.onActive.add((t=>{t.preventDefault(),k.next()})),k.onLoopModeChanged.add((()=>this.updateLoopMode()))(),k.onTrackChanged.add((()=>this.updateLoopMode()))(),k.onStateChanged.add((()=>{this.setState(k.state),this.setProg(k.currentTime,k.duration)}))(),k.onProgressChanged.add((()=>this.setProg(k.currentTime,k.duration))),this.onProgressSeeking((t=>{k.ensureLoaded().then((()=>{k.currentTime=t*k.duration}))})),this.btnVolume=new VolumeButton(document.getElementById("btn-volume")),this.btnVolume.text=h`Volume`,this.btnVolume.bindToPlayer()}setState(t){var e=this.btnPlay;if("none"===t)R.setPlayIcon(!0),e.toggleClass("disabled",!0);else if("paused"===t)R.setPlayIcon(!0),e.toggleClass("disabled",!1);else if("playing"===t)R.setPlayIcon(!1),e.toggleClass("disabled",!1);else{if("stalled"!==t)throw new Error("invalid state value: "+t);R.setPlayIcon(!1),e.toggleClass("disabled",!1)}this.state=t}setProg(t,e){var i=t/e;i=numLimit(i,0,1),this.fill.style.width=100*i+"%",this.labelCur.textContent=formatTime(t),this.labelTotal.textContent=formatTime(e)}updateLoopMode(){this.btnLoop.hidden=!1,this.btnLoop.text=d.get("loopmode_"+k.loopMode),this.btnNext.toggleClass("disabled",!k.getNextTrack(1)),this.btnPrev.toggleClass("disabled",!k.getNextTrack(-1))}onProgressSeeking(t){var call=e=>{t(numLimit(e/this.progbar.clientWidth,0,1))};listenPointerEvents(this.progbar,(t=>{if(t.ev.preventDefault(),"move"!=t.action&&toggleClass(this.progbar,"btn-down","down"===t.action),H.bottomBar.shown&&!H.bottomBar.inTransition&&("mouse"===t.type&&1===t.ev.buttons||"touch"===t.type)&&call(t.point.pageX-this.progbar.getBoundingClientRect().left),"down"===t.action)return"track"}))}},this.trackinfo=new class{constructor(){this.element=document.getElementById("bottombar-trackinfo")}init(){k.onTrackChanged.add((()=>this.setTrack(k.track))),this.element.addEventListener("click",(t=>{"nowplaying"!=D.current[0]&&D.nav("nowplaying")}))}setTrack(t){H.windowTitle.setFromTrack(t),t?(replaceChild(this.element,buildDOM({tag:"span",child:[{tag:"span.name",textContent:t.name},{tag:"span.artist",textContent:t.artist}]})),H.bottomBar.toggle(!0,5e3)):this.element.textContent=""}},this.mainContainer=new class{constructor(){this.dom=document.getElementById("main-container")}},this.sidebar=new class{constructor(){this.dom=document.getElementById("sidebar"),this._float=!1,this._hide=!1,this._hideMobile=!0,this._hideLarge=!1,this._btnShown=!1,this._isMobile=!1}get float(){return this._float}get hide(){return this._hide&&this._float}get btnShown(){return this._btnShown}init(){this.toggleBtn(!0),this.checkWidth(),window.addEventListener("resize",(()=>this.checkWidth())),D.onNavCompleted.add((()=>{this.float&&this.toggleHide(!0)})),m.onDragStart.add((()=>{toggleClass(this.dom,"peek",!0)})),m.onDragEnd.add((()=>{toggleClass(this.dom,"peek",!1)})),this.dom.addEventListener("dragover",(()=>this.toggleHide(!1)))}isMobile(){return window.innerWidth<800}checkWidth(){const t=this.isMobile();t!=this._isMobile&&(this._isMobile=t,this.toggleHide(t?this._hideMobile||this._hideLarge:this._hideLarge&&this._hideMobile))}toggleFloat(t){void 0!==t&&!!t===this._float||(this._float=toggleClass(document.body,"float-sidebar",t),this.updateOverlay())}toggleBtn(t){t!=this._btnShown&&(this._btnShown=t,t?(this.btn=this.btn||new SidebarToggle,this.dom.parentElement.appendChild(this.btn.dom)):this.btn.dom.remove())}toggleHide(t){this._hide=toggleClass(this.dom,"hide",t),this.isMobile()?this._hideMobile=this._hide:this._hideLarge=this._hide,this.toggleFloat(this.isMobile()||this._hide),this.updateOverlay()}updateOverlay(){var t=this.float&&!this.hide;if(t!=!!this.overlay)if(t)this.overlay=new Overlay({tag:"div.overlay",style:"z-index: 99;",onclick:()=>this.toggleHide(!0),ondragover:()=>this.toggleHide(!0)}),j.appendView(this.overlay);else{const t=this.overlay;this.overlay=null,fadeout(t.dom).onFinished((()=>{j.removeView(t)}))}}},this.sidebarLogin=new class{constructor(){this.container=j.sidebar.header,this.loginState=new SidebarItem}init(){this.container.addView(this.loginState,0),this.loginState.dom.id="login-state",this.loginState.onActive.add((t=>{z.openUI(void 0,t)}))}update(){var t,e,i=this.loginState.text,n=null!==(e=null===(t=z.pendingInfo)||void 0===t?void 0:t.username)&&void 0!==e?e:z.info.username;n?(i=n,"logging"===z.state&&(i+=h` (logging in...)`),"error"===z.state&&(i+=h` (error!)`),"none"===z.state&&(i+=h` (not logged in)`)):i="logging"===z.state?h`(logging...)`:h`Guest (click to login)`,this.loginState.updateWith({text:i})}},this.sidebarList=new class{constructor(){this.container=j.sidebar.list,this.featuresListview=j.sidebar.features,this.currentActive=new ItemActiveHelper}setActive(t){this.currentActive.set(t)}addFeatureItem(t){this.featuresListview.add(t)}},this.content=new class{constructor(){this.container=j.contentOuter,this.current=null}removeCurrent(){const t=this.current;this.current=null,t&&(t.onRemove(),t.dom&&(this.container.removeView(t),t.onDomRemoved()))}setCurrent(t){t!==this.current&&(this.removeCurrent(),t&&(t.onShow(),t.dom&&(this.container.appendView(t),t.onDomInserted())),this.current=t)}},this.windowTitle=new class{constructor(){this.appName=h`Music Cloud`}reset(){this.setTitle(null)}setTitle(t){t?t+=" - "+this.appName:t=this.appName,document.title=t}setFromTrack(t){t?this.setTitle(t.name+" - "+t.artist):this.setTitle(null)}},this.notification=new class{constructor(){this.siNotification=new SettingItem("mcloud-notif","json",{enabled:!1,nowPlaying:!0}),this.lastNotif=null}get config(){return this.siNotification.data}isEnabledFor(t){return this.config.enabled&&this.config[t]}browserSupport(){return"Notification"in window}checkPermission(){return"granted"==Notification.permission}requestPermission(){return __awaiter(this,void 0,void 0,(function*(){return!!this.browserSupport()&&(!!this.checkPermission()||"granted"==(yield Notification.requestPermission()))}))}show(t,e,i=5e3){console.info("[UI] notification",{title:t,options:e,timeout:i}),this.lastNotif&&this.lastNotif.close();var n=this.lastNotif=new Notification(t,e);return i&&setTimeout((()=>{n.close()}),i),n}init(){!this.config.enabled||this.browserSupport()&&this.checkPermission()||(this.config.enabled=!1,this.siNotification.save()),k.onTrackChanged.add((()=>{if(this.isEnabledFor("nowPlaying")&&!H.isVisible()&&this.config.nowPlaying&&("playing"==k.state||"stalled"==k.state)){const t=k.track;this.show(t.name,{body:h`Artist`+": "+(null==t?void 0:t.artist),requireInteraction:!1})}}))}setEnable(t){return __awaiter(this,void 0,void 0,(function*(){(!t||this.browserSupport()&&(yield this.requestPermission()))&&(this.config.enabled=t,this.siNotification.save())}))}}}init(){this.addErrorListener(),this.lang.init(),this.sidebar.init(),this.bottomBar.init(),this.trackinfo.init(),this.playerControl.init(),this.sidebarLogin.init(),this.windowTitle.reset(),this.notification.init(),Dialog.defaultParent=new DialogParent(j),ToastsContainer.default.parentDom=j.dom,ToastsContainer.default.dom.style.position="absolote",D.addRoute({path:["home"],onNav:()=>{H.content.setCurrent(null),H.sidebarList.currentActive.set(null)}}),document.addEventListener("dragover",(t=>{t.preventDefault()})),document.addEventListener("drop",(t=>{var e;if(t.defaultPrevented)return;t.preventDefault();const i=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;i&&i.length&&(new MessageBox).setTitle(h`Question`).addText(1===i.length?h`Did you mean to upload 1 file?`:h`Did you mean to upload ${i.length} files?`).addResultBtns(["no","yes"]).allowCloseWithResult("no").showAndWaitResult().then((t=>{if("yes"===t){"uploads"!==D.currentStr&&D.nav("uploads");for(let t=0;t<i.length;t++){const e=i[t];F.uploadFile(e)}}}))})),document.addEventListener("keydown",(t=>{this.usingKeyboardInput=!0,document.body.classList.add("keyboard-input")}),!0),["mousedown","touchstart"].forEach((t=>document.addEventListener(t,(t=>{this.usingKeyboardInput=!1,document.body.classList.remove("keyboard-input")}),{passive:!0,capture:!0}))),window.addEventListener("message",(t=>{t.data.theme&&H.theme.set(t.data.theme)}))}addErrorListener(){window.addEventListener("error",(t=>{Toast.show(h`Application Error:`+"\n"+t.error,5e3)}))}endPreload(){setTimeout((()=>{H.mainContainer.dom.classList.remove("no-transition"),fadeout(document.getElementById("preload-overlay"))}),1)}isVisible(){return!document.hidden}updateAllViews(){j.updateAll()}showContextMenuForItem(t,e,...i){e.show(...i),t.forEach((t=>t.toggleClass("menu-shown",!0))),e.onClose.add((()=>{t.forEach((t=>t.toggleClass("menu-shown",!1)))}))}};class ProgressButton extends View{constructor(t){super(null!=t?t:{tag:"div.btn"}),this.fill=new View({tag:"div.btn-fill"}),this.textSpan=new TextView({tag:"span.text"}),this.dom.classList.add("btn-progress"),this.appendView(this.fill),this.appendView(this.textSpan)}get text(){return this.textSpan.text}set text(t){this.textSpan.text=t}get progress(){return this._progress}set progress(t){this.fill.dom.style.width=100*t+"%",this._progress=t}}class VolumeButton extends ProgressButton{constructor(t){var e,i;super(t),this.onChanging=new a,this.showUsage=!1,this.tipView=new ToolTip,this.tipView.toggleClass("volume-tip",!0),this.InputStateTracker=new InputStateTracker(this.dom),this.InputStateTracker.onChanged.add((()=>this.updateTip())),this.dom.addEventListener("wheel",(t=>{t.preventDefault();var e=-.05*Math.sign(t.deltaY);this.onChanging.invoke(this.progress+e)})),listenPointerEvents(this.dom,(t=>{if("mouse"!==t.type||"down"!==t.action||1==t.ev.buttons){if(t.ev.preventDefault(),"down"===t.action)return this.dom.focus(),e=t.point.pageX,i=this.progress,this.dom.classList.add("btn-down"),this.fill.dom.style.transition="none","track";if("move"===t.action){var n=t.point.pageX-e;this.onChanging.invoke(i+.01*n)}else"up"===t.action&&("touchcancel"==t.ev.type&&this.onChanging.invoke(i),this.dom.classList.remove("btn-down"),this.fill.dom.style.transition="");this.updateTip()}})),this.dom.addEventListener("click",(t=>{this.showUsage=!0,this.updateTip()}));const n={ArrowUp:.05,ArrowDown:-.05,ArrowRight:.01,ArrowLeft:-.01};this.dom.addEventListener("keydown",(t=>{var e=n[t.code];e&&(t.preventDefault(),this.onChanging.invoke(this.progress+e))}))}get state(){return this.InputStateTracker.state}get progress(){return super.progress}set progress(t){super.progress=t,this.updateTip()}updateTip(){const t=Math.floor(100*this.progress);this.tipView.text=t+"%";const e=this.state.mouseIn||this.state.mouseDown||this.state.focusIn&&H.usingKeyboardInput;if(e==this.tipView.shown);else if(e){const t=this.dom.getBoundingClientRect(),e=H.bottomBar.container.getBoundingClientRect();this.tipView.show({x:t.left+t.width/2-e.left,y:t.top-e.top-3,parent:H.bottomBar.container})}else this.tipView.close({className:"animation-fading-out"})}bindToPlayer(){k.onVolumeChanged.add((()=>{this.progress=k.volume}))(),this.onChanging.add((t=>{var e=numLimit(t,0,1);e=Math.round(100*e)/100,this.showUsage=!1,k.volume=e}))}}class SidebarToggle extends View{createDom(){return{tag:"div.sidebar-toggle.clickable.no-selection",child:{tag:"div.logo",text:"M"},onclick:t=>{H.sidebar.toggleHide()},ondragover:t=>{H.sidebar.toggleHide(!1)}}}}class CommentsContentView extends ListContentView{constructor(t){super(),this.comments=t}appendHeader(){super.appendHeader(),this.header.appendView(this.editorNew=new CommentEditor),this.editorNew.dom.classList.add("comment-editor-new"),this.editorNew.onsubmit=t=>{var e=t.content;t.content="",""!==e&&this.comments.post(e)},this.refreshBtn.onActive.add((()=>{this.comments.fetch()}))}appendListView(){super.appendListView(),this.comments.state||this.comments.fetch()}}class CommentsView{constructor(){this.lazyView=new Lazy((()=>this.createContentView())),this.state=!1}get view(){return this.lazyView.value}fetch(t){return __awaiter(this,void 0,void 0,(function*(){if("fetching"===this.state||"waiting"===this.state)return void console.warn("[Comments] another fetch task is running.");this.state="waiting";var e=new LoadingIndicator;t||this.view.useLoadingIndicator(e);try{yield z.waitLogin(!0),this.state="fetching";var i=yield x.get(this.endpoint+"?reverse=1");this.view.useLoadingIndicator(null)}catch(t){throw this.state="error",e.error(t,(()=>this.fetch())),this.view.useLoadingIndicator(e),t}const n=this;(new class extends DataUpdatingHelper{constructor(){super(...arguments),this.items=n.view.listView}addItem(t,e){n.addItem(t,e)}updateItem(t,e){t.comment=e}removeItem(t){t.remove()}}).update(i.comments),this.view.updateView(),this.state="fetched",this.eventName&&!this.eventRegistered&&(B.listenEvent(this.eventName,(()=>{this.fetch(!0)}),!0),this.eventRegistered=!0)}))}addItem(t,e){const i=new CommentViewItem(t);return(t.uid===z.info.id||z.isAdmin)&&(i.onremove=()=>{this.ioAction((()=>x.delete({path:this.endpoint+"/"+i.comment.id})))}),this.view.listView.add(i,e)}ioAction(t){return __awaiter(this,void 0,void 0,(function*(){var e=new LoadingIndicator({content:h`Submitting`});this.view.useLoadingIndicator(e),yield e.action((()=>__awaiter(this,void 0,void 0,(function*(){yield t(),yield this.fetch()}))))}))}post(t){return __awaiter(this,void 0,void 0,(function*(){yield this.ioAction((()=>x.post({path:this.endpoint+"/new",obj:{content:t}})))}))}createContentView(){var t,e=new CommentsContentView(this);return e.title=null!==(t=this.title)&&void 0!==t?t:()=>h`Comments`,e}}class CommentViewItem extends ListViewItem{constructor(t){super(),this.onContextMenu=(t,e)=>{e.preventDefault();var i=new ContextMenu([new MenuInfoItem({text:h`Comment ID`+": "+this.comment.id})]);this.onremove&&i.add(new MenuItem({text:h`Remove`,cls:"dangerous",onActive:()=>{this.onremove(this)}}),0),this.onedit&&i.add(new MenuItem({text:h`Edit`,onActive:()=>{this.onedit(this)}}),0),H.showContextMenuForItem([this],i,{ev:e})},this.comment=t}get id(){return this.comment.id}createDom(){return i("div",{class:"item comment no-transform"},i("div",{class:"username"},(()=>this.comment.username)),i("div",{class:"date"},(()=>formatDateTime(new Date(this.comment.date)))),i("div",{class:"content"},(()=>this.comment.content)))}}class CommentEditor extends View{get content(){return this.ensureDom(),this.domcontent.value}set content(t){this.ensureDom(),this.domcontent.value=t}createDom(){return{tag:"div.comment-editor",child:[{tag:"textarea.input-text.content",_id:"content"},{tag:"div.btn.submit",textContent:h`Submit`,_id:"submit"}]}}postCreateDom(){this.domcontent=this.getDomById("content"),this.domsubmit=this.getDomById("submit"),this.domcontent.addEventListener("keydown",(t=>{t.ctrlKey&&13===t.keyCode&&this.onsubmit(this)})),this.domsubmit.addEventListener("click",(()=>{this.onsubmit(this)}))}}const N=new class extends CommentsView{constructor(){super(...arguments),this.endpoint="discussion",this.eventName="diss-changed"}init(){this.title=()=>h`Discussion`,this.sidebarItem=new SidebarItem({text:()=>h`Discussion`}),D.addRoute({path:["discussion"],sidebarItem:()=>this.sidebarItem,contentView:()=>this.lazyView.value}),H.sidebarList.addFeatureItem(this.sidebarItem),z.onSwitchedUser.add((()=>{this.sidebarItem.hidden=!("logged"==z.state&&z.serverOptions.discussionEnabled&&y.showDiscussion)}))()}},W=new class extends CommentsView{constructor(){super(...arguments),this.endpoint="my/notes",this.eventName="note-changed"}init(){this.title=()=>h`Notes`,this.sidebarItem=new SidebarItem({text:()=>h`Notes`}),D.addRoute({path:["notes"],sidebarItem:()=>this.sidebarItem,contentView:()=>this.lazyView.value}),H.sidebarList.addFeatureItem(this.sidebarItem),z.onSwitchedUser.add((()=>{this.state&&"waiting"!==W.state&&this.fetch()})),z.onSwitchedUser.add((()=>{this.sidebarItem.hidden=!("logged"==z.state&&z.serverOptions.notesEnabled&&y.showNotes)}))()}},$=new class{init(){D.addRoute({path:["track-comments"],onNav:({remaining:t})=>{var e=parseInt(t[0]);H.sidebarList.setActive(null);var i=new CommentsView;i.endpoint="tracks/"+e+"/comments",H.content.setCurrent(i.view)}})}},q=new class{constructor(){this.lazyView=new Lazy((()=>new PlayingView))}init(){var t=new SidebarItem({text:()=>h`Now Playing`});D.addRoute({path:["nowplaying"],contentView:()=>this.view,sidebarItem:()=>t}),D.addRoute({path:["tracks"],onNav:t=>{D.nav(["track",...t.remaining],"replace")}}),D.addRoute({path:["track"],onNav:t=>{var e;D.nav(["nowplaying"],!1),t.remaining[0]!=(null===(e=k.track)||void 0===e?void 0:e.id)&&x.get("tracks/"+t.remaining[0]).then((t=>{k.setTrack(new Track({infoObj:t}))}))}}),H.sidebarList.addFeatureItem(t),k.onTrackChanged.add((()=>{t.hidden=!k.track}))()}get view(){return this.lazyView.value}};class PlayingView extends ContentView{constructor(){super(),this.header=new class extends ContentHeader{onScrollboxScroll(){setScrollableShadow(this.dom,this.scrollbox.scrollTop-this.lines.dom.offsetTop)}}({title:()=>h`Now Playing`}),this.infoView=new View({tag:"div.infoview",child:[{tag:"div.name",text:()=>{var t;return null===(t=k.track)||void 0===t?void 0:t.name}},{tag:"div.artist",text:()=>{var t;return null===(t=k.track)||void 0===t?void 0:t.artist}}]}),this.lyricsView=new LyricsView,this.loading=new LoadingIndicator,this.loadingOuter=new View({tag:"div",style:"flex: 1; align-items: center;",child:this.loading}),this.viewToggle=new ViewToggle({container:this,items:{normal:this.lyricsView,loading:this.loadingOuter}}),this.si=new SettingItem("mcloud-nowplaying","json",{lyricsScale:100}),this.loadedLyrics="",this._checkTrackVersion=0,this.header.lines=this.lyricsView.lines,this.lyricsView.scale=this.si.data.lyricsScale,this.lyricsView.onFontSizeChanged.add((()=>{this.si.data.lyricsScale=this.lyricsView.scale,this.si.save(),this.lyricsView.centerLyrics()})),this.lyricsView.onLyricsChanged.add((()=>{this.header.onScrollboxScroll()})),this.lyricsView.onSpanClick.add((t=>{t.span.startTime&&t.span.startTime>=0&&(k.currentTime=t.span.startTime)})),this.header.actions.addView(this.editBtn=new ActionBtn({text:h`Edit`,onActive:t=>{var e;null===(e=k.track)||void 0===e||e.startEdit(t)}})),this.header.appendView(this.infoView),this.header.bindScrollBox(this.lyricsView.dom)}createDom(){return{tag:"div.playingview",child:[this.header,this.lyricsView]}}postCreateDom(){super.postCreateDom()}onShow(){super.onShow(),this.ensureDom()}onDomInserted(){super.onDomInserted(),this.shownEvents.add(k.onTrackChanged,(()=>{this.checkTrack()}))(),this.shownEvents.add(k.onProgressChanged,(()=>this.lyricsView.onProgressChanged())),this.shownEvents.add(x.onTrackInfoChanged,(t=>{var e;t.id===(null===(e=k.track)||void 0===e?void 0:e.id)&&this.checkTrack()})),this.lyricsView.onShow()}onRemove(){super.onRemove(),this.lyricsView.onHide()}onSidebarItemReactived(){this.lyricsView.setScrollingPause(null),this.lyricsView.setCurrentTime(this.lyricsView.curTime,"smooth")}checkTrack(){return __awaiter(this,void 0,void 0,(function*(){var t=++this._checkTrackVersion;this.infoView.updateDom();const e=k.track;let i="";if(this.editBtn.hidden=!e,this.editBtn.text=(null==e?void 0:e.canEdit)?h`Edit`:h`Details`,this.loadingOuter.dom.remove(),e&&!e.isLyricsGotten()){this.loading.reset(),this.viewToggle.setShownKeys(["loading"]);try{i=yield e.getLyrics()}catch(e){if(t!=this._checkTrackVersion)return;return void this.loading.error(e,(()=>this.checkTrack()))}if(t!=this._checkTrackVersion)return}else i=(null==e?void 0:e.lyrics)||"";return this.viewToggle.setShownKeys(["normal"]),this.lyricsView.track=e,this.loadedLyrics!=i&&(this.loadedLyrics=i,this.lyricsView.reset(),this.lyricsView.setLyrics(i),!0)}))}}const K=new class ListenTogether{init(){}createSession(){}joinSession(){}leaveSession(){}openUI(){}},X=new class{constructor(){this.lazyView=new Lazy((()=>new SearchView)),this.checkPlaying=()=>{var t,e,i=this.lazyView.computed&&!!this.view.tempList&&(null===(e=null===(t=k.track)||void 0===t?void 0:t._bind)||void 0===e?void 0:e.list)===this.view.tempList;this.sidebarItem.updateWith({playing:i})}}init(){this.sidebarItem=new ListIndexViewItem({text:()=>h`Search`}),D.addRoute({path:["search"],contentView:()=>this.view,sidebarItem:()=>this.sidebarItem,onNav:t=>{const e=t.remaining[0];e&&e!=this.view.currentQuery&&this.view.performSearch(e)}}),H.sidebarList.addFeatureItem(this.sidebarItem),k.onTrackChanged.add(this.checkPlaying)()}get view(){return this.lazyView.value}};class SearchView extends ListContentView{constructor(){super(...arguments),this.title=()=>h`Search`,this.searchbar=new SearchBar,this.tempList=null}appendListView(){super.appendListView(),this.listView.toggleClass("tracklistview",!0),this.listView.dragging=!0,this.listView.onItemClicked=t=>{var e=this.getTempList().tracks[t.position];k.track===e&&k.isPlaying?D.nav("nowplaying"):k.playTrack(e)}}appendHeader(){super.appendHeader(),this.refreshBtn.hidden=!0,this.header.appendView(this.searchbar),this.searchbar.onSearch.add((()=>{this.performSearch(this.searchbar.input.value)}))}getTempList(){return this.tempList||(this.tempList=new TrackList,this.listView.forEach((t=>this.tempList.addTrack(t.track.infoObj)))),this.tempList}performSearch(t){return __awaiter(this,void 0,void 0,(function*(){this.currentQuery=t,this.searchbar.value!=t&&(this.searchbar.value=t);var e=new LoadingIndicator;this.useLoadingIndicator(e),D.nav(["search",t]);try{var i=yield x.get("tracks?query="+encodeURIComponent(t));this.tempList=null,X.checkPlaying(),this.listView.removeAll(),i.tracks.forEach((t=>{this.listView.add(new TrackViewItem(new Track({infoObj:t})))})),this.updatePlaying(),this.useLoadingIndicator(null)}catch(i){e.error(i,(()=>this.performSearch(t)))}}))}onShow(){super.onShow(),this.updatePlaying(),this.shownEvents.add(k.onTrackChanged,(()=>this.updatePlaying()))}onRemove(){super.onRemove()}updatePlaying(){var t=k.track;this.listView.forEach((e=>{e.updateWith({playing:!!t&&e.track.id===t.id})}))}}class SearchBar extends View{constructor(){super(...arguments),this.input=new InputView,this.btn=new ButtonView({text:h`Search`,onActive:()=>this.onSearch.invoke()}),this.onSearch=new a}get value(){return this.input.value}set value(t){this.input.value=t}createDom(){return{tag:"div.searchbar",child:[this.input,this.btn]}}postCreateDom(){super.postCreateDom(),this.input.dom.addEventListener("keydown",(t=>{"Enter"===t.code&&(t.preventDefault(),this.onSearch.invoke())}))}}
/*! *************************************************
        Copyright (c) 2020 lideming

        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:

        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
    ************************************************* */
const Y=window.app={webfx:w,settings:y,settingsUI:S,ui:H,api:x,playerCore:k,router:D,listIndex:U,user:z,uploads:F,discussion:N,notes:W,nowPlaying:q,lyricsEdit:M,playerFX:I,Toast:Toast,ToastsContainer:ToastsContainer,Lyrics:P,msgcli:B,init(){console.time("[Main] app.init()"),Y.checkMode(),Y.injectStyle(),H.init(),k.init(),I.init(),z.init(),F.init(),X.init(),N.init(),W.init(),q.init(),K.init(),$.init(),U.init(),B.init(),D.init(),L.showUpdatedToast(),console.timeEnd("[Main] app.init()")},checkMode(){"1"==localStorage.getItem("mcloud-dev")&&startBlockingDetect()},injectStyle(){injectWebfxCss(),injectCss('* {\r\n    box-sizing: border-box;\r\n}\r\n\r\nhtml {\r\n    touch-action: manipulation;\r\n}\r\n\r\nbody {\r\n    margin: 0;\r\n    font-family: sans-serif;\r\n    font-size: 22px;\r\n\r\n    --color-bg: white;\r\n    --color-text: black;\r\n    --color-text-gray: #666;\r\n    --color-bg-selection: hsl(5, 100%, 85%);\r\n    --color-primary: hsl(5, 100%, 67%);\r\n    --color-primary-darker: hsl(5, 100%, 60%);\r\n    --color-primary-dark: hsl(5, 100%, 40%);\r\n    --color-primary-dark-depends: hsl(5, 100%, 40%);\r\n    --color-primary-verydark: hsl(5, 100%, 20%);\r\n    --color-primary-light: hsl(5, 100%, 83%);\r\n    --color-primary-lighter: hsl(5, 100%, 70%);\r\n    --color-fg-11: #111111;\r\n    --color-fg-22: #222222;\r\n    --color-fg-33: #333333;\r\n    --color-bg-cc: #cccccc;\r\n    --color-bg-dd: #dddddd;\r\n    --color-bg-ee: #eeeeee;\r\n    --color-bg-f8: #f8f8f8;\r\n    --color-shadow: rgba(0, 0, 0, .5);\r\n    --color-light-shadow: rgba(0, 0, 0, .3);\r\n    background: var(--color-bg);\r\n    color: var(--color-text);\r\n}\r\n\r\nbody.dark {\r\n    --color-bg: black;\r\n    --color-text: #ddd;\r\n    --color-text-gray: #aaa;\r\n    --color-bg-selection: hsl(5, 100%, 20%);\r\n    --color-primary-dark-depends: hsl(5, 100%, 83%);\r\n    --color-fg-11: #dddddd;\r\n    --color-fg-22: #cccccc;\r\n    --color-fg-33: #bbbbbb;\r\n    --color-bg-f8: #111111;\r\n    --color-bg-ee: #222222;\r\n    --color-bg-dd: #333333;\r\n    --color-bg-cc: #444444;\r\n    --color-shadow: rgba(180, 180, 180, .5);\r\n    --color-light-shadow: rgba(180, 180, 180, .3);\r\n}\r\n\r\nul, li {\r\n    padding: 0;\r\n    margin: 0;\r\n    list-style-type: none;\r\n}\r\n\r\na {\r\n    color: var(--color-text);\r\n}\r\n\r\n.icon {\r\n    display: block;\r\n    position: relative;\r\n    height: 1em;\r\n    width: 1em;\r\n    margin: auto;\r\n    overflow: visible;\r\n}\r\n\r\n.icon svg {\r\n    position: absolute;\r\n    fill: currentColor;\r\n    height: 1.2em;\r\n    width: 1.2em;\r\n    left: -.1em;\r\n    top: -.1em;\r\n}\r\n\r\n.item {\r\n    padding: .7em;\r\n}\r\n\r\n.no-transition, .no-transition * {\r\n    transition: none !important;\r\n}\r\n\r\n.changing-theme, .changing-theme * {\r\n    transition: background-color .3s, color .3s, border-color .3s, border-radius .3s !important;\r\n}\r\n\r\n:focus {\r\n    outline: none;\r\n}\r\n\r\n.keyboard-input :focus, .input-text:focus  {\r\n    outline: solid .1em var(--color-primary-light);\r\n}\r\n\r\n.keyboard-input #sidebar:focus,\r\n.keyboard-input .listcontentview > .scrollbox:focus,\r\n.keyboard-input .lyricsview:focus {\r\n    outline: solid .1em var(--color-primary-light);\r\n    outline-offset: -.1em;\r\n}\r\n\r\n::selection {\r\n    background: var(--color-bg-selection);\r\n}\r\n\r\n\r\nhtml, body {\r\n    height: 100%;\r\n    overflow: hidden;\r\n}\r\n\r\n.flexbox-v {\r\n    display: flex;\r\n    flex-direction: column;\r\n}\r\n\r\n.flexbox-h {\r\n    display: flex;\r\n    flex-direction: row;\r\n}\r\n\r\n.flex-1 {\r\n    flex: 1;\r\n}\r\n\r\n.clearfix::after {\r\n    content: "";\r\n    display: block;\r\n    clear: both;\r\n}\r\n\r\n#main-container {\r\n    height: calc(100% - 15px);\r\n    position: relative;\r\n    contain: strict;\r\n}\r\n\r\n.bottompinned #main-container {\r\n    height: calc(100% - 75px);\r\n}\r\n\r\n#sidebar, #content-outer {\r\n    position: absolute;\r\n    height: 100%;\r\n    overflow-y: auto;\r\n    contain: strict;\r\n}\r\n\r\n#sidebar {\r\n    top: 0;\r\n    left: 0;\r\n    width: 250px;\r\n    background: var(--color-bg-f8);\r\n    border-right: 1px solid var(--color-bg-cc);\r\n    touch-action: pan-y pinch-zoom;\r\n    will-change: transform, scroll-position;\r\n    transition: transform .3s, width .3s;\r\n    transform: translate(0, 0);\r\n    z-index: 1;\r\n}\r\n\r\n#content-outer {\r\n    top: 0;\r\n    left: 250px;\r\n    width: calc(100% - 250px);\r\n    background: var(--color-bg);\r\n    transition: left .3s, width .3s;\r\n}\r\n\r\n@media only screen and (min-width: 800px) {\r\n    #sidebar {\r\n        width: calc(250px + (100vw - 800px) * .2);\r\n    }\r\n    #content-outer {\r\n        left: calc(250px + (100vw - 800px) * .2);\r\n        width: calc(100% - (250px + (100vw - 800px) * .2));\r\n    }\r\n}\r\n\r\n\r\n.float-sidebar #sidebar {\r\n    float: none;\r\n    position: absolute;\r\n    left: 0;\r\n    top: 0;\r\n    z-index: 100;\r\n    transition: transform .3s, opacity .3s;\r\n    width: 250px;\r\n    max-width: 80vw;\r\n    box-shadow: 0 0 20px var(--color-shadow);\r\n}\r\n\r\n.float-sidebar #content-outer {\r\n    left: 0;\r\n    width: 100%;\r\n}\r\n\r\n.float-sidebar #sidebar.hide {\r\n    transform: translate(-100%, 0);\r\n    transition: transform .3s, opacity .3s .3s, width 0s .3s;\r\n    box-shadow: none;\r\n}\r\n\r\n.float-sidebar #sidebar.hide.peek {\r\n    transform: translate(calc(-100% + 3em), 0);\r\n    opacity: .3;\r\n    transition: transform .3s, opacity .3s;\r\n}\r\n\r\n#sidebar-header {\r\n    padding-left: 3em;\r\n    min-height: 3em;\r\n    position: sticky;\r\n    top: 0;\r\n    background: inherit;\r\n    z-index: 3;\r\n    display: flex;\r\n}\r\n\r\n#login-state {\r\n    display: flex;\r\n    flex: 1;\r\n    align-items: center;\r\n    height: 3em;\r\n    overflow: hidden;\r\n}\r\n\r\n#settings-btn {\r\n    display: flex;\r\n    align-items: center;\r\n    text-align: center;\r\n    justify-content: center;\r\n    width: 3em;\r\n}\r\n\r\n#settings-btn svg {\r\n    height: 1.2em;\r\n    width: 1.2em;\r\n}\r\n\r\n#sidebar-features {\r\n    z-index: 2;\r\n    position: relative;\r\n}\r\n\r\n#sidebar-list .section-header {\r\n    position: sticky;\r\n    top: 0;\r\n    padding: .7em;\r\n    padding-top: 4em;\r\n    margin-top: -3.3em;\r\n    z-index: 1;\r\n}\r\n\r\n.sidebar-toggle {\r\n    position: absolute;\r\n    left: 0;\r\n    top: 0;\r\n    z-index: 101;\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n    height: 3em;\r\n    width: 3em;\r\n    background: var(--color-bg-ee);\r\n    color: var(--color-primary-dark);\r\n}\r\n\r\n.sidebar-toggle .logo {\r\n    text-align: center;\r\n    line-height: 1;\r\n    font-size: 1.2em;\r\n    font-weight: 700;\r\n    transition: transform .3s, color .3s;\r\n    transform: scale(1);\r\n}\r\n\r\n.sidebar-toggle:hover .logo {\r\n    color: var(--color-primary);\r\n    transform: scale(1.2);\r\n    transition: transform .2s, color .2s;\r\n}\r\n\r\n.content-header {\r\n    position: relative;\r\n    z-index: 1;\r\n    top: 0;\r\n    background: var(--color-bg);\r\n    animation: showing-top .3s;\r\n    cursor: default;\r\n    /* font-size: 16px; */\r\n    line-height: 1.25;\r\n    align-self: stretch;\r\n}\r\n\r\n.titlebar {\r\n    padding: .5em;\r\n    transition: padding-left .3s;\r\n}\r\n\r\n.float-sidebar .content-header .titlebar {\r\n    padding-left: 3em;\r\n}\r\n\r\n.titlebar .catalog {\r\n    font-size: 120%;\r\n    line-height: 1;\r\n    color: var(--color-text-gray);\r\n    padding: .25em;\r\n    margin-left: .25em;\r\n}\r\n\r\n.titlebar .title {\r\n    vertical-align: baseline;\r\n    display: inline-block;\r\n    font-size: 120%;\r\n    line-height: 1;\r\n    min-height: 1em;\r\n    min-width: 3em;\r\n    padding: .3em;\r\n    margin-left: .3em;\r\n}\r\n\r\n.titlebar .title.editable {\r\n    cursor: text;\r\n}\r\n\r\n.titlebar .title.editable:hover {\r\n    background: var(--color-bg-ee)\r\n}\r\n\r\n.titlebar .title.editing {\r\n    padding: 0;\r\n}\r\n\r\n.titlebar .title input {\r\n    display: inline-block;\r\n    line-height: 1;\r\n    padding: .2em;\r\n    width: 10em;\r\n    font: inherit;\r\n    border: none;\r\n    outline: none;\r\n    background: var(--color-bg-dd);\r\n    color: var(--color-text);\r\n}\r\n\r\n.titlebar .actions {\r\n    float: right;\r\n    vertical-align: middle;\r\n}\r\n\r\n.titlebar .actions .action {\r\n    display: inline-block;\r\n    vertical-align: middle;\r\n    color: var(--color-text-gray);\r\n    margin: .25em;\r\n}\r\n\r\n.titlebar .actions .action.active {\r\n    color: var(--color-text);\r\n}\r\n\r\n.listcontentview {\r\n    display: flex;\r\n    flex-direction: column;\r\n    height: 100%;\r\n}\r\n\r\n.listcontentview > .scrollbox {\r\n    flex: 1;\r\n    overflow-y: auto;\r\n    animation: showing .3s;\r\n    will-change: transform;\r\n}\r\n\r\n.tracklistview {\r\n    padding-bottom: 1.5em;\r\n}\r\n\r\n.section-header {\r\n    display: flex;\r\n    color: var(--color-text-gray);\r\n    padding: .5em;\r\n    font-size: 85%;\r\n    position: sticky;\r\n    top: 0;\r\n}\r\n\r\n#sidebar .section-header {\r\n    background: var(--color-bg-f8);\r\n    z-index: 1;\r\n}\r\n\r\n.section-title {\r\n    flex: 1;\r\n}\r\n\r\n.section-action {\r\n    cursor: pointer;\r\n}\r\n\r\n.section-action:hover {\r\n    color: black;\r\n}\r\n\r\n.indexitem {\r\n    position: relative;\r\n    display: flex;\r\n    align-items: center;\r\n}\r\n\r\n.indexitem > .tag {\r\n    position: absolute;\r\n    left: 1em;\r\n    bottom: .25em;\r\n    font-size: 70%;\r\n    color: var(--color-text-gray);\r\n    text-align: right;\r\n}\r\n\r\n.indexitem > .state {\r\n    margin-left: .5em;\r\n    line-height: 1;\r\n}\r\n\r\n.indexitem > .state > svg {\r\n    height: 1em;\r\n    width: 1em;\r\n}\r\n\r\n.trackitem {\r\n    display: flex;\r\n    align-items: center;\r\n    contain: content;\r\n}\r\n\r\n.trackitem .pos {\r\n    text-align: center;\r\n    flex: 2em;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.trackitem .pos .icon {\r\n    color: var(--color-text);\r\n}\r\n\r\n.trackitem .name, .trackitem .artist, .trackitem .duration,\r\n.trackitem .uploads-state {\r\n    margin-left: .5em;\r\n    overflow-wrap: break-word;\r\n}\r\n\r\n.trackitem .name {\r\n    flex: 1 1 60%;\r\n}\r\n\r\n.trackitem .artist {\r\n    flex: 1 1 40%;\r\n}\r\n\r\n.trackitem .artist, #bottombar-trackinfo .artist {\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.trackitem .duration {\r\n    color: var(--color-text-gray);\r\n    display: none;\r\n}\r\n\r\n.trackitem.uploads-item .uploads-state {\r\n    flex: 4em;\r\n    text-overflow: ellipsis;\r\n    white-space: nowrap;\r\n    overflow: hidden;\r\n    color: #ff6659;\r\n}\r\n\r\n.trackitem.uploads-item.state-error .uploads-state {\r\n    color: #f44336;\r\n}\r\n\r\n.trackitem.uploads-item.state-done .uploads-state {\r\n    color: #66bb6a;\r\n}\r\n/* \r\n@media only screen and (min-width: 1000px) {\r\n    .trackitem .duration {\r\n        display: block;\r\n        flex: 4em;\r\n    }\r\n} */\r\n\r\n@media only screen and (max-width: 500px) {\r\n    .trackitem {\r\n        display: block;\r\n        position: relative;\r\n        padding: .25em;\r\n    }\r\n    .trackitem .name, .trackitem .artist,\r\n    .trackitem.uploads-item .name, .trackitem.uploads-item .uploads-state {\r\n        display: block;\r\n        margin: .15em .5em;\r\n        margin-left: 3em;\r\n        width: auto;\r\n    }\r\n    .trackitem .pos {\r\n        position: absolute;\r\n        margin: .15em;\r\n        width: 2em;\r\n    }\r\n    .trackitem.uploads-item.state-done .uploads-state {\r\n        display: none;\r\n    }\r\n}\r\n\r\n.trackitem.selected {\r\n    background: hsla(5, 100%, 50%, .3);\r\n}\r\n\r\n.trackitem.selected:hover {\r\n    background: hsla(5, 100%, 30%, .3);\r\n}\r\n\r\n.dark .trackitem.selected:hover {\r\n    background: hsla(5, 100%, 60%, .3);\r\n}\r\n\r\n/* .trackitem .artist::before,  */\r\n\r\n#bottombar-trackinfo .artist::before {\r\n    content: " - ";\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n#main-container::after {\r\n    content: "";\r\n    clear: both;\r\n}\r\n\r\n#bottombar {\r\n    position: fixed;\r\n    left: 400px;\r\n    right: 0;\r\n    bottom: -45px;\r\n    height: 75px;\r\n    transform: translate(0, 0);\r\n    transition: transform .3s;\r\n    background: var(--color-bg);\r\n    /* box-shadow: 0 0px 3px var(--color-shadow); */\r\n    z-index: 10001;\r\n    contain: layout;\r\n    will-change: transform;\r\n}\r\n\r\n.bottompinned #bottombar {\r\n    box-sizing: content-box;\r\n    box-shadow: none;\r\n    /* border-top: 1px solid var(--color-bg-cc); */\r\n}\r\n\r\n#bottombar.show {\r\n    transform: translate(0, -45px);\r\n}\r\n\r\n#progressbar {\r\n    position: absolute;\r\n    width: 100%;\r\n    height: 20px;\r\n    transition: width .3s, transform .3s, border-radius .3s, background-color .2s;\r\n    cursor: pointer;\r\n    overflow: hidden;\r\n}\r\n\r\n#progressbar-fill {\r\n    height: 100%;\r\n    transition: border-radius .3s, background-color .2s;\r\n}\r\n\r\n#bottombar.show #progressbar {\r\n    width: calc(100% - 2em - 180px);\r\n    transform: translate(calc(1em + 180px), 7.5px);\r\n}\r\n\r\n#bottombar.show #progressbar, #bottombar.show #progressbar-filxl {\r\n    border-radius: 12.5px;\r\n}\r\n\r\n#progress-outer {\r\n    padding-left: 180px;\r\n    position: absolute;\r\n    top: 9px;\r\n    height: .7em;\r\n    width: 100%;\r\n}\r\n\r\n#progressbar-label-cur, #progressbar-label-total {\r\n    display: none;\r\n    width: 3em;\r\n    margin: 0 10px;\r\n    text-align: center;\r\n    font-size: 70%;\r\n    line-height: 1;\r\n    transition: transform .3s;\r\n}\r\n\r\n#progressbar-label-cur {\r\n    float: left;\r\n    transform: translate(-50px, 0);\r\n}\r\n\r\n#progressbar-label-total {\r\n    float: right;\r\n    transform: translate(50px, 0);\r\n}\r\n\r\n.show #progressbar-label-cur, .show #progressbar-label-total {\r\n    transform: translate(0, 0);\r\n}\r\n\r\n#bottombar-btns {\r\n    position: absolute;\r\n    left: 180px;\r\n    bottom: 8px;\r\n    width: calc(100% - 20px - 180px);\r\n}\r\n\r\n#playcontrol {\r\n    position: absolute;\r\n    left: 10px;\r\n    display: flex;\r\n}\r\n\r\n#playcontrol > * {\r\n    color: var(--color-primary);\r\n    margin: 10px 5px;\r\n    font-size: 50px;\r\n}\r\n\r\n#bottombar-btns .prev_n_next {\r\n    height: 1.4em;\r\n    font-size: 30px;\r\n    line-height: 1;\r\n    margin: 0 .3em;\r\n    vertical-align: middle;\r\n}\r\n\r\n#bottombar-trackinfo {\r\n    display: block;\r\n    margin: 0 1em;\r\n    text-align: center;\r\n    max-height: 1.5em;\r\n    line-height: 1.4;\r\n    overflow: hidden;\r\n    cursor: pointer;\r\n}\r\n\r\n#sidebar-header, #sidebar-features {\r\n    border-bottom: 1px solid var(--color-bg-cc);\r\n}\r\n\r\n#sidebar-header .item, #sidebar-features .item {\r\n    animation: none;\r\n}\r\n\r\n.dark .overlay {\r\n    background: rgba(0, 0, 0, .4);\r\n}\r\n\r\n.dark .input-text {\r\n    border: solid 1px #ccc;\r\n}\r\n\r\n.keyboard-input .btn:focus {\r\n    outline: solid 2px var(--color-primary-dark);\r\n    outline-offset: -2px;\r\n    background: var(--color-primary-darker);\r\n}\r\n\r\n.upload-area {\r\n    margin: .5em;\r\n    padding: .5em;\r\n    text-align: center;\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    justify-content: center;\r\n    min-height: 100px;\r\n    background: var(--color-bg-ee);\r\n    animation: showing-top .3s;\r\n}\r\n\r\n.comment-editor {\r\n    margin: .5em 1em;\r\n}\r\n\r\n.comment-editor-new {\r\n    animation: showing-top .3s;\r\n}\r\n\r\n.comment-editor .content {\r\n    width: 100%;\r\n    height: 5em;\r\n    padding: .5em;\r\n    font-family: inherit;\r\n    font-size: 16px;\r\n    resize: vertical;\r\n}\r\n\r\n.comment-editor .submit {\r\n    margin: 10px 0 0 auto;\r\n    line-height: 2;\r\n    width: 8em;\r\n}\r\n\r\n.comment {\r\n    margin: .7em;\r\n    overflow-wrap: break-word;\r\n}\r\n\r\n.comment .username {\r\n    float: left;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.comment .date {\r\n    float: right;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.comment .content {\r\n    clear: both;\r\n    white-space: pre-wrap;\r\n}\r\n\r\n.btn-progress, .keyboard-input .btn-progress:focus {\r\n    background: #9a0007;\r\n}\r\n\r\n.btn-progress:hover, .keyboard-input .btn-progress:focus:hover {\r\n    background-color: hsl(5, 100%, 20%);\r\n}\r\n\r\n.btn-progress.btn-down, .btn-progress:active {\r\n    background-color: hsl(5, 100%, 10%);\r\n}\r\n\r\n.btn-progress .text {\r\n    position: relative;\r\n}\r\n\r\n.btn-fill {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    height: 100%;\r\n    background-color: var(--color-primary);\r\n    transition: all .2s;\r\n}\r\n\r\n.btn-progress:hover .btn-fill {\r\n    background-color: var(--color-primary-darker);\r\n    transition: all .05s;\r\n}\r\n\r\n.btn-progress.btn-down .btn-fill, .btn-progress:active .btn-fill {\r\n    background: hsl(5, 100%, 50%);\r\n}\r\n\r\n.messagebox-text {\r\n    margin: .3em;\r\n}\r\n\r\n.uploads-usage {\r\n    margin-left: .7em;\r\n}\r\n\r\n.playingview, .lyricsedit {\r\n    display: flex;\r\n    height: 100%;\r\n    justify-content: center;\r\n    align-items: stretch;\r\n    flex-direction: column;\r\n}\r\n\r\n.playingview .infoview {\r\n    animation: showing-top .3s;\r\n}\r\n\r\n.playingview .name, .playingview .artist {\r\n    font-size: 120%;\r\n    text-align: center;\r\n    margin: 0 1em .5em;\r\n}\r\n\r\n.playingview .name {\r\n    margin-top: .3em;\r\n}\r\n\r\n.playingview .pic {\r\n    margin: 20px 0;\r\n    width: 200px;\r\n    height: 200px;\r\n    background: var(--color-bg-dd);\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n}\r\n\r\n.playingview .pic .nopic {\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.playingview .artist {\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.float-sidebar .playingview .pic {\r\n    width: 200px;\r\n    height: 200px;\r\n}\r\n\r\n.playingview .lyricsview, .lyricsedit .lyricsview {\r\n    position: relative;\r\n    flex: 1;\r\n    width: 100%;\r\n    overflow: auto;\r\n    will-change: transform;\r\n    animation: showing .3s;\r\n}\r\n\r\n.lyricsview .line {\r\n    margin: 1em .7em;\r\n    min-height: 1em;\r\n    line-height: 1.3;\r\n    text-align: center;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.lyricsview .line rt {\r\n    font-size: 60%;\r\n}\r\n\r\n.lyricsview .line.active {\r\n    color: var(--color-text);\r\n}\r\n\r\n.lyricsview .line.active .span.active {\r\n    color: var(--color-primary);\r\n    animation: lryics-span-active .2s;\r\n}\r\n\r\n.lyricsview .span.next {\r\n    text-decoration: underline var(--color-primary) 2px;\r\n    min-width: 1em;\r\n}\r\n\r\n.lyricsview .span {\r\n    cursor: pointer;\r\n}\r\n\r\n.lyricsview.edit .span.ts::before {\r\n    content: "[]";\r\n    font-size: 50%;\r\n    color: var(--color-text-gray);\r\n    opacity: .5;\r\n}\r\n\r\n.lyricsview.edit .span.next.ts::before {\r\n    color: var(--color-primary);\r\n    opacity: 1;\r\n}\r\n\r\n.lyricsview .line .trans {\r\n    font-size: 80%;\r\n}\r\n\r\n@keyframes lryics-span-active {\r\n    0%, 100% {\r\n        color: var(--color-primary);\r\n    }\r\n    33% {\r\n        color: var(--color-primary-dark-depends);\r\n    }\r\n}\r\n\r\n.searchbar {\r\n    display: flex;\r\n    align-items: center;\r\n    margin: .3em .7em .7em;\r\n}\r\n\r\n.searchbar .input-text {\r\n    flex: 1;\r\n    line-height: 1.5;\r\n    font-size: inherit;\r\n}\r\n\r\n.searchbar .btn {\r\n    margin-left: .7em;\r\n    line-height: 1.5;\r\n    padding: .2em;\r\n}\r\n\r\n.volume-tip {\r\n    animation: volume-tip-animation .2s;\r\n    pointer-events: none;\r\n}\r\n\r\n.volume-tip.animation-fading-out {\r\n    animation: volume-tip-animation .2s reverse;\r\n    transform: translate(-50%, 0) scale(.5);\r\n    opacity: 0;\r\n    transition: all .2s;\r\n}\r\n\r\n@keyframes volume-tip-animation {\r\n    0% {\r\n        transform: translate(-50%, 0) scale(.5);\r\n        opacity: 0;\r\n    }\r\n    100% {\r\n        transform: translate(-50%, -100%) scale(1);\r\n        opacity: 1;\r\n    }\r\n}\r\n\r\n/*\r\n\r\n.rounded .btn,\r\n.rounded .item,\r\n.rounded .sidebar-toggle,\r\n.rounded .context-menu,\r\n.rounded .toast,\r\n.rounded .input-text,\r\n.rounded .dialog,\r\n.rounded .upload-area {\r\n    border-radius: 19px;\r\n}\r\n\r\n.rounded .input-text {\r\n    padding: .5em 10px;\r\n}\r\n\r\n.rounded #sidebar-features .item,\r\n.rounded #sidebar-list .item {\r\n    border-radius: 0 19px 19px 0;\r\n    margin-right: 6px;\r\n    margin-left: 0;\r\n}\r\n\r\n.rounded .item {\r\n    margin: 2px;\r\n}\r\n\r\n.rounded .context-menu .item {\r\n    margin: 2px 4px;\r\n}\r\n\r\n.rounded .context-menu {\r\n    padding: 2px 0;\r\n}\r\n\r\n.rounded #settings-btn {\r\n    width: 46px;\r\n}\r\n\r\n.rounded #login-state {\r\n    height: 46px;\r\n}\r\n\r\n.rounded .sidebar-toggle {\r\n    left: 2px;\r\n    top: 2px;\r\n    width: 46px;\r\n    height: 46px;\r\n    background: none;\r\n}\r\n\r\n.sidebar-toggle:hover {\r\n    background: var(--color-bg-ee);\r\n}\r\n\r\n*/\r\n\r\n.trackitem .name, .trackitem .artist {\r\n    overflow: hidden;\r\n    display: -webkit-box;\r\n    -webkit-line-clamp: 2;\r\n    -webkit-box-orient: vertical;  \r\n}\r\n\r\n.trackitem .duration {\r\n    text-align: center;\r\n}',{tag:"style#mcloud-injected-style"})}};Y.init(),window.preload.jsOk(),t.app=Y,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=bundle.js.map
