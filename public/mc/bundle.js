!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).mcloud={})}(this,(function(t){"use strict";var e=window&&window.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function fulfilled(t){try{step(i.next(t))}catch(t){r(t)}}function rejected(t){try{step(i.throw(t))}catch(t){r(t)}}function step(t){t.done?s(t.value):function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))};const n=Object.assign,i=Object.prototype.hasOwnProperty;function strPadLeft(t,e,n=" "){for(;t.length<e;)t=n+t;return t}function formatDuration(t){if("number"!=typeof t||isNaN(t))return"--:--";t=Math.round(t);var e=Math.floor(t/60);return t%=60,strPadLeft(e.toString(),2,"0")+":"+strPadLeft(t.toString(),2,"0")}const s=["B","KB","MB","GB"];function formatFileSize(t){if("number"!=typeof t||isNaN(t))return"NaN";for(var e=0;e<s.length-1&&t>=1024;)e++,t/=1024;return t.toFixed(2)+" "+s[e]}function formatDateTime(t){var e=new Date;return t.getFullYear()===e.getFullYear()&&t.getMonth()===e.getMonth()&&t.getDate()===e.getDate()?t.toLocaleTimeString():t.toLocaleString()}function numLimit(t,e,n){return t<e||"number"!=typeof t||isNaN(t)?e:t>n?n:t}function createName(t,e){for(let n=0;;n++){let i=t(n);if(!e(i))return i}}function base64EncodeUtf8(t){return btoa(encodeURIComponent(t).replace(/%([0-9A-F]{2})/g,(function toSolidBytes(t,e){return String.fromCharCode("0x"+e)})))}function sleepAsync(t){return new Promise((e=>{setTimeout(e,t)}))}function arrayRemove(t,e){for(let n=0;n<t.length;n++)t[n]===e&&(t.splice(n,1),n--)}function arrayInsert(t,e,n){void 0===n?t.push(e):t.splice(n,0,e)}function arrayMap(t,e){if(t instanceof Array)return t.map(e);var n=0,i=new Array(t.length);for(var s of t)i[n]=e(s,n),n++;return i}function arrayForeach(t,e){var n=0;for(var i of t)e(i,n++)}function foreachFlaten(t,e){for(const n of t)n instanceof Array?foreachFlaten(n,e):e(n)}function arrayFind(t,e){if(t instanceof Array)return t.find(e);var n=0;for(var i of t)if(e(i,n++))return i;return null}function arraySum(t,e){var n=0;return arrayForeach(t,(t=>{var i=e(t);i&&(n+=i)})),n}function objectApply(t,e,s){if(e){if(!s)return n(t,e);for(const n in e)if(i.call(e,n)&&(!s||s.indexOf(n)>=0)){const i=e[n];t[n]=i}}return t}function objectInit(t,e,n){if(e)for(const s in e)if(i.call(e,s)&&(!n||n.indexOf(s)>=0)){const n=e[s];s.startsWith("on")&&t[s]instanceof r?t[s].add(n):t[s]=n}return t}function mod(t,e){return t<0&&(t=e+t),t%e}Array.prototype.remove=function(t){arrayRemove(this,t)};const r=class CallbacksImpl extends Array{constructor(){super(...arguments),this._hook=void 0}get onChanged(){var t;return null!==(t=this._hook)&&void 0!==t||(this._hook=new r),this._hook}invoke(...t){this.forEach((e=>{try{e.apply(this,t)}catch(t){console.error("Error in callback",t)}}))}add(t){var e;return this.push(t),null===(e=this._hook)||void 0===e||e.invoke(!0,t),t}remove(t){var e;super.remove(t),null===(e=this._hook)||void 0===e||e.invoke(!1,t)}};class Ref{constructor(t){this._value=void 0,this._onChanged=void 0,this._value=t}get onChanged(){return this._onChanged||(this._onChanged=new r),this._onChanged}get value(){return this._value}set value(t){this._value=t,this._onChanged&&this.onChanged.invoke(this)}static from(t){const e=new Ref;return e._value=t,e}}class Lazy{constructor(t){this._func=t,this._value=void 0}get computed(){return!this._func}get rawValue(){return this._value}get value(){return this._func&&(this._value=this._func(),this._func=void 0),this._value}}class Semaphore{constructor(t){this.queue=new Array,this.maxCount=1,this.runningCount=0,objectInit(this,t)}enter(){if(this.runningCount===this.maxCount){var t,e=new Promise((e=>{t=e}));return this.queue.push(t),e}return this.runningCount++,Promise.resolve()}exit(){this.runningCount===this.maxCount&&this.queue.length?window.queueMicrotask?window.queueMicrotask(this.queue.shift()):setTimeout(this.queue.shift(),0):this.runningCount--}run(t){return e(this,void 0,void 0,(function*(){yield this.enter();try{yield t()}finally{this.exit()}}))}}class CancelToken{constructor(){this.cancelled=!1,this.onCancelled=new r}cancel(){this.cancelled||(this.cancelled=!0,this.onCancelled.invoke())}throwIfCancelled(){if(this.cancelled)throw new Error("operation cancelled.")}}class EventRegistrations{constructor(){this.list=[]}add(t,e){return this.list.push({event:t,func:e}),t.add(e),e}removeAll(){for(;this.list.length;){var t=this.list.pop();t.event.remove(t.func)}}}class View{constructor(t){this.parentView=void 0,this._position=void 0,this._domctx=new BuildDOMCtx,this._dom=void 0,this._baseView=void 0,this._mountState=o.Unmounted,this._onActive=void 0,this._childViews=void 0,this._domctx.view=this,t&&this.domExprCreated(t)}static getView(t){return t instanceof View?t:new View(t)}get position(){return this._position}get dom(){return this.ensureDom(),this._dom}get domCreated(){return!!this._dom}get baseView(){return this._baseView}get mountState(){return this._mountState}get hidden(){return this.dom.hidden}set hidden(t){this.dom.hidden=t}ensureDom(){if(!this._dom){var t=this.createDom();this.domExprCreated(t)}}domExprCreated(t){var e=buildView(t,this._domctx);e instanceof View?(this._baseView=e,this._dom=e.dom):this._dom=e,this.postCreateDom(),this.updateDom()}createDom(){return document.createElement("div")}postCreateDom(){View.debugging&&this.dom.dataset&&(this.dom.dataset.webfx=o[this._mountState])}updateDom(){this._domctx.update()}mountStateChanged(t){if(t!=this._mountState){if(this._mountState=t,View.debugging&&!this._baseView&&this.domCreated&&this.dom.dataset&&(this.dom.dataset.webfx==o[t]&&console.trace("mountState on the DOM is changed by other view",t,this),this.dom.dataset.webfx=o[t]),this._baseView)this._baseView.mountStateChanged(t);else if(this._childViews)for(const e of this._childViews)e.mountStateChanged(t)}else console.trace("mountState unchanged",t,this)}getDomById(t){var e,n;return this.ensureDom(),null!==(n=null===(e=this._domctx.dict)||void 0===e?void 0:e[t])&&void 0!==n?n:null}updateWith(t){objectApply(this,t),this.updateDom()}updateAllWith(t){objectApply(this,t),this.updateAll()}toggleClass(t,e){toggleClass(this.dom,t,e)}getDOM(){return this.dom}addChild(t){const e=buildView(t,this._domctx);e instanceof View?this.appendView(e):this.dom.appendChild(e)}get onActive(){return this._onActive||(this._onActive=new r,this.dom.addEventListener("click",(t=>{this._onActive.invoke(t)})),this.dom.addEventListener("keydown",(t=>{this.handleKeyDown(t)}))),this._onActive}handleKeyDown(t){var e;if("Enter"===t.code){const n=this.dom.getBoundingClientRect();null===(e=this._onActive)||void 0===e||e.invoke(new MouseEvent("click",{clientX:n.x,clientY:n.y,relatedTarget:this.dom})),t.preventDefault()}}get childViews(){return this._baseView?this._baseView.childViews:(this._childViews||(this._childViews=[]),this._childViews)}appendView(t){this.addView(t)}addView(t,e){this._registerChild(t,e,!1),this._mountState==o.Mounted&&t.mountStateChanged(o.Mounting),this._insertToDom(t,e),this._mountState!=o.Unmounted&&t.mountStateChanged(this._mountState)}_registerChild(t,e,n=!0){const i=this.childViews;if(t.parentView)throw new Error("the view is already in a container view");if(t.parentView=this,void 0===e)t._position=i.length,i.push(t);else{i.splice(e,0,t);for(let t=e;t<i.length;t++)i[t]._position=t}n&&this._mountState!=o.Unmounted&&t.mountStateChanged(this._mountState)}removeView(t){t=this._ensureItem(t),this._removeFromDom(t);var e=t._position;t.parentView=t._position=void 0,this.childViews.splice(e,1);for(let t=e;t<this.childViews.length;t++)this.childViews[t]._position=t;this._mountState!=o.Unmounted&&t.mountStateChanged(o.Unmounted)}removeAllView(){for(;this.childViews.length;)this.removeView(this.childViews.length-1)}removeFromParent(){this.parentView&&this.parentView.removeView(this)}updateAll(){if(this.updateDom(),this.baseView)return this.baseView.updateAll();this.updateChildren()}updateChildren(){if(this._childViews)for(const t of this._childViews)t.updateAll()}_insertToDom(t,e){var n;null==e?this.dom.appendChild(t.dom):this.dom.insertBefore(t.dom,(null===(n=this.childViews[e+1])||void 0===n?void 0:n.dom)||null)}_removeFromDom(t){t.domCreated&&t.dom.remove()}_ensureItem(t){if("number"==typeof t)t=this.childViews[t];else{if(!t)throw new Error("item is null or undefined.");if(t.parentView!==this)throw new Error("the item is not in this listview.")}return t}}function tryGetDOM(t){return t?t instanceof View?t.getDOM():t instanceof Node?t:t&&"getDOM"in t?t.getDOM():void 0:t}function getDOM(t){var e=tryGetDOM(t);if(!e)throw console.error("getDOM():",t),new Error("getDOM(): unsupported parameter: "+t);return e}function appendView(t,e){warnMountingView(t,e),getDOM(t).appendChild(e.dom)}function addChild(t,e){if(t instanceof View)t.addChild(e);else if(t instanceof Node)warnMountingView(t,e),t.appendChild(buildDOM(e));else{if(!("addChild"in t))throw console.error("addChild():",{parent:t,child:e}),new Error("addChild(): unsupported parent");t.addChild(e)}}function warnMountingView(t,e){if(e instanceof View){const n={parent:t,child:e};t instanceof Node?console.trace("Should use `mountView()` to mount a view to DOM.",n):console.trace("Should use `View.addChild()` or `View.appendView()` to add a view into another view.",n)}}function mountView(t,e){e.mountStateChanged(o.Mounting),t.appendChild(e.dom),e.mountStateChanged(o.Mounted)}function unmountView(t,e){e.dom.remove(),e.mountStateChanged(o.Unmounted)}View.debugging=!1,Node.prototype.getDOM=function(){return console.trace("webfx: Node.getDOM() is deprecated. Please use the exported function `getDOM()` instead."),this},Node.prototype.addChild=function(t){console.trace("webfx: Node.addChild() is deprecated. Please use the exported function `addChild()` instead."),addChild(this,t)},Node.prototype.appendView=function(t){console.trace("webfx: Node.appendView() is deprecated. Please use the exported function `appendView()` instead."),appendView(this,t)};class ContainerView extends View{addView(t,e){return super.addView(t,e)}removeView(t){super.removeView(t)}_insertToDom(t,e){super._insertToDom(t,e)}_removeFromDom(t){super._removeFromDom(t)}_ensureItem(t){return super._ensureItem(t)}get items(){return this.childViews}[Symbol.iterator](){return this.childViews[Symbol.iterator]()}get length(){return this.childViews.length}get(t){return this.childViews[t]}map(t){return arrayMap(this,t)}find(t){return arrayFind(this,t)}forEach(t){return arrayForeach(this,t)}}var o;!function(t){t[t.Unmounted=0]="Unmounted",t[t.Mounting=1]="Mounting",t[t.Mounted=2]="Mounted"}(o||(o={}));class BuildDOMCtx{constructor(){this.dict=void 0,this.actions=void 0,this.view=void 0}setDict(t,e){this.dict||(this.dict={}),this.dict[t]=e}addUpdateAction(t){this.actions||(this.actions=[]),this.actions.push(t)}update(){if(this.actions)for(const t of this.actions)t.run()}}class TextAction{constructor(t,e){this.node=t,this.func=e}run(){this.node.textContent=this.func()}}class HiddenAction{constructor(t,e){this.node=t,this.func=e}run(){this.node.hidden=this.func()}}class UpdateAction{constructor(t,e){this.node=t,this.func=e}run(){this.func(this.node)}}function tryHandleValues(t,e){if("string"==typeof t)return document.createTextNode(t);if("function"==typeof t){const n=t();if(n&&"object"==typeof n)throw new Error("Unexpected function return value");{const i=document.createTextNode(n);return null==e||e.addUpdateAction(new TextAction(i,t)),i}}return Node&&t instanceof Node?t:null}var buildDomCore=function(t,e,n){var i;if(e--<0)throw new Error("ran out of TTL");var s=tryHandleValues(t,n);if(s)return s;if(t instanceof JsxNode&&!((t=t.buildView(n,e))instanceof View))return t;if(t instanceof View)return null===(i=null==n?void 0:n.view)||void 0===i||i._registerChild(t),t.getDOM();const r=t.tag;if(!r)throw new Error("no tag");var o=function(t){for(var e,n,i=/[#\.^]?[\w\-]+/y;e=i.exec(t);){var s=e[0],r=s[0];if("."===r)n.classList.add(s.substr(1));else if("#"===r)n.id=s.substr(1);else{if(n)throw new Error("unexpected multiple tags");n=document.createElement(s)}}return n}(r);for(var a in t)if(t.hasOwnProperty(a)){var l=t[a];buildDOMHandleKey(a,l,o,n,e)}const d=t.init;return d&&d(o),o},buildDOMHandleKey=function(t,e,n,i,s){if("child"===t)e instanceof Array?foreachFlaten(e,(function(t){n.appendChild(buildDomCore(t,s,i))})):n.appendChild(buildDomCore(e,s,i));else if("_id"===t||"_key"===t)i.setDict(e,n);else if("ref"===t)e.value=n;else if("text"===t)"function"==typeof e?i.addUpdateAction(new TextAction(n,e)):n.textContent=e;else if("class"===t)n.className=e;else if("style"===t&&"object"==typeof e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t)){const i=e[t];n.style[t]=i}}else"hidden"===t&&"function"==typeof e?i.addUpdateAction(new HiddenAction(n,e)):"update"===t&&"function"==typeof e?i.addUpdateAction(new UpdateAction(n,e)):"init"===t||(n[t]=e)};function buildDOM(t,e){return buildDomCore(t,32,e||null)}function buildView(t,e){return t instanceof View?t:t instanceof JsxNode?t.buildView(e,64):buildDOM(t,e)}class JsxNode{constructor(t,e,n){this.tag=t,this.attrs=e,this.child=n}getDOM(){return this.buildDom(null,64)}buildDom(t,e){return getDOM(this.buildView(t,e))}buildView(t,e){if(e--<0)throw new Error("ran out of TTL");let n;if("string"==typeof this.tag){const i=document.createElement(this.tag);if(n=i,this.attrs){for(const n in this.attrs)if(Object.prototype.hasOwnProperty.call(this.attrs,n)){const s=this.attrs[n];buildDOMHandleKey(n,s,i,t,e)}const n=this.attrs.init;n&&n(i)}}else if(n=this.tag,this.attrs){let t=null;for(const e in this.attrs)if(Object.prototype.hasOwnProperty.call(this.attrs,e)){const i=this.attrs[e];"init"==e?t=i:"ref"==e?i.value=n:e.startsWith("on")&&n[e]instanceof r?n[e].add(i):n[e]=i}t&&t(n)}return this.child&&foreachFlaten(this.child,n instanceof View?t=>{n.addChild(jsxBuildCore(t,e,n._domctx))}:i=>{var s;const r=jsxBuildCore(i,e,t);r instanceof View?(n.appendChild(r.dom),null===(s=null==t?void 0:t.view)||void 0===s||s._registerChild(r)):addChild(n,r)}),n}addChild(t){null==this.child&&(this.child=[]),this.child.push(t)}}function jsxBuildCore(t,e,n){if(e--<0)throw new Error("ran out of TTL");if(t instanceof View)return t;var i=tryHandleValues(t,n);if(i)return i;if(t instanceof JsxNode)return t.buildView(n,e);throw console.error("Unknown node type",t),new Error("Unknown node type")}function jsxBuild(t,e){return jsxBuildCore(t,64,e||new BuildDOMCtx)}function jsxFactory(t,e,...n){if("string"==typeof t)return new JsxNode(t,e,n);{const i=(null==e?void 0:e.args)?new t(...e.args):new t;return new JsxNode(i,e,n)}}const a=jsxFactory;function clearChildren(t){for(;t.lastChild;)t.removeChild(t.lastChild)}function toggleClass(t,e,n){var i=t.classList;return i.toggle?i.toggle(e,n):(void 0===n&&(n=!i.contains(e)),n?i.add(e):i.remove(e),n)}function fadeout(t,e){const{className:n="fading-out",duration:i=500,remove:s=!0}=e||{};t.classList.add(n);var r=null,end=(e=!0)=>{end&&(end=null,t.removeEventListener("transitionend",onTransitionend),t.classList.remove(n),s&&e&&t.remove(),e&&(null==r||r()))},onTransitionend=function(t){t.eventPhase===Event.AT_TARGET&&(null==end||end())};return t.addEventListener("transitionend",onTransitionend),setTimeout(end,i),{get finished(){return!end},onFinished(t){return end?r=t:t(),this},cancel(t=!1){null==end||end(t)}}}function startBlockingDetect(t=20){var e=Date.now(),n=Date.now();setInterval((()=>{var i=Date.now();i-n>=t&&console.info(`[Blocking] ${(i-e)/1e3}s: blocked for ${i-n} ms`),n=i}),1)}class Timer{constructor(t){this.callback=t,this.cancelFunc=void 0}timeout(t){this.tryCancel();var e=setTimeout(this.callback,t);this.cancelFunc=()=>window.clearTimeout(e)}interval(t){this.tryCancel();var e=setInterval(this.callback,t);this.cancelFunc=()=>window.clearInterval(e)}animationFrame(){this.tryCancel();var t=requestAnimationFrame(this.callback);this.cancelFunc=()=>cancelAnimationFrame(t)}tryCancel(){this.cancelFunc&&(this.cancelFunc(),this.cancelFunc=void 0)}}function listenPointerEvents(t,e,n){var i=!1,mouseDown=function(t){if("track"===e({type:"mouse",ev:t,point:t,action:"down"})){var mousemove=function(t){e({type:"mouse",ev:t,point:t,action:"move"})},mouseup=function(t){document.removeEventListener("mousemove",mousemove,!0),document.removeEventListener("mouseup",mouseup,!0),e({type:"mouse",ev:t,point:t,action:"up"})};document.addEventListener("mousemove",mousemove,!0),document.addEventListener("mouseup",mouseup,!0)}},touchStart=function(s){var r=s.changedTouches[0],o=e({type:"touch",touch:"start",ev:s,point:r,action:i?"move":"down"});if(!i&&"track"===o){i=!0;var touchmove=function(t){var n=t.changedTouches[0];e({type:"touch",touch:"move",ev:t,point:n,action:"move"})},touchend=function(n){0===n.touches.length&&(i=!1,t.removeEventListener("touchmove",touchmove),t.removeEventListener("touchend",touchend),t.removeEventListener("touchcancel",touchend));var s=n.changedTouches[0];e({type:"touch",touch:"end",ev:n,point:s,action:i?"move":"up"})};t.addEventListener("touchmove",touchmove,n),t.addEventListener("touchend",touchend,n),t.addEventListener("touchcancel",touchend,n)}};return t.addEventListener("mousedown",mouseDown,n),t.addEventListener("touchstart",touchStart,n),{remove:()=>{t.removeEventListener("mousedown",mouseDown,n),t.removeEventListener("touchstart",touchStart,n)}}}function listenEvent(t,e,n){return t.addEventListener(e,n),{remove:()=>t.removeEventListener(e,n)}}function listenEvents(t,e,n){return e.forEach((e=>t.addEventListener(e,n))),{remove:()=>e.forEach((e=>t.removeEventListener(e,n)))}}function injectCss(t,e){var n;document.head.appendChild(buildDOM({tag:null!==(n=null==e?void 0:e.tag)&&void 0!==n?n:"style",text:t}))}class TextCompositionWatcher{constructor(t){this.onCompositingChanged=new r,this._isCompositing=!1,this.dom=getDOM(t),this.dom.addEventListener("compositionstart",(t=>{this.isCompositing=!0})),this.dom.addEventListener("compositionend",(t=>{this.isCompositing=!1}))}get isCompositing(){return this._isCompositing}set isCompositing(t){this._isCompositing=t,this.onCompositingChanged.invoke()}}class InputStateTracker{constructor(t){this.dom=t,this.state={mouseDown:!1,mouseIn:!1,focusIn:!1},this._removeEvents=null,this._removePointerEvents=null,this.onChanged=new r,this._removeEvents=listenEvents(t,["mouseenter","mouseleave","focusin","focusout"],(t=>{switch(t.type){case"mouseenter":this.stateChanged("mouseIn",!0);break;case"mouseleave":this.stateChanged("mouseIn",!1);break;case"focusin":this.stateChanged("focusIn",!0);break;case"focusout":this.stateChanged("focusIn",!1)}})).remove,this._removePointerEvents=listenPointerEvents(t,(t=>{if("down"==t.action)return this.stateChanged("mouseDown",!0),"track";"up"==t.action&&this.stateChanged("mouseDown",!1)})).remove}stateChanged(t,e){this.state[t]=e,this.onChanged.invoke(t)}removeListeners(){var t,e;null===(t=this._removeEvents)||void 0===t||t.call(this),null===(e=this._removePointerEvents)||void 0===e||e.call(this),this._removePointerEvents=this._removeEvents=null}}class DataUpdatingHelper{update(t){const e=this.items;var n={};for(const e of t)n[this.dataSelectId(e)]=e;var i={},s=[];for(const t of e){const e=this.selectId(t);void 0!==n[e]?i[e]=t:s.push(t)}for(let t=s.length-1;t>=0;t--)this.removeItem(s[t]);var r=0;for(const e of t){const t=i[this.dataSelectId(e)];void 0!==t?this.updateItem(t,e):this.addItem(e,r),r++}}updateOrRebuildAll(t){this.update(t),this.isSame(t)||this.rebuildAll(t)}isSame(t){var e=this.items[Symbol.iterator]();for(const i of t){var n=e.next();if(n.done)return!1;if(this.selectId(n.value)!==this.dataSelectId(i))return!1}return!!e.next().done}rebuildAll(t){var e=this.items;if(e instanceof Array)for(let t=e.length-1;t>=0;t--)this.removeItem(e[t]);else for(const t of e)this.removeItem(t);let n=0;for(const e of t)this.addItem(e,n++)}selectId(t){return t.id}dataSelectId(t){return t.id}addItem(t,e){}updateItem(t,e){}removeItem(t){}}class I18n{constructor(){this.data={},this.curLang="en",this.missing=new Map}get(t,e){return this.get2(t,e)||t}get2(t,e,n){n=n||this.curLang;var i=this.data[n];if(!i)return console.log("i18n missing lang: "+n),null;var s=i[t];if(!s)return this.missing.has(t)||(this.missing.set(t,1),console.log("i18n missing key: "+t)),null;if(e)for(const t in e)if(e.hasOwnProperty(t)){const n=e[t];s=s.replace("{"+t+"}",n)}return s}add2dArray(t){const e=[],n=t[0];for(const t of n)e.push(this.data[t]=this.data[t]||{});for(let n=1;n<t.length;n++){const i=t[n],s=i[0];for(let t=0;t<i.length;t++){const n=i[t];e[t][s]=n}}}renderElements(t){console.log("i18n elements rendering"),t.forEach((t=>{for(const n of t.childNodes)if(n.nodeType===Node.TEXT_NODE){var e=this.get2(n.beforeI18n||n.textContent);e?(n.beforeI18n=n.beforeI18n||n.textContent,n.textContent=e):(n.beforeI18n&&(n.textContent=n.beforeI18n),console.log("missing key for node",n))}}))}static detectLanguage(t){var e=null,n=-1,i=[];return(navigator.languages||[navigator.language]).forEach((t=>{i.push(t),t.indexOf("-")>0&&i.push(t.substr(0,t.indexOf("-")))})),t.forEach((t=>{var s=i.indexOf(t);(!e||-1!==s&&s<n)&&(e=t,n=s)})),e||t[0]}}function createStringBuilder(t){var e=createArrayBuilder(t);return function(n,...i){return 0===i.length?t.get(n[0]):e(n,...i).join("")}}function createArrayBuilder(t){var e=new WeakMap,n=new Map;return function(i,...s){if(0===s.length)return[t.get(i[0])];let r=e.get(i);if(void 0===r){r="";for(let t=0;t<i.length;t++){r+=i[t],t<s.length&&(r+="{"+t+"}")}e.set(i,r)}const o=t.get(r);let a=n.get(o);return void 0===a&&(a=function parseTemplate(t){const e=[];let n=0,i="";for(let s=0;s<t.length;s++){const r=t[s];switch(r){case"{":if(0==n)n=1;else{if(1!=n)throw new Error(`Expected number, got '${r}' at ${s}`);n=0,i+="{"}break;case"}":if(3==n)n=0,e.push(+i),i="";else if(0==n)n=2;else{if(2!=n)throw new Error(`Expected number, got '${r}' at ${s}`);n=0,i+="}"}break;default:if(2==n)throw new Error(`Expected '}', got '${r}' at ${s}`);1==n&&(n=3,i&&e.push(i),i=""),i+=r}}if(0!=n)throw new Error("Unexpected end of template string");i&&e.push(i);return e}(o)),a.map((t=>"number"==typeof t?s[t]:t))}}var l=new I18n;const d=createStringBuilder(l);function getWebfxCss(){return':root {\n    --color-bg: white;\n    --color-text: black;\n    --color-text-gray: #666;\n    --color-bg-selection: hsl(5, 100%, 85%);\n    --color-primary: hsl(5, 100%, 67%);\n    --color-primary-darker: hsl(5, 100%, 60%);\n    --color-primary-dark: hsl(5, 100%, 40%);\n    --color-primary-dark-depends: hsl(5, 100%, 40%);\n    --color-primary-verydark: hsl(5, 100%, 20%);\n    --color-primary-light: hsl(5, 100%, 83%);\n    --color-primary-lighter: hsl(5, 100%, 70%);\n    --color-fg-11: #111111;\n    --color-fg-22: #222222;\n    --color-fg-33: #333333;\n    --color-bg-cc: #cccccc;\n    --color-bg-dd: #dddddd;\n    --color-bg-ee: #eeeeee;\n    --color-bg-f8: #f8f8f8;\n    --color-shadow: rgba(0, 0, 0, .5);\n}\n\n.no-selection {\n    user-select: none;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n}\n\n/* listview item */\n\n.item {\n    display: block;\n    position: relative;\n    padding: 10px;\n    /* background: #ddd; */\n    /* animation: showing .3s forwards; */\n    text-decoration: none;\n    line-height: 1.2;\n}\n\na.item {\n    color: inherit;\n}\n\n.clickable, .item {\n    cursor: pointer;\n    transition: transform .3s;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.item:hover, .dragover {\n    background: var(--color-bg-ee);\n}\n\n.keyboard-input .item:focus {\n    outline-offset: -2px;\n}\n\n.dragover-placeholder {\n    /* border-top: 2px solid gray; */\n    position: relative;\n}\n\n.dragover-placeholder::before {\n    content: "";\n    display: block;\n    position: absolute;\n    transform: translate(0, -1px);\n    height: 2px;\n    width: 100%;\n    background: gray;\n    z-index: 100;\n    pointer-events: none;\n}\n\n.clickable:active, .item:active {\n    transition: transform .07s;\n    transform: scale(.97);\n}\n\n.item:active {\n    background: var(--color-bg-dd);\n}\n\n.item.no-transform:active {\n    transform: none;\n}\n\n.item.active {\n    background: var(--color-bg-dd);\n}\n\n.loading-indicator {\n    position: relative;\n    margin: .3em;\n    margin-top: 3em;\n    margin-bottom: 1em;\n    text-align: center;\n    white-space: pre-wrap;\n    cursor: default;\n    animation: loading-fadein .3s;\n}\n\n.loading-indicator-text {\n    margin: 0 auto;\n}\n\n.loading-indicator.running .loading-indicator-inner {\n    display: inline-block;\n    position: relative;\n    vertical-align: bottom;\n}\n\n.loading-indicator.running .loading-indicator-inner::after {\n    content: "";\n    height: 1px;\n    margin: 0%;\n    background: var(--color-text);\n    display: block;\n    animation: fadein .5s 1s backwards;\n}\n\n.loading-indicator.running .loading-indicator-text {\n    margin: 0 .5em;\n    animation: fadein .3s, loading-first .3s .5s cubic-bezier(0.55, 0.055, 0.675, 0.19) reverse, loading-second .3s .8s cubic-bezier(0.55, 0.055, 0.675, 0.19), loading .25s 1.1s cubic-bezier(0.55, 0.055, 0.675, 0.19) alternate-reverse infinite;\n}\n\n.loading-indicator.error {\n    color: red;\n}\n\n.loading-indicator.fading-out {\n    transition: max-height;\n    animation: loading-fadein .3s reverse;\n}\n\n@keyframes loading-fadein {\n    0% {\n        opacity: 0;\n        max-height: 0;\n    }\n    100% {\n        opacity: 1;\n        max-height: 200px;\n    }\n}\n\n@keyframes fadein {\n    0% {\n        opacity: 0;\n    }\n    100% {\n        opacity: 1;\n    }\n}\n\n@keyframes loading-first {\n    0% {\n        transform: translate(0, -2em) scale(1) rotate(360deg);\n    }\n    100% {\n        transform: translate(0, 0) scale(1) rotate(0deg);\n    }\n}\n\n@keyframes loading-second {\n    0% {\n        transform: translate(0, -2em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes loading {\n    0% {\n        transform: translate(0, -1em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes showing {\n    0% {\n        opacity: .3;\n        transform: translate(-20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-top {\n    0% {\n        opacity: .3;\n        transform: translate(0, -20px)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-right {\n    0% {\n        opacity: .3;\n        transform: translate(20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n.overlay {\n    background: rgba(0, 0, 0, .2);\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    animation: fadein .3s;\n    z-index: 10001;\n    overflow: hidden;\n    contain: strict;\n    will-change: transform;\n}\n\n.overlay.fixed {\n    position: fixed;\n}\n\n.overlay.nobg {\n    background: none;\n    will-change: auto;\n}\n\n.overlay.centerChild {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.overlay.clickThrough {\n    pointer-events: none;\n}\n\n.dialog * {\n    box-sizing: border-box;\n}\n\n.dialog {\n    font-size: 14px;\n    position: relative;\n    overflow: auto;\n    background: var(--color-bg);\n    border-radius: 5px;\n    box-shadow: 0 0 12px var(--color-shadow);\n    animation: dialogin .2s ease-out;\n    z-index: 10001;\n    display: flex;\n    flex-direction: column;\n    max-height: 100%;\n    contain: content;\n    will-change: transform;\n    pointer-events: auto;\n}\n\n.dialog.resize {\n    resize: both;\n}\n\n.fading-out .dialog {\n    transition: transform .3s ease-in;\n    transform: scale(.85);\n}\n\n.dialog-title, .dialog-content, .dialog-bottom {\n    padding: 10px;\n}\n\n.dialog-title {\n    background: var(--color-bg-ee);\n}\n\n.dialog-content {\n    flex: 1;\n    padding: 5px 10px;\n    overflow: auto;\n}\n\n.dialog-content.flex {\n    display: flex;\n    flex-direction: column;\n}\n\n.dialog-bottom {\n    padding: 5px 10px;\n}\n\n@keyframes dialogin {\n    0% {\n        transform: scale(.85);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n.input-label {\n    font-size: 80%;\n    color: var(--color-text-gray);\n    margin: 5px 0 3px 0;\n}\n\n.input-text {\n    display: block;\n    width: 100%;\n    padding: 5px;\n    border: solid 1px gray;\n    background: var(--color-bg);\n    color: var(--color-text);\n}\n\n.dialog .input-text {\n    margin: 5px 0;\n}\n\ntextarea.input-text {\n    resize: vertical;\n}\n\n.labeled-input {\n    display: flex;\n    flex-direction: column;\n}\n\n.labeled-input .input-text {\n    flex: 1;\n}\n\n.labeled-input:focus-within .input-label {\n    color: var(--color-primary-darker);\n}\n\n.input-text:focus {\n    border-color: var(--color-primary-darker);\n}\n\n.input-text:active {\n    border-color: var(--color-primary-dark);\n}\n\n.btn {\n    display: block;\n    text-align: center;\n    transition: all .2s;\n    padding: 0 .4em;\n    min-width: 3em;\n    line-height: 1.5em;\n    background: var(--color-primary);\n    color: white;\n    text-shadow: 0 0 4px var(--color-primary-verydark);\n    box-shadow: 0 0 3px var(--color-shadow);\n    cursor: pointer;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    user-select: none;\n    position: relative;\n    overflow: hidden;\n}\n\n.btn:hover {\n    transition: all .05s;\n    background: var(--color-primary-darker);\n}\n\n.btn.btn-down, .btn:active {\n    transition: all .05s;\n    background: var(--color-primary-dark);\n    box-shadow: 0 0 1px var(--color-shadow);\n}\n\n.btn.disabled {\n    background: var(--color-primary-light);\n}\n\n.dialog .btn {\n    margin: 10px 0;\n}\n\n.btn-big {\n    padding: 5px;\n}\n\n.btn-inline {\n    display: inline;\n}\n\n.textbtn {\n    display: inline-block;\n    color: var(--color-text-gray);\n    margin: 0 5px;\n}\n\n.textbtn.active {\n    color: var(--color-text);\n}\n\n*[hidden] {\n    display: none !important;\n}\n\n.context-menu {\n    position: absolute;\n    overflow-y: auto;\n    background: var(--color-bg);\n    border: solid 1px #777;\n    box-shadow: 0 0px 12px var(--color-shadow);\n    min-width: 100px;\n    max-width: 450px;\n    outline: none;\n    z-index: 10001;\n    animation: context-menu-in .2s ease-out forwards;\n    will-change: transform;\n}\n\n.context-menu .item.dangerous {\n    transition: color .3s, background .3s;\n    color: red;\n}\n\n.context-menu .item.dangerous:hover {\n    transition: color .1s, background .1s;\n    background: red;\n    color: white;\n}\n\n@keyframes context-menu-in {\n    0% {\n        transform: scale(.9);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n*.menu-shown {\n    background: var(--color-bg-dd);\n}\n\n.menu-info {\n    white-space: pre-wrap;\n    color: var(--color-text-gray);\n    padding: 5px 10px;\n    /* animation: showing .3s; */\n    cursor: default;\n}\n\n.toasts-container {\n    position: fixed;\n    bottom: 0;\n    right: 0;\n    padding: 5px;\n    width: 300px;\n    z-index: 10001;\n    overflow: hidden;\n}\n\n.toast {\n    margin: 5px;\n    padding: 10px;\n    border-radius: 5px;\n    box-shadow: 0 0 10px var(--color-shadow);\n    background: var(--color-bg);\n    white-space: pre-wrap;\n    animation: showing-right .3s;\n}\n\n.fading-out {\n    transition: opacity .3s;\n    opacity: 0;\n    pointer-events: none;\n}\n\n.anchor-bottom {\n    transform: translate(-50%, -100%);\n}\n\n.tooltip {\n    position: absolute;\n    background: var(--color-bg);\n    box-shadow: 0 0 5px var(--color-shadow);\n    border-radius: 5px;\n    padding: .2em .25em;\n}\n'}let h=!1;function injectWebfxCss(){h||(injectCss(':root {\n    --color-bg: white;\n    --color-text: black;\n    --color-text-gray: #666;\n    --color-bg-selection: hsl(5, 100%, 85%);\n    --color-primary: hsl(5, 100%, 67%);\n    --color-primary-darker: hsl(5, 100%, 60%);\n    --color-primary-dark: hsl(5, 100%, 40%);\n    --color-primary-dark-depends: hsl(5, 100%, 40%);\n    --color-primary-verydark: hsl(5, 100%, 20%);\n    --color-primary-light: hsl(5, 100%, 83%);\n    --color-primary-lighter: hsl(5, 100%, 70%);\n    --color-fg-11: #111111;\n    --color-fg-22: #222222;\n    --color-fg-33: #333333;\n    --color-bg-cc: #cccccc;\n    --color-bg-dd: #dddddd;\n    --color-bg-ee: #eeeeee;\n    --color-bg-f8: #f8f8f8;\n    --color-shadow: rgba(0, 0, 0, .5);\n}\n\n.no-selection {\n    user-select: none;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n}\n\n/* listview item */\n\n.item {\n    display: block;\n    position: relative;\n    padding: 10px;\n    /* background: #ddd; */\n    /* animation: showing .3s forwards; */\n    text-decoration: none;\n    line-height: 1.2;\n}\n\na.item {\n    color: inherit;\n}\n\n.clickable, .item {\n    cursor: pointer;\n    transition: transform .3s;\n    -webkit-tap-highlight-color: transparent;\n}\n\n.item:hover, .dragover {\n    background: var(--color-bg-ee);\n}\n\n.keyboard-input .item:focus {\n    outline-offset: -2px;\n}\n\n.dragover-placeholder {\n    /* border-top: 2px solid gray; */\n    position: relative;\n}\n\n.dragover-placeholder::before {\n    content: "";\n    display: block;\n    position: absolute;\n    transform: translate(0, -1px);\n    height: 2px;\n    width: 100%;\n    background: gray;\n    z-index: 100;\n    pointer-events: none;\n}\n\n.clickable:active, .item:active {\n    transition: transform .07s;\n    transform: scale(.97);\n}\n\n.item:active {\n    background: var(--color-bg-dd);\n}\n\n.item.no-transform:active {\n    transform: none;\n}\n\n.item.active {\n    background: var(--color-bg-dd);\n}\n\n.loading-indicator {\n    position: relative;\n    margin: .3em;\n    margin-top: 3em;\n    margin-bottom: 1em;\n    text-align: center;\n    white-space: pre-wrap;\n    cursor: default;\n    animation: loading-fadein .3s;\n}\n\n.loading-indicator-text {\n    margin: 0 auto;\n}\n\n.loading-indicator.running .loading-indicator-inner {\n    display: inline-block;\n    position: relative;\n    vertical-align: bottom;\n}\n\n.loading-indicator.running .loading-indicator-inner::after {\n    content: "";\n    height: 1px;\n    margin: 0%;\n    background: var(--color-text);\n    display: block;\n    animation: fadein .5s 1s backwards;\n}\n\n.loading-indicator.running .loading-indicator-text {\n    margin: 0 .5em;\n    animation: fadein .3s, loading-first .3s .5s cubic-bezier(0.55, 0.055, 0.675, 0.19) reverse, loading-second .3s .8s cubic-bezier(0.55, 0.055, 0.675, 0.19), loading .25s 1.1s cubic-bezier(0.55, 0.055, 0.675, 0.19) alternate-reverse infinite;\n}\n\n.loading-indicator.error {\n    color: red;\n}\n\n.loading-indicator.fading-out {\n    transition: max-height;\n    animation: loading-fadein .3s reverse;\n}\n\n@keyframes loading-fadein {\n    0% {\n        opacity: 0;\n        max-height: 0;\n    }\n    100% {\n        opacity: 1;\n        max-height: 200px;\n    }\n}\n\n@keyframes fadein {\n    0% {\n        opacity: 0;\n    }\n    100% {\n        opacity: 1;\n    }\n}\n\n@keyframes loading-first {\n    0% {\n        transform: translate(0, -2em) scale(1) rotate(360deg);\n    }\n    100% {\n        transform: translate(0, 0) scale(1) rotate(0deg);\n    }\n}\n\n@keyframes loading-second {\n    0% {\n        transform: translate(0, -2em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes loading {\n    0% {\n        transform: translate(0, -1em);\n    }\n    100% {\n        transform: translate(0, 0);\n    }\n}\n\n@keyframes showing {\n    0% {\n        opacity: .3;\n        transform: translate(-20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-top {\n    0% {\n        opacity: .3;\n        transform: translate(0, -20px)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n@keyframes showing-right {\n    0% {\n        opacity: .3;\n        transform: translate(20px, 0)\n    }\n    100% {\n        opacity: 1;\n        transform: translate(0, 0)\n    }\n}\n\n.overlay {\n    background: rgba(0, 0, 0, .2);\n    position: absolute;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    animation: fadein .3s;\n    z-index: 10001;\n    overflow: hidden;\n    contain: strict;\n    will-change: transform;\n}\n\n.overlay.fixed {\n    position: fixed;\n}\n\n.overlay.nobg {\n    background: none;\n    will-change: auto;\n}\n\n.overlay.centerChild {\n    display: flex;\n    align-items: center;\n    justify-content: center;\n}\n\n.overlay.clickThrough {\n    pointer-events: none;\n}\n\n.dialog * {\n    box-sizing: border-box;\n}\n\n.dialog {\n    font-size: 14px;\n    position: relative;\n    overflow: auto;\n    background: var(--color-bg);\n    border-radius: 5px;\n    box-shadow: 0 0 12px var(--color-shadow);\n    animation: dialogin .2s ease-out;\n    z-index: 10001;\n    display: flex;\n    flex-direction: column;\n    max-height: 100%;\n    contain: content;\n    will-change: transform;\n    pointer-events: auto;\n}\n\n.dialog.resize {\n    resize: both;\n}\n\n.fading-out .dialog {\n    transition: transform .3s ease-in;\n    transform: scale(.85);\n}\n\n.dialog-title, .dialog-content, .dialog-bottom {\n    padding: 10px;\n}\n\n.dialog-title {\n    background: var(--color-bg-ee);\n}\n\n.dialog-content {\n    flex: 1;\n    padding: 5px 10px;\n    overflow: auto;\n}\n\n.dialog-content.flex {\n    display: flex;\n    flex-direction: column;\n}\n\n.dialog-bottom {\n    padding: 5px 10px;\n}\n\n@keyframes dialogin {\n    0% {\n        transform: scale(.85);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n.input-label {\n    font-size: 80%;\n    color: var(--color-text-gray);\n    margin: 5px 0 3px 0;\n}\n\n.input-text {\n    display: block;\n    width: 100%;\n    padding: 5px;\n    border: solid 1px gray;\n    background: var(--color-bg);\n    color: var(--color-text);\n}\n\n.dialog .input-text {\n    margin: 5px 0;\n}\n\ntextarea.input-text {\n    resize: vertical;\n}\n\n.labeled-input {\n    display: flex;\n    flex-direction: column;\n}\n\n.labeled-input .input-text {\n    flex: 1;\n}\n\n.labeled-input:focus-within .input-label {\n    color: var(--color-primary-darker);\n}\n\n.input-text:focus {\n    border-color: var(--color-primary-darker);\n}\n\n.input-text:active {\n    border-color: var(--color-primary-dark);\n}\n\n.btn {\n    display: block;\n    text-align: center;\n    transition: all .2s;\n    padding: 0 .4em;\n    min-width: 3em;\n    line-height: 1.5em;\n    background: var(--color-primary);\n    color: white;\n    text-shadow: 0 0 4px var(--color-primary-verydark);\n    box-shadow: 0 0 3px var(--color-shadow);\n    cursor: pointer;\n    -ms-user-select: none;\n    -moz-user-select: none;\n    -webkit-user-select: none;\n    user-select: none;\n    position: relative;\n    overflow: hidden;\n}\n\n.btn:hover {\n    transition: all .05s;\n    background: var(--color-primary-darker);\n}\n\n.btn.btn-down, .btn:active {\n    transition: all .05s;\n    background: var(--color-primary-dark);\n    box-shadow: 0 0 1px var(--color-shadow);\n}\n\n.btn.disabled {\n    background: var(--color-primary-light);\n}\n\n.dialog .btn {\n    margin: 10px 0;\n}\n\n.btn-big {\n    padding: 5px;\n}\n\n.btn-inline {\n    display: inline;\n}\n\n.textbtn {\n    display: inline-block;\n    color: var(--color-text-gray);\n    margin: 0 5px;\n}\n\n.textbtn.active {\n    color: var(--color-text);\n}\n\n*[hidden] {\n    display: none !important;\n}\n\n.context-menu {\n    position: absolute;\n    overflow-y: auto;\n    background: var(--color-bg);\n    border: solid 1px #777;\n    box-shadow: 0 0px 12px var(--color-shadow);\n    min-width: 100px;\n    max-width: 450px;\n    outline: none;\n    z-index: 10001;\n    animation: context-menu-in .2s ease-out forwards;\n    will-change: transform;\n}\n\n.context-menu .item.dangerous {\n    transition: color .3s, background .3s;\n    color: red;\n}\n\n.context-menu .item.dangerous:hover {\n    transition: color .1s, background .1s;\n    background: red;\n    color: white;\n}\n\n@keyframes context-menu-in {\n    0% {\n        transform: scale(.9);\n    }\n    100% {\n        transform: scale(1);\n    }\n}\n\n*.menu-shown {\n    background: var(--color-bg-dd);\n}\n\n.menu-info {\n    white-space: pre-wrap;\n    color: var(--color-text-gray);\n    padding: 5px 10px;\n    /* animation: showing .3s; */\n    cursor: default;\n}\n\n.toasts-container {\n    position: fixed;\n    bottom: 0;\n    right: 0;\n    padding: 5px;\n    width: 300px;\n    z-index: 10001;\n    overflow: hidden;\n}\n\n.toast {\n    margin: 5px;\n    padding: 10px;\n    border-radius: 5px;\n    box-shadow: 0 0 10px var(--color-shadow);\n    background: var(--color-bg);\n    white-space: pre-wrap;\n    animation: showing-right .3s;\n}\n\n.fading-out {\n    transition: opacity .3s;\n    opacity: 0;\n    pointer-events: none;\n}\n\n.anchor-bottom {\n    transform: translate(-50%, -100%);\n}\n\n.tooltip {\n    position: absolute;\n    background: var(--color-bg);\n    box-shadow: 0 0 5px var(--color-shadow);\n    border-radius: 5px;\n    padding: .2em .25em;\n}\n',{tag:"style.webfx-injected-style"}),h=!0)}class TextView extends View{constructor(){super(...arguments),this._text="",this.textFunc=null}get text(){var t,e;return null!==(e=null===(t=this.dom)||void 0===t?void 0:t.textContent)&&void 0!==e?e:this._text}set text(t){"function"==typeof t?(this._text=t(),this.textFunc=t):(this._text=t,this.textFunc=null),this.domCreated&&(this.dom.textContent=this._text)}postCreateDom(){super.postCreateDom(),this._text&&(this.dom.textContent=this._text)}updateDom(){super.updateDom(),this.textFunc&&(this.dom.textContent=this.textFunc())}}class ButtonView extends TextView{constructor(t){super(),this.disabled=!1,this.type="normal",objectInit(this,t),this.updateDom()}createDom(){return{tag:"div.btn",tabIndex:0}}updateDom(){super.updateDom(),this.toggleClass("disabled",this.disabled),this.toggleClass("btn-big","big"===this.type),this.toggleClass("btn-inline","inline"===this.type)}}class TextBtn extends TextView{constructor(t){super(),this.clickable=!0,this.active=!1,this.right=!1,objectInit(this,t)}createDom(){return{tag:"span.textbtn.no-selection"}}updateDom(){super.updateDom(),this.dom.tabIndex=this.clickable?0:-1,this.toggleClass("clickable",this.clickable),this.toggleClass("active",this.active),this.dom.style.float=this.right?"right":"left"}}const c=TextBtn;function setPosition(t,e){let{x:n=0,y:i=0,anchor:s="bottom"}=e;t.style.left=n+"px",t.style.top=i+"px",t.classList.contains("anchor-"+s)||(t.classList.forEach((e=>{e.startsWith("anchor-")&&t.classList.remove(e)})),t.classList.add("anchor-"+s))}var u,p=new class DragManager{constructor(){this._currentItem=null,this._currentArray=null,this.onDragStart=new r,this.onDragEnd=new r}get currentItem(){var t,e,n;return null!==(n=null!==(t=this._currentItem)&&void 0!==t?t:null===(e=this._currentArray)||void 0===e?void 0:e[0])&&void 0!==n?n:null}get currentArray(){return this._currentItem?[this._currentItem]:this._currentArray}start(t){this._currentItem=t,console.log("drag start",t),this.onDragStart.invoke()}startArray(t){this._currentArray=t,console.log("drag start array",t),this.onDragStart.invoke()}end(){this._currentItem=null,this._currentArray=null,console.log("drag end"),this.onDragEnd.invoke()}};class EditableHelper{constructor(t){this.editing=!1,this.beforeEdit=null,this.onComplete=null,this.element=t}startEdit(t){if(!this.editing){this.editing=!0;var e=this.element,n=this.beforeEdit=e.textContent;toggleClass(e,"editing",!0);for(var i=buildDOM({tag:"input",type:"text",value:n});e.firstChild;)e.removeChild(e.firstChild);e.appendChild(i),i.select(),i.focus();var stopEdit=()=>{var n;this.editing=!1,toggleClass(e,"editing",!1),s.forEach((t=>t.remove())),i.remove(),null===(n=this.onComplete)||void 0===n||n.call(this,i.value),null==t||t(i.value)},s=[listenEvent(i,"keydown",(t=>{"Enter"===t.code&&(stopEdit(),t.preventDefault())})),listenEvent(i,"focusout",(t=>{stopEdit()}))]}}startEditAsync(){return new Promise((t=>this.startEdit(t)))}}class ViewToggle{constructor(t){this.shownKeys=[],this.toggleMode="remove",this.container=null,objectInit(this,t),this.setShownKeys(this.shownKeys)}add(t,e){const n=this.items[t];n?n instanceof Array?this.items[t].push(e):this.items[t]=[n,e]:this.items[t]=e,this.toggleView(e,this.shownKeys.indexOf(t)>=0)}setShownKeys(t){this.shownKeys=t;const e=this.items;for(const n in e){const i=t.indexOf(n)>=0;if(Object.prototype.hasOwnProperty.call(e,n)){const t=e[n];if(t)if(t instanceof Array)for(const e of t)this.toggleView(e,i);else t&&this.toggleView(t,i)}}}toggleView(t,e,n){if(n||(n=this.toggleMode),"display"==n)t.dom.style.display=e?"":"none";else if("hidden"==n)t.dom.hidden=!e;else{if("remove"!=n)throw new Error("Unknown toggle mode");e!=!!t.parentView&&(e?this.container.appendView(t):this.container.removeView(t))}}}class ItemActiveHelper{constructor(t){this.funcSetActive=(t,e)=>t.toggleClass("active",e),this.current=null,objectInit(this,t)}set(t){this.current!==t&&(this.current&&this.funcSetActive(this.current,!1),this.current=t,this.current&&this.funcSetActive(this.current,!0))}}class ToolTip extends TextView{constructor(){super(...arguments),this._shown=!1,this._timer=new Timer((()=>this.close())),this._cancelClose=null}createDom(){return{tag:"div.tooltip"}}get shown(){return this._shown}show(t){var e;if(this.shown)return;this._shown=!0,null===(e=this._cancelClose)||void 0===e||e.call(this);let{parent:n=document.body,timeout:i}=t;i&&this._timer.timeout(i);const s=this.dom;setPosition(s,t),n.appendChild(s)}close(t){this.shown&&(this._timer.tryCancel(),this._shown=!1,this._cancelClose=fadeout(this.dom,t).cancel)}}!function(t){t.FlagsInput=class FlagsInput extends ContainerView{constructor(t){super(),null==t||t.forEach((t=>{var e=t instanceof Flag?t:new Flag({text:Object.prototype.toString.call(t)});this.addView(e)}))}createDom(){return{tag:"div.flags-input"}}};class Flag extends TextView{get parentInput(){return this.parentView}constructor(t){super(),objectInit(this,t)}createDom(){return{tag:"div.flags-input-item"}}}t.Flag=Flag}(u||(u={}));class Overlay extends View{createDom(){return{tag:"div.overlay"}}setCenterChild(t){return this.setFlags({centerChild:t})}setNoBg(t){return this.setFlags({nobg:t})}setFixed(t){return this.setFlags({fixed:t})}setFlags(t){for(const e in t)Object.prototype.hasOwnProperty.call(t,e)&&this.toggleClass(e,t[e]);return this}}var g=window&&window.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function fulfilled(t){try{step(i.next(t))}catch(t){r(t)}}function rejected(t){try{step(i.throw(t))}catch(t){r(t)}}function step(t){t.done?s(t.value):function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))};class Dialog extends View{constructor(){super(),this.parent=Dialog.defaultParent,this.overlay=(new Overlay).setFlags({centerChild:!0,nobg:!0}),this.header=new View({tag:"div.dialog-title.clearfix"}),this.content=new View({tag:"div.dialog-content"}),this.shown=!1,this.btnTitle=new TextBtn({active:!0,clickable:!1}),this.btnClose=new TextBtn({text:d`Close`,right:!0}),this.title="Dialog",this.allowClose=!0,this.showCloseButton=!0,this.onShown=new r,this.onClose=new r,this.focusTrap=new View({tag:"div.focustrap",tabIndex:0}),this.btnClose.onActive.add((()=>this.allowClose&&this.close()))}get domheader(){return this.header.dom}static get defaultParent(){return Dialog._defaultParent||(Dialog._defaultParent=new DialogParent),Dialog._defaultParent}static set defaultParent(t){Dialog._defaultParent=t}get width(){return this.dom.style.width}set width(t){this.dom.style.width=t}get contentFlex(){return this.content.dom.classList.contains("flex")}set contentFlex(t){this.content.toggleClass("flex",!!t)}get resizable(){return this.dom.classList.contains("resize")}set resizable(t){this.toggleClass("resize",!!t)}createDom(){return{tag:"div.dialog",tabIndex:0,style:"width: 300px",child:[this.header,this.content,this.focusTrap]}}postCreateDom(){super.postCreateDom(),this.addBtn(this.btnTitle),this.addBtn(this.btnClose),this.overlay.appendView(this),this.overlay.dom.addEventListener("mousedown",(t=>{this.allowClose&&0===t.button&&t.target===this.overlay.dom&&(t.preventDefault(),this.close())})),this.overlay.dom.addEventListener("keydown",(t=>{if(this.allowClose&&27===t.keyCode)t.preventDefault(),this.close();else if(t.target===this.dom&&"Tab"===t.code&&t.shiftKey){t.preventDefault();let e=this.dom.querySelectorAll("a, [tabindex]");e.length>=2&&e[e.length-2].focus&&e[e.length-2].focus()}}));{let t;listenPointerEvents(this.header.dom,(e=>{if("down"===e.action){if(e.ev.target!==this.header.dom&&e.ev.target!==this.btnTitle.dom)return;e.ev.preventDefault();const n=this.overlay.dom.getBoundingClientRect(),i=this.dom.getBoundingClientRect();return t={x:e.point.pageX-n.x-i.x,y:e.point.pageY-n.y-i.y},"track"}if("move"===e.action){e.ev.preventDefault();const n=this.overlay.dom.getBoundingClientRect(),i=numLimit(e.point.pageX,n.left,n.right),s=numLimit(e.point.pageY,n.top,n.bottom);this.setOffset(i-t.x,s-t.y)}}))}this.focusTrap.dom.addEventListener("focus",(t=>{this.dom.focus()}))}updateDom(){super.updateDom(),this.btnTitle.updateWith({text:this.title}),this.btnTitle.hidden=!this.title,this.btnClose.hidden=!(this.allowClose&&this.showCloseButton)}addBtn(t){this.ensureDom(),this.header.appendView(t)}addContent(t,e){this.ensureDom(),e&&this.content.removeAllView(),this.content.addChild(t)}addChild(t){this.addContent(t)}setOffset(t,e){this.dom.style.left=t?t+"px":"",this.dom.style.top=e?e+"px":"",this.overlay.setCenterChild(!1)}getOffset(){return{x:this.dom.style.left?parseFloat(this.dom.style.left):0,y:this.dom.style.top?parseFloat(this.dom.style.top):0}}center(){this.setOffset(0,0),this.overlay.setCenterChild(!0)}show(t){var e;this.shown||(this.shown=!0,null===(e=this._cancelFadeout)||void 0===e||e.call(this,!0),this.ensureDom(),this.parent.onDialogShowing(this),this.setTransformOrigin(t),this.dom.focus(),(this.autoFocus||this).dom.focus(),this.onShown.invoke())}setTransformOrigin(t){if(t){const e=this.dom.getBoundingClientRect();this.dom.style.transformOrigin=`${t.x-e.x}px ${t.y-e.y}px`}else this.dom.style.transformOrigin=""}close(){this.shown&&(this.shown=!1,this.setTransformOrigin(void 0),this.onClose.invoke(),this._cancelFadeout=fadeout(this.overlay.dom).onFinished((()=>{var t;return null===(t=this.overlay.parentView)||void 0===t?void 0:t.removeView(this.overlay)})).cancel,Dialog.defaultParent.onDialogClosing(this))}waitClose(){return new Promise((t=>{var e=this.onClose.add((()=>{this.onClose.remove(e),t()}))}))}}Dialog._defaultParent=null;class MessageBox extends Dialog{constructor(){super(...arguments),this.allowClose=!1,this.title="Message",this.result="none"}addResultBtns(t){for(const e of t)this.addBtnWithResult(new TextBtn({text:l.get("msgbox_"+e),right:!0}),e);return this}setTitle(t){return this.title=t,this.domCreated&&this.updateDom(),this}addText(t){return this.addContent(new TextView({tag:"div.messagebox-text",text:t})),this}allowCloseWithResult(t,e){return this.result=t,this.allowClose=!0,this.showCloseButton=!!e,this.domCreated&&this.updateDom(),this}addBtnWithResult(t,e){return t.onActive.add((()=>{this.result=e,this.close()})),this.addBtn(t),this}showAndWaitResult(){return g(this,void 0,void 0,(function*(){return this.show(),yield this.waitClose(),this.result}))}}class DialogParent{constructor(t=document.body){this.bgOverlay=new Overlay,this.dialogCount=0,this.fixed=!1,this._cancelFadeout=null,this.view=View.getView(t),t===document.body&&(this.fixed=!0,this.view.mountStateChanged(o.Mounted))}onDialogShowing(t){var e;0==this.dialogCount++&&(null===(e=this._cancelFadeout)||void 0===e||e.call(this,!0),this.bgOverlay.setFlags({fixed:this.fixed,clickThrough:!0}),this.view.appendView(this.bgOverlay)),t.overlay.setFlags({fixed:this.fixed}),this.view.appendView(t.overlay)}onDialogClosing(t){0==--this.dialogCount&&(this._cancelFadeout=fadeout(this.bgOverlay.dom).onFinished((()=>this.view.removeView(this.bgOverlay))).cancel)}}class InputView extends View{constructor(t){super(),this.multiline=!1,this.type="text",this.placeholder="",objectInit(this,t)}get value(){return this.dom.value}set value(t){this.dom.value=t}createDom(){return this.multiline?{tag:"textarea.input-text"}:{tag:"input.input-text"}}updateDom(){super.updateDom(),this.dom instanceof HTMLInputElement&&(this.dom.type=this.type,this.dom.placeholder=this.placeholder)}}class LabeledInputBase extends View{constructor(t){super(),this.label="",objectInit(this,t)}get dominput(){return this.input.dom}createDom(){return{tag:"div.labeled-input",child:[{tag:"div.input-label",text:()=>this.label},this.input]}}updateDom(){super.updateDom(),this.input.domCreated&&this.input.updateDom()}}class LabeledInput extends LabeledInputBase{constructor(t){super(),objectInit(this,t),this.input||(this.input=new InputView)}get value(){return this.dominput.value}set value(t){this.dominput.value=t}updateDom(){this.input.type=this.type,super.updateDom()}}class ListViewItem extends View{constructor(){super(...arguments),this.dragging=void 0,this._selected=!1,this.onSelectedChanged=new r,this.enterctr=0,this.dragoverPlaceholder=null}get listview(){return this.parentView instanceof ListView?this.parentView:null}get selectionHelper(){var t;return null===(t=this.listview)||void 0===t?void 0:t.selectionHelper}get dragData(){return this.dom.textContent}get selected(){return this._selected}set selected(t){this._selected=t,this.domCreated&&this.updateDom(),this.onSelectedChanged.invoke()}remove(){this.listview&&this.listview.remove(this)}postCreateDom(){super.postCreateDom(),this.dom.setAttribute("role","listitem"),this.dom.addEventListener("click",(t=>{var e,n,i;(null===(e=this.listview)||void 0===e?void 0:e.selectionHelper.handleItemClicked(this,t))||null===(i=null===(n=this.listview)||void 0===n?void 0:n.onItemClicked)||void 0===i||i.call(n,this)})),this.dom.addEventListener("keydown",(t=>{var e,n,i,s,r,o;if("Enter"===t.code){if(t.altKey){const t=this.dom.getBoundingClientRect(),s=new MouseEvent("contextmenu",{clientX:t.left,clientY:t.top,relatedTarget:this.dom});null===(i=null!==(e=this.onContextMenu)&&void 0!==e?e:null===(n=this.listview)||void 0===n?void 0:n.onContextMenu)||void 0===i||i(this,s)}else{if(null===(s=this.listview)||void 0===s?void 0:s.selectionHelper.handleItemClicked(this,t))return;null===(o=null===(r=this.listview)||void 0===r?void 0:r.onItemClicked)||void 0===o||o.call(r,this)}t.preventDefault()}else if(!this.listview||"ArrowUp"!==t.code&&"ArrowDown"!==t.code)if(!this.listview||"PageUp"!==t.code&&"PageDown"!==t.code)!this.listview||"Home"!==t.code&&"End"!==t.code?this.listview&&this.listview.selectionHelper.handleItemKeyDown(this,t):(this.listview.get("Home"==t.code?0:this.listview.length-1).dom.focus(),t.preventDefault());else{const e="PageUp"===t.code?-1:1,n=this.listview.scrollBox,i=e>0?this.dom.offsetTop+n.offsetHeight:this.dom.offsetTop+this.dom.offsetHeight-n.offsetHeight,s=this.listview.length;let r=this;for(;e>0?i>r.dom.offsetTop+r.dom.offsetHeight:i<r.dom.offsetTop;){const t=r.position+e;if(t<0||t>=s)break;r=this.listview.get(t)}r&&r!==this&&(r.dom.focus(),t.preventDefault())}else{const e="ArrowUp"===t.code?-1:1,n=this.listview.get(this.position+e);n&&(n.dom.focus(),t.preventDefault())}})),this.dom.addEventListener("contextmenu",(t=>{var e,n,i;null===(i=null!==(e=this.onContextMenu)&&void 0!==e?e:null===(n=this.listview)||void 0===n?void 0:n.onContextMenu)||void 0===i||i(this,t)})),this.dom.addEventListener("dragstart",(t=>{var e,n;if(null!==(e=this.dragging)&&void 0!==e?e:null===(n=this.listview)||void 0===n?void 0:n.dragging){var i=[];this.selected&&this.selectionHelper?(i=[...this.selectionHelper.selectedItems]).sort(((t,e)=>t.position-e.position)):i=[this],p.startArray(i),t.dataTransfer.setData("text/plain",i.map((t=>t.dragData)).join("\r\n")),i.forEach((t=>t.dom.style.opacity=".5"))}else t.preventDefault()})),this.dom.addEventListener("dragend",(t=>{var e=p.currentArray;p.end(),t.preventDefault(),e.forEach((t=>t.dom.style.opacity=""))})),this.dom.addEventListener("dragover",(t=>{this.dragHandler(t,"dragover")})),this.dom.addEventListener("dragenter",(t=>{this.dragHandler(t,"dragenter")})),this.dom.addEventListener("dragleave",(t=>{this.dragHandler(t,"dragleave")})),this.dom.addEventListener("drop",(t=>{this.dragHandler(t,"drop")}))}dragHandler(t,e){var n,i,s,r,o,a,l,d;const h=p.currentItem;let c=p.currentArray;const u="drop"===e,g={source:h,target:this,sourceItems:c,event:t,drop:u,accept:!1};if(h instanceof ListViewItem&&(null===(n=this.listview)||void 0===n?void 0:n.moveByDragging)&&h.listview===this.listview){t.preventDefault();const e=c.indexOf(this)>=0,n=t.clientY-this.dom.getBoundingClientRect().top>this.dom.offsetHeight/2;if(e&&u||(g.accept=n?"move-after":"move"),u){if(-1===c.indexOf(this)){let t=this.position;n&&t++;for(const e of c)e!==this&&(t>e.position&&t--,this.listview.move(e,t),t++)}}else t.dataTransfer.dropEffect="move"}const m=null!==(i=this.onDragover)&&void 0!==i?i:null===(s=this.listview)||void 0===s?void 0:s.onDragover;!g.accept&&m&&(m(g),(u||g.accept)&&t.preventDefault());const v=null!==(r=this.onContextMenu)&&void 0!==r?r:null===(o=this.listview)||void 0===o?void 0:o.onContextMenu;if(!g.accept&&c&&c.indexOf(this)>=0&&v&&(u?v(this,t):t.preventDefault()),"dragenter"===e||"dragover"==e||"dragleave"===e||u){"dragenter"===e?this.enterctr++:"dragleave"===e?this.enterctr--:"drop"===e&&(this.enterctr=0);let t=this.enterctr>0;this.toggleClass("dragover",t);let n=t&&("move"===g.accept||"move-after"===g.accept)&&g.accept;if(n!=(null!==(l=null===(a=this.dragoverPlaceholder)||void 0===a?void 0:a[1])&&void 0!==l&&l)&&(null===(d=this.dragoverPlaceholder)||void 0===d||d[0].remove(),this.dragoverPlaceholder=null,n)){this.dragoverPlaceholder=[buildDOM({tag:"div.dragover-placeholder"}),n];var w=this.dom;"move-after"===g.accept&&(w=w.nextElementSibling),this.dom.parentElement.insertBefore(this.dragoverPlaceholder[0],w)}}}}class ListView extends ContainerView{constructor(t){super(t),this.onItemClicked=null,this.dragging=!1,this.moveByDragging=!1,this.selectionHelper=new SelectionHelper,this._scrollBox=null,this.onItemMoved=null,this.onDragover=null,this.onContextMenu=null,this.selectionHelper.itemProvider=this}get scrollBox(){return this._scrollBox||this.dom}set scrollBox(t){this._scrollBox=t}postCreateDom(){super.postCreateDom(),this.dom.setAttribute("role","list")}add(t,e){this.addView(t,e),this.dragging&&(t.dom.draggable=!0)}remove(t,e){t=this._ensureItem(t),!e&&t.selected&&this.selectionHelper.toggleItemSelection(t),this.removeView(t)}move(t,e){var n;t=this._ensureItem(t),this.remove(t,!0),this.add(t,e),null===(n=this.onItemMoved)||void 0===n||n.call(this,t,t.position)}removeAll(){for(;this.length;)this.remove(this.length-1)}clear(){this.removeAll(),clearChildren(this.dom)}ReplaceChild(t){this.clear(),this.dom.appendChild(t.getDOM())}}class SelectionHelper{constructor(){this._enabled=!1,this.onEnabledChanged=new r,this.itemProvider=null,this.ctrlForceSelect=!1,this.selectedItems=[],this.onSelectedItemsChanged=new r,this.lastToggledItem=null}get enabled(){return this._enabled}set enabled(t){if(!!t!=!!this._enabled){for(this._enabled=t;this.selectedItems.length;)this.toggleItemSelection(this.selectedItems[0],!1);this.lastToggledItem=null,this.onEnabledChanged.invoke()}}get count(){return this.selectedItems.length}handleItemClicked(t,e){if(!this.enabled){if(!this.ctrlForceSelect||!e.ctrlKey)return!1;this.enabled=!0}if(e.shiftKey&&this.lastToggledItem&&this.itemProvider){var n=!!this.lastToggledItem.selected,i=t.position,s=this.lastToggledItem.position;i>s&&([i,s]=[s,i]);for(let t=i;t<=s;t++)this.toggleItemSelection(this.itemProvider.get(t),n);this.lastToggledItem=t}else this.toggleItemSelection(t);return e.preventDefault(),!0}handleItemKeyDown(t,e){if(!this.enabled)return!1;if(this.itemProvider&&e.ctrlKey&&"KeyA"===e.code){const t=this.itemProvider.length;for(let e=0;e<t;e++)this.toggleItemSelection(this.itemProvider.get(e),!0);return e.preventDefault(),!0}return!1}toggleItemSelection(t,e){void 0!==e&&e===!!t.selected||(t.selected?(t.selected=!1,this.selectedItems.remove(t),this.onSelectedItemsChanged.invoke("remove",t)):(t.selected=!0,this.selectedItems.push(t),this.onSelectedItemsChanged.invoke("add",t)),this.lastToggledItem=t,0===this.count&&this.ctrlForceSelect&&(this.enabled=!1))}}class LazyListView extends ListView{constructor(){super(...arguments),this._loaded=0,this._lazy=!1,this._slowLoading=null,this._autoLoad=null}get loaded(){return this.loaded}get slowLoading(){return this._slowLoading}get autoLoad(){return this._autoLoad}get lazy(){return this._lazy}set lazy(t){this._lazy=t,t||this.ensureLoaded(this.length-1)}ensureLoaded(t){for(t>=this.length&&(t=this.length-1);this._loaded<=t;)this.dom.appendChild(this.items[this._loaded].dom),this._loaded++}loadNext(t=50){return this._loaded<this.length&&(this.ensureLoaded(Math.min(this.length-1,this._loaded+t-1)),!0)}slowlyLoad(t=30,e=50,n=!1){return n&&this.enableAutoLoad(t,e),this._slowLoading?this._slowLoading:this._loaded>=this.length?Promise.resolve(!0):this._slowLoading=new Promise((n=>{var i,s,callback=()=>{this._slowLoading&&this.loadNext(e)?s():(this.lazy=!!this._autoLoad,i(),n(!!this._slowLoading),this._slowLoading=null)};if(-1==t&&window.requestIdleCallback){let t;i=()=>window.cancelIdleCallback(t),(s=()=>{t=window.requestIdleCallback(callback)})()}else{-1==t&&(t=30);let e=setInterval(callback,t);i=()=>clearInterval(e),s=()=>{}}}))}enableAutoLoad(t=30,e=50){this._autoLoad={interval:t,batchSize:e},this.slowlyLoad(t,e)}stopLoading(){this._slowLoading=null,this._autoLoad=null}unload(){this.stopLoading();for(let t=this._loaded-1;t>=0;t--)this.items[t].dom.remove();this.lazy=!0,this._loaded=0}_insertToDom(t,e){!this.lazy||e<this._loaded?(super._insertToDom(t,e),this._loaded++):this._autoLoad&&this.slowlyLoad(this._autoLoad.interval,this._autoLoad.batchSize)}_removeFromDom(t){t.position<this._loaded&&(super._removeFromDom(t),this._loaded--)}}var m=window&&window.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,r){function fulfilled(t){try{step(i.next(t))}catch(t){r(t)}}function rejected(t){try{step(i.throw(t))}catch(t){r(t)}}function step(t){t.done?s(t.value):function adopt(t){return t instanceof n?t:new n((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))};class LoadingIndicator extends View{constructor(t){super(),this._status="running",this.onclick=null,t&&objectInit(this,t)}get state(){return this._status}set state(t){this._status=t,["running","error","normal"].forEach((e=>this.toggleClass(e,t===e)))}get content(){return this._text}set content(t){this._text=t,this.ensureDom(),this._textdom.textContent=t}reset(){this.state="running",this.content=d`Loading`,this.onclick=null}error(t,e){this.state="error",this.content=d`Oh no! Something just goes wrong:`+"\r\n"+t,e&&(this.content+="\r\n"+d`[Click here to retry]`),this.onclick=e}action(t){return m(this,void 0,void 0,(function*(){try{yield t()}catch(e){this.error(e,(()=>this.action(t)))}}))}createDom(){return{tag:"div.loading-indicator",child:[{tag:"div.loading-indicator-inner",child:[{tag:"div.loading-indicator-text",_id:"text"}]}],onclick:t=>{var e;return null===(e=this.onclick)||void 0===e?void 0:e.call(this,t)}}}postCreateDom(){this._textdom=this.getDomById("text"),this.reset()}}class MenuItem extends ListViewItem{constructor(t){super(),this.text="",this.cls="normal",this.keepOpen=!1,objectInit(this,t)}createDom(){return{tag:"div.item.no-selection",tabIndex:0}}postCreateDom(){super.postCreateDom(),this.onActive.add((t=>{this.parentView instanceof ContextMenu&&(this.keepOpen||this.parentView.keepOpen||this.parentView.close())}))}updateDom(){super.updateDom(),this.dom.textContent=this.text,this.cls!==this._lastcls&&(this._lastcls&&this.dom.classList.remove(this._lastcls),this.cls&&this.dom.classList.add(this.cls))}}class MenuLinkItem extends MenuItem{constructor(t){super(t),this.link="",this.download="",objectInit(this,t)}createDom(){var t=super.createDom();return t.tag="a.item.no-selection",t.target="_blank",t}updateDom(){super.updateDom(),this.dom.href=this.link,this.dom.download=this.download}}class MenuInfoItem extends MenuItem{constructor(t){super(t),this.text="",this.keepOpen=!0,objectInit(this,t)}createDom(){return{tag:"div.menu-info"}}updateDom(){super.updateDom(),this.dom.textContent=this.text}}class ContextMenu extends ListView{constructor(t){super({tag:"div.context-menu",tabIndex:0}),this.keepOpen=!1,this.useOverlay=!0,this._visible=!1,this.overlay=null,this.onClose=new r,this._originalFocused=null,null==t||t.forEach((t=>this.add(t)))}get visible(){return this._visible}postCreateDom(){super.postCreateDom(),this.dom.addEventListener("focusout",(t=>{!this.dom.contains(t.relatedTarget)&&this.close()})),this.dom.addEventListener("keydown",(t=>{"Escape"===t.code&&(t.preventDefault(),this.close())}))}show(t){this._visible?console.trace("[ContextMenu] show() called when it's already visible."):("ev"in t&&(t={x:t.ev.clientX,y:t.ev.clientY}),this._visible=!0,this.useOverlay?(this.overlay||(this.overlay=(new Overlay).setFixed(!0),this.overlay.dom.style.background="rgba(0, 0, 0, .1)",this.overlay.dom.addEventListener("mousedown",(t=>{t.eventPhase===Event.AT_TARGET&&(t.preventDefault(),this.close())}))),this.overlay.appendView(this),mountView(document.body,this.overlay)):mountView(document.body,this),this._originalFocused=document.activeElement,this.setPosition(t),this.dom.focus())}setPosition(t){if(this._visible){this.dom.style.left="0",this.dom.style.top="0";var e=document.body.offsetWidth,n=document.body.offsetHeight;if(this.useOverlay){const t=this.overlay.dom;e=t.offsetWidth,n=t.offsetHeight}this.dom.style.maxHeight=n+"px";var i=this.dom.offsetWidth,s=this.dom.offsetHeight,r=t.x,o=t.y;r+i>e&&(r-=i),o+s>n&&(o-=s),r<0&&(r=t.x>e/2?0:e-i),o<0&&(o=t.y>n/2?0:n-s),this.dom.style.left=r+"px",this.dom.style.top=o+"px",this.dom.style.transformOrigin=`${t.x-r}px ${t.y-o}px`}else console.trace("[ContextMenu] setPosition() called when it's not visible.")}close(){var t,e;this._visible&&(this._visible=!1,this.onClose.invoke(),null===(e=null===(t=this._originalFocused)||void 0===t?void 0:t.focus)||void 0===e||e.call(t),this._originalFocused=null,this.overlay&&fadeout(this.overlay.dom).onFinished((()=>unmountView(document.body,this.overlay))),fadeout(this.dom).onFinished((()=>!this.overlay&&unmountView(document.body,this))))}}class Section extends View{constructor(t){super(),this.titleView=new TextView({tag:"span.section-title"}),this.headerView=new View({tag:"div.section-header",child:[this.titleView]}),this.ensureDom(),t&&(t.title&&this.setTitle(t.title),t.content&&this.setContent(t.content),t.actions&&t.actions.forEach((t=>this.addAction(t))))}createDom(){return{tag:"div.section",child:[this.headerView]}}setTitle(t){this.titleView.removeAllView(),this.titleView.addChild(t)}setContent(t){this.content&&this.removeView(this.content),this.content=View.getView(t),this.appendView(this.content)}addAction(t){var e=t instanceof View?t:new SectionAction({text:t.text,onActive:t.onclick});this.headerView.appendView(e)}}class SectionAction extends TextView{constructor(t){super(),objectInit(this,t)}createDom(){return{tag:"div.section-action.clickable",tabIndex:0}}}class ToastsContainer extends View{constructor(){super(...arguments),this.parentDom=null,this.toasts=[]}createDom(){return{tag:"div.toasts-container"}}addToast(t){0===this.toasts.length&&this.show(),this.toasts.push(t)}removeToast(t){this.toasts.remove(t),0===this.toasts.length&&this.remove()}show(){(this.parentDom||document.body).appendChild(this.dom)}remove(){this.dom.remove()}}ToastsContainer.default=new ToastsContainer;class Toast extends View{constructor(t){super(),this.text="",this.shown=!1,this.timer=new Timer((()=>this.close())),objectInit(this,t),this.container||(this.container=ToastsContainer.default)}show(t){this.shown||(this.container.addToast(this),this.container.appendView(this),this.shown=!0),t?this.timer.timeout(t):this.timer.tryCancel()}close(){this.shown&&(this.shown=!1,fadeout(this.dom).onFinished((()=>this.container.removeToast(this))))}createDom(){return{tag:"div.toast"}}updateDom(){super.updateDom(),this.dom.textContent=this.text}static show(t,e){var n=new Toast({text:t});return n.show(e),n}}var v=Object.freeze({__proto__:null,AutoResetEvent:class AutoResetEvent{constructor(){this._whenNotify=null,this._callback=null}wait(){return this._whenNotify||(this._whenNotify=new Promise((t=>{this._callback=()=>{this._callback=this._whenNotify=null,t()}}))),this._whenNotify}set(){this._callback&&this._callback()}},BuildDOMCtx:BuildDOMCtx,ButtonView:ButtonView,Callbacks:r,CancelToken:CancelToken,ContainerView:ContainerView,ContextMenu:ContextMenu,DataUpdatingHelper:DataUpdatingHelper,Dialog:Dialog,DialogParent:DialogParent,EditableHelper:EditableHelper,EventRegistrations:EventRegistrations,get FlagsInput(){return u},I:d,I18n:I18n,InputStateTracker:InputStateTracker,InputView:InputView,ItemActiveHelper:ItemActiveHelper,JsxNode:JsxNode,LabeledInput:LabeledInput,LabeledInputBase:LabeledInputBase,Lazy:Lazy,LazyListView:LazyListView,ListView:ListView,ListViewItem:ListViewItem,LoadingIndicator:LoadingIndicator,MenuInfoItem:MenuInfoItem,MenuItem:MenuItem,MenuLinkItem:MenuLinkItem,MessageBox:MessageBox,get MountState(){return o},Overlay:Overlay,Ref:Ref,Section:Section,SectionAction:SectionAction,SelectionHelper:SelectionHelper,Semaphore:Semaphore,TabBtn:c,TextBtn:TextBtn,TextCompositionWatcher:TextCompositionWatcher,TextView:TextView,Timer:Timer,Toast:Toast,ToastsContainer:ToastsContainer,ToolTip:ToolTip,View:View,ViewToggle:ViewToggle,addChild:addChild,appendView:appendView,arrayFind:arrayFind,arrayForeach:arrayForeach,arrayInsert:arrayInsert,arrayMap:arrayMap,arrayRemove:arrayRemove,arraySum:arraySum,base64EncodeUtf8:base64EncodeUtf8,buildDOM:buildDOM,buildView:buildView,clearChildren:clearChildren,createArrayBuilder:createArrayBuilder,createName:createName,createStringBuilder:createStringBuilder,dragManager:p,fadeout:fadeout,foreachFlaten:foreachFlaten,formatDateTime:formatDateTime,formatDuration:formatDuration,formatFileSize:formatFileSize,getDOM:getDOM,getWebfxCss:getWebfxCss,i18n:l,injectCss:injectCss,injectWebfxCss:injectWebfxCss,jsx:a,jsxBuild:jsxBuild,jsxFactory:jsxFactory,listenEvent:listenEvent,listenEvents:listenEvents,listenPointerEvents:listenPointerEvents,mod:mod,mountView:mountView,numLimit:numLimit,objectApply:objectApply,objectInit:objectInit,readBlobAsDataUrl:function readBlobAsDataUrl(t){return new Promise(((e,n)=>{var i=new FileReader;i.onload=t=>{e(i.result)},i.onerror=t=>n(),i.readAsDataURL(t)}))},replaceChild:function replaceChild(t,e){clearChildren(t),e&&t.appendChild(e)},setPosition:setPosition,sleepAsync:sleepAsync,startBlockingDetect:startBlockingDetect,strPadLeft:strPadLeft,toggleClass:toggleClass,tryGetDOM:tryGetDOM,unmountView:unmountView,version:"1.10.1"});class ScrollAnimator{constructor(t){this.view=t,this.duration=300,this.beginTime=-1,this.beginPos=0,this.lastPos=0,this.targetPos=0,this._rafHandle=-1,this.posType="top",this.scrollEventPending=!1,this.onUserScroll=new r,this._rafCallback=null,this.view.dom.addEventListener("scroll",(e=>{e.target===t.dom&&(this.scrollEventPending?this.scrollEventPending=!1:(this.onUserScroll.invoke(e),this.cancel()))}))}get currentPos(){return"center"==this.posType?this.view.dom.scrollTop+this.view.dom.offsetHeight/2:this.view.dom.scrollTop}set currentPos(t){var e=t;"center"==this.posType&&(e-=this.view.dom.offsetHeight/2),this.view.dom.scrollTop!=e&&(this.scrollEventPending=!0,this.view.dom.scrollTop=e)}cancel(){this._rafHandle>=0&&(cancelAnimationFrame(this._rafHandle),this._rafHandle=-1)}scrollTo(t){this.targetPos=t,this.lastPos=this.beginPos=this.currentPos,this._rafHandle<0&&this._startRaf(),this.beginTime=performance.now()}_startRaf(){this._rafCallback||(this._rafCallback=t=>{this._render(t)?this._rafHandle=requestAnimationFrame(this._rafCallback):this._rafHandle=-1}),this._rafHandle=requestAnimationFrame(this._rafCallback)}_render(t){if(Math.abs(this.currentPos-this.lastPos)>10)return!1;const e=numLimit((t-this.beginTime)/this.duration,0,1),n=this.beginPos+(this.targetPos-this.beginPos)*this._easeInOutQuad(e);return this.lastPos=n,this.currentPos=n,1!==e}_easeInOutQuad(t){return t<.5?2*t*t:(4-2*t)*t-1}}class SettingItem{constructor(t,e,n){if(this.onRender=null,this.key=t,!(e=this.type="string"==typeof e?SettingItem.types[e]:e)||!e.serialize||!e.deserialize)throw new Error("invalid 'type' arugment");this.readFromStorage(n)}readFromStorage(t){var e=this.key?localStorage.getItem(this.key):null;this.isInitial=!e,this.set(e?this.type.deserialize(e):t,!0)}render(t,e){e||t(this.data);const n=this.onRender,i=t;return n&&(t=function(t){n(t),i(t)}),this.onRender=t,this}bindToBtn(t,e){if(this.type!==SettingItem.types.bool)throw new Error("only for bool type");var n=document.createElement("span");t.insertBefore(n,t.firstChild),this.render((function(i){t.classList.toggle("disabled",!i),e=e||["❌","✅"],n.textContent=e[+i]}));var i=this;return t.addEventListener("click",(function(){i.toggle()})),this}remove(){localStorage.removeItem(this.key)}save(){this.isInitial=!1,localStorage.setItem(this.key,this.type.serialize(this.data))}set(t,e){this.data=t,this.isInitial=!1,this.onRender&&this.onRender(t),!e&&this.key&&this.save()}get(){return this.data}toggle(){if(this.type!==SettingItem.types.bool)throw new Error("only for bool type");this.set(!this.data)}loop(t){var e=this.data,n=t.findIndex((function(t){return t===e})),i=t[(n+1)%t.length];this.set(i)}}SettingItem.types={bool:{serialize:function(t){return t?"true":"false"},deserialize:function(t){return"true"===t||"false"!==t&&void 0}},str:{serialize:function(t){return t},deserialize:function(t){return t}},json:{serialize:function(t){return JSON.stringify(t)},deserialize:function(t){return JSON.parse(t)}}};class FileSelector extends View{constructor(t){super(),this.domfile=new Ref,this.accept="*/*",this.multiple=!1,objectApply(this,t)}createDom(){return{tag:"input",type:"file",ref:this.domfile,style:"display: none; height: 0;",accept:this.accept,multiple:this.multiple}}postCreateDom(){this.domfile.value.addEventListener("change",(t=>{this.domfile.value.files&&this.handleFiles(this.domfile.value.files)}))}open(){this.domfile.value.click()}handleFiles(t){var e;for(let n=0;n<t.length;n++){const i=t[n];console.log("[Uploads] drop file",{name:i.name,size:i.size}),null===(e=this.onfile)||void 0===e||e.call(this,i)}}}var w=JSON.parse('[[["en","zh"],["English","中文"],["Language: {0}","语言：{0}"],[" (auto-detected)","（自动检测）"],["Reload to fully apply changes","刷新以完全应用更改"],["Pin","固定"],["Unpin","浮动"],["Pause","暂停"],["Pause...","暂停..."],["Play","播放"],[" (logging in...)"," （登录中...）"],["Guest (click to login)","游客（点击登录）"],["Login","登录"],["Login via {0}","使用 {0} 登录"],["Create account","创建账户"],["Login settings","登录设置"],["Linked accounts","关联账户"],["(Not available)","(不可用)"],["Link","关联"],["Unlink","解除"],["Account has been linked successfully.","账户关联成功。"],["Account has been unlinked successfully.","账户解除关联成功。"],["Account linking error: {0}","账户关联错误: {0}"],["Close","关闭"],["Username","用户名"],["Password","密码"],["Change password","更改密码"],["New password","新密码"],["Confirm password","确认密码"],["Requesting...","请求中……"],[" (error!)","（错误！）"],["Username or password is not correct.","用户名或密码不正确。"],["Logged in with previous working account.","已登录为之前的用户。"],["Please input the username!","请输入用户名！"],["Please input the password!","请输入密码！"],["Please input the new password!","请输入新密码！"],["Password confirmation does not match!","确认密码不相同！"],["Playlist","播放列表"],["Playlists","播放列表"],["New Playlist","新建播放列表"],["New Playlist ({0})","新播放列表（{0}）"],["Click to edit","点击编辑"],["(Empty)","（空）"],["Logging in","登录中"],["Loading","加载中"],["Oh no! Something just goes wrong:","发生错误："],["[Click here to retry]","[点击重试]"],["My Uploads","我的上传"],["Click here to select files to upload","点此选择文件并上传"],["or drag files to this zone...","或拖放文件到此处..."],["Comments","评论"],["Copy link","复制链接"],["Remove","移除"],["Remove {0} tracks","移除 {0} 首歌曲"],["List ID","列表 ID"],["Track ID","歌曲 ID"],["Name","名称"],["Artist","艺术家"],["Album","专辑"],["Album artist","专辑艺术家"],["Duration","时长"],["Size","大小"],["Search","搜索"],["Discussion","灌水区"],["Notes","便签"],["Submit","提交"],["Submitting","提交中"],["Download","下载"],["Show picture","查看图像"],["Set Picture","设置图像"],["Convert","转换"],["Converting \\"{0}\\"...","正在转换 \\"{0}\\"..."],["Error converting \\"{0}\\".","转换 \\"{0}\\" 时发生错误."],["Edit","编辑"],["Details","详细信息"],["Discard","放弃更改"],["Lyrics View","歌词视图"],["Source View","源码视图"],["Failed to switch view.","切换视图失败。"],["Done","完成"],["Save","保存"],["Saving...","保存中..."],["Error","错误"],["User {0}","用户 {0}"],["User","用户"],["Change avatar","更改头像"],["You\'ve logged in as \\"{0}\\".","你已登录为 \\"{0}\\"。"],["You are admin.","你是管理员。"],["Switch user","切换用户"],["Logout","注销"],["Logging out...","正在注销..."],["Failed to create playlist \\"{0}\\".","创建播放列表 \\"{0}\\" 失败。"],["Failed to sync playlist \\"{0}\\".","同步播放列表 \\"{0}\\" 失败。"],["Login to create playlists.","登录以创建播放列表。"],["Failed to login.","登录失败。"],["Failed to upload file \\"{0}\\".","上传文件 \\"{0}\\" 失败。"],["Failed to remove track.","移除歌曲失败。"],["Failed to logout.","注销失败。"],["Player error:","播放器错误："],["Unknown error.","未知错误。"],["Retry after {0} sec...","{0} 秒后重试..."],["Removing of a uploading track is currently not supported.","目前不支持移除上传中的歌曲。"],["Changing password...","正在更改密码..."],["Failed to change password.","更改密码失败。"],["Password changed successfully.","已成功更改密码。"],["Server: ","服务器："],["Volume","音量"],["(Scroll whell or drag to adjust volume)","（滚动滚轮或拖动调整音量）"],["Warning","警告"],["Are you sure to delete the track permanently?","确定要永久删除此歌曲吗？"],["Are you sure to delete {0} tracks permanently?","确定要永久删除 {0} 首歌曲吗？"],["Question","询问"],["Did you mean to upload 1 file?","是否要上传 1 个文件？"],["Did you mean to upload {0} files?","是否要上传 {0} 个文件？"],["Refresh","刷新"],["Select","选择"],["Select all","全选"],["Cancel","取消"],["Settings","设置"],["UI color: {0}","界面色彩：{0}"],["UI style: {0}","界面样式：{0}"],["Preferred bitrate (0: original file)","首选码率（0：原始文件）"],["Custom server URL","自定义服务器 URL"],["Enable notification","启用通知"],["Disable notification","禁用通知"],["Now Playing","正在播放"],["Lyrics","歌词"],["Edit Lyrics","编辑歌词"],["Error parsing lyrics","歌词解析错误"],["No lyrics","无歌词"],["Source code","源代码"],["Client updated:\\n{0}\\n  =>\\n{1}","客户端已更新:\\n{0}\\n  =>\\n{1}"],["[Unknown version]","[未知版本]"],["About","关于"],["Build Date","编译时间"],["This project is {0} under MIT license.","此项目以 MIT 协议 {0}。"],["This project is based on {0}.","此项目基于 {0}。"],["open-sourced","开源"],["Recent changes:","最近更改:"],["Music Cloud","Music Cloud"]],[["_key_","en","zh"],["uploads_pending","Pending","队列中"],["uploads_uploading","Uploading","上传中"],["uploads_processing","Processing","处理中"],["uploads_error","Error","错误"],["uploads_done","Done","完成"],["prev_track","Prev","上一首"],["next_track","Next","下一首"],["loopmode_list-seq","List-seq","顺序播放"],["loopmode_list-loop","List-loop","列表循环"],["loopmode_list-shuffle","List-shuffle","乱序播放"],["loopmode_track-loop","Track-loop","单曲循环"],["msgbox_no","No","否"],["msgbox_yes","Yes","是"],["msgbox_ok","OK","确定"],["msgbox_cancel","Cancel","取消"],["colortheme_light","light","亮色"],["colortheme_dark","dark","暗色"],["styletheme_","classic","经典"],["styletheme_-rounded","rounded","圆角"],["visibility_0","Private","私有"],["visibility_1","Public","公开"],["my_visibility_0","My private","我的私有"],["my_visibility_1","My public","我的公开"],["make_it_visibility_0","Make it private","转为私有"],["make_it_visibility_1","Make it public","转为公开"],["make_{0}_visibility_0","Make {0} items private","转换 {0} 个项目为私有"],["make_{0}_visibility_1","Make {0} items public","转换 {0} 个项目为公开"],["social-link-error_already-linked","The account has been already linked.","该账户已经被关联。"]]]');const f=createArrayBuilder(l);w.forEach((t=>l.add2dArray(t)));const b={defaultApiBaseUrl:"https://mc.yuuza.net/api/",apiBaseUrl:"",debug:!0,apiDebugDelay:0,showDownloadOptions:!1,showDiscussion:!1,showNotes:!1,init(){var t=localStorage.getItem("mcloud-server");this.apiBaseUrl=t||this.defaultApiBaseUrl}};const y=new class{constructor(){this.appBaseUrl=function getAppBaseUrl(){var t=window.location.href,e=t.indexOf("?");if(e>=0)return t.substring(0,e);var n=t.indexOf("#");return n>=0?t.substring(0,n):t}(),this.storageUrlBase="",this.debugSleep=b.debug?b.apiDebugDelay:0,this.defaultAuth=null,this.onTrackInfoChanged=new r,this.onTrackDeleted=new r}get baseUrl(){return b.apiBaseUrl}async _fetch(t,e){return this.debugSleep&&await sleepAsync(this.debugSleep*(Math.random()+1)),await fetch(t,Object.assign({credentials:"same-origin"},e))}getHeaders(t){var e,n={},i=null!==(e=(t=t||{}).auth)&&void 0!==e?e:this.defaultAuth;return i&&(n.Authorization=i),1!=t.cache&&(n["Cache-Control"]="no-store"),n}async get(t,e){var n;e=e||{};var i=await this._fetch(this.baseUrl+t,{headers:Object.assign({},this.getHeaders(e))});return await this.checkResp(e,i),(null===(n=i.headers.get("Content-Type"))||void 0===n?void 0:n.startsWith("application/json"))?await i.json():i}async post(t){var e,n=t.obj;if(void 0===t.mode&&(t.mode=void 0!==n?"json":"empty"),"json"===t.mode)n=void 0!==n?JSON.stringify(n):void 0;else if("raw"===t.mode);else{if("empty"!==t.mode)throw new Error("Unknown arg.mode");n=null}var i=this.getHeaders(t);"json"===t.mode&&(i["Content-Type"]="application/json"),i=Object.assign(Object.assign({},i),t.headers);var s=await this._fetch(this.baseUrl+t.path,{body:n,method:null!==(e=t.method)&&void 0!==e?e:"POST",headers:i});await this.checkResp(t,s);var r=s.headers.get("Content-Type");return r&&/^application\/json;?/.test(r)?await s.json():null}put(t){return this.post(Object.assign(Object.assign({},t),{method:"PUT"}))}delete(t){return this.post(Object.assign(Object.assign({},t),{method:"DELETE"}))}upload(t){const e=t.cancelToken;if(e)var n=e.onCancelled.add((function(){i.abort()}));const i=new XMLHttpRequest,s=new Promise(((t,e)=>{i.onload=e=>t(),i.onerror=t=>e("XHR error"),i.onabort=t=>e("XHR abort")}));i.upload.onprogress=t.onprogerss||null,i.open(t.method,this.processUrl(t.url)),t.auth&&i.setRequestHeader("Authorization",t.auth),t.contentType&&i.setRequestHeader("Content-Type",t.contentType),i.send(t.body);const r=async function(t){try{await s}finally{e&&(e.onCancelled.remove(n),e.throwIfCancelled())}if(i.status<200||i.status>=300)throw new Error("HTTP status "+i.status);return i}();return{xhr:i,complete:r}}async checkResp(t,e){if(!1!==t.status&&(void 0!==t.status&&e.status!=t.status||e.status>=400)){if(450===e.status){try{var n=(await e.json()).error}catch(t){}if(n)throw new Error(n)}throw new Error("HTTP status "+e.status)}}async getListAsync(t){return await this.get("lists/"+t)}async getListIndexAsync(){return await this.get("lists/index")}async putListAsync(t,e=!1){return await this.post({path:"lists/"+t.id,method:e?"POST":"PUT",obj:t})}getTrack(t){return this.get("tracks/"+t)}getList(t){return this.get("lists/"+t)}processUrl(t){return!t||t.match("^(https?:/)?/")?t:this.storageUrlBase&&t.startsWith("storage/")?this.storageUrlBase+t.substring(8):this.baseUrl+t}},x=new class PlayerCore{constructor(){this.track=null,this.trackProfile=null,this.audioLoaded=!1,this.objectUrl=null,this.onTrackChanged=new r,this.siPlayer=new SettingItem("mcloud-player","json",{loopMode:"list-loop",volume:1,preferBitrate:256}),this.onLoopModeChanged=new r,this._state="none",this.onStateChanged=new r,this.onAudioCreated=new r,this._loadRetryCount=0,this._loadRetryTimer=new Timer((()=>{this.play()})),this.onProgressChanged=new r,this.onVolumeChanged=new r}get loopMode(){return this.siPlayer.data.loopMode}set loopMode(t){this.siPlayer.data.loopMode=t,this.siPlayer.save(),this.onLoopModeChanged.invoke()}get preferBitrate(){return this.siPlayer.data.preferBitrate}get state(){return this._state}set state(t){t!==this._state&&(console.info(`[PlayerCore] state '${this._state}' -> '${t}'`),this._state=t,this.onStateChanged.invoke())}get currentTime(){var t;return null===(t=this.audio)||void 0===t?void 0:t.currentTime}set currentTime(t){this.audio.currentTime=t}get duration(){var t;return this.audio&&this.audioLoaded&&this.audio.readyState>=HTMLMediaElement.HAVE_METADATA?this.audio.duration:null===(t=this.track)||void 0===t?void 0:t.length}get isVideo(){var t;return"video"==(null===(t=this.track)||void 0===t?void 0:t.type)}get volume(){var t,e;return null!==(e=null===(t=this.audio)||void 0===t?void 0:t.volume)&&void 0!==e?e:1}set volume(t){this.audio.volume=t,t!==this.siPlayer.data.volume&&(this.siPlayer.data.volume=t,this.siPlayer.save())}get playbackRate(){return this.audio.playbackRate}get isPlaying(){return this.audio&&!!this.audio.duration&&!this.audio.paused}get isPaused(){return this.audio.paused}get canPlay(){return this.audio.readyState>=2}init(){var t=new SettingItem("mcloud-loop","str",null);null!==t.data&&(this.loopMode=t.data,t.remove()),this.audio=document.createElement("video"),this.initAudio()}initAudio(){this.audio.crossOrigin="anonymous",this.audio.addEventListener("timeupdate",(()=>this.onProgressChanged.invoke())),this.audio.addEventListener("canplay",(()=>{this._loadRetryCount=0,this.onProgressChanged.invoke()})),this.audio.addEventListener("seeking",(()=>{this.audio.paused||(this.state="stalled")})),this.audio.addEventListener("stalled",(()=>{this.audio.paused||(this.state="stalled")})),this.audio.addEventListener("play",(()=>{this.state="stalled"})),this.audio.addEventListener("playing",(()=>{this.state="playing"})),this.audio.addEventListener("pause",(()=>{this.state="paused"})),this.audio.addEventListener("error",(t=>{console.error("[PlayerCore] audio error",t);var e="paused"!==this.state&&"stalled"!==this.state;if(this.track&&this.track.url){let n=d`Player error:`+"\n"+(t.message||d`Unknown error.`);e&&"playing"!=this.state&&this._loadRetryCount++<3&&(n+="\n"+d`Retry after ${3} sec...`,this._loadRetryTimer.timeout(3e3)),Toast.show(n,3e3),!q.isVisible()&&q.notification.isEnabledFor("nowPlaying")&&q.notification.show(d`Music Cloud`,{body:n,requireInteraction:!1})}})),this.audio.addEventListener("ended",(()=>{this.next()})),this.audio.addEventListener("volumechange",(()=>this.onVolumeChanged.invoke())),this.audio.volume=this.siPlayer.data.volume,this.onAudioCreated.invoke()}prev(){return this.next(-1)}next(t){var e=this.getNextTrack(t);e&&this.playTrack(e,!0)}getNextTrack(t){var e,n,i;return null===(i=null===(n=null===(e=this.track)||void 0===e?void 0:e._bind)||void 0===n?void 0:n.list)||void 0===i?void 0:i.getNextTrack(this.track,this.loopMode,t)}loadUrl(t){this.objectUrl&&(URL.revokeObjectURL(this.objectUrl),this.objectUrl=null),this.audioLoaded=!!t,t?(t instanceof Blob&&(t=this.objectUrl=URL.createObjectURL(t)),this.audio.src=t):(this.audio.pause(),this.audio.removeAttribute("src")),this.audio.load()}async setTrack(t,e=!1){console.info("[PlayerCore] set track: "+(t?`id ${t.id}: ${t.name} - ${t.artist}`:"(null)"));var n=this.track;this.track=t,this._loadRetryTimer.tryCancel(),n===t||(null==t?void 0:t.url)&&(null==n?void 0:n.url)===(null==t?void 0:t.url)||(null==t?void 0:t.blob)&&t.blob===(null==n?void 0:n.blob)||(e&&t?await this.loadTrack(t):this.loadUrl(null),this.state=t?e?"stalled":"paused":"none"),this.onTrackChanged.invoke(),this.onProgressChanged.invoke(),e&&t&&await this.playTrack(t)}async playTrack(t,e){t===this.track?(e&&(this.audio.currentTime=0),await this.play()):await this.setTrack(t,!0)}async loadTrack(t){var e;null===(e=this._loadct)||void 0===e||e.cancel();var n=this._loadct=new CancelToken;if(t.blob)this.loadUrl(null),n.throwIfCancelled(),this.trackProfile=null,this.loadUrl(t.blob);else{let e,s={profile:"",bitrate:0,size:t.size};if("video"==t.type)s=t.files[0];else{var i=this.preferBitrate;i&&t.files&&t.files.forEach((t=>{(!s.bitrate||Math.abs(s.bitrate-i)>Math.abs(t.bitrate-i))&&(s=t)}))}-1==s.size?(this.loadUrl(null),e=await t.requestFileUrl(s),n.throwIfCancelled()):e=await t.requestFileUrl(s),this.trackProfile=s,this.loadUrl(y.processUrl(e))}}async play(){await this.ensureLoaded();try{this.audio.play()}catch(t){console.error("audio.play() error",t),this.state="none"}}async ensureLoaded(){var t=this.track;t&&!this.audioLoaded&&await this.loadTrack(t)}pause(){this.audio.pause()}},k=["list-seq","list-loop","list-shuffle","track-loop"];if(navigator.mediaSession){let t=navigator.mediaSession;x.onTrackChanged.add((()=>{try{var e=x.track;if(!e)return;t.metadata=new MediaMetadata({title:null==e?void 0:e.name,artist:null==e?void 0:e.artist,artwork:(null==e?void 0:e.picurl)?[{src:y.processUrl(null==e?void 0:e.picurl)}]:[]})}catch(t){}})),x.onStateChanged.add((()=>{try{t.playbackState="playing"===x.state||"stalled"===x.state?"playing":"none"===x.state?"none":"paused"}catch(t){}})),t.setActionHandler("play",(()=>x.play())),t.setActionHandler("pause",(()=>x.pause())),t.setActionHandler("previoustrack",(()=>x.prev())),t.setActionHandler("nexttrack",(()=>x.next()))}window.addEventListener("beforeunload",(t=>{if(x.track&&!x.audio.paused)return t.preventDefault(),t.returnValue="The player is running. Are you sure to leave?"}));var C={version:"1.0.11",buildDate:"2022-05-24T14:42:40.857Z",commits:[{id:"0097745",date:"2022-05-24T22:33:53+08:00",message:"Merge remote-tracking branch 'upstream/dev' into carbox"},{id:"29dbd32",date:"2022-05-24T22:30:02+08:00",message:"style: volume button is always rounded"},{id:"f116631",date:"2022-05-24T22:02:54+08:00",message:"Merge remote-tracking branch 'upstream/dev' into carbox"},{id:"a59605c",date:"2022-05-20T07:31:30+08:00",message:"re-add loudness map"},{id:"cc3e685",date:"2022-05-18T01:34:43+08:00",message:"thinner volume button"},{id:"c3ba702",date:"2022-05-18T01:15:18+08:00",message:"add missing i18n strings"},{id:"95de382",date:"2022-05-17T20:09:21+08:00",message:'clicking lyrics in bottombar nav to "nowplaying"'},{id:"3864a15",date:"2022-05-17T20:08:32+08:00",message:"show next visible line when current line is empty"},{id:"77a4287",date:"2022-05-17T20:06:34+08:00",message:"router: prevent nav to the same path"},{id:"169ab2c",date:"2022-05-17T18:32:30+08:00",message:"make control buttons center"},{id:"65114f9",date:"2022-05-17T07:14:11+08:00",message:"dont show both track-info and lyrics on small screen"},{id:"7a4dae1",date:"2022-05-17T06:53:16+08:00",message:"add lyrics in bottombar"},{id:"8bff447",date:"2022-05-17T05:37:13+08:00",message:'add "fullscreen" button'},{id:"9eb338a",date:"2022-05-17T04:57:08+08:00",message:"minor style adjustments"},{id:"460b04c",date:"2022-05-17T04:38:24+08:00",message:"thin scrollbar in lyrics view"},{id:"282fc32",date:"2022-05-17T04:30:12+08:00",message:"volume button in reworked bottombar"},{id:"a021081",date:"2022-05-17T02:02:03+08:00",message:"bottom bar rework"},{id:"d57b0e2",date:"2022-05-16T00:47:27+08:00",message:"update deps"},{id:"64f59f9",date:"2022-05-02T06:39:00+08:00",message:"update deps"},{id:"98c2136",date:"2022-04-11T00:01:19+08:00",message:"carbox: disable useless features"}]};const V=new class{constructor(){this.siVersion=new SettingItem("mcloud-ver","str",""),this.currentVersion=C.version,this.currentDate=C.buildDate,this.prevDate="",this.versionChanged=!1}init(){this.prevDate=this.siVersion.data,this.versionChanged=!!this.prevDate&&this.prevDate!=this.currentDate,this.siVersion.set(this.currentDate)}showUpdatedToast(){if(this.versionChanged){const[t,e]=[this.prevDate,this.currentDate].map((t=>t?new Date(t).toLocaleString(q.lang.curLang):d`[Unknown version]`));Toast.show(d`Client updated:\n${t}\n  =>\n${e}`,5e3)}}};V.init();const L=new class PlayerFX{get webAudioInited(){return!!this.ctx}init(){}initWebAudio(){this.webAudioInited||(this.ctx=new AudioContext,this.source=this.ctx.createMediaElementSource(x.audio),function chainNodes(t,e){let n=t;for(let t of e)("function"!=typeof t||(t=t(),t))&&(n.connect(t),n=t)}(this.source,[()=>(this.analyser=this.ctx.createAnalyser(),this.analyser.fftSize=8192,this.analyser),this.ctx.destination]))}showUI(t){this.initWebAudio(),(new FXDialog).show(t)}},T=800,I=600;class FXDialog extends Dialog{constructor(){super(),this.canvas=new View({tag:"canvas",height:I,width:T}),this.width="830px",this.addContent(this.canvas),this.overlay.setFlags({clickThrough:!0})}postCreateDom(){super.postCreateDom();const t=this.canvas.dom.getContext("2d"),e=t.createImageData(T,I),n=e.data,i=[];console.info(i);const update=()=>{if(!this.shown)return;requestAnimationFrame(update);const s=L.analyser,r=new Uint8Array(T);s.getByteFrequencyData(r),i.unshift(r),i.length>I&&i.pop();const o=n;for(let t=0;t<i.length;t++)for(let e=0;e<T;e++){const n=i[t][e],s=4*(e+T*(I-t-1));o[s+0]=o[s+1]=o[s+2]=n,o[s+3]=255}t.putImageData(e,0,0)};requestAnimationFrame(update)}}const S=new class{openUI(t){this.dialog||(this.dialog=new SettingsDialog),this.dialog.center(),this.dialog.show(t)}},_=["light","dark"],D=["","-rounded"];function loopInArray(t,e){return t[(t.indexOf(e)+1)%t.length]}function getThemeAndStyle(){let[t,e]=q.theme.current.split("-");return e=e?"-"+e:"",{theme:t,style:e}}function setThemeAndStyle(t){var e,n;const i=getThemeAndStyle(),s=null!==(e=t.theme)&&void 0!==e?e:i.theme,r=null!==(n=t.style)&&void 0!==n?n:i.style;q.theme.set(`${s}${r}`)}class SettingsDialog extends Dialog{constructor(){super(),this.btnSwitchTheme=new ButtonView({type:"big"}),this.btnSwitchStyle=new ButtonView({type:"big"}),this.btnSwitchLang=new ButtonView({type:"big"}),this.inputPreferBitrate=new LabeledInput,this.inputServer=new LabeledInput,this.btnNotification=new ButtonView({type:"big"}),this.addContent(this.btnSwitchTheme),this.btnSwitchTheme.onActive.add((()=>{const t=getThemeAndStyle();setThemeAndStyle({theme:loopInArray(_,t.theme)}),this.updateDom()})),this.addContent(this.btnSwitchStyle),this.btnSwitchStyle.onActive.add((()=>{const t=getThemeAndStyle();setThemeAndStyle({style:loopInArray(D,t.style)}),this.updateDom()})),this.addContent(this.btnSwitchLang),this.btnSwitchLang.onActive.add((()=>{q.lang.curLang;var t=q.lang.siLang.data,e=["",...q.lang.availableLangs];t=e[(e.indexOf(t)+1)%e.length],q.lang.siLang.set(t)})),this.addContent(this.inputPreferBitrate),this.onShown.add((()=>{var t;this.inputPreferBitrate.value=(null!==(t=x.siPlayer.data.preferBitrate)&&void 0!==t?t:"0").toString()})),this.onClose.add((()=>{var t=parseInt(this.inputPreferBitrate.value);isNaN(t)||(x.siPlayer.data.preferBitrate=t,x.siPlayer.save())})),this.addContent(this.inputServer),this.inputServer.value=localStorage.getItem("mcloud-server")||"",this.inputServer.dominput.placeholder=b.defaultApiBaseUrl,this.inputServer.dominput.addEventListener("change",(t=>{localStorage.setItem("mcloud-server",this.inputServer.value),b.apiBaseUrl=this.inputServer.value})),this.addContent(this.btnNotification),this.btnNotification.onActive.add((()=>{q.notification.setEnable(!q.notification.config.enabled).then((()=>this.updateDom()))}));const t=new View(a("div",null,a(ButtonView,{onActive:t=>{L.showUI(t)}},"Test: Player FX")));t.hidden=!0;let e=0;this.addContent(t),this.addContent(a("div",{style:"margin: 5px 0; display: flex; flex-wrap: wrap; justify-content: space-between;"},a("div",{onclick:()=>{5==++e&&(t.hidden=!1)}},"MusicCloud "+V.currentVersion),a(TextBtn,{onActive:t=>{(new AboutDialog).show(t),this.close()}},(()=>d`About`))))}show(t){this.inputServer.hidden=!!y.defaultAuth,super.show(t)}updateDom(){this.title=d`Settings`,this.btnClose.updateWith({text:d`Close`}),super.updateDom();const{theme:t,style:e}=getThemeAndStyle();this.btnSwitchTheme.text=d`UI color: ${l.get("colortheme_"+t)}`,this.btnSwitchStyle.text=d`UI style: ${l.get("styletheme_"+e)}`,this.btnSwitchLang.text=d`Language: ${d`English`}`,q.lang.siLang.data||(this.btnSwitchLang.text+=d` (auto-detected)`),this.inputPreferBitrate.updateWith({label:d`Preferred bitrate (0: original file)`}),this.inputServer.updateWith({label:d`Custom server URL`}),this.btnNotification.text=q.notification.config.enabled?d`Disable notification`:d`Enable notification`}}class AboutDialog extends Dialog{constructor(){super(),this.title=d`About`,this.width="500px",this.addContent(new View(a("div",null,a("h2",null,d`MusicCloud`+" "+V.currentVersion),a("p",null,V.currentDate?d`Build Date`+": "+new Date(V.currentDate).toLocaleString(q.lang.curLang):""),a("p",null,f`This project is ${a("a",{href:"https://github.com/lideming/MusicCloud",class:"clickable",target:"_blank"},(()=>d`open-sourced`))} under MIT license.`),a("p",null,f`This project is based on ${a("a",{href:"https://github.com/lideming/webfx",class:"clickable",target:"_blank"},"webfx")}.`),a("h3",null,d`Recent changes:`),a("div",{style:"max-height: 300px; overflow-y: auto;"},a("table",null,a("tr",null,a("th",null,"Id"),a("th",null,"Message")),C.commits.map((t=>a("tr",null,a("td",null,a("a",{href:`https://github.com/lideming/MusicCloud/commit/${t.id}`,target:"_blank"},a("code",null,t.id))),a("td",null,t.message)))))))))}}class Sidebar extends View{constructor(){super(...arguments),this.header=new View(a("div",{id:"sidebar-header"},new View(a("div",{style:"flex: 1"})),a(SettingsBtn,null))),this.features=new ListView(a("div",{id:"sidebar-features"})),this.list=new View(a("div",{id:"sidebar-list"}))}createDom(){return a("nav",{id:"sidebar",class:"no-selection"},this.header,this.features,this.list)}}class SidebarItem extends ListViewItem{constructor(t){super(),this._text="",this.contentView=null,objectInit(this,t)}get text(){return getFuncVal(this._text)}set text(t){this._text=t}createDom(){return{tag:"li.item.no-selection",tabIndex:0,text:()=>getFuncVal(this.text)}}bindContentView(t){return this}}class SettingsBtn extends View{createDom(){return a("div",{class:"item",id:"settings-btn",tabIndex:"0"},a(Icon,{icon:'<svg xmlns="http://www.w3.org/2000/svg" enable-background="new 0 0 24 24" height="24" viewBox="0 0 24 24" width="24"><g><path d="M0,0h24v24H0V0z" fill="none"/><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/></g></svg>'}))}postCreateDom(){super.postCreateDom(),this.onActive.add((t=>{S.openUI(t)}))}}class ContentView extends View{constructor(){super(...arguments),this._isVisible=!1,this._lastRenderedLanguage="",this._fadeout=null,this._shownEvents=null}get isVisible(){return this._isVisible}postCreateDom(){super.postCreateDom(),this.toggleClass("contentview",!0)}onShow(){this._isVisible=!0,this.domCreated&&this._lastRenderedLanguage!=q.lang.curLang&&this.updateAll()}onDomInserted(){}onShowing(){}updateDom(){super.updateDom(),this._lastRenderedLanguage=q.lang.curLang}onHiding(){}onRemove(){var t;this._isVisible=!1,null===(t=this._shownEvents)||void 0===t||t.removeAll()}onDomRemoved(){}onSidebarItemReactived(){}fadeIn(){var t;null===(t=this._fadeout)||void 0===t||t.cancel(),this.onShowing()}fadeOut(){this.onHiding(),this._fadeout=fadeout(this.dom,{remove:!1}).onFinished((()=>{this.onRemove(),this.removeFromParent(),this.onDomRemoved()}))}get shownEvents(){return this._shownEvents?this._shownEvents:this._shownEvents=new EventRegistrations}}class ContentHeader extends View{constructor(t){super(),this.titleEditable=!1,this.actions=new ContainerView({tag:"div.actions"}),this.scrollbox=null,this.scrollboxScrollHandler=null,this.titleView=new View({tag:"span.title.no-selection",text:()=>getFuncVal(this.title),update:t=>{toggleClass(t,"editable",!!this.titleEditable),this.titleEditable?t.title=d`Click to edit`:t.removeAttribute("title"),t.tabIndex=this.titleEditable?0:-1}}),this.titlebar=new View({tag:"div.titlebar.clearfix",child:[{tag:"span.catalog.no-selection",text:()=>getFuncVal(this.catalog),hidden:()=>!this.catalog},this.titleView,this.actions]}),t&&objectInit(this,t),this.titleView.onActive.add((async()=>{if(this.titleEditable&&(this.editHelper=this.editHelper||new EditableHelper(this.titleView.dom),!this.editHelper.editing)){var t=await this.editHelper.startEditAsync();t!==this.editHelper.beforeEdit&&""!=t&&this.onTitleEdit(t),this.updateDom()}}))}createDom(){return{tag:"div.content-header",child:[this.titlebar]}}bindScrollBox(t){this.scrollbox&&(this.scrollbox.removeEventListener("scroll",this.scrollboxScrollHandler),this.scrollboxScrollHandler=null),this.scrollbox=t,null==t||t.addEventListener("scroll",this.scrollboxScrollHandler=t=>{t.eventPhase==Event.AT_TARGET&&this.onScrollboxScroll()},{passive:!0})}onScrollboxScroll(){var t,e;setScrollableShadow(this.dom,null!==(e=null===(t=this.scrollbox)||void 0===t?void 0:t.scrollTop)&&void 0!==e?e:0)}updateDom(){super.updateDom(),this.titlebar.updateDom(),this.titleView.updateDom()}}function getFuncVal(t){return"function"==typeof t?t():t}class ActionBtn extends TextView{get active(){return this.dom.classList.contains("active")}set active(t){this.toggleClass("active",t)}constructor(t){super(),objectInit(this,t)}createDom(){return{tag:"span.action.clickable.no-selection",tabIndex:0}}}function setScrollableShadow(t,e){t.style.boxShadow=`0 0 ${numLimit(2*Math.log(e),0,10)}px var(--color-light-shadow)`}class CopyMenuItem extends MenuItem{constructor(t){super(t),this.textView=null,this.onActive.add((()=>{this.dom.textContent="",this.textView||(this.textView=new InputView,this.addChild(this.textView),this.textView.value=this.textToCopy),this.textView.dom.select(),document.execCommand("copy")}))}}class Icon extends View{get icon(){return this.dom.innerHTML}set icon(t){this.dom.innerHTML=t}constructor(t){super({tag:"span.icon"}),objectInit(this,t)}}var E='<svg width="12" height="14" viewBox="0 0 12 14" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M11.2812 5.71875C11.7281 5.99375 12 6.47813 12 7C12 7.52187 11.7281 8.00625 11.2812 8.25313L2.28219 13.7531C1.81906 14.0625 1.23937 14.075 0.76625 13.8094C0.293031 13.5437 0 13.0437 0 12.5V1.5C0 0.9575 0.293031 0.457188 0.76625 0.191563C1.23937 -0.0737497 1.81906 -0.0628123 2.28219 0.22L11.2812 5.71875Z" fill="#FFD0CC"/>\n</svg>\n',A='<svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M10.7682 7.28712C10.384 6.90321 9.75 7.17474 9.75 7.71799V8.93751H8.53125L3.9 2.76251C3.74766 2.55938 3.50644 2.43751 3.25 2.43751H0.8125C0.36334 2.43751 0 2.80059 0 3.25001C0 3.69942 0.36334 4.06251 0.8125 4.06251H2.84375L7.475 10.2375C7.62734 10.4432 7.86855 10.5625 8.125 10.5625H9.74924V11.7797C9.74924 12.3228 10.4058 12.5953 10.79 12.2114L12.7984 10.1806C13.0367 9.94229 13.0367 9.55628 12.7984 9.31811L10.7682 7.28712ZM8.53125 4.06251H9.74924V5.28202C9.74924 5.82512 10.4061 6.0968 10.7674 5.7129L12.7758 3.68215C13.0141 3.44371 13.0141 3.0578 12.7758 2.81964L10.7674 0.788893C10.3832 0.404987 9.72661 0.677403 9.72661 1.22053V2.43751H8.125C7.86957 2.43751 7.62836 2.55811 7.47525 2.76276L6.44922 4.13106L7.44199 5.48438L8.53125 4.06251ZM2.84375 8.93751H0.8125C0.36334 8.93751 0 9.30085 0 9.75001C0 10.1992 0.36334 10.5625 0.8125 10.5625H3.25C3.50543 10.5625 3.74664 10.4419 3.89975 10.2373L4.92553 8.86946L3.91016 7.51563L2.84375 8.93751Z" fill="#FF6557"/>\n</svg>\n';const P=new class{constructor(){this.routes=[],this.wasBacked=!1,this.onNavCompleted=new r}init(){window.addEventListener("popstate",(t=>{this.navByLocation(!0)})),this.navByLocation()}navByLocation(t=!1){var e=window.location.hash;this.nav(e?e.substr(1):"",{pushState:!1,back:t})}addRoute(t){this.routes.push(t),t.sidebarItem&&t.sidebarItem().onActive.add((()=>{t.contentView&&t.contentView().isVisible?t.contentView().onSidebarItemReactived():this.nav([...t.path])}))}nav(t,e){"string"==typeof t&&(t=function parsePath(t){return t.split("/").map((t=>decodeURIComponent(t)))}(t));var n=t.map((t=>encodeURIComponent(t))).join("/");if(this.currentStr!==n||(null==e?void 0:e.evenIsCurrent)){for(const e of this.routes)if(match(t,e)){e.contentView&&q.content.setCurrent(e.contentView()),e.sidebarItem&&q.sidebarList.setActive(e.sidebarItem()),e.onNav&&e.onNav({path:t,remaining:t.slice(e.path.length)});break}if(this.current=t,this.currentStr=n,void 0===(null==e?void 0:e.pushState)||e.pushState){const t=[{},n,"#"+n];"replace"==(null==e?void 0:e.pushState)?window.history.replaceState(...t):window.history.pushState(...t)}this.onNavCompleted.invoke({path:t})}}};function match(t,e){var n=e.path;for(let e=0;e<n.length;e++)if(t[e]!==n[e])return!1;return!0}function parse(t){var e=Date.now(),n=new Parser(t).parse();return console.log(`[Lyrics] parsed ${t.length} chars in ${Date.now()-e} ms`,n),n}class LookaheadBuffer{constructor(){this.consumed=0,this.buf=[]}consume(){var t=this.peek(0);return this.buf.shift(),this.consumed++,t}peek(t){for(void 0===t&&(t=0);this.buf.length<=t;)this.buf.push(this.provider());return this.buf[t]}}const M={["[".charCodeAt(0)]:1,["]".charCodeAt(0)]:2,["{".charCodeAt(0)]:3,["}".charCodeAt(0)]:4,["\r".charCodeAt(0)]:null,["\n".charCodeAt(0)]:6};class Lexer{constructor(t){this.buf=new LookaheadBuffer,this.cur=0,this.str=t,this.buf.provider=()=>this.read()}get len(){return this.str.length}toArray(){for(var t=0;7!==this.buf.peek(t).type;t++);return this.buf.buf.map((t=>t))}read(){var t=this.readCore();return this.lastToken=t,t}readCore(){var t=this.str,e=this.cur,n=this.cur;try{if(n===t.length)return new Token(7,"[eof]",n);for(;;){var i=t.charCodeAt(n),s=n++;if(!(i>=0))return new Token(7,"[eof]",s);const r=M[i];if(void 0!==r){if(null===r)continue;return new Token(r,i,s)}for(;(i=t.charCodeAt(n))>=0&&void 0===M[i];)n++;return new Token(5,t.substring(e,n),e)}}finally{this.cur=n}}peek(t){return this.buf.peek(t)}consume(){return this.buf.consume()}tryExpect(t,e){var n=this.peek(e);return n.type===t?n:null}tryExpectSeq(t){var e=0;for(const n of t)if(!this.tryExpect(n,e++))return!1;return!0}expect(t){var e=this.tryExpect(t);return e||this.error(`expected token type '${B[t]}'`),e}error(t){throw new Error((null!=t?t:"error")+" at "+this.peek())}tryExpectAndConsume(t){return this.tryExpect(t)&&this.consume()}expectAndConsume(t){return this.expect(t),this.consume()}}var B;!function(t){t[t.tagBegin=1]="tagBegin",t[t.tagEnd=2]="tagEnd",t[t.bracketBegin=3]="bracketBegin",t[t.bracketEnd=4]="bracketEnd",t[t.text=5]="text",t[t.lineFeed=6]="lineFeed",t[t.eof=7]="eof"}(B||(B={}));class Token{constructor(t,e,n){this.type=t,this.val="number"==typeof e?String.fromCharCode(e):e,this.pos=n}toString(){return`{${B[this.type]}|${this.val}}`}}class Parser{constructor(t){this.lines=[],this.bpm=null,this.offset=0,this.curTime=0,this.lang="",this.tlang="",this.haveReadLyrics=!1,this.lex=new Lexer(t),this.tokens=this.lex.buf}parse(){var t,e=this.lex;for(this.skipLineFeeds();7!==e.peek().type;)t=e.buf.consumed,this.parseLine(),this.haveReadLyrics||this.skipLineFeeds(),e.buf.consumed===t&&e.error("parseLine() doesn't consume tokens");return this.lines.sort(((t,e)=>t.orderTime-e.orderTime)),{lines:this.lines,lang:this.lang,translationLang:this.tlang,bpm:this.bpm}}parseLine(){var t,e=this.lex,n=null,i=[],s=[],r=null,o=null,a=null,l=null;const d=e.peek().pos;for(;;)if(e.tryExpectAndConsume(1)){let r,h=null;if(e.tryExpect(2))r={time:-1,beats:null,beatsDiv:null};else{if(!e.tryExpect(5))return void this.pushRawLine(n,d);h=e.expectAndConsume(5).val,r=this.parseTimestamp(h,null!=a&&a>=0?a:null!==(t=this.curTime)&&void 0!==t?t:0)}if(e.tryExpectSeq([2,3])){e.consume(),e.consume();let t=e.expectAndConsume(5).val;e.expectAndConsume(4),s.push(o={text:h||"",ruby:t,startTime:a,timeStamp:l}),l=null;continue}if(null!=r){e.expectAndConsume(2),o||null==n?(l&&s.push(o={text:"",ruby:null,startTime:a,timeStamp:l}),l=r,-1!=r.time&&(a=r.time,null===n&&(n=r.time))):i.push(r);continue}if(null===h)continue;if(h.startsWith("bpm:"))this.bpm=parseFloat(h.substr(4)),e.expectAndConsume(2);else if(h.startsWith("offset:"))this.offset=parseFloat(h.substr(7))/1e3,e.expectAndConsume(2);else if(h.startsWith("lang:")){let t=/^([\w\-]+)(\/([\w\-]+))?$/.exec(h.substr(5));t&&(this.lang=t[1],this.tlang=t[3]||""),e.expectAndConsume(2)}else{if(!o)return void this.pushRawLine(n,d);s.push(o={text:"["+h+"]",ruby:null,startTime:a,timeStamp:null}),e.tryExpect(2)&&e.consume()}}else{if(!e.tryExpect(5)){if(e.tryExpect(6)){if(e.consume(),s.length>0&&e.tryExpect(5)){let t=e.peek().val;t.startsWith("/")&&(r=t.substr(1),e.consume(),e.tryExpectAndConsume(7)||e.expectAndConsume(6))}break}if(e.tryExpect(7))break;return void this.pushRawLine(n,d)}{let t=e.consume().val;s.push(o={text:t,ruby:null,startTime:a,timeStamp:l}),l=null}}if(l&&(s.push(o={text:"",ruby:null,startTime:a,timeStamp:l}),l=null),0===s.length){if(!this.haveReadLyrics)return;s.push(o={text:"",ruby:null,startTime:null,timeStamp:null})}this.haveReadLyrics=!0,null!=a&&(this.curTime=a),this.lines.push({startTime:n,orderTime:null!=n?n:this.curTime,translation:r,spans:s,rawLine:null}),i.forEach((t=>{var e=t.time-n;this.lines.push({startTime:t.time,orderTime:t.time,translation:r,spans:s.map((t=>({text:t.text,ruby:t.ruby,startTime:t.startTime>=0?t.startTime+e:t.startTime,timeStamp:t.timeStamp?{time:t.timeStamp.time>=0?t.timeStamp.time+e:t.timeStamp.time,beats:t.timeStamp.beats,beatsDiv:t.timeStamp.beatsDiv}:null}))),rawLine:null})}))}skipLine(){for(;!this.lex.tryExpect(6)&&!this.lex.tryExpect(7);)this.lex.consume();this.lex.consume()}skipLineFeeds(){for(;this.lex.tryExpect(6);)this.lex.consume()}pushRawLine(t,e){this.skipLine(),this.lines.push({startTime:t,orderTime:null!=t?t:this.curTime,translation:null,spans:null,rawLine:this.lex.str.substring(e,this.lex.peek().pos)})}parseTimestamp(t,e){var n=/^((\d+)\:)?(\d+)(\.(\d+))?$/.exec(t);if(e||(e=0),n){let t=0;return n[2]&&(t+=60*parseInt(n[2])),n[3]&&(t+=parseInt(n[3])),n[4]&&(t+=parseFloat(n[4])),t+=this.offset,t<0&&(t=0),{time:t,beats:null,beatsDiv:null}}if(n=/^b([\d\.]+)?(\/(\d+))?$/.exec(t)){let t={time:60/this.bpm,beats:1,beatsDiv:1};return n[1]&&(t.beats=parseFloat(n[1]),t.time*=t.beats),n[3]&&(t.beatsDiv=parseInt(n[3]),t.time/=t.beatsDiv),t.time+=e,t}return null}}function serialize(t,e=!1){var n="",i=e&&(!!t.lang||null!=t.bpm);return t.lines.forEach((s=>{s.spans&&i&&(i=!1,t.lang&&(n+="[lang:"+t.lang,t.translationLang&&(n+="/"+t.translationLang),n+="]\n"),null!=t.bpm&&(n+="[bpm:"+t.bpm+"]\n"),n+="\n"),s.rawLine?n+=s.rawLine:s.spans&&(s.spans.forEach((t=>{if(t.timeStamp)if(e)null!=t.timeStamp.beats?(n+="[b",1!=t.timeStamp.beats&&(n+=t.timeStamp.beats),1!=t.timeStamp.beatsDiv&&(n+="/"+t.timeStamp.beatsDiv),n+="]"):-1===t.timeStamp.time?n+="[]":n+="["+t.timeStamp.time.toFixed(3)+"]";else{const e=t.timeStamp.time;if(-1===t.timeStamp.time);else{const t=padLeft(Math.floor(e/60),2,"0"),i=padLeft((e%60).toFixed(2),5,"0");n+=`[${t}:${i}]`}}e&&null!=t.ruby?n+="["+t.text+"]{"+t.ruby+"}":n+=t.text})),e&&s.translation&&(n+="\n/"+s.translation),n+="\n")})),n}function padLeft(t,e,n){for("number"==typeof t&&(t=t.toString());t.length<e;)t=n+t;return t}var F=Object.freeze({__proto__:null,parse:parse,Parser:Parser,serialize:serialize});class LyricsView extends View{constructor(){super(),this.lines=new ContainerView({tag:"div.lyrics"}),this.lyrics=null,this.hasVisibleLyrics=!1,this.track=null,this.curLine=new ItemActiveHelper,this.curTime=0,this.scrollingTarget=null,this.onSpanClick=new r,this.onFontSizeChanged=new r,this.onLyricsChanged=new r,this.scrollAnimator=new ScrollAnimator(this),this._fontSize=100,this.scrollPos=0,this._resize=()=>{this.resize()},this.timer=new Timer((()=>this.onProgressChanged())),this.lastChangedRealTime=0,this.onProgressChanged=()=>{if(this.isTrackPlaying()){var t=x.currentTime,e=Date.now();t!=this.curTime&&(this.lastChangedRealTime=e,this.setCurrentTime(t,"smooth")),e-this.lastChangedRealTime<250?this.timer.cancelFunc||this.timer.interval(30):this.timer.tryCancel()}},this.pauseScrollTime=null,this.setLyrics(""),this.scrollAnimator.posType="center",this.scrollAnimator.onUserScroll.add((()=>{this.setScrollingPause(5e3)}))}createDom(){return{tag:"div.lyricsview",tabIndex:0,child:[this.lines]}}postCreateDom(){var t,e;function dist(t,e){var n=t.screenX-e.screenX,i=t.screenY-e.screenY;return Math.sqrt(n*n+i*i)}this.dom.addEventListener("touchstart",(n=>{n.touches.length>=2&&(n.preventDefault(),t=this.scale,e=dist(n.touches[0],n.touches[1]))})),this.dom.addEventListener("touchmove",(n=>{if(n.touches.length>=2){n.preventDefault();var i=dist(n.touches[0],n.touches[1]),s=numLimit(t*i/e,20,500);this.scale=s}})),this.dom.addEventListener("wheel",(t=>{if(t.ctrlKey&&t.deltaY){t.preventDefault();var e=this.scale+(t.deltaY>0?-20:20);e=numLimit(e,20,500),this.scale=e}}))}setLyrics(t){let e,n="";try{e="string"==typeof t?parse(t):t}catch(t){console.error("[Lyrics] parsing error",t),n=d`Error parsing lyrics`,e=null}this.lyrics=e,this.hasVisibleLyrics=!1,this.curLine.set(null),this.lines.removeAllView(),(null==e?void 0:e.lang)?this.lines.dom.lang=e.lang:this.lines.dom.removeAttribute("lang");const i=Date.now(),s={lyrics:e,onSpanClicked:t=>this.onSpanClick.invoke(t),enableTranslation:!0};e&&e.lines.forEach((t=>{t.spans&&(this.lines.addView(new LineView(t,s)),this.hasVisibleLyrics=!0)})),this.hasVisibleLyrics||this.lines.addView(new LineView({orderTime:0,spans:[{text:n||d`No lyrics`}]},s)),console.log(`[LyricsView] rendered ${[this.lines.length]} lines in ${Date.now()-i} ms`),this.onLyricsChanged.invoke(),this.resize()}setCurrentTime(t,e){var n,i;if(this.hasVisibleLyrics){t>=0||(t=0),this.curTime=t;var s=this.curLine.current,r=this.getLineByTime(t,s),o=this.getLineByTime(t+this.scrollAnimator.duration/1e3*.5*x.playbackRate,r);null==r||r.setCurrentTime(t),this.curLine.set(r),e&&"smooth"!==e&&r&&(s!==r||"force"===e)?(this.scrollAnimator.cancel(),this.scrollAnimator.currentPos=r.dom.offsetTop+r.dom.offsetHeight/2):"smooth"!==e||this.isScrollingPaused()||o===this.scrollingTarget||(this.scrollingTarget=o,this.scrollAnimator.duration=300/x.playbackRate,o?this.scrollAnimator.scrollTo(o.dom.offsetTop+o.dom.offsetHeight/2):this.scrollAnimator.scrollTo(null!==(i=null===(n=this.lines.get(0))||void 0===n?void 0:n.dom.offsetTop)&&void 0!==i?i:0))}}resize(){if(this.domCreated){const t=this.dom.offsetHeight,e=this.lines.dom.scrollHeight;this.lines.dom.style.margin=e>t/2?(t-1)/2+"px 0":(t-e-1)/2+"px 0"}this.isScrollingPaused()||this.centerLyrics()}get scale(){return this._fontSize}set scale(t){this._fontSize=t,this.lines.dom.style.fontSize=t+"%",this.onFontSizeChanged.invoke()}reset(){this.dom.scrollTop=this.scrollPos=0}onShow(){this.scrollAnimator.currentPos=this.scrollPos,this.isTrackPlaying()&&this.setCurrentTime(x.currentTime),requestAnimationFrame(this._resize),window.addEventListener("resize",this._resize)}onHide(){this.scrollPos=this.scrollAnimator.currentPos,window.removeEventListener("resize",this._resize),this.timer.tryCancel()}centerLyrics(){"playing"===x.state&&this.isTrackPlaying()&&this.setCurrentTime(x.currentTime,"force")}isTrackPlaying(){return x.track&&x.track===this.track&&x.track.id===this.track.id}isScrollingPaused(){return!!(this.pauseScrollTime&&Date.now()<this.pauseScrollTime)}setScrollingPause(t){null==t?this.pauseScrollTime=null:(this.pauseScrollTime=Math.max(this.pauseScrollTime||0,Date.now()+t),this.scrollingTarget=null)}getLineByTime(t,e){var n;if(e&&t>=e.line.startTime){n=e;for(let i=e.position+1;i<this.lines.length;i++){let e=this.lines.get(i);if(null!=e.line.startTime){if(!(e.line.startTime<=t))break;n=e}}}else n=null,this.lines.forEach((e=>{null!=e.line.startTime&&e.line.startTime<=t&&(n=e)}));return n}}class LineView extends ContainerView{constructor(t,e){var n;if(super({tag:"p.line"}),this.currentIndex=0,this.context=e,this.line=t,this.line.spans.forEach((t=>{this.addView(new SpanView(t,this))})),(null===(n=this.context)||void 0===n?void 0:n.enableTranslation)&&this.line.translation){const t=null==e?void 0:e.lyrics;var i=t&&(t.translationLang||t.lang);this.dom.appendChild(buildDOM({tag:"div.trans",lang:i,text:this.line.translation}))}}get spans(){return this.items}setCurrentTime(t){const e=this.items;let n=this.currentIndex;for(;;)if(n<e.length&&e[n].startTime<=t)e[n].toggleClass("active",!0),n++;else{if(!(n>0&&e[n-1].startTime>t))break;e[n-1].toggleClass("active",!1),n--}this.currentIndex=n}}class SpanView extends View{constructor(t,e){super(),this.span=t,this.lineView=e}get timeStamp(){return this.span.timeStamp}set timeStamp(t){this.span.timeStamp=t}get startTime(){return this.span.startTime}set startTime(t){this.span.startTime=t}get isNext(){return this.dom.classList.contains("next")}set isNext(t){this.toggleClass("next",t)}createDom(){var t=this.span;return buildDOM({tag:"span.span",child:t.ruby?{tag:"ruby",child:[t.text,{tag:"rp",text:"("},{tag:"rt",text:t.ruby},{tag:"rp",text:")"}]}:t.text})}postCreateDom(){var t,e;super.postCreateDom(),this.dom.addEventListener("mousedown",(n=>{t=n.offsetX,e=n.offsetY})),this.dom.addEventListener("click",(n=>{var i,s;Math.abs(n.offsetX-t)<=3&&Math.abs(n.offsetY-e)<=3&&(n.preventDefault(),null===(s=null===(i=this.lineView.context)||void 0===i?void 0:i.onSpanClicked)||void 0===s||s.call(i,this))}))}}const U={"list-seq":'<svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M1.50001 10.2131H9.125L9.12499 11.3477C9.12499 11.5877 9.26662 11.8055 9.4863 11.9038C9.70643 11.9991 9.96288 11.9611 10.1432 11.7989L12.1744 9.97385C12.3016 9.85978 12.375 9.69502 12.375 9.52266C12.375 9.35029 12.3016 9.18604 12.1734 9.07045L10.1422 7.24542C10.0289 7.14251 9.88163 7.08928 9.73437 7.08928C9.65027 7.08928 9.5664 7.1067 9.48665 7.14154C9.26718 7.23883 9.12499 7.45682 9.12499 7.69762V8.71305H1.50001C1.50001 8.71305 1 8.75277 1 9.50825C1 10.2637 1.50001 10.2131 1.50001 10.2131Z" fill="#FF6557"/>\n<path d="M1.50001 4.1238H9.125L9.12499 5.25844C9.12499 5.49846 9.26662 5.71622 9.4863 5.81457C9.70643 5.90987 9.96288 5.87185 10.1432 5.70963L12.1744 3.88459C12.3016 3.77053 12.375 3.60577 12.375 3.43341C12.375 3.26104 12.3016 3.09679 12.1734 2.9812L10.1422 1.15617C10.0289 1.05326 9.88163 1.00003 9.73437 1.00003C9.65027 1.00003 9.5664 1.01746 9.48665 1.0523C9.26718 1.14958 9.12499 1.36757 9.12499 1.60837V2.6238H1.50001C1.50001 2.6238 1 2.66352 1 3.41901C1 4.17449 1.50001 4.1238 1.50001 4.1238Z" fill="#FF6557"/>\n</svg>\n',"list-loop":'<svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M12.1875 6.48896C11.7388 6.48896 11.375 6.85169 11.375 7.30009C11.375 8.64199 10.2817 9.73346 8.9375 9.73346H4.875V8.71956C4.875 8.47954 4.73337 8.26178 4.51369 8.16343C4.29355 8.06812 4.03711 8.10614 3.85684 8.26837L1.82559 10.0934C1.69838 10.2075 1.625 10.3722 1.625 10.5446C1.625 10.717 1.6984 10.8812 1.82655 10.9968L3.8578 12.8218C3.97109 12.9247 4.11836 12.978 4.26562 12.978C4.34972 12.978 4.43358 12.9605 4.51334 12.9257C4.73281 12.8284 4.875 12.6104 4.875 12.3696V11.3557H8.9375C11.1775 11.3557 13 9.53626 13 7.30009C13 6.85143 12.6369 6.48896 12.1875 6.48896ZM4.0625 3.24446H8.10215L8.125 4.25837C8.125 4.49838 8.26663 4.71614 8.48631 4.81449C8.5668 4.84897 8.65059 4.86671 8.71152 4.86671C8.85909 4.86671 9.00529 4.81285 9.11955 4.71067L11.1508 2.88564C11.3014 2.77046 11.375 2.6057 11.375 2.41052C11.375 2.21534 11.3016 2.0739 11.1734 1.95832L9.1422 0.133284C8.96327 -0.0267101 8.70573 -0.0663285 8.48636 0.029511C8.26719 0.15047 8.10215 0.368257 8.10215 0.6083L8.125 1.62221H4.0625C1.82254 1.62221 0 3.44217 0 5.67784C0 6.12624 0.363848 6.48896 0.8125 6.48896C1.26115 6.48896 1.625 6.12624 1.625 5.67784C1.625 4.33694 2.71934 3.24446 4.0625 3.24446Z" fill="#FF6557"/>\n</svg>\n',"list-shuffle":A,"track-loop":'<svg width="13" height="13" viewBox="0 0 13 13" fill="none" xmlns="http://www.w3.org/2000/svg">\n<g clip-path="url(#clip0_17_4)">\n<path d="M12.1875 6.48896C11.7388 6.48896 11.375 6.85169 11.375 7.30009C11.375 8.64199 10.2817 9.73346 8.9375 9.73346H4.875V8.71956C4.875 8.47954 4.73337 8.26178 4.51369 8.16343C4.29355 8.06812 4.03711 8.10614 3.85684 8.26837L1.82559 10.0934C1.69838 10.2075 1.625 10.3722 1.625 10.5446C1.625 10.717 1.6984 10.8812 1.82655 10.9968L3.8578 12.8218C3.97109 12.9247 4.11836 12.978 4.26562 12.978C4.34972 12.978 4.43358 12.9605 4.51334 12.9257C4.73281 12.8284 4.875 12.6104 4.875 12.3696V11.3557H8.9375C11.1775 11.3557 13 9.53626 13 7.30009C13 6.85143 12.6369 6.48896 12.1875 6.48896ZM4.0625 3.24446H8.10215L8.125 4.25837C8.125 4.49838 8.26663 4.71614 8.48631 4.81449C8.5668 4.84897 8.65059 4.86671 8.71152 4.86671C8.85909 4.86671 9.00529 4.81285 9.11955 4.71067L11.1508 2.88564C11.3014 2.77046 11.375 2.6057 11.375 2.41052C11.375 2.21534 11.3016 2.0739 11.1734 1.95832L9.1422 0.133284C8.96327 -0.0267101 8.70573 -0.0663285 8.48636 0.029511C8.26719 0.15047 8.10215 0.368257 8.10215 0.6083L8.125 1.62221H4.0625C1.82254 1.62221 0 3.44217 0 5.67784C0 6.12624 0.363848 6.48896 0.8125 6.48896C1.26115 6.48896 1.625 6.12624 1.625 5.67784C1.625 4.33694 2.71934 3.24446 4.0625 3.24446Z" fill="#FF6557"/>\n<path d="M6.5 8V6.2V5L5.5 5.6" stroke="#FF6557" stroke-linecap="round" stroke-linejoin="round"/>\n</g>\n<defs>\n<clipPath id="clip0_17_4">\n<rect width="13" height="13" fill="white"/>\n</clipPath>\n</defs>\n</svg>\n'};class ControlButton extends View{constructor({icon:t}){super(a("div",{class:"control-btn clickable"})),this.icon=t}set icon(t){this.dom.innerHTML=t}set disabled(t){this.toggleClass("disabled",t)}}class PlayButton extends ControlButton{constructor(){super({icon:E}),this.toggleClass("play-btn",!0)}setAction(t){this.dom.innerHTML="play"==t?E:'<svg width="10" height="15" viewBox="0 0 10 15" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M8.5 0.341614H7.5C6.67156 0.341614 6 1.13909 6 2.08947V12.777C6 13.7607 6.67156 14.5582 7.5 14.5582L8.5 14.625C9.32844 14.625 10 13.8275 10 12.8438V2.15626C10 1.17249 9.32812 0.341614 8.5 0.341614ZM2.5 0.341614H1.5C0.671562 0.341614 0 1.13909 0 2.12286V12.8104C0 13.8272 0.671562 14.625 1.5 14.625H2.5C3.32844 14.625 4 13.8275 4 12.8438V2.15626C4 1.17249 3.32812 0.341614 2.5 0.341614Z" fill="#FFD0CC"/>\n</svg>\n'}}class ProgressBar extends View{constructor(){super(...arguments),this.refCurrentTime=new Ref,this.refTotalTime=new Ref,this.refBackground=new Ref,this.refFill=new Ref,this.loudnessMap=new LoudnessMap}createDom(){return a("div",{class:"progress-bar"},a("span",{ref:this.refCurrentTime,class:"time"},"--:--"),a("div",{ref:this.refBackground,class:"background"},a("div",{ref:this.refFill,class:"fill"}),this.loudnessMap),a("span",{ref:this.refTotalTime,class:"time"},"--:--"))}bindPlayer(t){t.onTrackChanged.add((()=>{var e;this.refTotalTime.value.textContent=formatDuration(null===(e=t.track)||void 0===e?void 0:e.length),this.loudnessMap.updateLoudnessMap(t)})),t.onProgressChanged.add((()=>{var e,n;this.refCurrentTime.value.textContent=formatDuration(t.currentTime),this.refFill.value.style.width=`${numLimit(t.currentTime/(null!==(n=null===(e=t.track)||void 0===e?void 0:e.length)&&void 0!==n?n:0)*100,0,100)}%`})),listenPointerEvents(this.refBackground.value,(e=>{if(e.ev.preventDefault(),"up"==e.action)return;const n=this.refBackground.value.getBoundingClientRect();return t.currentTime=(e.point.clientX-n.left)/n.width*t.duration,"down"==e.action?"track":void 0}))}}class LoudnessMap extends View{createDom(){return a("canvas",{class:"loudness-map",height:"32",width:"1024"})}async updateLoudnessMap(t){const e=t.track;var n=await(null==e?void 0:e._loudmap);if(e&&!n){if(this.dom){const t=this.dom.getContext("2d"),{width:e,height:n}=this.dom;t.clearRect(0,0,e,n)}e._loudmap=(async()=>{var t=await y.get(`tracks/${e.id}/loudnessmap`);if(!t.ok)return null;var n=await t.arrayBuffer();return e._loudmap=new Uint8Array(n)})(),n=await e._loudmap}if(t.track===e)if(n&&n.length>20){const[t,e]=[Math.min(1024,n.length/4),32];this.dom.width=t;const i=2,s=n.length/(t+(i-1)),r=e/256*(256/Math.log(256)),o=this.dom.getContext("2d");o.clearRect(0,0,t,e),o.beginPath();let a=[];for(let e=0;e<t+(i-1);e+=1){const t=Math.floor(e*s),i=Math.floor(e*s+s);let r=0;for(let e=t;e<i;e++)r+=n[e];a.push(r/s)}a=this.smooth(a);const l=[...a].filter((t=>t>0)).sort(((t,e)=>t-e)),d=Math.log(l[Math.floor(.02*l.length)])*r,h=.75*e/(Math.log(l[Math.floor(.99*l.length)])*r-d),c=.2*e-d*h;o.moveTo(-1,e);for(let n=0;n<t;n++){let t=a[n];t<=0?t=0:(t=Math.log(t),t*=r,t*=h,t+=c),o.lineTo(n,e-t),o.lineTo(n+1,e-t)}o.lineTo(t,e),o.fillStyle="white",o.fill(),this.hidden=!1}else this.hidden=!0}smooth(t){var e=t[0],n=[];for(let i=1;i<t.length;i++){e+=.25*(t[i]-e),Math.abs(e)<1&&(e=0),n.push(e)}return console.info({arr:t,r:n}),n}}class ProgressButton extends View{constructor(t){super(null!=t?t:{tag:"div.btn"}),this.fill=new View({tag:"div.btn-fill"}),this.textSpan=new TextView({tag:"span.text"}),this.dom.classList.add("btn-progress"),this.appendView(this.fill),this.appendView(this.textSpan)}get text(){return this.textSpan.text}set text(t){this.textSpan.text=t}get progress(){return this._progress}set progress(t){this.fill.dom.style.width=100*t+"%",this._progress=t}}class VolumeButton extends ProgressButton{constructor(t){var e,n;super(t),this.onChanging=new r,this.showUsage=!1,this.tipView=new ToolTip,this.addView(new View(a("span",{innerHTML:'<svg width="12" height="11" viewBox="0 0 12 11" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M9.02563 3.91016C8.80075 3.73111 8.46978 3.76262 8.28734 3.98325C8.10346 4.20325 8.13628 4.52788 8.36117 4.70813C8.60781 4.90703 8.75 5.19492 8.75 5.48067C8.75 5.7851 8.60781 6.07342 8.36041 6.27193C8.13553 6.45232 8.10272 6.77682 8.28658 6.99682C8.38981 7.12156 8.54077 7.18592 8.69258 7.18592C8.80948 7.18592 8.92773 7.1477 9.02486 7.06993C9.51781 6.69238 9.8 6.11445 9.8 5.48067C9.8 4.84688 9.51781 4.30547 9.02563 3.91016ZM10.3491 2.32461C10.1255 2.14556 9.79475 2.17641 9.61012 2.39637C9.42624 2.61637 9.45906 2.941 9.68328 3.12125C10.4256 3.69746 10.85 4.58262 10.85 5.48067C10.85 6.37871 10.4248 7.24453 9.68384 7.85899C9.45963 8.03937 9.42681 8.36387 9.61069 8.58387C9.7146 8.70794 9.86488 8.77231 10.0167 8.77231C10.1343 8.77231 10.2519 8.73409 10.3496 8.65563C11.3356 7.88262 11.9 6.72461 11.9 5.48067C11.9 4.23672 11.3356 3.11524 10.3491 2.32461ZM6.58875 0.751524C6.33719 0.640214 6.04166 0.685438 5.83559 0.865177L2.88313 3.43965H1.05C0.470094 3.43965 0 3.90113 0 4.47004V6.53082C0 7.09973 0.470094 7.56121 1.05 7.56121H2.884L5.83494 10.135C5.96531 10.248 6.13156 10.3082 6.3 10.3082C6.39708 10.3082 6.49598 10.2882 6.58788 10.2473C6.84031 10.1363 7 9.89141 7 9.62285V1.37758C7 1.10752 6.84031 0.862169 6.58875 0.751524Z" fill="#FFA299"/>\n</svg>\n'}))),this.toggleClass("volume-btn",!0),this.tipView.toggleClass("volume-tip",!0),this.InputStateTracker=new InputStateTracker(this.dom),this.InputStateTracker.onChanged.add((()=>this.updateTip())),this.dom.addEventListener("wheel",(t=>{t.preventDefault();var e=-.05*Math.sign(t.deltaY);this.onChanging.invoke(this.progress+e)})),listenPointerEvents(this.dom,(t=>{if("mouse"!==t.type||"down"!==t.action||1==t.ev.buttons){if(t.ev.preventDefault(),"down"===t.action)return this.dom.focus(),e=t.point.pageX,n=this.progress,this.dom.classList.add("btn-down"),this.fill.dom.style.transition="none","track";if("move"===t.action){var i=t.point.pageX-e;this.onChanging.invoke(n+.01*i)}else"up"===t.action&&("touchcancel"==t.ev.type&&this.onChanging.invoke(n),this.dom.classList.remove("btn-down"),this.fill.dom.style.transition="");this.updateTip()}})),this.dom.addEventListener("click",(t=>{this.showUsage=!0,this.updateTip()}));const i={ArrowUp:.05,ArrowDown:-.05,ArrowRight:.01,ArrowLeft:-.01};this.dom.addEventListener("keydown",(t=>{var e=i[t.code];e&&(t.preventDefault(),this.onChanging.invoke(this.progress+e))}))}get state(){return this.InputStateTracker.state}get progress(){return super.progress}set progress(t){super.progress=t,this.updateTip()}updateTip(){const t=Math.floor(100*this.progress);this.tipView.text=t+"%";const e=this.state.mouseIn||this.state.mouseDown||this.state.focusIn&&q.usingKeyboardInput;if(e==this.tipView.shown);else if(e){const t=this.dom.getBoundingClientRect(),e=this.parentView.dom,n=e.getBoundingClientRect();this.tipView.show({x:t.left+t.width/2-n.left,y:t.top-n.top-3,parent:e})}else this.tipView.close({className:"animation-fading-out"})}bindPlayer(t){t.onVolumeChanged.add((()=>{this.progress=t.volume}))(),this.onChanging.add((e=>{var n=numLimit(e,0,1);n=Math.round(100*n)/100,this.showUsage=!1,t.volume=n}))}}class SimpleLyricsView extends View{constructor(){super(...arguments),this.lyrics=null,this.currentLine=null,this.lineView=null,this.onLyricsChanged=new r,this.currentFadingout=null}createDom(){return a("div",{class:"lyrics clickable"})}postCreateDom(){super.postCreateDom(),this.onActive.add((()=>{P.nav("nowplaying")}))}bindPlayer(t){t.onTrackChanged.add((async()=>{const e=t.track;if(!e)return this.lyrics=null,this.fadeoutCurrentLineView(),void this.onLyricsChanged.invoke();this.fadeoutCurrentLineView();const n=await e.getLyrics();this.lyrics=parse(n),this.onLyricsChanged.invoke()}));const updateLine=()=>{var n;if(!this.lyrics)return;const i=t.currentTime+.1;let s=null;for(const t of this.lyrics.lines)if(null!=t.startTime){if(t.startTime>i&&s&&(1!=(null===(n=s.spans)||void 0===n?void 0:n.length)||s.spans[0].text))break;s=t}this.currentLine!==s&&(this.currentLine=s,this.fadeoutCurrentLineView(),s&&(this.lineView=new LineView(s),this.addView(this.lineView))),this.lineView&&this.lineView.setCurrentTime(i),e.timeout(100)},e=new Timer(updateLine);t.onProgressChanged.add((()=>{updateLine()}))}fadeoutCurrentLineView(){const t=this.lineView;t&&(this.currentFadingout&&this.currentFadingout.cancel(!0),this.lineView=null,this.currentFadingout=fadeout(t.dom,{remove:!1}).onFinished((()=>{this.removeView(t),this.currentFadingout=null})))}}class ListContentView extends ContentView{constructor(){super(...arguments),this._scrollPos=0}get rendered(){return this.domCreated}get canMultiSelect(){return this._canMultiSelect}set canMultiSelect(t){this._canMultiSelect=t,this.selectBtn&&(this.selectBtn.hidden=!this.canMultiSelect),this.listView&&(this.listView.selectionHelper.ctrlForceSelect=this.canMultiSelect)}createDom(){return buildDOM({tag:"div.listcontentview"})}postCreateDom(){super.postCreateDom(),this.appendHeader(),this.appendScrollBox()}createHeader(){return new ContentHeader({title:this.title})}appendHeader(){this.header=this.createHeader(),this.header.actions.addView(this.refreshBtn=new ActionBtn({text:()=>d`Refresh`})),this.header.actions.addView(this.selectAllBtn=new ActionBtn({text:()=>d`Select all`})),this.header.actions.addView(this.selectBtn=new ActionBtn({text:()=>d`Select`})),this.selectBtn.onActive.add((()=>{this.listView.selectionHelper.enabled=!this.listView.selectionHelper.enabled})),this.selectAllBtn.onActive.add((()=>{this.listView.forEach((t=>this.listView.selectionHelper.toggleItemSelection(t,!0)))})),this.appendView(this.header)}appendScrollBox(){this.scrollBox=this.createScrollBox(),this.appendView(this.scrollBox),this.appendListView()}createScrollBox(){var t=new View({tag:"div.scrollbox"});return this.header.bindScrollBox(t.dom),t}appendListView(){this.listView=new LazyListView({tag:"ul.listview"}),this.listView.lazy=!0,this.listView.selectionHelper.onEnabledChanged.add((()=>{this.selectBtn.hidden=!this.canMultiSelect&&!this.listView.selectionHelper.enabled,this.selectBtn.text=this.listView.selectionHelper.enabled?()=>d`Cancel`:()=>d`Select`,this.selectAllBtn.hidden=!this.listView.selectionHelper.enabled}))(),this.listView.selectionHelper.ctrlForceSelect=this.canMultiSelect,this.listView.scrollBox=this.scrollBox.dom,this.scrollBox.appendView(this.listView)}onShow(){super.onShow(),this.ensureDom(),this.listView.unload()}onDomInserted(){super.onDomInserted(),this.listView.ensureLoaded(50),this.scrollBox&&this._scrollPos&&(this.listView.dom.style.minHeight=this._scrollPos+this.scrollBox.dom.offsetHeight+"px",this.scrollBox.dom.scrollTop=this._scrollPos),this.listView.slowlyLoad(-1,100,!0).then((()=>{this.listView.dom.style.minHeight=""})),this.header.onScrollboxScroll()}onRemove(){this.scrollBox&&(this._scrollPos=this.scrollBox.dom.scrollTop),this.listView.stopLoading(),super.onRemove()}useLoadingIndicator(t){t!==this.loadingIndicator&&(this.rendered&&(this.loadingIndicator&&this.loadingIndicator.dom.remove(),t&&this.insertLoadingIndicator(t)),this.loadingIndicator=t),this.updateView()}insertLoadingIndicator(t){this.scrollBox.dom.insertBefore(t.dom,this.listView.dom)}updateView(){this.rendered&&(0===this.listView.length?this.loadingIndicator||(this.emptyIndicator=this.emptyIndicator||new LoadingIndicator({state:"normal",content:d`(Empty)`}),this.useLoadingIndicator(this.emptyIndicator)):this.emptyIndicator&&this.loadingIndicator===this.emptyIndicator&&this.useLoadingIndicator(null))}async loadingAction(t){var e=this.loadingIndicator||new LoadingIndicator;this.useLoadingIndicator(e);try{await t()}catch(n){throw e.error(n,(()=>this.loadingAction(t))),n}this.useLoadingIndicator(null)}}const H=new class{startEdit(t,e){this.view||(this.sidebarItem=new SidebarItem({text:()=>d`Edit Lyrics`}),this.view=new LyricsEditContentView,q.sidebarList.addFeatureItem(this.sidebarItem),P.addRoute({path:["lyricsEdit"],contentView:()=>this.view,sidebarItem:()=>this.sidebarItem,onNav:()=>{this.sidebarItem.hidden=!1}})),this.view.setTrack(t,e),P.nav("lyricsEdit")}};class LyricsEditContentView extends ContentView{constructor(){super(),this.header=new ContentHeader({title:d`Edit Lyrics`}),this.lyricsView=new EditableLyricsView,this.sourceView=new LyricsSourceView,this.currentView=null,this._mode="lyrics",this.track=null,this.lyrics=null,this.originalLyrics=null,this.header.actions.addView(this.btnLyrics=new ActionBtn({text:d`Lyrics View`,onActive:()=>{this.setMode("lyrics")}})),this.header.actions.addView(this.btnSource=new ActionBtn({text:d`Source View`,onActive:()=>{this.setMode("source")}})),this.header.actions.addView(new ActionBtn({text:d`Discard`,onActive:()=>{this.lyrics=this.originalLyrics,this.close()}})),this.header.actions.addView(new ActionBtn({text:d`Done`,onActive:()=>{this.serializeLyricsFromView(),this.close()}}))}get mode(){return this._mode}set mode(t){this.setMode(t)}setMode(t,e){if(e||t!==this._mode){try{e||this.serializeLyricsFromView();var n=this.currentView;if("lyrics"===t){try{var i=parse(this.lyrics)}catch(t){throw new Error(d`Error parsing lyrics`)}this.lyricsView.setLyrics(i),n=this.lyricsView}else{if("source"!==t)throw new Error("unknown mode");this.sourceView.value=this.lyrics,n=this.sourceView}this.setCurrentView(n)}catch(t){return void Toast.show(d`Failed to switch view.`+"\n"+t,3e3)}this.btnLyrics.active="lyrics"===t,this.btnSource.active="source"===t,this._mode=t}}setCurrentView(t){this.currentView&&(this.currentView.onHide(),this.removeView(this.currentView),this.currentView=null),t&&(this.currentView=t,this.appendView(t),t.onShow())}serializeLyricsFromView(){if("lyrics"===this.mode)this.lyricsView.modified&&(this.lyrics=serialize(this.lyricsView.lyrics,!0));else{if("source"!==this.mode)throw new Error("unknown mode");this.lyrics=this.sourceView.value}}close(){H.sidebarItem.hidden=!0,window.history.back(),this.track.startEdit().inputLyrics.value=this.lyrics}createDom(){return{tag:"div.lyricsedit",child:[this.header]}}setTrack(t,e){this.track=t,this.originalLyrics=e,this.lyrics=e,this.lyricsView.reset(),this.lyricsView.track=t,this.sourceView.reset(),this.setMode(e?this.mode:"source",!0)}onShow(){this.ensureDom(),this.shownEvents.add(x.onProgressChanged,(()=>{this.currentView===this.lyricsView&&this.lyricsView.onProgressChanged()}))}onDomInserted(){var t;super.onDomInserted(),null===(t=this.currentView)||void 0===t||t.onShow()}onRemove(){var t;super.onRemove(),null===(t=this.currentView)||void 0===t||t.onHide()}}class EditableLyricsView extends LyricsView{constructor(){super(),this.nextSpans=[],this.modified=!1,this.onLyricsChanged.add((()=>{this.modified=!1,this.lines.forEach((t=>{var e;if(null===(e=t.spans)||void 0===e?void 0:e.length){let e=t.spans[0].span;e.timeStamp||(e.timeStamp={time:-1,beats:null,beatsDiv:null}),t.spans.forEach((t=>{t.timeStamp&&t.toggleClass("ts",!0)}))}})),this.nextSpans=[],this.setNextSpans(this.getSpans())})),this.onSpanClick.add((t=>{null!=t.span.startTime&&t.span.startTime>=0&&(x.currentTime=numLimit(t.span.startTime-3,0,1/0)),this.setNextSpans(this.getSpans(t,"here"))})),this.dom.addEventListener("keydown",(t=>{if("ArrowRight"==t.code||"KeyF"==t.code||"KeyD"==t.code){if(t.preventDefault(),this.nextSpans.length){const t=x.currentTime;this.nextSpans[0].timeStamp.time=t,this.nextSpans.forEach((e=>{e.startTime=t})),0===this.nextSpans[0].position&&(this.nextSpans[0].lineView.line.startTime=t),this.modified=!0}let e=this.getSpans(null,"forward");e.length&&this.setNextSpans(e)}else if("ArrowLeft"==t.code){t.preventDefault();let e=this.getSpans(null,"backward");e.length&&this.setNextSpans(e)}})),this.toggleClass("edit",!0)}getSpans(t,e){if(!t)if(this.nextSpans.length)t=this.nextSpans["backward"===e?0:this.nextSpans.length-1];else{if(!this.lines.length)return[];t=this.lines.get(0).spans[0]}var n=t.position,i=t.lineView;if(null==e||"here"===e)for(;i.spans&&!i.spans[n].timeStamp;)0==n--&&(n=(i=this.lines.get(i.position-1)).length-1);else if("forward"===e)do{i&&++n===i.length&&(i=this.lines.get(i.position+1),n=0)}while(i&&i.spans&&!i.spans[n].timeStamp);else if("backward"===e)do{i&&0==n--&&(n=(i=this.lines.get(i.position-1)).length-1)}while(i&&i.spans&&!i.spans[n].timeStamp);var s=[];if(i)do{s.push(i.spans[n]),n++}while(n<i.length&&!i.spans[n].timeStamp);return s}setNextSpans(t){for(;this.nextSpans.length;)this.nextSpans.pop().isNext=!1;t.forEach((t=>{t.isNext=!0,this.nextSpans.push(t)}))}}class LyricsSourceEditView extends InputView{get value(){return this.dom.value}set value(t){this.dom.value=t}createDom(){return{tag:"textarea.input-text"}}postCreateDom(){super.postCreateDom(),this.dom.addEventListener("keydown",(t=>{if(t.ctrlKey&&"r"===t.key){t.preventDefault();const e=this.dom.selectionStart,n=this.dom.selectionEnd,i=this.dom.value;this.dom.value=i.substring(0,e)+"["+i.substring(e,n)+"]{}"+i.substring(n);const s=e==n?e+1:n+3;this.dom.setSelectionRange(s,s)}}))}}class LyricsSourceView extends LyricsSourceEditView{constructor(){super(),this.scrollPos=0,this.dom.style.border="none",this.dom.style.height="100%",this.dom.style.padding="10px",this.dom.style.resize="none"}reset(){this.scrollPos=0}onShow(){this.dom.scrollTop=this.scrollPos}onHide(){this.scrollPos=this.dom.scrollTop}}class Track{constructor(t){this.infoObj=null,this.blob=null,this._bind=void 0,this._loudmap=null,this._lyricsFetchTask=null,objectApply(this,t)}get id(){return this.infoObj.id}get owner(){return this.infoObj.owner}get name(){return this.infoObj.name}get type(){return this.infoObj.type}get artist(){return this.infoObj.artist}get url(){return this.infoObj.url}get picurl(){return this.infoObj.picurl}get thumburl(){return this.infoObj.thumburl}get files(){return this.infoObj.files}get length(){return this.infoObj.length}get size(){return this.infoObj.size}get lyrics(){return this.infoObj.lyrics}get visibility(){return this.infoObj.visibility}get displayName(){return this.artist+" - "+this.name}get canEdit(){return"admin"==N.role||N.info.id==this.owner}toString(){return`${d`Track ID`}: ${this.id}\r\n${d`Name`}: ${this.name}\r\n${d`Artist`}: ${this.artist}`}toApiTrack(){return this.infoObj}getExtensionName(){var t;return null===(t=/\.([\w\-_]{1,6})$/.exec(this.url))||void 0===t?void 0:t[1]}updateFromApiTrack(t){if(this.id!==t.id)throw new Error("Bad track id");this.infoObj=t}startEdit(t){var e=new TrackDialog;return e.setTrack(this),e.show(t),e}getFileUrl(t){return(null==t?void 0:t.profile)?-1!=t.size&&this.url+"."+t.profile:this.url}async requestFileUrl(t){var e=this.getFileUrl(t);if(!1!==e)return e;var n=Toast.show(d`Converting "${this.displayName}"...`);try{return t.size=(await y.post({path:`tracks/${this.id}/convert`,obj:{profile:t.profile}})).size,n.close(),this.getFileUrl(t)}catch(t){throw n.updateWith({text:d`Error converting "${this.displayName}".`+"\n"+t}),n.show(3e3),t}}isLyricsGotten(){return null!=this.lyrics}getLyrics(){return this.isLyricsGotten()?Promise.resolve(this.lyrics):this.id?(this._lyricsFetchTask||(this._lyricsFetchTask=(async()=>{try{var t=await y.get("tracks/"+this.id+"/lyrics");return this.infoObj.lyrics=t.lyrics,this.lyrics}catch(t){throw this._lyricsFetchTask=null,console.error(`[Track] id ${this.id} fetching lyrics error`,t),t}})()),this._lyricsFetchTask):Promise.resolve("")}}class TrackDialog extends Dialog{constructor(){super(),this.inputName=new LabeledInput({label:d`Name`}),this.inputArtist=new LabeledInput({label:d`Artist`}),this.inputAlbum=new LabeledInput({label:d`Album`}),this.inputAlbumArtist=new LabeledInput({label:d`Album artist`}),this.inputLyrics=new LabeledInputWithLoading({label:d`Lyrics`}),this.fileSelector=new FileSelector({accept:"image/jpeg"}),this.btnSave=new TextBtn({text:d`Save`,right:!0}),this.btnEditLyrics=new TextBtn({text:d`Edit Lyrics`,right:!0}),this.btnSetPicture=new TextBtn({text:d`Set Picture`,right:!0}),this.autoFocus=this.inputName.input,this.width="500px",this.resizable=!0,this.contentFlex=!0,this.inputLyrics.input=new LyricsSourceEditView,this.inputLyrics.input.dom.style.resize="none",this.inputLyrics.dom.style.flex="1",this.inputLyrics.dominput.style.minHeight="3em",this.inputLyrics.dominput.style.height="6em",[this.inputName,this.inputArtist,this.inputAlbum,this.inputAlbumArtist,this.inputLyrics,this.fileSelector].forEach((t=>this.addContent(t))),this.addBtn(this.btnSave),this.btnSave.onActive.add((()=>this.save())),this.addBtn(this.btnEditLyrics),this.btnEditLyrics.onActive.add((()=>{this.close(),H.startEdit(this.track,this.inputLyrics.value)})),this.addBtn(this.btnSetPicture),this.btnSetPicture.onActive.add((()=>{this.fileSelector.open()})),this.fileSelector.onfile=async t=>{try{this.btnSetPicture.updateWith({clickable:!1,text:d`Uploading...`});let e=await y.put({path:`tracks/${this.track.id}/picture`,mode:"raw",obj:await t.arrayBuffer()});this.btnSetPicture.updateWith({clickable:!1,text:d`Done`}),this.track.updateFromApiTrack(e),y.onTrackInfoChanged.invoke(e)}catch(t){console.error(t),this.btnSetPicture.updateWith({clickable:!1,text:d`Error`})}finally{sleepAsync(2e3).then((()=>{this.btnSetPicture.updateWith({clickable:!0,text:d`Set Picture`})}))}},this.compositionWatcher=new TextCompositionWatcher(this.dom),this.dom.addEventListener("keydown",(t=>{!this.track.canEdit||this.compositionWatcher.isCompositing||"Enter"!==t.code||!t.ctrlKey&&t.target===this.inputLyrics.input.dom||(t.preventDefault(),this.save())}))}setTrack(t){var e,n;this.track=t,this.title=d`Track ID`+" "+t.id,t.canEdit||(this.title+=d` (read-only)`),this.btnSave.hidden=!t.canEdit,this.inputName.updateWith({value:t.name}),this.inputArtist.updateWith({value:t.artist}),this.inputAlbum.value=(null===(e=t.infoObj)||void 0===e?void 0:e.album)||"",this.inputAlbumArtist.value=(null===(n=t.infoObj)||void 0===n?void 0:n.albumArtist)||"",t.isLyricsGotten()?(this.inputLyrics.loaded=!0,this.inputLyrics.updateWith({value:t.lyrics})):(this.inputLyrics.loaded=!1,t.getLyrics().then((e=>{this.inputLyrics.loaded=!0,this.inputLyrics.updateWith({value:t.lyrics})}))),this.updateDom()}async save(){var t;if(!this.btnSave.clickable)throw new Error("btnSave is not clickable.");this.btnSave.updateWith({clickable:!1,text:d`Saving...`});try{var e=await y.put({path:"tracks/"+this.track.id,obj:{id:this.track.id,name:this.inputName.value,artist:this.inputArtist.value,album:this.inputAlbum.value,albumArtist:this.inputAlbumArtist.value,lyrics:this.inputLyrics.loaded?this.inputLyrics.value:void 0,version:null===(t=this.track.infoObj)||void 0===t?void 0:t.version}});if(e.error){if("track_changed"!=e.error)throw new Error("Unknown track update error");if(Toast.show(d`The track was changed from somewhere else.`,5e3),(e=e.track).id!=this.track.id)throw new Error("Bad ID in response");this.track.updateFromApiTrack(e),y.onTrackInfoChanged.invoke(e),this.setTrack(this.track)}else{if(e.id!=this.track.id)throw new Error("Bad ID in response");y.onTrackInfoChanged.invoke(e),this.close()}}catch(t){console.error("[Track] saving error",t),this.btnSave.updateWith({clickable:!1,text:d`Error`}),await sleepAsync(3e3)}this.btnSave.updateWith({clickable:!0,text:d`Save`})}}class LabeledInputWithLoading extends LabeledInput{constructor(){super(...arguments),this.loadingIndicator=new LoadingIndicator}get loaded(){return this.loadingIndicator.hidden}set loaded(t){this.loadingIndicator.hidden=t,this.input.hidden=!t}postCreateDom(){super.postCreateDom(),this.appendView(this.loadingIndicator),this.loaded=!1}}const O=new class{constructor(){this.ws=null,this.loginState="",this.onConnected=new r,this.onLogin=new r,this.lastQueryId=0,this.queries={},this.events={},this.permEvents={}}get connected(){var t;return(null===(t=this.ws)||void 0===t?void 0:t.readyState)===WebSocket.OPEN}init(){N.onSwitchedUser.add((()=>{this.connected&&y.defaultAuth&&this.login(y.defaultAuth)})),this.onConnected.add((()=>{"logged"===N.state&&this.login(y.defaultAuth),this.listenPermEvents()})),this.connect()}listenPermEvents(){var t=[];for(const e in this.permEvents)this.permEvents.hasOwnProperty(e)&&(this.events[e]=this.permEvents[e],t.push(e));0!==t.length&&this.sendQuery({cmd:"listenEvent",events:t},null)}getUrl(){var t=y.baseUrl.match(/^(?:(https?:)?\/\/([\w\-\.:]+))?(\/)?(.*)$/);if(!t)throw new Error("cannot generate websocket URL");var[e,n,i,s,r]=t;return(n="https:"===(n=n||window.location.protocol)?"wss://":"ws://")+(i=i||window.location.host)+(r=s?"/"+r:window.location.pathname+r)+"ws"}connect(){this.ws=new WebSocket(this.getUrl()),this.ws.onopen=t=>{this.onConnected.invoke()},this.ws.onclose=t=>{console.warn("[MsgCli] ws close",{code:t.code,reason:t.reason}),this.ws=null,this.loginState="",this.events={};var e=this.queries;for(const t in e)if(e.hasOwnProperty(t))try{e[t]({queryId:+t,resp:"wsclose"})}catch(t){console.error("[MsgCli] error",t)}this.queries={},setTimeout((()=>{this.connect()}),1e4)},this.ws.onmessage=t=>{if("string"==typeof t.data){var e=JSON.parse(t.data);if(e.resp&&e.queryId)console.debug("[MsgCli] ws query answer",e),this.queries[e.queryId]&&(this.queries[e.queryId](e),delete this.queries[e.queryId]);else if("event"===e.cmd){var n=e.event;console.debug("[MsgCli] ws received event",e),this.events[n]?this.events[n](e.data):console.debug("[MsgCli] ws unknown event",e)}else console.debug("[MsgCli] ws unknown json",e)}else console.debug("[MsgCli] ws unknwon data",t.data)}}login(t){this.loginState="sent",this.sendQueryAsync({cmd:"login",token:t}).then((t=>{"ok"===t.resp?(console.info("[MsgCli] ws login ok"),this.loginState="done",this.onLogin.invoke()):(console.warn("[MsgCli] ws login result: ",t.resp),this.loginState="")}))}sendQuery(t,e){if(!this.connected)throw new Error("not connected");var n=++this.lastQueryId;const i=Object.assign({queryId:n},t);console.debug("[MsgCli] ws send",function printFilter(t){if(t.token)return Object.assign(Object.assign({},t),{token:"***"});return t}(i)),this.ws.send(JSON.stringify(i)),e&&(this.queries[n]=e)}sendQueryAsync(t){return new Promise((e=>{this.sendQuery(t,e)}))}listenEvent(t,e,n){var i,s;if("string"==typeof t&&(t={events:[t],remove:[]}),t.events=(null!==(i=t.events)&&void 0!==i?i:[]).filter((t=>!this.events[t])),t.remove=null!==(s=t.remove)&&void 0!==s?s:[],this.connected)this.sendQuery(Object.assign({cmd:"listenEvent"},t),null);else if(!n)throw new Error("not connected");for(const i of t.events)this.events[i]=e,n&&(this.permEvents[i]=e);for(const e of t.remove)delete this.events[e],delete this.permEvents[e]}};class TrackList{constructor(){this.info=null,this.id=null,this.tracks=[],this.tracksSuffled=null,this.fetching=null,this.posting=null,this.eventListening=!1,this.putDelaying=null,this.putInProgress=null}get apiid(){var t,e;return null!==(e=null===(t=this.info)||void 0===t?void 0:t.id)&&void 0!==e?e:null}get name(){var t,e;return null!==(e=null===(t=this.info)||void 0===t?void 0:t.name)&&void 0!==e?e:null}get version(){var t,e;return null!==(e=null===(t=this.info)||void 0===t?void 0:t.version)&&void 0!==e?e:null}get canEdit(){return N.info.id==this.info.owner}setLoadIndicator(t){this.loadIndicator=t,this.contentView&&this.contentView.useLoadingIndicator(t)}loadInfo(t){var e;this.id=t.id,this.info=objectApply(null!==(e=this.info)&&void 0!==e?e:{},t,["id","owner","name","version","visibility"]),this.info.id<0&&(this.info.id=0),this.updateCanEdit()}updateCanEdit(){this.contentView&&this.contentView.header.updateWith({titleEditable:this.canEdit})}loadApiId(t){this.loadInfo({id:t,owner:0,name:"",version:0,visibility:0})}loadFromGetResult(t){var e;this.loadInfo(t),this.onInfoChanged();const n=this;return this.listView&&(this.listView.lazy=!0),this.tracks||(this.tracks=[]),(new class extends DataUpdatingHelper{constructor(){super(...arguments),this.items=n.tracks}addItem(t,e){n.addTrack_NoUpdating(t,e)}updateItem(t,e){t.updateFromApiTrack(e)}removeItem(t){n.remove_NoUpdating(t)}}).updateOrRebuildAll(t.tracks),this.updateTracksState(),null===(e=this.contentView)||void 0===e||e.updateView(),this.listView&&this.listView.slowlyLoad(1,30),this}addTrack(t,e){var n,i=this.addTrack_NoUpdating(t,e);return void 0!==e&&e!==this.tracks.length-1&&this.updateTracksState(),null===(n=this.contentView)||void 0===n||n.updateView(),i}addTrack_NoUpdating(t,e){var n,i,s=new Track({infoObj:t,_bind:{list:this,position:this.tracks.length}});return arrayInsert(this.tracks,s,e),null===(n=this.tracksSuffled)||void 0===n||n.push(s),null===(i=this.contentView)||void 0===i||i.addItem(s,e,!1),s}loadEmpty(){var t;return null===(t=this.contentView)||void 0===t||t.updateView(),this.fetching=Promise.resolve()}fetch(t){var e;return t&&(this.fetching=null),this.fetching=null!==(e=this.fetching)&&void 0!==e?e:this.fetchImpl()}postToUser(){return this.posting=this.posting||this._post()}async _post(){if(await N.waitLogin(),this.apiid)throw new Error("cannot post: apiid exists");var t=this.getTrackListPutInfo(),e=await y.post({path:"users/me/lists/new",obj:t});this.info.id=e.id}getTrackListPutInfo(){return Object.assign(Object.assign({},this.info),{trackids:this.fetching?this.tracks.map((t=>t.id)):void 0})}async getRealId(){return this.apiid||await this.postToUser(),this.apiid}put(){if(this.putDelaying)return this.putDelaying;this.putDelaying=this.putCore()}async putCore(){try{if(this.putInProgress&&await this.putInProgress,await sleepAsync(10),await N.waitLogin(!0),this.fetching&&await this.fetching,this.posting&&await this.posting,!this.apiid)throw new Error("cannot put: no apiid")}catch(t){this.putDelaying=null,console.error("[TrackList] pre-put error",t)}const t=this.info.version;try{[this.putInProgress,this.putDelaying]=[this.putDelaying,null];var e=this.getTrackListPutInfo();this.info.version++,await y.put({path:"lists/"+this.apiid,obj:e})}catch(e){if(this.info.version=t,console.error("[TrackList] put error",this,e),!(e instanceof Error&&"list_changed"==e.message))throw Toast.show(d`Failed to sync playlist "${this.name}".`+"\n"+e,3e3),e;Toast.show(d`Failed to sync playlist "${this.name}": the list was changed by other client. Please refresh and try again.`+"\n"+e,3e3)}finally{this.putInProgress=null}}async fetchImpl(){const t=new LoadingIndicator;this.setLoadIndicator(t);try{if(!this.apiid)throw new Error("Cannot fetch: no apiid");const t=await y.getListAsync(this.apiid);this.loadFromGetResult(t),this.setLoadIndicator(null)}catch(e){throw t.error(e,(()=>this.fetch(!0))),e}this.eventListening||null==this.apiid||O.listenEvent("l-"+this.apiid,(t=>{console.info(t,this.version),"number"==typeof t.version&&t.version==this.version||this.fetch(!0)}),!0)}async rename(t){this.info.name=t,this.onInfoChanged(),await this.put()}onInfoChanged(){var t,e=this.name,n=null===(t=this.contentView)||void 0===t?void 0:t.header;n&&n.updateWith({title:e}),j.onInfoChanged(this.id,this.info)}createView(){return this.contentView=this.contentView||new TrackListView(this)}getNextTrack(t,e,n){var i,s,r,o,a,l;n=null!=n?n:1;var d=t._bind;if(!d)return null;var h=d.position;if((null==d?void 0:d.list)!==this)return null;if(this.listView&&(h=null!==(s=null!=h?h:null===(i=this.listView.find((e=>e.track===t)))||void 0===i?void 0:i.position)&&void 0!==s?s:null===(r=this.listView.find((e=>e.track.id===t.id)))||void 0===r?void 0:r.position),(null==(h=null!=h?h:this.tracks.indexOf(t))||h<0)&&(h=this.tracks.findIndex((e=>e.id===t.id))),null==h||h<0)return null;if("list-seq"===e)return null!==(o=this.tracks[h+n])&&void 0!==o?o:null;if("list-loop"===e)return null!==(a=this.tracks[mod(h+n,this.tracks.length)])&&void 0!==a?a:null;if("list-shuffle"===e){this.tracksSuffled||(this.tracksSuffled=this.tracks.slice(0),function shuffleArray(t){for(var e=t.length-1;e>0;e--){var n=Math.floor(Math.random()*(e+1)),i=t[e];t[e]=t[n],t[n]=i}}(this.tracksSuffled));var c=this.tracksSuffled;return(!(h=c.indexOf(t))||h<0)&&(h=c.findIndex((e=>e.id===t.id))),null!==(l=c[mod(h+n,c.length)])&&void 0!==l?l:null}return"track-loop"===e?t:(console.warn("[TrackList] unknown loopMode",e),null)}updateTracksFromListView(){this.updateTracksState(),this.put()}updateTracksState(){this.listView?this.tracks=this.listView.map((t=>(t.track._bind.position=t.position,t.updateDom(),t.track))):this.tracks.forEach(((t,e)=>t._bind.position=e))}updateTrackInfo(t,e){t.updateFromApiTrack(e),this.listView&&this.listView.get(t._bind.position).updateDom()}remove(t,e){var n;this.remove_NoUpdating(t),this.updateTracksState(),null===(n=this.contentView)||void 0===n||n.updateView(),(void 0===e||e)&&this.put()}remove_NoUpdating(t){var e,n=t._bind.position;null!=n&&(t._bind=void 0,this.tracks.splice(n,1),null===(e=this.tracksSuffled)||void 0===e||e.remove(t),this.listView&&this.listView.remove(n))}}class TrackListView extends ListContentView{constructor(t){super(),this.curPlaying=new ItemActiveHelper({funcSetActive:function(t,e){t.updateWith({playing:e})}}),this.trackActionHandler={},this.currentTracking=!1,this.scrollAnimator=void 0,this.trackChanged=()=>{this.updateCurPlaying(),this.currentTracking&&this.centerCurrentTrack()},this.canMultiSelect=!0,this.list=t,this.trackActionHandler.onTrackRemove=t=>t.forEach((t=>this.list.remove(t.track))),this.trackActionHandler.canRemove=t=>this.list.canEdit}createHeader(){var t;return new ContentHeader({catalog:()=>d`Playlist`,title:null!==(t=this.list.name)&&void 0!==t?t:"",titleEditable:!!this.list.rename,onTitleEdit:t=>this.list.rename(t)})}appendHeader(){super.appendHeader(),this.refreshBtn.onActive.add((()=>{this.list.fetch(!0)}))}onShow(){super.onShow(),this.shownEvents.add(x.onTrackChanged,this.trackChanged),this.shownEvents.add(N.onSwitchedUser,(()=>{this.list.updateCanEdit()}))(),this.list.fetch(),this.trackChanged()}onRemove(){super.onRemove()}onSidebarItemReactived(){this.centerCurrentTrack()}centerCurrentTrack(){var t;this.currentTracking=!0;const e=this.curPlaying.current;e&&(null===(t=this.scrollAnimator)||void 0===t||t.scrollTo(e.dom.offsetTop+e.dom.offsetHeight/2))}appendListView(){super.appendListView();var t=this.listView;t.dom.classList.add("tracklistview"),this.list.listView=t,t.dragging=!0,this.list.canEdit&&(t.moveByDragging=!0),t.onItemMoved=()=>this.list.updateTracksFromListView(),t.onItemClicked=t=>{this.currentTracking=!0,t.track===x.track&&x.isPlaying?P.nav("nowplaying"):(x.playTrack(t.track),"video"==t.track.type&&P.nav("nowplaying"))},t.selectionHelper.onSelectedItemsChanged.add(((t,e)=>{var n,i;null===(n=this.listView.get(e.position-1))||void 0===n||n.toggleClass("next-selected","add"===t),null===(i=this.listView.get(e.position+1))||void 0===i||i.toggleClass("prev-selected","add"===t)})),this.list.tracks.forEach((t=>this.addItem(t,void 0,!1))),this.list.loadIndicator&&this.useLoadingIndicator(this.list.loadIndicator),this.updateView(),this.scrollAnimator=new ScrollAnimator(this.scrollBox),this.scrollAnimator.posType="center"}addItem(t,e,n){var i=this.createViewItem(t);this.listView.add(i,e),this.updateCurPlaying(i),(null==n||n)&&this.updateView()}createViewItem(t){var e=new TrackViewItem(t);return e.actionHandler=this.trackActionHandler,e}updateCurPlaying(t){var e,n;const i=x.track;if(void 0===t)if(i){const t=(null===(e=i._bind)||void 0===e?void 0:e.list)===this.list&&null!=i._bind.position?this.listView.get(i._bind.position):null!==(n=i&&this.listView.find((t=>t.track===i)))&&void 0!==n?n:this.listView.find((t=>t.track.id===i.id));this.curPlaying.set(t)}else this.curPlaying.set(null);else if(i){const e=t.track;(e===i||!this.curPlaying.current&&e.id===i.id)&&this.curPlaying.set(t)}}}class TrackViewItem extends ListViewItem{constructor(t){super(),this.actionHandler=null,this.noPos=!1,this.playing=!1,this.onContextMenu=(t,e)=>{var n,i,s,r,o,a,h;e.preventDefault();var c=this.selected&&this.selectionHelper?this.selectionHelper.selectedItems:[this],u=new ContextMenu;if(1==c.length){if(t.track.id&&"none"!=N.state&&!1!==N.serverOptions.trackCommentsEnabled&&u.add(new MenuItem({text:d`Comments`,onActive:()=>{P.nav(["track-comments",t.track.id.toString()])}})),b.showDownloadOptions&&this.track.url){var p=this.track.getExtensionName();p=p?p.toUpperCase()+", ":"";var g=formatFileSize(this.track.size),m=[...null!==(n=this.track.files)&&void 0!==n?n:[]];m.sort(((t,e)=>e.bitrate-t.bitrate)),m.find((t=>""===t.profile))||u.add(new MenuLinkItem({text:d`Download`+" ("+p+g+")",link:y.processUrl(this.track.url),download:this.track.artist+" - "+this.track.name+"."+p})),m.forEach((t=>{var e,n=null===(e=t.format)||void 0===e?void 0:e.toUpperCase(),i=this.track.getFileUrl(t);i?u.add(new MenuLinkItem({text:d`Download`+" ("+n+", "+t.bitrate+" Kbps)",link:y.processUrl(i),download:this.track.artist+" - "+this.track.name+"."+n})):this.track.canEdit&&u.add(new MenuItem({text:d`Convert`+" ("+n+", "+t.bitrate+" Kbps)",onActive:()=>{this.track.requestFileUrl(t)}}))}))}this.track.picurl&&u.add(new MenuLinkItem({text:d`Show picture`,link:y.processUrl(this.track.picurl)}))}this.track.canEdit&&[0,1].forEach((t=>{var e=0;for(const n of c)n.track.visibility!=t&&e++;e&&u.add(new MenuItem({text:l.get(1==e?"make_it_visibility_"+t:"make_{0}_visibility_"+t,[e]),onActive:()=>{y.post({path:"tracks/visibility",obj:{trackids:c.map((t=>t.track.id)),visibility:t}}).then((e=>{c.forEach((e=>{e.track.infoObj.visibility=t,y.onTrackInfoChanged.invoke(e.track.infoObj)}))}))}}))})),1==c.length&&(1==this.track.visibility&&u.add(new CopyMenuItem({text:d`Copy link`,textToCopy:y.appBaseUrl+"#track/"+this.track.id})),u.add(new MenuItem({text:this.track.canEdit?d`Edit`:d`Details`,onActive:t=>this.track.startEdit(t)})),(null===(i=this.actionHandler)||void 0===i?void 0:i.onTrackRemove)&&0!=(null===(r=null===(s=this.actionHandler)||void 0===s?void 0:s.canRemove)||void 0===r?void 0:r.call(s,[this]))&&u.add(new MenuItem({text:d`Remove`,cls:"dangerous",onActive:()=>{var t,e;return null===(e=(t=this.actionHandler).onTrackRemove)||void 0===e?void 0:e.call(t,[this])}}))),(null===(o=this.actionHandler)||void 0===o?void 0:o.onTrackRemove)&&c.length>1&&0!=(null===(h=null===(a=this.actionHandler)||void 0===a?void 0:a.canRemove)||void 0===h?void 0:h.call(a,[...c]))&&u.add(new MenuItem({text:d`Remove ${c.length} tracks`,cls:"dangerous",onActive:()=>{var t,e;null===(e=(t=this.actionHandler).onTrackRemove)||void 0===e||e.call(t,[...c])}}));let v=d`Track ID`+": "+c.map((t=>t.track.id)).join(", ")+"\n"+d`Duration`+": "+formatDuration(arraySum(c,(t=>t.track.length)))+"\n"+d`Size`+": "+formatFileSize(arraySum(c,(t=>t.track.size)));if(1==c.length){const t=this.track.owner==N.info.id?"my_":"";v+="\n"+l.get(t+"visibility_"+c[0].track.visibility)}u.add(new MenuInfoItem({text:v})),q.showContextMenuForItem(c,u,{ev:e})},this.track=t}get dragData(){return`${this.track.name} - ${this.track.artist}`}createDom(){return{tag:"li.item.trackitem.no-selection",tabIndex:0,child:[{tag:"div.picbox",child:[{tag:"img.pic",loading:"lazy",height:128,width:128,update:t=>{var e;let n="";this.track.thumburl&&(n=null!==(e=y.processUrl(this.track.thumburl))&&void 0!==e?e:""),n!=t.src&&(t.src=n),toggleClass(t,"nopic",!n)}},{tag:"span.pos",update:t=>{var e;this.playing?(clearChildren(t),t.appendChild(new Icon({icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M8 5v14l11-7z"/></svg>'}).dom)):this.noPos||(t.textContent=null!=(null===(e=this.track._bind)||void 0===e?void 0:e.position)?(this.track._bind.position+1).toString():""),toggleClass(t,"withpic",!!this.track.thumburl),t.hidden=this.noPos&&!this.playing}}]},{tag:"span.name",text:()=>this.track.name},{tag:"span.artist",text:()=>this.track.artist},{tag:"span.duration",text:()=>formatDuration(this.track.length)}],draggable:!0,_item:this}}updateDom(){super.updateDom(),this.toggleClass("selected",!!this.selected)}}class UploadTrack extends Track{constructor(t){super(t),this._bind={list:R}}get canEdit(){return"done"===this._upload.state}setState(t){var e;this._upload.state=t,null===(e=this._upload.view)||void 0===e||e.updateDom()}}const R=new class extends TrackList{constructor(){super(...arguments),this.tracks=[],this.state=!1,this.inprogress=0,this.unreadError=!1,this.uploadSemaphore=new Semaphore({maxCount:2}),this.view=new class extends TrackListView{constructor(){super(...arguments),this.usage=new TextView({tag:"span.uploads-usage"})}appendHeader(){this.title=()=>d`My Uploads`,super.appendHeader(),this.uploadArea=new UploadArea({onfile:t=>R.uploadFile(t)}),this.header.appendView(this.uploadArea),this.trackActionHandler.canRemove=()=>!0,this.trackActionHandler.onTrackRemove=t=>{1===t.length?this.removeTrack(t[0]):(new MessageBox).setTitle(d`Warning`).addText(d`Are you sure to delete ${t.length} tracks permanently?`).addResultBtns(["cancel","ok"]).allowCloseWithResult("cancel").showAndWaitResult().then((e=>{"ok"===e&&t.forEach((t=>this.removeTrack(t,!0)))}))}}createHeader(){var t=new ContentHeader({title:this.title});return t.titlebar.appendView(this.usage),t}onShow(){super.onShow(),R.unreadError&&(R.unreadError=!1,R.updateSidebarItem())}appendListView(){super.appendListView(),R.state||R.fetch()}updateUsage(){var t=0,e=0;R.tracks.forEach((n=>{var i;null===(i=n.files)||void 0===i||i.forEach((n=>{var i,s;n.profile?e+=null!==(s=n.size)&&void 0!==s?s:0:t+=null!==(i=n.size)&&void 0!==i?i:0}))})),this.usage.text=t?`(${formatFileSize(t)} + ${formatFileSize(e)})`:""}updateView(){super.updateView(),this.updateUsage()}createViewItem(t){const e=new UploadViewItem(t);return e.actionHandler=this.trackActionHandler,e}async removeTrack(t,e){const n=t.track;if("uploading"===n._upload.state||"pending"===n._upload.state)n._upload.state="cancelled",n._upload.cancelToken.cancel(),R.remove(n);else if("error"===n._upload.state)R.remove(n);else{if("done"!==n._upload.state)return void console.error("[Uploads] Unexpected track._upload.state",n._upload.state);if(!e&&"ok"!==await(new MessageBox).setTitle(d`Warning`).addText(d`Are you sure to delete the track permanently?`).addResultBtns(["cancel","ok"]).allowCloseWithResult("cancel").showAndWaitResult())return;try{await y.delete({path:"tracks/"+n.id})}catch(t){return void Toast.show(d`Failed to remove track.`+"\n"+t)}y.onTrackDeleted.invoke(n)}}}(this)}get canEdit(){return!1}init(){this.sidebarItem=new ListIndexViewItem({text:()=>d`My Uploads`}),P.addRoute({path:["uploads"],sidebarItem:()=>this.sidebarItem,contentView:()=>this.view}),q.sidebarList.addFeatureItem(this.sidebarItem),N.onSwitchedUser.add((()=>{!1!==this.state&&"waiting"!==this.state&&(this.tracks=[],this.state=!1,this.view.rendered&&(this.view.listView.removeAll(),this.view.updateView()),setTimeout((()=>this.fetch(!0)),1))})),N.onSwitchedUser.add((()=>{this.sidebarItem.hidden="logged"!=N.state}))(),x.onTrackChanged.add((()=>{this.sidebarItem.updateWith({playing:!!this.tracks.find((t=>t===x.track))})})),y.onTrackInfoChanged.add((t=>{this.tracks.forEach((e=>{var n;e.id===t.id&&(e.updateFromApiTrack(t),null===(n=e._upload.view)||void 0===n||n.updateDom())}))})),y.onTrackDeleted.add((t=>{var e=this.tracks.find((e=>e.id===t.id));e&&this.remove(e)}))}insertTrack(t,e=0,n){this.tracks.splice(e,0,t),this.view.rendered&&this.view.addItem(t,e,n)}remove(t){var e,n=this.tracks.indexOf(t);-1!==n&&(this.tracks.splice(n,1),null===(e=t._upload.view)||void 0===e||e.remove())}async fetchImpl(){this.state="waiting";var t=new LoadingIndicator;t.content=d`Logging in`,this.view.useLoadingIndicator(t);try{await N.waitLogin(!0),this.state="fetching",t.reset();var e=(await y.get("my/uploads")).tracks.map((t=>new UploadTrack({infoObj:t,_upload:{state:"done"}})));this.state="fetched"}catch(e){return void t.error(e,(()=>this.fetchImpl()))}const n=this;var i=this.tracks.filter((t=>"done"===t._upload.state)),s=this.tracks.findIndex((t=>"done"!==t._upload.state))+1;(new class extends DataUpdatingHelper{constructor(){super(...arguments),this.items=i}addItem(t,e){n.insertTrack(t,s,!1)}updateItem(t,e){t.updateFromApiTrack(e.infoObj)}removeItem(t){var e;null===(e=t._upload.view)||void 0===e||e.remove()}}).update(e),this.view.useLoadingIndicator(null),this.view.updateView()}async uploadFile(t){var e={id:void 0,url:void 0,artist:"Unknown",name:t.name},n=new UploadTrack({infoObj:e,blob:t,_upload:{state:"pending",cancelToken:new CancelToken}});this.insertTrack(n),this.inprogress++,this.updateSidebarItem(),await this.uploadSemaphore.enter();try{if("cancelled"===n._upload.state)return null;await this.uploadCore(e,n,t)}catch(e){if("cancelled"===n._upload.state)return null;throw n.setState("error"),Toast.show(d`Failed to upload file "${t.name}".`+"\n"+e,3e3),console.warn("[Uploads] uploads failed: ",t.name,e),0==R.view.isVisible&&(this.unreadError=!0),e}finally{this.inprogress--,this.updateSidebarItem(),this.uploadSemaphore.exit()}return this.view.rendered&&this.view.updateUsage(),n}async uploadCore(t,e,n){e.setState("uploading");const i=e._upload.cancelToken,s=await y.post({path:"tracks/uploadrequest",obj:{filename:n.name,size:n.size}});var r;i.throwIfCancelled();var onprogerss=t=>{var n;t.lengthComputable&&(e._upload.progress=t.loaded/t.total,null===(n=e._upload.view)||void 0===n||n.updateDom())};if("direct"===s.mode){const e=new Blob([JSON.stringify(t)]),s=new Blob([z.encodeBlock(e),z.encodeBlock(n)]),o=await y.upload({method:"POST",url:"tracks/newfile",body:s,auth:y.defaultAuth,contentType:"application/x-mcloud-upload",cancelToken:i,onprogerss:onprogerss}).complete;i.throwIfCancelled(),r=JSON.parse(o.responseText)}else{if("put-url"!==s.mode)throw new Error("Unknown upload mode");console.info("[Uploads] uploading to url",s),await y.upload({method:s.method,url:s.url,body:n,cancelToken:i,onprogerss:onprogerss}).complete,console.info("[Uploads] posting result to api"),e.setState("processing"),r=await y.post({path:"tracks/uploadresult",obj:{url:s.url,filename:n.name,tag:s.tag}}),i.throwIfCancelled()}e.infoObj=r,e.setState("done")}updateSidebarItem(){this.sidebarItem.text=this.inprogress?d`My Uploads`+` (${this.inprogress})`:d`My Uploads`,this.unreadError&&(this.sidebarItem.text+=" (!!)"),this.sidebarItem.updateDom()}};class UploadViewItem extends TrackViewItem{constructor(t){super(t),t._upload.view=this}postCreateDom(){super.postCreateDom(),this.dom.classList.add("uploads-item"),this.dom.appendChild(this.domstate=buildDOM({tag:"span.uploads-state"}))}updateDom(){super.updateDom();var t=this.track._upload.state;this._lastUploadState!=t&&(this._lastUploadState&&this.dom.classList.remove("state-"+this._lastUploadState),t&&this.dom.classList.add("state-"+t),"uploading"===this.track._upload.state&&void 0!==this.track._upload.progress?this.domstate.textContent=(100*this.track._upload.progress).toFixed(0)+"%":this.domstate.textContent=l.get("uploads_"+t),this.dragging="done"===t)}}class UploadArea extends View{constructor(t){super(),this.domfile=new Ref,objectApply(this,t)}createDom(){return{tag:"div.upload-area.clickable",tabIndex:0,child:[{tag:"div.text.no-selection",text:()=>d`Click here to select files to upload`},{tag:"div.text.no-selection",text:()=>d`or drag files to this zone...`},{tag:"input",type:"file",ref:this.domfile,style:"visibility: collapse; height: 0;",accept:"audio/*",multiple:!0}]}}postCreateDom(){this.domfile.value.addEventListener("change",(t=>{this.domfile.value.files&&this.handleFiles(this.domfile.value.files)})),this.onActive.add((t=>{this.domfile.value.click()})),this.dom.addEventListener("dragover",(t=>{t.dataTransfer&&t.dataTransfer.types.indexOf("Files")>=0&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="copy")})),this.dom.addEventListener("drop",(t=>{t.dataTransfer&&(t.preventDefault(),t.stopPropagation(),t.dataTransfer.types.indexOf("Files")>=0&&this.handleFiles(t.dataTransfer.files))}))}handleFiles(t){var e;for(let n=0;n<t.length;n++){const i=t[n];console.log("[Uploads] drop file",{name:i.name,size:i.size}),null===(e=this.onfile)||void 0===e||e.call(this,i)}}}var z={encodeBlock:t=>new Blob([z.encodeLen(t.size),t]),encodeLen(t){for(var e="",n=0;n<8;n++)e="0123456789aBcDeF"[t>>4*n&15]+e;return e+="\r\n"}};class ListIndexViewItem extends SidebarItem{constructor(t){super({}),this.playing=!1,this.onContextMenu=(t,e)=>{var n=new ContextMenu;if(this.index&&this.listInfo){if(1==this.listInfo.visibility&&n.add(new CopyMenuItem({text:d`Copy link`,textToCopy:y.appBaseUrl+"#list/"+this.listInfo.id})),this.listInfo.owner==N.id){const e=this.listInfo.visibility?0:1;n.add(new MenuItem({text:l.get("make_it_visibility_"+e),onActive:()=>{const n=this.index.getList(t.listInfo.id);n.info.visibility=e,n.onInfoChanged(),n.put()}}))}n.add(new MenuItem({text:d`Remove`,cls:"dangerous",onActive:()=>{this.index.removeList(this.listInfo.id)}}))}this.listInfo&&n.add(new MenuInfoItem({text:d`List ID`+": "+this.listInfo.id})),n.length&&(e.preventDefault(),q.showContextMenuForItem([t],n,{ev:e}))},objectApply(this,t)}createDom(){return{tag:"li.item.indexitem.no-selection",tabIndex:0,child:[{_id:"tag",tag:"span.tag"},{tag:"span.name.flex-1",text:()=>{var t,e;return null!==(e=null===(t=this.listInfo)||void 0===t?void 0:t.name)&&void 0!==e?e:this.text}},{tag:"span.state",update:t=>{var e=this.playing?new Icon({icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M12 3v9.28c-.47-.17-.97-.28-1.5-.28C8.01 12 6 14.01 6 16.5S8.01 21 10.5 21c2.31 0 4.2-1.75 4.45-4H15V6h4V3h-7z"/></svg>'}):null;clearChildren(t),e&&t.appendChild(e.dom),t.hidden=!e}}]}}updateDom(){super.updateDom();var t=this.getDomById("tag"),e=this.listInfo&&0!=this.listInfo.visibility?this.listInfo.owner==N.id&&1==this.listInfo.visibility?d`my_visibility_1`:this.listInfo.ownerName:"";t.textContent=e,t.style.display=e?"block":"none",this.dom.style.paddingTop=e?".3em":"",this.dom.style.paddingBottom=e?"1.2em":""}}const j=new class ListIndex{constructor(){this.loadedList={},this.loadIndicator=new LoadingIndicator,this.playing=null,this.nextId=-100,this.listView=new ListView({tag:"ul"}),this.listView.dragging=!0,this.listView.moveByDragging=!0,this.listView.onItemMoved=(t,e)=>{this.putUser()},this.listView.onDragover=t=>{const e=t.source,n=t.event.dataTransfer;if(n)if(e instanceof TrackViewItem){if(t.accept=!0,n.dropEffect="copy",t.drop){const e=this.getList(t.target.listInfo.id);e.fetch().then((n=>{for(const n of t.sourceItems)e.addTrack(n.track.toApiTrack(),t.event.altKey?void 0:0);return e.put()})).catch((t=>{console.error("[ListIndex] error adding track:",t)}))}}else if(n.files.length>0&&(n.effectAllowed="copy",t.accept=!0,t.drop)){const e=this.getList(t.target.listInfo.id);for(let i=0;i<n.files.length;i++){const s=n.files[i];R.uploadFile(s).then((async n=>{n&&(await e.fetch(),e.addTrack(n.toApiTrack(),t.event.altKey?void 0:0),await e.put())})).catch((t=>{console.error("[ListIndex] error adding track:",t)}))}}},this.listView.onItemClicked=t=>{var e;q.sidebarList.currentActive.current!==t?(q.sidebarList.setActive(t),this.showTracklist(t.listInfo.id)):null===(e=t.contentView)||void 0===e||e.onSidebarItemReactived()}}putUser(){N.setListids(this.listView.map((t=>t.listInfo.id)))}init(){x.onTrackChanged.add((()=>{var t,e,n,i,s,r,o=null!==(n=null===(e=null===(t=x.track)||void 0===t?void 0:t._bind)||void 0===e?void 0:e.list)&&void 0!==n?n:null;o!=this.playing&&((null==o?void 0:o.id)&&(null===(i=this.getViewItem(o.id))||void 0===i||i.updateWith({playing:!0})),(null===(s=this.playing)||void 0===s?void 0:s.id)&&(null===(r=this.getViewItem(this.playing.id))||void 0===r||r.updateWith({playing:!1})),this.playing=o)})),y.onTrackInfoChanged.add((t=>{for(const e in this.loadedList)if(this.loadedList.hasOwnProperty(e)){const n=this.loadedList[e];n.tracks.forEach((e=>{e.id===t.id&&n.updateTrackInfo(e,t)}))}})),y.onTrackDeleted.add((t=>{for(const e in this.loadedList)if(this.loadedList.hasOwnProperty(e)){const n=this.loadedList[e];n.tracks.forEach((e=>{e.id===t.id&&n.remove(e,!1)}))}})),this.section=new Section({title:()=>d`Playlists`,content:this.listView});const t=new Icon({icon:'<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24"><path d="M0 0h24v24H0z" fill="none"/><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>'});t.dom.style.fontSize="1.4em",this.section.addAction(jsxBuild(a(SectionAction,{onActive:()=>{this.newTracklist()}},[t]))),q.sidebarList.container.appendView(this.section),q.sidebar.dom.addEventListener("scroll",(t=>{if(t.eventPhase===Event.AT_TARGET){var e=q.sidebar.header.dom,n=this.section.headerView.dom;n.offsetTop<=e.offsetTop+e.offsetHeight?(setScrollableShadow(e,0),n.style.zIndex=""):(setScrollableShadow(e,q.sidebar.dom.scrollTop),n.style.zIndex="4"),setScrollableShadow(n,n.offsetTop+n.offsetHeight-this.listView.dom.offsetTop)}}),{passive:!0}),this.listView.scrollBox=q.sidebar.dom,P.addRoute({path:["list"],onNav:async t=>{await N.waitLogin(!1);var e=window.parseInt(t.remaining[0]),n=this.getList(e),i=n.createView();q.content.setCurrent(i);var s=this.getViewItem(e);q.sidebarList.setActive(s),s||(await n.fetch(),s=this.addListInfo(n.info),"logged"==N.state&&this.putUser()),s.contentView=i}}),P.addRoute({path:[""],onNav:async t=>{await N.waitLogin(!1)&&this.listView.length>0&&P.nav(["list",this.listView.get(0).listInfo.id.toString()],{pushState:!1})}})}setIndex(t){var e;this.listView.clear();for(const n of null!==(e=null==t?void 0:t.lists)&&void 0!==e?e:[])this.addListInfo(n)}addListInfo(t){var e,n,i,s,r=new ListIndexViewItem({index:this,listInfo:t,playing:t.id===(null===(i=null===(n=null===(e=x.track)||void 0===e?void 0:e._bind)||void 0===n?void 0:n.list)||void 0===i?void 0:i.id)});this.listView.add(r);var o=q.content.current;return o instanceof TrackListView&&(null===(s=o.list)||void 0===s?void 0:s.id)===t.id&&q.sidebarList.setActive(r),r}getListInfo(t){var e;return null===(e=this.getViewItem(t))||void 0===e?void 0:e.listInfo}getList(t){var e=this.loadedList[t];if(!e){e=new TrackList;const n=this.getListInfo(t);n?(e.loadInfo(n),e.apiid||e.loadEmpty()):e.loadApiId(t),this.loadedList[t]=e}return e}getViewItem(t){return this.listView.find((e=>e.listInfo.id===t))}showTracklist(t){P.nav(["list",t.toString()])}onInfoChanged(t,e){var n=this.getViewItem(t);n&&(objectApply(n.listInfo,e),n.updateDom())}async removeList(t){var e;t<0&&(t=await this.getList(t).getRealId()),await y.delete({path:"my/lists/"+t}),null===(e=this.getViewItem(t))||void 0===e||e.remove();const n=q.content.current;n instanceof TrackListView&&n.list.id===t&&q.content.setCurrent(null)}async newTracklist(){if(!await N.waitLogin(!1))return this._toastLogin=this._toastLogin||new Toast({text:d`Login to create playlists.`}),void this._toastLogin.show(3e3);var t=this.nextId--,e={id:t,owner:N.id,name:createName((t=>t?d`New Playlist (${t+1})`:d`New Playlist`),(t=>!!this.listView.find((e=>e.listInfo.name===t)))),visibility:0,version:0};this.addListInfo(e);var n=this.getList(t);n.postToUser().then((()=>{e.id=n.apiid}),(t=>{Toast.show(d`Failed to create playlist "${e.name}".`+"\n"+t,5e3)}))}},N=new class User{constructor(){this.siLogin=new SettingItem("mcloud-login","json",{id:-1,username:null,passwd:void 0,token:null,avatar:void 0,lastBaseUrl:null}),this.info=this.siLogin.data,this._serverOptions={},this.state="none",this.onSwitchedUser=new r,this.loggingin=null,this.pendingInfo=null,this._ignore_track_once=null}get id(){return this.info.id}get isAdmin(){return"admin"===this.role}get serverOptions(){return this._serverOptions}setState(t){this.state=t,q.sidebarLogin.update()}init(){var t,e;x.onTrackChanged.add((()=>this.playingTrackChanged()));const n=null===(t=window.preload)||void 0===t?void 0:t.preLoginTask;if((null===(e=window.preload)||void 0===e?void 0:e.inputToken)&&(this.info.token=window.preload.inputToken),this.info.username||this.info.token||n?this.login(n?{preLogin:n}:{info:this.info}).then(null,(t=>{Toast.show(d`Failed to login.`+"\n"+t,5e3)})):(this.setState("none"),this.openUI()),window.location.href.indexOf("#social-link-success")>=0&&(window.history.replaceState(null,"",window.location.href.split("#social-link-success")[0]),Toast.show(d`Account has been linked successfully.`,5e3),(new LoginSettingsDialog).show()),window.location.href.indexOf("#social-link-error")>=0){var i=window.location.href.split("#social-link-error=");window.history.replaceState(null,"",i[0]);var s=i[1];Toast.show(d`Account linking error: ${l.get("social-link-error_"+s)}`,5e3),(new LoginSettingsDialog).show()}}openUI(t,e){(t=null!=t?t:"logged"!==this.state)?(this.loginDialog||(this.loginDialog=new LoginDialog),this.loginDialog.show(e)):(new MeDialog).show(e)}closeUI(){var t;null===(t=this.loginDialog)||void 0===t||t.close()}getBasicAuth(t){return"Basic "+base64EncodeUtf8(t.username+":"+t.passwd)}getBearerAuth(t){return"Bearer "+t}async login(t){"logged"!==this.state&&this.setState("logging");var e=(async()=>{let e;try{if(t.info){const n=t.info,i=n.token;console.info({info:n,token:i}),e=i?await y.get("users/me",{auth:this.getBearerAuth(i)}):await y.post({path:"users/me/login",auth:this.getBasicAuth(n)})}else{if(!t.preLogin)throw new Error("Unexpected login argument");e=await t.preLogin}}catch(t){if("logged"!==this.state&&this.setState("error"),"user_not_found"===t.message)throw new Error(d`Username or password is not correct.`);throw t}finally{this.pendingInfo=null}await this.handleLoginResult(e)})();this.loggingin=e,await e}async register(t){this.setState("logging");var e=(async()=>{var e=await y.post({path:"users/new",obj:t});if(e.error){if(this.setState("error"),"dup_user"===e.error)throw new Error(d`A user with the same username exists`);throw new Error(e.error)}await this.handleLoginResult(e)})();this.loggingin=e,await e}async handleLoginResult(t){var e;if(!t.username||!t.id)throw new Error(d`iNTernEL eRRoR`);if(this.info.username,t.username,this.info.id=t.id,this.info.username=t.username,this.info.avatar=null!==(e=t.avatar)&&void 0!==e?e:void 0,this.info.passwd=void 0,t.token&&(this.info.token=t.token),this.info.lastBaseUrl=y.baseUrl,this.role=t.role,this.siLogin.save(),t.serverOptions){const e=this._serverOptions=t.serverOptions;e.msg&&Toast.show(d`Server: `+e.msg,3e3),y.storageUrlBase=e.storageUrlBase||""}y.defaultAuth=this.getBearerAuth(this.info.token),q.sidebarLogin.update(),j.setIndex(t),this.setState("logged"),this.loggingin=null,this.onSwitchedUser.invoke(),t.playing&&!x.track&&this.tryRestorePlaying(t.playing)}async logout(){if(this.info.token){var t=Toast.show(d`Logging out...`);try{await y.post({path:"users/me/logout"}),t.close()}catch(e){return t.text=d`Failed to logout.`+"\n"+e,void t.show(5e3)}}objectApply(this.info,{id:-1,username:void 0,passwd:void 0,token:void 0,avatar:void 0}),this.role=void 0,this.siLogin.save(),y.defaultAuth=null,q.content.setCurrent(null),j.setIndex(null),this.setState("none"),this.loggingin=null,this.onSwitchedUser.invoke()}async setListids(t){var e={id:this.info.id,username:this.info.username,listids:t};await y.put({path:"users/me",obj:e})}async waitLogin(t){do{if("logged"===this.state)return!0;if("logging"===this.state)try{if(await this.loggingin,"logged"!=this.state)break;return!0}catch(t){break}}while(0);if(t)throw new Error("No login");return!1}playingTrackChanged(){var t,e,n,i,s,r,o,a,l=x.track;if(l&&this._ignore_track_once===l)this._ignore_track_once=null;else{var d={listid:null!==(n=null===(e=null===(t=null==l?void 0:l._bind)||void 0===t?void 0:t.list)||void 0===e?void 0:e.id)&&void 0!==n?n:0,position:null!==(s=null===(i=null==l?void 0:l._bind)||void 0===i?void 0:i.position)&&void 0!==s?s:0,trackid:null!==(r=null==l?void 0:l.id)&&void 0!==r?r:0,profile:null!==(a=null===(o=x.trackProfile)||void 0===o?void 0:o.profile)&&void 0!==a?a:""};this.postPlaying(d).then((()=>console.info("[User] post playing OK")),(t=>console.warn("[User] post playing error",t)))}}async tryRestorePlaying(t){if(t.trackid){var e=null;t.track&&(e=new Track({infoObj:t.track}),this._ignore_track_once=e,x.setTrack(e));var n=t.listid?j.getList(t.listid):R;await n.fetch();var i=n.tracks[t.position];(null==i?void 0:i.id)!==t.trackid&&(i=n.tracks.find((e=>e.id===t.trackid))||null),(!e&&null==x.track||e&&x.track==e)&&(this._ignore_track_once=i,x.setTrack(i))}}async getPlaying(){return await this.waitLogin(!0),await y.get("my/playing")}async postPlaying(t){await this.waitLogin(!0),await y.post({path:"my/playing",obj:t})}async changePassword(t){var e=Toast.show(d`Changing password...`);try{await y.put({path:"users/me",obj:{id:this.info.id,username:this.info.username,passwd:t}}),this.info.passwd=t,y.defaultAuth=this.getBasicAuth(this.info),this.siLogin.save()}catch(t){return e.updateWith({text:d`Failed to change password.`+"\n"+t}),void e.show(3e3)}e.updateWith({text:d`Password changed successfully.`}),e.show(3e3)}};class LoginDialog extends Dialog{constructor(){super(),this.tabLogin=new TextBtn({text:d`Login`,active:!0}),this.tabCreate=new TextBtn({text:d`Create account`}),this.inputUser=new LabeledInput({label:d`Username`}),this.inputPasswd=new LabeledInput({label:d`Password`,type:"password"}),this.inputPasswd2=new LabeledInput({label:d`Confirm password`,type:"password"}),this.viewStatus=new TextView({tag:"div.input-label",style:"white-space: pre-wrap; color: red;"}),this.btn=new ButtonView({text:d`Login`,type:"big"}),this.socialLogins=[],this.isRegistering=!1;var t=this;t.title="",[this.tabLogin,this.tabCreate].forEach((e=>{t.addBtn(e),e.onActive.add((()=>toggle(e)))})),[this.inputUser,this.inputPasswd,this.inputPasswd2].forEach((e=>t.addContent(e))),t.addContent(buildDOM({tag:"div",child:[this.viewStatus,this.btn]})),this.compositionWatcher=new TextCompositionWatcher(this.dom),t.dom.addEventListener("keydown",(t=>{this.compositionWatcher.isCompositing||"Enter"!==t.code||(this.btnClicked(),t.preventDefault())})),t.autoFocus=this.inputUser.input,this.btn.toggleClass("bigbtn",!0),this.btn.dom.addEventListener("click",(()=>this.btnClicked()));var toggle=t=>{t.active||(this.isRegistering=!this.isRegistering,this.inputPasswd2.hidden=!this.isRegistering,this.btn.text=t.text,this.tabLogin.updateWith({active:!this.isRegistering}),this.tabCreate.updateWith({active:this.isRegistering}),this.socialLogins.forEach((t=>t.hidden=this.isRegistering)))};this.inputPasswd2.hidden=!0,this.addBtn(new TextBtn({text:d`Settings`,right:!0,onActive:t=>{S.openUI(t),this.close()}})),this.tabCreate.hidden=!0,this.inputUser.hidden=this.inputPasswd.hidden=this.btn.hidden=!0;const onServerconfig=t=>{var e;this.tabCreate.hidden=0==t.allowRegistration,this.inputUser.hidden=this.inputPasswd.hidden=this.btn.hidden=0==t.passwordLogin,null===(e=t.socialLogin)||void 0===e||e.forEach((t=>{const e=new ButtonView({text:d`Login via ${t.name}`,type:"big",onActive:()=>{window.location.href=y.processUrl(`users/me/socialLogin?provider=${t.id}&returnUrl=${encodeURIComponent(window.location.href)}`)}});this.socialLogins.push(e),this.addContent(e)}))};if("logged"==N.state)onServerconfig(N.serverOptions);else{const t=new LoadingIndicator({});this.addContent(t),y.get("users/me/serverconfig").then((e=>{t.removeFromParent(),onServerconfig(e)})).catch((e=>{t.error(e)}))}}show(...t){this.center(),super.show(...t)}btnClicked(){if(!this.btn.dom.classList.contains("disabled")){var t=[];this.inputUser.value||t.push(d`Please input the username!`),this.inputPasswd.value?this.isRegistering&&this.inputPasswd.value!==this.inputPasswd2.value&&t.push(d`Password confirmation does not match!`):t.push(d`Please input the password!`),this.viewStatus.dom.textContent=t.join("\r\n"),t.length||(async()=>{this.viewStatus.text=d`Requesting...`,this.btn.updateWith({disabled:!0});var t={username:this.inputUser.value,passwd:this.inputPasswd.value};try{N.pendingInfo=t,this.isRegistering?await N.register(t):await N.login({info:t}),this.viewStatus.text="",[this.inputUser,this.inputPasswd,this.inputPasswd2].forEach((t=>t.value="")),N.closeUI()}catch(t){this.viewStatus.text=t,"logged"===N.state&&N.info.username&&(this.viewStatus.text+="\r\n"+d`Logged in with previous working account.`)}finally{N.pendingInfo=null,this.btn.updateWith({disabled:!1})}})()}}}class MeDialog extends Dialog{constructor(){super(),this.btnLoginSettings=new ButtonView({text:d`Login settings`,type:"big"}),this.btnSwitch=new ButtonView({text:d`Switch user`,type:"big"}),this.btnLogout=new ButtonView({text:d`Logout`,type:"big"}),this.btnChangeAvatar=new ButtonView({text:d`Change avatar`,type:"normal"}),this.fileSelector=new FileSelector({accept:"image/*",multiple:!1}),N.info.username,this.title=d`User`;const t=new Ref;this.addContent(new View({tag:"div.user-info",child:[{tag:"img.user-avatar",ref:t,src:N.info.avatar?y.processUrl(N.info.avatar):"",hidden:!N.info.avatar},{tag:"div",child:[{tag:"div.user-name",text:N.info.username},this.btnChangeAvatar]},this.fileSelector]})),this.btnChangeAvatar.toggleClass("user-change-avatar",!0),this.btnChangeAvatar.onActive.add((()=>{this.fileSelector.open()})),this.fileSelector.onfile=async e=>{await y.put({path:"users/me/avatar",mode:"raw",obj:await e.arrayBuffer()});const{avatar:n}=await y.get("users/me");N.info.avatar=n,t.value.src=y.processUrl(N.info.avatar)},N.isAdmin&&this.addContent(new View({tag:"p",textContent:d`You are admin.`})),this.addContent(this.btnLoginSettings),this.addContent(this.btnSwitch),this.addContent(this.btnLogout),this.btnLoginSettings.onActive.add((t=>{(new LoginSettingsDialog).show(t),this.close()})),this.btnSwitch.onActive.add((t=>{N.openUI(!0,t),this.close()})),this.btnLogout.onActive.add((()=>{N.logout(),this.close()})),this.addBtn(new TextBtn({text:d`Settings`,right:!0,onActive:t=>{S.openUI(t),this.close()}}))}}class LoginSettingsDialog extends Dialog{constructor(){super(),this.inputPasswd=new LabeledInput({label:d`New password`,type:"password"}),this.inputPasswd2=new LabeledInput({label:d`Confirm password`,type:"password"}),this.status=new TextView({tag:"div.input-label",style:"white-space: pre-wrap;"}),this.btnChangePassword=new ButtonView({text:d`Change password`,type:"big"}),this.title=d`Login settings`,[new SocialLogins,new View({tag:"h3",textContent:d`Change password`}),this.inputPasswd,this.inputPasswd2,this.status,this.btnChangePassword].forEach((t=>this.addContent(t))),this.btnChangePassword.onActive.add((()=>{this.inputPasswd.value?this.inputPasswd.value!==this.inputPasswd2.value?(this.status.text=d`Password confirmation does not match!`,this.status.dom.style.color="red"):N.changePassword(this.inputPasswd.value).then((()=>{this.status.text=d`Password changed.`,this.status.dom.style.color="#00FF00"})):(this.status.text=d`Please input the new password!`,this.status.dom.style.color="red")}))}}class SocialLogins extends View{constructor(){super({tag:"div"}),this.appendView(new View({tag:"h3",textContent:d`Linked accounts`})),this.initAsync()}async initAsync(){const t=new TextView({tag:"div",text:d`Loading`,style:"color: var(--text-gray)"});this.appendView(t),await N.waitLogin(!0);const{links:e}=await y.get("users/me/socialLinks");e&&0!=e.length?(t.removeFromParent(),e.forEach((t=>{this.appendView(new SocialLoginItem(t))}))):t.text=d`(Not available)`}}class SocialLoginItem extends View{constructor(t){var e;super({tag:"div.social-login-item",child:[{tag:"span.name",text:t.name+(t.username?` (${t.username})`:"")},e=new ButtonView({text:()=>t.username?d`Unlink`:d`Link`,onActive:()=>{t.username?y.delete({path:`users/me/socialLinks/${t.id}`}).then((()=>{t.username=null,e.updateDom(),Toast.show(d`Account has been unlinked successfully.`,5e3)})):(e.disabled=!0,y.post({path:`users/me/socialLinks/${t.id}?returnUrl=${encodeURIComponent(window.location.href)}`}).then((({url:t})=>{window.location.href=t})))}})]})}}View.debugging=!0,SidebarItem.prototype.bindContentView=function(t){return this.onActive.add((()=>{this.contentView||(this.contentView=t()),q.content.current!==this.contentView?(q.content.setCurrent(this.contentView),q.sidebarList.setActive(this)):this.contentView.onSidebarItemReactived()})),this};const W=new class MainContainer extends View{constructor(){super(...arguments),this.sidebar=new Sidebar,this.contentOuter=new View(a("main",{id:"content-outer"}))}createDom(){return a("div",{id:"main-container",class:"no-transition"},this.sidebar,this.contentOuter)}},$=new class BottomBar extends View{constructor(){super(...arguments),this.trackImg=new View(a("img",{class:"trackpic clickable",onclick:()=>P.nav("nowplaying"),src:""})),this.progressBar=new ProgressBar,this.btnPlay=new PlayButton,this.btnPrev=new ControlButton({icon:'<svg width="8" height="11" viewBox="0 0 8 11" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M0.7775 0.625765C0.33575 0.625765 0 0.989613 0 1.43827V9.56073C0 10.0094 0.35825 10.3732 0.8 10.3732C1.24175 10.3522 1.6 10.0094 1.6 9.53965V1.43827C1.6 0.989613 1.24175 0.625765 0.7775 0.625765ZM6.6875 0.813148L1.8875 4.8528C1.6955 5.03789 1.6 5.26895 1.6 5.5C1.6 5.73091 1.6955 5.96161 1.886 6.12512L6.686 10.1648C7.20175 10.5995 7.99875 10.2346 7.99875 9.53965V1.41719C7.9775 0.743324 7.2025 0.378207 6.6875 0.813148Z" fill="#FF6557"/>\n</svg>\n'}),this.btnNext=new ControlButton({icon:'<svg width="8" height="11" viewBox="0 0 8 11" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M7.1775 10.3521C7.61925 10.3521 7.955 9.9883 7.955 9.53965V1.43826C7.955 0.989611 7.59675 0.625763 7.155 0.625763C6.71325 0.625763 6.3775 0.989611 6.3775 1.41541V9.53787C6.3775 10.0094 6.7575 10.3521 7.1775 10.3521ZM1.31275 10.1871L6.11275 6.14746C6.30337 5.98405 6.3985 5.75315 6.3985 5.52234C6.3985 5.29144 6.30327 5.06074 6.11275 4.89723L1.31275 0.857579C0.797 0.378205 0 0.743322 0 1.43826V9.56072C0 10.2557 0.797 10.6213 1.31275 10.1871Z" fill="#FF6557"/>\n</svg>\n'}),this.btnOrder=new ControlButton({icon:A}),this.btnVolume=new VolumeButton,this.trackInfo=new TextView(a("span",{class:"track-info clickable",onclick:()=>P.nav("nowplaying"),hidden:()=>!this.track},a("span",{class:"name"},(()=>{var t;return null===(t=this.track)||void 0===t?void 0:t.name})),a("span",{class:"artist"},(()=>{var t;return null===(t=this.track)||void 0===t?void 0:t.artist})))),this.lyrics=new SimpleLyricsView,this.btnFullscreen=new ControlButton({icon:'<svg width="14" height="13" viewBox="0 0 14 13" fill="none" xmlns="http://www.w3.org/2000/svg">\n<path d="M3.14286 0.8125H0.785714C0.351362 0.8125 0 1.17584 0 1.625V4.0625C0 4.51166 0.351362 4.875 0.785714 4.875C1.22007 4.875 1.57143 4.51166 1.57143 4.0625V2.4375H3.14286C3.57721 2.4375 3.92857 2.07416 3.92857 1.625C3.92857 1.17584 3.57746 0.8125 3.14286 0.8125ZM13.2143 0.8125H10.8571C10.4228 0.8125 10.0714 1.17584 10.0714 1.625C10.0714 2.07416 10.4228 2.4375 10.8571 2.4375H12.4286V4.0625C12.4286 4.51166 12.7799 4.875 13.2143 4.875C13.6486 4.875 14 4.51166 14 4.0625V1.625C14 1.17584 13.6489 0.8125 13.2143 0.8125ZM3.14286 10.5625H1.57143V8.9375C1.57143 8.48834 1.22007 8.125 0.785714 8.125C0.351362 8.125 0 8.48834 0 8.9375V11.375C0 11.8242 0.351362 12.1875 0.785714 12.1875H3.14286C3.57721 12.1875 3.92857 11.8242 3.92857 11.375C3.92857 10.9258 3.57746 10.5625 3.14286 10.5625ZM13.2143 8.125C12.7799 8.125 12.4286 8.48834 12.4286 8.9375V10.5625H10.8571C10.4228 10.5625 10.0714 10.9258 10.0714 11.375C10.0714 11.8242 10.4228 12.1875 10.8571 12.1875H13.2143C13.6486 12.1875 14 11.8242 14 11.375V8.9375C14 8.48809 13.6489 8.125 13.2143 8.125Z" fill="#FF6557"/>\n</svg>\n'})}createDom(){return a("div",{class:"bottombar"},this.trackImg,a("div",{class:"control-split-h"},this.progressBar,a("div",{class:"bottom-controls"},this.trackInfo,this.btnOrder,this.btnPrev,this.btnPlay,this.btnNext,this.btnVolume,this.lyrics,this.btnFullscreen)))}bindPlayer(t){const updatePrevNext=()=>{this.btnPrev.disabled=!t.getNextTrack(-1),this.btnNext.disabled=!t.getNextTrack(1)};t.onTrackChanged.add((()=>{var e,n,i;(null===(e=t.track)||void 0===e?void 0:e.thumburl)&&(this.trackImg.dom.src=y.processUrl(null===(n=t.track)||void 0===n?void 0:n.thumburl)),this.trackImg.toggleClass("noimg",!(null===(i=t.track)||void 0===i?void 0:i.thumburl)),this.track=t.track,updatePrevNext(),this.btnFullscreen.hidden=!t.isVideo,this.trackInfo.updateDom()}))(),t.onStateChanged.add((()=>{this.btnPlay.setAction(t.isPlaying?"pause":"play")})),t.onLoopModeChanged.add((()=>{this.btnOrder.icon=U[t.loopMode],updatePrevNext()}))(),this.progressBar.bindPlayer(t),this.btnVolume.bindPlayer(t),this.lyrics.bindPlayer(t),this.lyrics.onLyricsChanged.add((()=>{var t,e;const n=!!(null===(e=null===(t=this.lyrics.lyrics)||void 0===t?void 0:t.lines)||void 0===e?void 0:e.length);this.toggleClass("has-lyrics",n),this.toggleClass("no-lyrics",!n)})),this.btnPlay.onActive.add((e=>{e.preventDefault(),t.isPlaying?t.pause():t.play()})),this.btnNext.onActive.add((e=>{e.preventDefault(),t.next()})),this.btnPrev.onActive.add((e=>{e.preventDefault(),t.prev()})),this.btnOrder.onActive.add((e=>{e.preventDefault();const n=k;t.loopMode=n[(n.indexOf(t.loopMode)+1)%n.length]})),this.btnFullscreen.onActive.add((t=>{t.preventDefault(),P.nav("nowplaying"),q.sidebar.toggleHide(!0),document.documentElement.requestFullscreen()}))}};mountView(document.body,W),mountView(document.body,$);const q=new class{constructor(){this.usingKeyboardInput=!1,this.theme=new class{constructor(){this.all=["light","dark","dark-rounded","light-rounded"],this.current="light",this.timer=new Timer((()=>toggleClass(document.body,"changing-theme",!1))),this.rendered=!1,this.siTheme=new SettingItem("mcloud-theme","str","light-rounded").render((t=>{if(this.current!==t){this.current=t,this.rendered&&toggleClass(document.body,"changing-theme",!0);const[e,n]=t.split("-");toggleClass(document.body,"dark","dark"===e),toggleClass(document.body,"rounded","rounded"===n),document.getElementById("meta-theme-color").content="dark"===e?"black":"",this.rendered&&this.timer.timeout(500)}this.rendered=!0}))}set(t){this.siTheme.set(t)}},this.lang=new class{constructor(){this.availableLangs=["en","zh"],this.siLang=new SettingItem("mcloud-lang","str","")}init(){this.siLang.render((t=>{t||(t=I18n.detectLanguage(this.availableLangs)),this.curLang=t,l.curLang=t,document.body.lang=t,console.info(`[UI] Current language: '${l.curLang}' - '${d`English`}'`),q.updateAllViews()})),l.renderElements(document.querySelectorAll(".i18ne"))}setLang(t,e){this.siLang.set(null!=t?t:""),(void 0===e||e)&&window.location.reload()}},this.mainContainer=new class{constructor(){this.dom=document.getElementById("main-container")}},this.sidebar=new class{constructor(){this.dom=document.getElementById("sidebar"),this.header=W.sidebar.header,this._float=!1,this._hide=!1,this._hideMobile=!0,this._hideLarge=!1,this._btnShown=!1,this._isMobile=!1,this._panxHandler=null,this._leftPadding=200,this._movingPos=null}get float(){return this._float}get hide(){return this._hide&&this._float}get btnShown(){return this._btnShown}init(){this.initPanHandler(),this.toggleBtn(!0),this.checkWidth(),window.addEventListener("resize",(()=>this.checkWidth())),P.onNavCompleted.add((()=>{this.float&&this.toggleHide(!0)})),p.onDragStart.add((()=>{toggleClass(this.dom,"peek",!0)})),p.onDragEnd.add((()=>{toggleClass(this.dom,"peek",!1)})),this.dom.addEventListener("dragover",(()=>this.toggleHide(!1)))}_getWidth(){return this.dom.offsetWidth-200}get movingPos(){return this._movingPos}set movingPos(t){this._movingPos=t;const e=this._getWidth();null!=t&&(t=function numSoftLimit(t,e,n,i){if(t>n)return n+(t-n)*i;if(t<e)return e+(t-e)*i;return t}(t,-e,0,.15));const n=1+t/e;this.overlay.dom.style.opacity=null==t?"":`${n}`,this.overlay.dom.style.transition=null==t?"opacity .3s":"none",this.dom.style.transform=null==t?"":`translate(${t}px, 0)`,this.dom.style.transition=null==t?"":"none",q.content.container.dom.style.transition=null==t?"":"none",q.content.container.dom.style.transform=null==t?"":`translate(${30*n}%, 0)`,this.dom.style.boxShadow=null==t?"":`0 0 ${numLimit((e+t)/5,0,20)}px var(--color-shadow)`,null!=t&&t>0?(this.btn.dom.style.transform=`translate(${t}px, 0)`,this.btn.dom.style.transition="none"):(this.btn.dom.style.transform="",this.btn.dom.style.transition="")}initPanHandler(){this._panxHandler=new TouchPanListener(W.dom,"x"),this._panxHandler.filter=t=>{var e;return this.dom.contains(t.target)||(null===(e=this.overlay)||void 0===e?void 0:e.dom.contains(t.target))||q.content.container.dom.contains(t.target)},this._panxHandler.onStart.add((()=>{this.toggleHide(!1),this.movingPos=this.dom.getBoundingClientRect().left+this._leftPadding}));var t=0;this._panxHandler.onMove.add((({deltaX:e})=>{t=e,this.movingPos+=e})),this._panxHandler.onEnd.add((()=>{var e=this.movingPos+10*t<-this._getWidth()/2;this.movingPos=null,this.toggleHide(e)}))}isMobile(){return window.innerWidth<800}checkWidth(){const t=this.isMobile();t!=this._isMobile&&(this._isMobile=t,this.toggleHide(t?this._hideMobile||this._hideLarge:this._hideLarge&&this._hideMobile))}toggleFloat(t){void 0!==t&&!!t===this._float||(this._float=toggleClass(document.body,"float-sidebar",t),this._panxHandler.enabled=this._float,this.updateOverlay())}toggleBtn(t){t!=this._btnShown&&(this._btnShown=t,t?(this.btn=this.btn||new SidebarToggle,this.dom.parentElement.appendChild(this.btn.dom)):this.btn.dom.remove())}toggleHide(t){this._hide=toggleClass(this.dom,"hide",t),this.isMobile()?this._hideMobile=this._hide:this._hideLarge=this._hide,this.toggleFloat(this.isMobile()||this._hide),q.content.container.toggleClass("sidebar-shown",!this._hide),this.updateOverlay()}updateOverlay(){var t=this.float&&!this.hide;if(t!=!!this.overlay)if(t)this.overlay=new Overlay({tag:"div.overlay",style:"z-index: 99; animation: none; transition: opacity .3s;",onclick:()=>this.toggleHide(!0),ondragover:()=>this.toggleHide(!0)}),this.overlay.dom.style.opacity="0",W.appendView(this.overlay),this.overlay.dom.offsetLeft,this.overlay.dom.style.opacity="1";else{const t=this.overlay;this.overlay=null,t.dom.style.opacity="0",fadeout(t.dom).onFinished((()=>{W.removeView(t)}))}}},this.sidebarLogin=new class{constructor(){this.container=W.sidebar.header,this.loginState=new View({tag:"div.item.no-selection",tabIndex:0}),this.loginName=new TextView({tag:"span.user-name"}),this.loginAvatar=new View({tag:"img.user-avatar"})}init(){this.loginState.addView(this.loginAvatar,0),this.loginState.addView(this.loginName,1),this.container.addView(this.loginState,0),this.loginState.dom.id="login-state",this.loginState.onActive.add((t=>{N.openUI(void 0,t)}))}update(){var t,e,n,i,s=this.loginName.text,r=null!==(e=null===(t=N.pendingInfo)||void 0===t?void 0:t.username)&&void 0!==e?e:N.info.username,o=null!==(i=y.processUrl(null===(n=N.info)||void 0===n?void 0:n.avatar))&&void 0!==i?i:"";r?(s=r,"logging"===N.state&&(s+=d` (logging in...)`),"error"===N.state&&(s+=d` (error!)`),"none"===N.state&&(s+=d` (not logged in)`)):s="logging"===N.state?d`(logging...)`:d`Guest (click to login)`,this.loginName.text=s,this.loginAvatar.hidden=!o,this.loginAvatar.dom.src=o}},this.sidebarList=new class{constructor(){this.container=W.sidebar.list,this.featuresListview=W.sidebar.features,this.currentActive=new ItemActiveHelper}setActive(t){this.currentActive.set(t)}addFeatureItem(t){this.featuresListview.add(t)}},this.content=new class{constructor(){this.container=W.contentOuter,this.current=null}removeCurrent(){const t=this.current;this.current=null,t&&t.fadeOut()}setCurrent(t){t!==this.current&&(this.container.toggleClass("content-animation-reverse",P.wasBacked),this.removeCurrent(),t&&(t.parentView||(t.onShow(),this.container.appendView(t),t.onDomInserted()),t.fadeIn()),this.current=t)}},this.contentBg=new class{constructor(){this.bgView=null,this.imgView=null,this.videoView=null,this.curImg=""}init(){x.onTrackChanged.add((()=>this.update())),x.onAudioCreated.add((()=>{this.videoView=new View(x.audio),this.bgView.addView(this.videoView)})),x.onStateChanged.add((()=>{var t,e;this.bgView.toggleClass("has-video","video"===(null===(e=null===(t=x.track)||void 0===t?void 0:t.infoObj)||void 0===e?void 0:e.type))})),y.onTrackInfoChanged.add((t=>{var e;return t.id===(null===(e=x.track)||void 0===e?void 0:e.id)&&this.update()})),this.bgView=new View({tag:"div.content-bg"}),q.content.container.addView(this.bgView,0)}toggleFullVideo(t){this.bgView.toggleClass("full-video",t)}update(){const t=x.track;if((null==t?void 0:t.thumburl)&&"video"!=t.type){const e="url("+y.processUrl(t.thumburl)+")";if(this.curImg!=e){const t=new View({tag:"div.content-bg-img",style:{backgroundImage:e}});this.bgView.addView(t,0),this.fadeoutCurrent(),this.imgView=t,this.curImg=e}}else this.fadeoutCurrent()}fadeoutCurrent(){const t=this.imgView;t&&(fadeout(t.dom,{remove:!1}).onFinished((()=>{t.removeFromParent()})),this.curImg="")}},this.windowTitle=new class{constructor(){this.appName=d`Music Cloud`}reset(){this.setTitle(null)}setTitle(t){t?t+=" - "+this.appName:t=this.appName,document.title=t}setFromTrack(t){t?this.setTitle(t.name+" - "+t.artist):this.setTitle(null)}},this.notification=new class{constructor(){this.siNotification=new SettingItem("mcloud-notif","json",{enabled:!1,nowPlaying:!0}),this.lastNotif=null}get config(){return this.siNotification.data}isEnabledFor(t){return this.config.enabled&&this.config[t]}browserSupport(){return"Notification"in window}checkPermission(){return"granted"==Notification.permission}async requestPermission(){return!!this.browserSupport()&&(!!this.checkPermission()||"granted"==await Notification.requestPermission())}show(t,e,n=5e3){console.info("[UI] notification",{title:t,options:e,timeout:n}),this.lastNotif&&this.lastNotif.close();var i=this.lastNotif=new Notification(t,e);return n&&setTimeout((()=>{i.close()}),n),i}init(){!this.config.enabled||this.browserSupport()&&this.checkPermission()||(this.config.enabled=!1,this.siNotification.save()),x.onTrackChanged.add((()=>{if(this.isEnabledFor("nowPlaying")&&!q.isVisible()&&this.config.nowPlaying&&("playing"==x.state||"stalled"==x.state)){const t=x.track;this.show(t.name,{body:d`Artist`+": "+(null==t?void 0:t.artist),requireInteraction:!1,image:(null==t?void 0:t.picurl)?y.processUrl(t.picurl):void 0,silent:!0})}}))}async setEnable(t){(!t||this.browserSupport()&&await this.requestPermission())&&(this.config.enabled=t,this.siNotification.save())}}}init(){this.addErrorListener(),this.lang.init(),this.sidebar.init(),this.contentBg.init(),$.bindPlayer(x),this.sidebarLogin.init(),this.windowTitle.reset(),this.notification.init(),Dialog.defaultParent=new DialogParent(W),ToastsContainer.default.parentDom=W.dom,ToastsContainer.default.dom.style.position="absolote",P.addRoute({path:["home"],onNav:()=>{q.content.setCurrent(null),q.sidebarList.currentActive.set(null)}}),document.addEventListener("dragover",(t=>{t.preventDefault()})),document.addEventListener("drop",(t=>{var e;if(t.defaultPrevented)return;t.preventDefault();const n=null===(e=t.dataTransfer)||void 0===e?void 0:e.files;n&&n.length&&(new MessageBox).setTitle(d`Question`).addText(1===n.length?d`Did you mean to upload 1 file?`:d`Did you mean to upload ${n.length} files?`).addResultBtns(["no","yes"]).allowCloseWithResult("no").showAndWaitResult().then((t=>{if("yes"===t){"uploads"!==P.currentStr&&P.nav("uploads");for(let t=0;t<n.length;t++){const e=n[t];R.uploadFile(e)}}}))})),document.addEventListener("keydown",(t=>{this.usingKeyboardInput=!0,document.body.classList.add("keyboard-input")}),!0),["mousedown","touchstart"].forEach((t=>document.addEventListener(t,(t=>{this.usingKeyboardInput=!1,document.body.classList.remove("keyboard-input")}),{passive:!0,capture:!0}))),window.addEventListener("message",(t=>{t.data.theme&&q.theme.set(t.data.theme)}))}addErrorListener(){window.addEventListener("error",(t=>{Toast.show(d`Application Error:`+"\n"+t.error,5e3)}))}endPreload(){setTimeout((()=>{q.mainContainer.dom.classList.remove("no-transition"),fadeout(document.getElementById("preload-overlay"))}),1)}isVisible(){return!document.hidden}updateAllViews(){W.updateAll()}showContextMenuForItem(t,e,...n){e.show(...n),t.forEach((t=>t.toggleClass("menu-shown",!0))),e.onClose.add((()=>{t.forEach((t=>t.toggleClass("menu-shown",!1)))}))}};class SidebarToggle extends View{createDom(){return{tag:"div.sidebar-toggle.clickable.no-selection",child:{tag:"div.logo",text:"M"},onclick:t=>{q.sidebar.toggleHide()},ondragover:t=>{q.sidebar.toggleHide(!1)}}}}class TouchPanListener{constructor(t,e="both"){this.element=t,this.mode=e,this.onStart=new r,this.onMove=new r,this.onEnd=new r,this._enabled=!1,this._listener=t=>{if(this.filter&&!this.filter(t))return;if(t.touches.length>1)return;var e=t.touches[0].pageX,n=t.touches[0].pageY,i="begin";const move=t=>{const s=t.touches[0].pageX,r=t.touches[0].pageY;if("ignore"!=i)if("moving"==i){t.preventDefault(),t.stopPropagation();var o=s-e,a=r-n;this.onMove.invoke({deltaX:o,deltaY:a}),e=s,n=r}else"x"==this.mode&&Math.abs(r-n)>10&&Math.abs(r-n)>Math.abs(s-e)||"y"==this.mode&&Math.abs(s-e)>10&&Math.abs(s-e)>Math.abs(r-n)?i="ignore":(Math.abs(s-e)>10||Math.abs(r-n)>10)&&(i="moving",t.preventDefault(),t.stopPropagation(),this.onStart.invoke())},end=t=>{0==t.touches.length&&("moving"==i&&this.onEnd.invoke(),this.element.removeEventListener("touchmove",move,!0),this.element.removeEventListener("touchend",end,!0),this.element.removeEventListener("touchcancel",end,!0))};this.element.addEventListener("touchmove",move,!0),this.element.addEventListener("touchend",end,!0),this.element.addEventListener("touchcancel",end,!0)}}get enabled(){return this._enabled}set enabled(t){t!=this._enabled&&(this._enabled=t,t?this.element.addEventListener("touchstart",this._listener,!0):this.element.removeEventListener("touchstart",this._listener,!0))}}class CommentsContentView extends ListContentView{constructor(t){super(),this.comments=t}appendHeader(){super.appendHeader(),this.header.appendView(this.editorNew=new CommentEditor),this.editorNew.dom.classList.add("comment-editor-new"),this.editorNew.onsubmit=t=>{var e=t.content;t.content="",""!==e&&this.comments.post(e)},this.refreshBtn.onActive.add((()=>{this.comments.fetch()}))}appendListView(){super.appendListView(),this.comments.state||this.comments.fetch()}}class CommentsView{constructor(){this.lazyView=new Lazy((()=>this.createContentView())),this.state=!1}get view(){return this.lazyView.value}async fetch(t){if("fetching"===this.state||"waiting"===this.state)return void console.warn("[Comments] another fetch task is running.");this.state="waiting";var e=new LoadingIndicator;t||this.view.useLoadingIndicator(e);try{await N.waitLogin(!0),this.state="fetching";var n=await y.get(this.endpoint+"?reverse=1");this.view.useLoadingIndicator(null)}catch(t){throw this.state="error",e.error(t,(()=>this.fetch())),this.view.useLoadingIndicator(e),t}const i=this;(new class extends DataUpdatingHelper{constructor(){super(...arguments),this.items=i.view.listView}addItem(t,e){i.addItem(t,e)}updateItem(t,e){t.comment=e}removeItem(t){t.remove()}}).update(n.comments),this.view.updateView(),this.state="fetched",this.eventName&&!this.eventRegistered&&(O.listenEvent(this.eventName,(()=>{this.fetch(!0)}),!0),this.eventRegistered=!0)}addItem(t,e){const n=new CommentViewItem(t);return(t.uid===N.info.id||N.isAdmin)&&(n.onremove=()=>{this.ioAction((()=>y.delete({path:this.endpoint+"/"+n.comment.id})))}),this.view.listView.add(n,e)}async ioAction(t){var e=new LoadingIndicator({content:d`Submitting`});this.view.useLoadingIndicator(e),await e.action((async()=>{await t(),await this.fetch()}))}async post(t){await this.ioAction((()=>y.post({path:this.endpoint+"/new",obj:{content:t}})))}createContentView(){var t,e=new CommentsContentView(this);return e.title=null!==(t=this.title)&&void 0!==t?t:()=>d`Comments`,e}}class CommentViewItem extends ListViewItem{constructor(t){super(),this.onContextMenu=(t,e)=>{e.preventDefault();var n=new ContextMenu([new MenuInfoItem({text:d`Comment ID`+": "+this.comment.id})]);this.onremove&&n.add(new MenuItem({text:d`Remove`,cls:"dangerous",onActive:()=>{this.onremove(this)}}),0),this.onedit&&n.add(new MenuItem({text:d`Edit`,onActive:()=>{this.onedit(this)}}),0),q.showContextMenuForItem([this],n,{ev:e})},this.comment=t}get id(){return this.comment.id}createDom(){return a("div",{class:"item comment no-transform"},a("div",{class:"username"},(()=>this.comment.username)),a("div",{class:"date"},(()=>formatDateTime(new Date(this.comment.date)))),a("div",{class:"content"},(()=>this.comment.content)))}}class CommentEditor extends View{get content(){return this.ensureDom(),this.domcontent.value}set content(t){this.ensureDom(),this.domcontent.value=t}createDom(){return{tag:"div.comment-editor",child:[{tag:"textarea.input-text.content",_id:"content"},{tag:"div.btn.submit",textContent:d`Submit`,_id:"submit"}]}}postCreateDom(){this.domcontent=this.getDomById("content"),this.domsubmit=this.getDomById("submit"),this.domcontent.addEventListener("keydown",(t=>{t.ctrlKey&&13===t.keyCode&&this.onsubmit(this)})),this.domsubmit.addEventListener("click",(()=>{this.onsubmit(this)}))}}const K=new class extends CommentsView{constructor(){super(...arguments),this.endpoint="discussion",this.eventName="diss-changed"}init(){this.title=()=>d`Discussion`,this.sidebarItem=new SidebarItem({text:()=>d`Discussion`}),P.addRoute({path:["discussion"],sidebarItem:()=>this.sidebarItem,contentView:()=>this.lazyView.value}),q.sidebarList.addFeatureItem(this.sidebarItem),N.onSwitchedUser.add((()=>{this.sidebarItem.hidden=!("logged"==N.state&&N.serverOptions.discussionEnabled&&b.showDiscussion)}))()}},X=new class extends CommentsView{constructor(){super(...arguments),this.endpoint="my/notes",this.eventName="note-changed"}init(){this.title=()=>d`Notes`,this.sidebarItem=new SidebarItem({text:()=>d`Notes`}),P.addRoute({path:["notes"],sidebarItem:()=>this.sidebarItem,contentView:()=>this.lazyView.value}),q.sidebarList.addFeatureItem(this.sidebarItem),N.onSwitchedUser.add((()=>{this.state&&"waiting"!==X.state&&this.fetch()})),N.onSwitchedUser.add((()=>{this.sidebarItem.hidden=!("logged"==N.state&&N.serverOptions.notesEnabled&&b.showNotes)}))()}},Z=new class{init(){P.addRoute({path:["track-comments"],onNav:({remaining:t})=>{var e=parseInt(t[0]);q.sidebarList.setActive(null);var n=new CommentsView;n.endpoint="tracks/"+e+"/comments",q.content.setCurrent(n.view)}})}},Y=new class{constructor(){this.lazyView=new Lazy((()=>new PlayingView))}init(){var t=new SidebarItem({text:()=>d`Now Playing`});P.addRoute({path:["nowplaying"],contentView:()=>this.view,sidebarItem:()=>t}),P.addRoute({path:["tracks"],onNav:t=>{P.nav(["track",...t.remaining],{pushState:"replace"})}}),P.addRoute({path:["track"],onNav:t=>{var e;P.nav(["nowplaying"],{pushState:!1}),t.remaining[0]!=(null===(e=x.track)||void 0===e?void 0:e.id)&&y.get("tracks/"+t.remaining[0]).then((t=>{x.setTrack(new Track({infoObj:t}))}))}}),q.sidebarList.addFeatureItem(t),x.onTrackChanged.add((()=>{t.hidden=!x.track}))()}get view(){return this.lazyView.value}};class PlayingView extends ContentView{constructor(){super(),this.header=new class extends ContentHeader{onScrollboxScroll(){setScrollableShadow(this.dom,this.scrollbox.scrollTop-this.lines.dom.offsetTop)}}({title:()=>d`Now Playing`}),this.infoView=new View({tag:"div.infoview",child:[{tag:"div.name",text:()=>{var t;return null===(t=x.track)||void 0===t?void 0:t.name}},{tag:"div.artist",text:()=>{var t;return null===(t=x.track)||void 0===t?void 0:t.artist}}]}),this.lyricsView=new LyricsView,this.loading=new LoadingIndicator,this.loadingOuter=new View({tag:"div",child:this.loading,style:{flex:1,display:"flex",flexDirection:"column",justifyContent:"center"}}),this.viewToggle=new ViewToggle({container:this,items:{header:this.header,normal:this.lyricsView,loading:this.loadingOuter}}),this.si=new SettingItem("mcloud-nowplaying","json",{lyricsScale:100}),this.loadedLyrics="",this._checkTrackVersion=0,this.header.lines=this.lyricsView.lines,this.header.dom.style.background="none",this.lyricsView.scale=this.si.data.lyricsScale,this.lyricsView.onFontSizeChanged.add((()=>{this.si.data.lyricsScale=this.lyricsView.scale,this.si.save(),this.lyricsView.centerLyrics()})),this.lyricsView.onLyricsChanged.add((()=>{this.header.onScrollboxScroll()})),this.lyricsView.onSpanClick.add((t=>{t.span.startTime&&t.span.startTime>=0&&(x.currentTime=t.span.startTime)})),this.header.actions.addView(this.editBtn=new ActionBtn({text:d`Edit`,onActive:t=>{var e;null===(e=x.track)||void 0===e||e.startEdit(t)}})),this.header.appendView(this.infoView),this.header.bindScrollBox(this.lyricsView.dom)}createDom(){return{tag:"div.playingview",child:[this.header,this.lyricsView]}}postCreateDom(){super.postCreateDom()}onShow(){super.onShow(),this.ensureDom()}onDomInserted(){super.onDomInserted(),this.shownEvents.add(x.onTrackChanged,(()=>{this.checkTrack()}))(),this.shownEvents.add(x.onProgressChanged,(()=>this.lyricsView.onProgressChanged())),this.shownEvents.add(y.onTrackInfoChanged,(t=>{var e;t.id===(null===(e=x.track)||void 0===e?void 0:e.id)&&this.checkTrack()})),this.lyricsView.onShow()}onShowing(){super.onShowing(),q.contentBg.toggleFullVideo(!0)}onHiding(){super.onHiding(),q.contentBg.toggleFullVideo(!1)}onRemove(){super.onRemove(),this.lyricsView.onHide()}onSidebarItemReactived(){this.lyricsView.setScrollingPause(null),this.lyricsView.setCurrentTime(this.lyricsView.curTime,"smooth")}async checkTrack(){var t=++this._checkTrackVersion;this.infoView.updateDom();const e=x.track;let n="";if(this.editBtn.hidden=!e,this.editBtn.text=(null==e?void 0:e.canEdit)?d`Edit`:d`Details`,this.loadingOuter.dom.remove(),"video"!=(null==e?void 0:e.type)){if(e&&!e.isLyricsGotten()){this.loading.reset(),this.viewToggle.setShownKeys(["header","loading"]);try{n=await e.getLyrics()}catch(e){if(t!=this._checkTrackVersion)return;return void this.loading.error(e,(()=>this.checkTrack()))}if(t!=this._checkTrackVersion)return}else n=(null==e?void 0:e.lyrics)||"";this.viewToggle.setShownKeys(["header","normal"]),this.lyricsView.track=e,this.loadedLyrics!=n&&(this.loadedLyrics=n,this.lyricsView.reset(),this.lyricsView.setLyrics(n))}else this.viewToggle.setShownKeys([])}}const G=new class ListenTogether{init(){}createSession(){}joinSession(){}leaveSession(){}openUI(){}},J=new class{constructor(){this.lazyView=new Lazy((()=>new SearchView)),this.checkPlaying=()=>{var t,e,n=this.lazyView.computed&&!!this.view.tempList&&(null===(e=null===(t=x.track)||void 0===t?void 0:t._bind)||void 0===e?void 0:e.list)===this.view.tempList;this.sidebarItem.updateWith({playing:n})}}init(){this.sidebarItem=new ListIndexViewItem({text:()=>d`Search`}),P.addRoute({path:["search"],contentView:()=>this.view,sidebarItem:()=>this.sidebarItem,onNav:t=>{const e=t.remaining[0];e&&e!=this.view.currentQuery&&this.view.performSearch(e)}}),q.sidebarList.addFeatureItem(this.sidebarItem),x.onTrackChanged.add(this.checkPlaying)()}get view(){return this.lazyView.value}};class SearchView extends ListContentView{constructor(){super(...arguments),this.title=()=>d`Search`,this.searchbar=new SearchBar,this.tempList=null}appendListView(){super.appendListView(),this.listView.toggleClass("tracklistview",!0),this.listView.dragging=!0,this.listView.onItemClicked=t=>{var e=this.getTempList().tracks[t.position];x.track===e&&x.isPlaying?P.nav("nowplaying"):x.playTrack(e)}}appendHeader(){super.appendHeader(),this.refreshBtn.hidden=!0,this.header.appendView(this.searchbar),this.searchbar.onSearch.add((()=>{this.performSearch(this.searchbar.input.value)}))}getTempList(){return this.tempList||(this.tempList=new TrackList,this.listView.forEach((t=>this.tempList.addTrack(t.track.infoObj)))),this.tempList}async performSearch(t){this.currentQuery=t,this.searchbar.value!=t&&(this.searchbar.value=t);var e=new LoadingIndicator;this.useLoadingIndicator(e),P.nav(["search",t]);try{var n=await y.get("tracks?query="+encodeURIComponent(t));this.tempList=null,J.checkPlaying(),this.listView.removeAll(),n.tracks.forEach((t=>{this.listView.add(new TrackViewItem(new Track({infoObj:t})))})),this.updatePlaying(),this.useLoadingIndicator(null)}catch(n){e.error(n,(()=>this.performSearch(t)))}}onShow(){super.onShow(),this.updatePlaying(),this.shownEvents.add(x.onTrackChanged,(()=>this.updatePlaying()))}onRemove(){super.onRemove()}updatePlaying(){var t=x.track;this.listView.forEach((e=>{e.updateWith({playing:!!t&&e.track.id===t.id})}))}}class SearchBar extends View{constructor(){super(...arguments),this.input=new InputView,this.btn=new ButtonView({text:d`Search`,onActive:()=>this.onSearch.invoke()}),this.onSearch=new r}get value(){return this.input.value}set value(t){this.input.value=t}createDom(){return{tag:"div.searchbar",child:[this.input,this.btn]}}postCreateDom(){super.postCreateDom(),this.input.dom.addEventListener("keydown",(t=>{"Enter"===t.code&&(t.preventDefault(),this.onSearch.invoke())}))}}const Q=new class ServiceWorkerClient{constructor(){this.reg=null}async init(){if("https:"==window.location.protocol)try{this.reg=await navigator.serviceWorker.register("sw.bundle.js",{scope:"."}),console.info("[sw client] service worker registered",this.reg)}catch(t){console.error("[sw client] error",t)}else console.info("[sw client] non-https protocol, skipping service worker registration")}};
/*! *************************************************
        Copyright (c) 2020 lideming

        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:

        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
    ************************************************* */
const tt=window.app={webfx:v,settings:b,settingsUI:S,ui:q,api:y,playerCore:x,router:P,listIndex:j,user:N,uploads:R,discussion:K,notes:X,nowPlaying:Y,lyricsEdit:H,playerFX:L,Toast:Toast,ToastsContainer:ToastsContainer,Lyrics:F,msgcli:O,init(){console.time("[Main] app.init()"),b.init(),tt.checkMode(),tt.injectStyle(),q.init(),x.init(),L.init(),N.init(),R.init(),J.init(),K.init(),X.init(),Y.init(),G.init(),Z.init(),j.init(),O.init(),P.init(),V.showUpdatedToast(),Q.init(),console.timeEnd("[Main] app.init()")},checkMode(){"1"==localStorage.getItem("mcloud-dev")&&startBlockingDetect()},injectStyle(){injectWebfxCss(),injectCss('* {\r\n    box-sizing: border-box;\r\n}\r\n\r\nhtml {\r\n    touch-action: auto;\r\n}\r\n\r\nbody {\r\n    margin: 0;\r\n    font-family: sans-serif;\r\n    font-size: 22px;\r\n\r\n    --color-bg: white;\r\n    --color-bg-transparent: var(--color-bg);\r\n    --color-text: black;\r\n    --color-text-gray: #666;\r\n    --color-bg-selection: hsl(5, 100%, 85%);\r\n    --color-primary: hsl(5, 100%, 67%);\r\n    --color-primary-darker: hsl(5, 100%, 60%);\r\n    --color-primary-dark: hsl(5, 100%, 40%);\r\n    --color-primary-dark-depends: hsl(5, 100%, 40%);\r\n    --color-primary-verydark: hsl(5, 100%, 20%);\r\n    --color-primary-lighter: hsl(5, 100%, 70%);\r\n    --color-primary-light: hsl(5, 100%, 83%);\r\n    --color-primary-really-light: hsl(5, 100%, 90%);\r\n    --color-fg-11: #111111;\r\n    --color-fg-22: #222222;\r\n    --color-fg-33: #333333;\r\n    --color-bg-cc: #cccccc;\r\n    --color-bg-dd: #dddddd;\r\n    --color-bg-ee: #eeeeee;\r\n    --color-bg-f8: #f8f8f8;\r\n    --color-shadow: rgba(0, 0, 0, .5);\r\n    --color-light-shadow: rgba(0, 0, 0, .3);\r\n    background: var(--color-bg);\r\n    color: var(--color-text);\r\n}\r\n\r\nbody.dark {\r\n    --color-bg: black;\r\n    --color-text: #ddd;\r\n    --color-text-gray: #aaa;\r\n    --color-bg-selection: hsl(5, 100%, 20%);\r\n    --color-primary-dark-depends: hsl(5, 100%, 83%);\r\n    --color-fg-11: #dddddd;\r\n    --color-fg-22: #cccccc;\r\n    --color-fg-33: #bbbbbb;\r\n    --color-bg-f8: #111111;\r\n    --color-bg-ee: #222222;\r\n    --color-bg-dd: #333333;\r\n    --color-bg-cc: #444444;\r\n    --color-shadow: rgba(180, 180, 180, .5);\r\n    --color-light-shadow: rgba(180, 180, 180, .3);\r\n}\r\n\r\nul, li {\r\n    padding: 0;\r\n    margin: 0;\r\n    list-style-type: none;\r\n}\r\n\r\na {\r\n    color: var(--color-text);\r\n}\r\n\r\n.btn {\r\n    box-shadow: 0 0 2px var(--color-light-shadow);\r\n}\r\n\r\n.icon {\r\n    display: block;\r\n    position: relative;\r\n    height: 1em;\r\n    width: 1em;\r\n    margin: auto;\r\n    overflow: visible;\r\n}\r\n\r\n.icon svg {\r\n    position: absolute;\r\n    fill: currentColor;\r\n    height: 1.2em;\r\n    width: 1.2em;\r\n    left: -.1em;\r\n    top: -.1em;\r\n}\r\n\r\n.item {\r\n    padding: .7em;\r\n}\r\n\r\n.input-text {\r\n    background: var(--color-bg-transparent);\r\n}\r\n\r\n.no-transition, .no-transition * {\r\n    transition: none !important;\r\n}\r\n\r\n.changing-theme, .changing-theme * {\r\n    transition: background-color .3s, color .3s, border-color .3s, border-radius .3s, margin .3s, padding .3s !important;\r\n}\r\n\r\n:focus {\r\n    outline: none;\r\n}\r\n\r\n.keyboard-input :focus, .input-text:focus  {\r\n    outline: solid .1em var(--color-primary-light);\r\n}\r\n\r\n.keyboard-input #sidebar:focus,\r\n.keyboard-input .listcontentview > .scrollbox:focus,\r\n.keyboard-input .lyricsview:focus {\r\n    outline: solid .1em var(--color-primary-light);\r\n    outline-offset: -.1em;\r\n}\r\n\r\n::selection {\r\n    background: var(--color-bg-selection);\r\n}\r\n\r\n::-webkit-scrollbar {\r\n    background: transparent;\r\n}\r\n\r\n::-webkit-scrollbar-thumb {\r\n    background: var(--color-bg-cc);\r\n}\r\n\r\n::-webkit-scrollbar-thumb:hover {\r\n    background: var(--color-bg-dd);\r\n}\r\n\r\n::-webkit-scrollbar-thumb:active {\r\n    background: var(--color-bg-ee);\r\n}\r\n\r\n* {\r\n    scrollbar-color: var(--color-bg-dd) transparent;\r\n}\r\n\r\nhtml, body {\r\n    height: 100%;\r\n    overflow: hidden;\r\n}\r\n\r\n.flexbox-v {\r\n    display: flex;\r\n    flex-direction: column;\r\n}\r\n\r\n.flexbox-h {\r\n    display: flex;\r\n    flex-direction: row;\r\n}\r\n\r\n.flex-1 {\r\n    flex: 1;\r\n}\r\n\r\n.clearfix::after {\r\n    content: "";\r\n    display: block;\r\n    clear: both;\r\n}\r\n\r\n#main-container {\r\n    /* height: calc(100% - 15px); */\r\n    height: calc(100% - 60px);\r\n    position: relative;\r\n    contain: strict;\r\n}\r\n\r\n#sidebar, #content-outer {\r\n    position: absolute;\r\n    height: 100%;\r\n    overflow: hidden;\r\n    contain: strict;\r\n}\r\n\r\n#sidebar {\r\n    top: 0;\r\n    left: 0;\r\n    width: 250px;\r\n    overflow-y: auto;\r\n    background: var(--color-bg-f8);\r\n    border-right: 1px solid var(--color-bg-cc);\r\n    will-change: transform, scroll-position;\r\n    box-sizing: content-box;\r\n    /* transition: transform .3s, width .3s, padding .3s, margin .3s; */\r\n    transform: translate(0, 0);\r\n    z-index: 1;\r\n    animation: showing .3s;\r\n    scrollbar-width: thin;\r\n}\r\n\r\n#sidebar::-webkit-scrollbar {\r\n    width: 8px;\r\n}\r\n\r\n#content-outer {\r\n    top: 0;\r\n    left: 250px;\r\n    width: calc(100% - 250px);\r\n    background: var(--color-bg);\r\n    /* transition: left .3s, width .3s; */\r\n}\r\n\r\n@media only screen and (min-width: 800px) {\r\n    #sidebar {\r\n        width: calc(250px + (100vw - 800px) * .2);\r\n    }\r\n    #content-outer {\r\n        left: calc(250px + (100vw - 800px) * .2);\r\n        width: calc(100% - (250px + (100vw - 800px) * .2));\r\n    }\r\n}\r\n\r\n\r\n.float-sidebar #sidebar {\r\n    float: none;\r\n    position: absolute;\r\n    left: 0;\r\n    top: 0;\r\n    z-index: 100;\r\n    transition: transform .3s, opacity .3s;\r\n    width: 250px;\r\n    max-width: 80vw;\r\n    box-shadow: 0 0 20px var(--color-shadow);\r\n    animation: none;\r\n\r\n    --leftpadding: 200px;\r\n    padding-left: var(--leftpadding);\r\n    margin-left: calc(0px - var(--leftpadding));\r\n}\r\n\r\n.float-sidebar #content-outer {\r\n    left: 0;\r\n    width: 100%;\r\n}\r\n\r\n.float-sidebar #sidebar.hide {\r\n    transform: translate(calc(-100% + var(--leftpadding)), 0);\r\n    transition: transform .3s, opacity .3s .3s, width 0s .3s;\r\n    box-shadow: none;\r\n}\r\n\r\n.float-sidebar #sidebar.hide.peek {\r\n    transform: translate(calc(-100% + var(--leftpadding) + 3em), 0);\r\n    opacity: .3;\r\n    transition: transform .3s, opacity .3s;\r\n}\r\n\r\n#sidebar-header {\r\n    padding-left: 3em;\r\n    min-height: 3em;\r\n    position: sticky;\r\n    top: 0;\r\n    background: inherit;\r\n    z-index: 3;\r\n    display: flex;\r\n}\r\n\r\n#login-state {\r\n    display: flex;\r\n    /* flex: 1; */\r\n    align-items: center;\r\n    height: 3em;\r\n    overflow: hidden;\r\n    padding-right: 5px;\r\n}\r\n\r\n#login-state .user-avatar {\r\n    width: 40px;\r\n    height: 40px;\r\n    margin: 0 5px 0 0;\r\n    flex: 0 0 0;\r\n}\r\n\r\n#login-state .user-name {\r\n    overflow: hidden;\r\n    font-size: 16px;\r\n    flex: 1 1;\r\n}\r\n\r\n#settings-btn {\r\n    display: flex;\r\n    align-items: center;\r\n    text-align: center;\r\n    justify-content: center;\r\n    width: 3em;\r\n}\r\n\r\n#settings-btn svg {\r\n    height: 1.2em;\r\n    width: 1.2em;\r\n}\r\n\r\n#sidebar-features {\r\n    z-index: 2;\r\n    position: relative;\r\n}\r\n\r\n#sidebar-list .section-header {\r\n    position: sticky;\r\n    /* top: 0; */\r\n    /* padding: .7em; */\r\n    /* padding-top: 4em; */\r\n    /* margin-top: -3.3em; */\r\n    top: 3.5em;\r\n    z-index: 1;\r\n}\r\n\r\n.sidebar-toggle {\r\n    position: absolute;\r\n    left: 0;\r\n    top: 0;\r\n    z-index: 110;\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n    height: 3em;\r\n    width: 3em;\r\n    background: var(--color-bg-ee);\r\n    color: var(--color-primary-dark);\r\n    transition: transform .3s;\r\n}\r\n\r\n.sidebar-toggle .logo {\r\n    text-align: center;\r\n    line-height: 1;\r\n    font-size: 1.2em;\r\n    font-weight: 700;\r\n    transition: transform .3s, color .3s;\r\n    transform: scale(1);\r\n}\r\n\r\n.sidebar-toggle:hover .logo {\r\n    color: var(--color-primary);\r\n    transform: scale(1.2);\r\n    transition: transform .2s, color .2s;\r\n}\r\n\r\n.contentview {\r\n    position: absolute;\r\n    overflow: hidden;\r\n    width: 100%;\r\n    height: 100%;\r\n    animation: fadein;\r\n    animation: contentview-fading-in 0.3s;\r\n    transform: translate(0, 0);\r\n    will-change: transform;\r\n}\r\n\r\n.contentview.fading-out {\r\n    animation: contentview-fading-out 0.3s;\r\n}\r\n\r\n.content-animation-reverse > .contentview {\r\n    animation: contentview-fading-out 0.3s reverse;\r\n}\r\n\r\n.content-animation-reverse > .contentview.fading-out {\r\n    animation: contentview-fading-in 0.3s reverse;\r\n}\r\n\r\n@keyframes contentview-fading-in {\r\n  0% {\r\n    transform: scale(0.9);\r\n    opacity: 0;\r\n  }\r\n  100% {\r\n    transform: scale(1);\r\n    opacity: 1;\r\n  }\r\n}\r\n\r\n@keyframes contentview-fading-out {\r\n  0% {\r\n    transform: scale(1);\r\n    opacity: 1;\r\n  }\r\n  100% {\r\n    transform: scale(1.1);\r\n    opacity: 0;\r\n  }\r\n}\r\n\r\n.content-header {\r\n    position: relative;\r\n    z-index: 1;\r\n    top: 0;\r\n    background: var(--color-bg);\r\n    /* animation: showing-top .3s; */\r\n    cursor: default;\r\n    /* font-size: 16px; */\r\n    line-height: 1.25;\r\n    align-self: stretch;\r\n}\r\n\r\n.titlebar {\r\n    padding: .5em;\r\n    /* transition: padding-left .3s; */\r\n}\r\n\r\n.float-sidebar .content-header .titlebar {\r\n    padding-left: 3em;\r\n}\r\n\r\n.titlebar .catalog {\r\n    font-size: 120%;\r\n    line-height: 1;\r\n    color: var(--color-text-gray);\r\n    padding: .25em;\r\n    margin-left: .25em;\r\n}\r\n\r\n.titlebar .title {\r\n    vertical-align: baseline;\r\n    display: inline-block;\r\n    font-size: 120%;\r\n    line-height: 1;\r\n    min-height: 1em;\r\n    min-width: 3em;\r\n    padding: .3em;\r\n    margin-left: .3em;\r\n}\r\n\r\n.titlebar .title.editable {\r\n    cursor: text;\r\n}\r\n\r\n.titlebar .title.editable:hover {\r\n    background: var(--color-bg-ee)\r\n}\r\n\r\n.titlebar .title.editing {\r\n    padding: 0;\r\n}\r\n\r\n.titlebar .title input {\r\n    display: inline-block;\r\n    line-height: 1;\r\n    padding: .2em;\r\n    width: 10em;\r\n    font: inherit;\r\n    border: none;\r\n    outline: none;\r\n    background: var(--color-bg-dd);\r\n    color: var(--color-text);\r\n}\r\n\r\n.titlebar .actions {\r\n    float: right;\r\n    vertical-align: middle;\r\n}\r\n\r\n.titlebar .actions .action {\r\n    display: inline-block;\r\n    vertical-align: middle;\r\n    color: var(--color-text-gray);\r\n    margin: .25em;\r\n}\r\n\r\n.titlebar .actions .action.active {\r\n    color: var(--color-text);\r\n}\r\n\r\n.listcontentview {\r\n    display: flex;\r\n    flex-direction: column;\r\n}\r\n\r\n.listcontentview > .scrollbox {\r\n    flex: 1;\r\n    overflow-y: auto;\r\n    /* animation: showing .3s; */\r\n    will-change: transform;\r\n}\r\n\r\n.tracklistview {\r\n    padding-bottom: 1.5em;\r\n}\r\n\r\n.section-header {\r\n    display: flex;\r\n    color: var(--color-text-gray);\r\n    padding: .5em;\r\n    font-size: 85%;\r\n    position: sticky;\r\n    top: 0;\r\n}\r\n\r\n#sidebar .section-header {\r\n    background: var(--color-bg-f8);\r\n    z-index: 1;\r\n}\r\n\r\n.section-title {\r\n    flex: 1;\r\n}\r\n\r\n.section-action {\r\n    cursor: pointer;\r\n}\r\n\r\n.section-action:hover {\r\n    color: black;\r\n}\r\n\r\n.indexitem {\r\n    position: relative;\r\n    display: flex;\r\n    align-items: center;\r\n}\r\n\r\n.indexitem > .tag {\r\n    position: absolute;\r\n    left: 1em;\r\n    bottom: .25em;\r\n    font-size: 70%;\r\n    color: var(--color-text-gray);\r\n    text-align: right;\r\n}\r\n\r\n.indexitem > .state {\r\n    margin-left: .5em;\r\n    line-height: 1;\r\n}\r\n\r\n.indexitem > .state > svg {\r\n    height: 1em;\r\n    width: 1em;\r\n}\r\n\r\n.trackitem {\r\n    display: flex;\r\n    align-items: center;\r\n    contain: content;\r\n    height: 4.5em;\r\n    contain: strict;\r\n}\r\n\r\n.trackitem .picbox {\r\n    display: inline-block;\r\n    position: relative;\r\n    text-align: center;\r\n    flex: 3em 0 0;\r\n    height: 3em;\r\n    margin-right: .5em;\r\n    background-color: var(--color-bg-f8);\r\n    background-size: contain;\r\n    background-position: center;\r\n    background-repeat: no-repeat;\r\n    overflow: hidden;\r\n}\r\n\r\n.trackitem .picbox .pic {\r\n    position: absolute;\r\n    left: 0;\r\n    top: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    opacity: .7;\r\n    object-fit: contain;\r\n}\r\n\r\n.trackitem .picbox .pic.nopic {\r\n    display: none;\r\n}\r\n\r\n.trackitem .pos {\r\n    display: inline-block;\r\n    text-align: center;\r\n    color: var(--color-text);\r\n    position: absolute;\r\n    left: 50%;\r\n    top: 50%;\r\n    transform: translate(-50%, -50%);\r\n}\r\n\r\n.trackitem .pos.withpic {\r\n    text-shadow: 0 0 5px var(--color-bg);\r\n}\r\n\r\n.trackitem .pos .icon {\r\n    color: var(--color-text);\r\n}\r\n\r\n.trackitem .name, .trackitem .artist, .trackitem .duration,\r\n.trackitem .uploads-state {\r\n    margin-left: .5em;\r\n    overflow-wrap: break-word;\r\n}\r\n\r\n.trackitem .name {\r\n    flex: 1 1 60%;\r\n}\r\n\r\n.trackitem .artist {\r\n    flex: 1 1 40%;\r\n}\r\n\r\n.trackitem .name, .trackitem .artist {\r\n    overflow: hidden;\r\n    display: block;\r\n    display: -webkit-box;\r\n    -webkit-line-clamp: 2;\r\n    -webkit-box-orient: vertical;\r\n}\r\n\r\n.trackitem .artist {\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.trackitem .duration {\r\n    color: var(--color-text-gray);\r\n    display: none;\r\n    text-align: center;\r\n}\r\n\r\n.trackitem.uploads-item .uploads-state {\r\n    flex: 4em;\r\n    text-overflow: ellipsis;\r\n    white-space: nowrap;\r\n    overflow: hidden;\r\n    color: #ff6659;\r\n}\r\n\r\n.trackitem.uploads-item.state-error .uploads-state {\r\n    color: #f44336;\r\n}\r\n\r\n.trackitem.uploads-item.state-done .uploads-state {\r\n    color: #66bb6a;\r\n}\r\n/* \r\n@media only screen and (min-width: 1000px) {\r\n    .trackitem .duration {\r\n        display: block;\r\n        flex: 4em;\r\n    }\r\n} */\r\n\r\n@media only screen and (max-width: 500px) {\r\n    .trackitem {\r\n        display: block;\r\n        position: relative;\r\n        padding: .4em;\r\n        height: 4em;\r\n    }\r\n    .trackitem .name, .trackitem .artist,\r\n    .trackitem.uploads-item .name, .trackitem.uploads-item .uploads-state {\r\n        display: block;\r\n        margin: .15em .5em;\r\n        /* margin-left: 3em; */\r\n        /* margin: 3px 10px; */\r\n        margin-left: 4em;\r\n        width: auto;\r\n        -webkit-line-clamp: 1;\r\n    }\r\n    .trackitem .picbox {\r\n        position: absolute;\r\n        margin: .15em;\r\n        width: 3em;\r\n        margin-right: 0;\r\n    }\r\n    .trackitem.uploads-item.state-done .uploads-state {\r\n        display: none;\r\n    }\r\n}\r\n\r\n.trackitem.selected {\r\n    background: hsla(5, 100%, 50%, .3);\r\n}\r\n\r\n.trackitem.selected:hover {\r\n    background: hsla(5, 100%, 30%, .3);\r\n}\r\n\r\n.dark .trackitem.selected:hover {\r\n    background: hsla(5, 100%, 60%, .3);\r\n}\r\n\r\n/* .trackitem .artist::before,  */\r\n\r\n#main-container::after {\r\n    content: "";\r\n    clear: both;\r\n}\r\n\r\n.bottombar {\r\n    position: fixed;\r\n    bottom: 0;\r\n    width: 100%;\r\n    display: flex;\r\n    height: 60px;\r\n    align-items: center;\r\n    padding: 0 8px;\r\n    box-shadow: 0 0px 3px var(--color-shadow);\r\n}\r\n\r\n.bottombar .trackpic {\r\n    height: 50px;\r\n    width: 50px;\r\n    border-radius: 8px;\r\n    transition: width .3s, opacity .3s;\r\n}\r\n\r\n.bottombar .trackpic.noimg {\r\n    width: 0;\r\n    opacity: 0;\r\n}\r\n\r\n.bottombar .progress-bar {\r\n    display: flex;\r\n    align-items: center;\r\n    margin-top: 2px;\r\n    cursor: pointer;\r\n}\r\n\r\n.bottombar .progress-bar .background {\r\n    flex: 1;\r\n    background: var(--color-primary-really-light);\r\n    height: 14px;\r\n    border-radius: 8px;\r\n    overflow: hidden;\r\n    position: relative;\r\n}\r\n\r\n.bottombar .progress-bar .fill {\r\n    background: var(--color-primary);\r\n    height: 14px;\r\n    border-top-right-radius: 8px;\r\n    border-bottom-right-radius: 8px;\r\n}\r\n\r\n.bottombar .progress-bar .loudness-map {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    width: 100%;\r\n    height: 100%;\r\n    opacity: .3;\r\n}\r\n\r\n.bottombar .progress-bar .time {\r\n    text-align: center;\r\n    width: 3.5em;\r\n    font-size: 12px;\r\n    line-height: 1;\r\n    font-weight: 300;\r\n    margin: 0 2px;\r\n}\r\n\r\n.bottombar .control-split-h {\r\n    flex: 1;\r\n    display: flex;\r\n    flex-direction: column;\r\n}\r\n\r\n.bottombar .bottom-controls {\r\n    display: flex; \r\n    align-items: center;\r\n    margin-top: 4px;\r\n    padding-left: 8px;\r\n}\r\n\r\n.bottombar .control-btn {\r\n    display: grid;\r\n    place-content: center;\r\n    width: 24px;\r\n    height: 24px;\r\n    margin: 0 4px;\r\n    border-radius: 50%;\r\n}\r\n\r\n.bottombar .control-btn svg {\r\n    filter: drop-shadow(0 0 1px var(--color-light-shadow));\r\n}\r\n\r\n.bottombar .control-btn.disabled {\r\n    opacity: .5;\r\n    cursor: default;\r\n}\r\n\r\n.bottombar .play-btn {\r\n    background: var(--color-primary);\r\n    width: 34px;\r\n    height: 34px;\r\n}\r\n\r\n.bottombar .play-btn svg {\r\n    filter: none;\r\n}\r\n\r\n.bottombar .volume-btn {\r\n    width: 55px;\r\n    margin: 0 8px;\r\n    height: 14px;\r\n    border-radius: 100px;\r\n}\r\n\r\n.bottombar .volume-btn span {\r\n    position: absolute;\r\n    left: 4px;\r\n    top: 0;\r\n    font-size: 0;\r\n    line-height: 14px;\r\n}\r\n\r\n.bottombar .volume-btn span svg {\r\n    vertical-align: middle;\r\n}\r\n\r\n.bottombar .track-info {\r\n    cursor: pointer;\r\n    flex: 1;\r\n    text-align: left;\r\n    font-size: 14px;\r\n    overflow: hidden;\r\n    text-overflow: ellipsis;\r\n    display: -webkit-box;\r\n    -webkit-line-clamp: 1;\r\n    -webkit-box-orient: vertical;\r\n    margin: 0 8px;\r\n}\r\n\r\n.bottombar .track-info .artist {\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.bottombar .track-info .artist::before {\r\n    content: " - ";\r\n}\r\n\r\n.bottombar .lyrics {\r\n    flex: 1;\r\n    text-align: center;\r\n    height: 30px;\r\n    overflow: hidden;\r\n    position: relative;\r\n    margin-left: 8px;\r\n}\r\n\r\n.bottombar .lyrics .line {\r\n    position: absolute;\r\n    width: 100%;\r\n    top: 50%;\r\n    transform: translate(0, -50%);\r\n    animation: fadein .3s;\r\n    margin: 0;\r\n    font-size: 14px;\r\n    line-height: 1.1;\r\n    overflow: hidden;\r\n    display: -webkit-box;\r\n    -webkit-line-clamp: 1;\r\n    -webkit-box-orient: vertical;\r\n}\r\n\r\n.bottombar .lyrics .span.active {\r\n    color: var(--color-primary);\r\n}\r\n\r\n@media only screen  and (max-width: 800px) {\r\n    .bottombar .track-info {\r\n        order: 1;\r\n    }\r\n    .bottombar.has-lyrics .track-info {\r\n        display: none;\r\n    }\r\n    .bottombar.no-lyrics .lyrics {\r\n        display: none;\r\n    }\r\n    .bottombar .lyrics {\r\n        text-align: left;\r\n        text-align: start;\r\n    }\r\n}\r\n\r\n#sidebar-header, #sidebar-features {\r\n    border-bottom: 1px solid var(--color-bg-cc);\r\n}\r\n\r\n#sidebar-header .item, #sidebar-features .item {\r\n    animation: none;\r\n}\r\n\r\n.dark .overlay {\r\n    background: rgba(0, 0, 0, .4);\r\n}\r\n\r\n.dark .input-text {\r\n    border: solid 1px #ccc;\r\n}\r\n\r\n.keyboard-input .btn:focus {\r\n    outline: solid 2px var(--color-primary-dark);\r\n    outline-offset: -2px;\r\n    background: var(--color-primary-darker);\r\n}\r\n\r\n.upload-area {\r\n    margin: .5em;\r\n    padding: .5em;\r\n    text-align: center;\r\n    display: flex;\r\n    flex-direction: column;\r\n    align-items: center;\r\n    justify-content: center;\r\n    min-height: min(100px, 15vh);\r\n    background: var(--color-bg-ee);\r\n    /* animation: showing-top .3s; */\r\n}\r\n\r\n.comment-editor {\r\n    margin: .5em 1em;\r\n}\r\n\r\n.comment-editor-new {\r\n    margin: 0 20px 10px;\r\n    /* animation: showing-top .3s; */\r\n}\r\n\r\n.comment-editor .content {\r\n    width: 100%;\r\n    height: 5em;\r\n    padding: .5em;\r\n    font-family: inherit;\r\n    font-size: 16px;\r\n    resize: vertical;\r\n}\r\n\r\n.comment-editor .submit {\r\n    margin: 10px 0 0 auto;\r\n    line-height: 2;\r\n    width: 8em;\r\n}\r\n\r\n.comment {\r\n    margin: .7em;\r\n    overflow-wrap: break-word;\r\n}\r\n\r\n.comment .username {\r\n    float: left;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.comment .date {\r\n    float: right;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.comment .content {\r\n    clear: both;\r\n    white-space: pre-wrap;\r\n}\r\n\r\n.btn-progress, .keyboard-input .btn-progress:focus {\r\n    background: var(--color-primary-really-light);\r\n}\r\n\r\n.btn-progress:hover, .keyboard-input .btn-progress:focus:hover {\r\n    background-color: var(--color-primary-really-light);\r\n}\r\n\r\n.btn-progress.btn-down, .btn-progress:active {\r\n    background-color: var(--color-primary-light);\r\n}\r\n\r\n.btn-progress .text {\r\n    position: relative;\r\n}\r\n\r\n.btn-fill {\r\n    position: absolute;\r\n    top: 0;\r\n    left: 0;\r\n    height: 100%;\r\n    background-color: var(--color-primary);\r\n    transition: all .2s;\r\n}\r\n\r\n.btn-progress:hover .btn-fill {\r\n    background-color: var(--color-primary-darker);\r\n    transition: all .05s;\r\n}\r\n\r\n.btn-progress.btn-down .btn-fill, .btn-progress:active .btn-fill {\r\n    background: hsl(5, 100%, 50%);\r\n}\r\n\r\n.messagebox-text {\r\n    margin: .3em;\r\n}\r\n\r\n.uploads-usage {\r\n    margin-left: .7em;\r\n}\r\n\r\n.playingview, .lyricsedit {\r\n    display: flex;\r\n    height: 100%;\r\n    align-items: stretch;\r\n    flex-direction: column;\r\n}\r\n\r\n.playingview .infoview {\r\n    /* animation: showing-top .3s; */\r\n}\r\n\r\n.playingview .name, .playingview .artist {\r\n    font-size: 120%;\r\n    text-align: center;\r\n    margin: 0 1em .5em;\r\n}\r\n\r\n.playingview .name {\r\n    margin-top: .3em;\r\n}\r\n\r\n.playingview .pic {\r\n    margin: 20px 0;\r\n    width: 200px;\r\n    height: 200px;\r\n    background: var(--color-bg-dd);\r\n    display: flex;\r\n    justify-content: center;\r\n    align-items: center;\r\n}\r\n\r\n.playingview .pic .nopic {\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.playingview .artist {\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.float-sidebar .playingview .pic {\r\n    width: 200px;\r\n    height: 200px;\r\n}\r\n\r\n.content-bg {\r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n    opacity: .3;\r\n    overflow: hidden;\r\n    transition: opacity .3s;\r\n}\r\n\r\n.content-bg-img {\r\n    position: absolute;\r\n    width: 100%;\r\n    height: 100%;\r\n    background-position: center;\r\n    background-size: cover;\r\n    background-repeat: no-repeat;\r\n    transform: scale(1.05);\r\n    -webkit-filter: blur(1.5vmax);\r\n    filter: blur(1.5vmax);\r\n    animation: fadein .3s;\r\n}\r\n\r\n.content-bg video {\r\n    height: 100%;\r\n    width: 100%;\r\n    position: absolute;\r\n    display: none;\r\n    /* transition: filter .3s; */\r\n}\r\n\r\n.content-bg.has-video video {\r\n    display: block;\r\n    -webkit-filter: blur(1.5vmax);\r\n    filter: blur(1.5vmax);\r\n}\r\n\r\n.content-bg.has-video.full-video {\r\n    opacity: 1;\r\n}\r\n\r\n.content-bg.has-video.full-video video {\r\n    -webkit-filter: none;\r\n    filter: none;\r\n}\r\n\r\n.playingview .lyricsview, .lyricsedit .lyricsview {\r\n    position: relative;\r\n    flex: 1;\r\n    width: 100%;\r\n    overflow: auto;\r\n    will-change: transform;\r\n    /* animation: showing .3s; */\r\n    scrollbar-width: thin;\r\n}\r\n\r\n.playingview .lyricsview::-webkit-scrollbar,\r\n.lyricsedit .lyricsview::-webkit-scrollbar {\r\n    width: 8px;\r\n}\r\n\r\n.lyricsview .line {\r\n    margin: 1em .7em;\r\n    min-height: 1em;\r\n    line-height: 1.3;\r\n    text-align: center;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.lyricsview .line rt {\r\n    font-size: 60%;\r\n}\r\n\r\n.lyricsview .line rt::selection {\r\n    background: none;\r\n}\r\n\r\n.lyricsview .line.active {\r\n    color: var(--color-text);\r\n}\r\n\r\n.lyricsview .line.active .span.active {\r\n    color: var(--color-primary);\r\n    animation: lryics-span-active .2s;\r\n}\r\n\r\n.lyricsview .span.next {\r\n    text-decoration: underline var(--color-primary) 2px;\r\n    min-width: 1em;\r\n}\r\n\r\n.lyricsview .span {\r\n    cursor: pointer;\r\n}\r\n\r\n.lyricsview.edit .span.ts::before {\r\n    content: "[]";\r\n    font-size: 50%;\r\n    color: var(--color-text-gray);\r\n    opacity: .5;\r\n}\r\n\r\n.lyricsview.edit .span.next.ts::before {\r\n    color: var(--color-primary);\r\n    opacity: 1;\r\n}\r\n\r\n.lyricsview .line .trans {\r\n    font-size: 80%;\r\n}\r\n\r\n@keyframes lryics-span-active {\r\n    0%, 100% {\r\n        color: var(--color-primary);\r\n    }\r\n    33% {\r\n        color: var(--color-primary-dark-depends);\r\n    }\r\n}\r\n\r\n.searchbar {\r\n    display: flex;\r\n    align-items: center;\r\n    margin: 0 .7em .7em;\r\n}\r\n\r\n.searchbar .input-text {\r\n    flex: 1;\r\n    line-height: 1.5;\r\n    font-size: inherit;\r\n}\r\n\r\n.searchbar .btn {\r\n    margin-left: .7em;\r\n    line-height: 1.5;\r\n    padding: .2em;\r\n}\r\n\r\n.volume-tip {\r\n    font-size: 14px;\r\n    animation: volume-tip-animation .2s;\r\n    pointer-events: none;\r\n}\r\n\r\n.volume-tip.animation-fading-out {\r\n    animation: volume-tip-animation .2s reverse;\r\n    transform: translate(-50%, 0) scale(.5);\r\n    opacity: 0;\r\n    transition: all .2s;\r\n}\r\n\r\n@keyframes volume-tip-animation {\r\n    0% {\r\n        transform: translate(-50%, 0) scale(.5);\r\n        opacity: 0;\r\n    }\r\n    100% {\r\n        transform: translate(-50%, -100%) scale(1);\r\n        opacity: 1;\r\n    }\r\n}\r\n\r\n.sidebar-toggle,\r\n.item {\r\n  border: solid 2px transparent;\r\n  transition: transform .3s, border .6s, opacity .3s;\r\n}\r\n\r\n.sidebar-toggle:active,\r\n.item:active {\r\n  border: solid 2px var(--color-bg-dd);\r\n  transition: transform .07s, border .07s, opacity .07s;\r\n  transform: scale(.97);\r\n  opacity: .7;\r\n}\r\n\r\n.rounded .btn,\r\n.rounded .item,\r\n.rounded .sidebar-toggle,\r\n.rounded .context-menu,\r\n.rounded .toast,\r\n.rounded .input-text,\r\n.rounded .dialog,\r\n.rounded .upload-area {\r\n    border-radius: 19px;\r\n}\r\n\r\n.rounded .trackitem .picbox {\r\n    border-radius: 8px;\r\n}\r\n\r\n.rounded .input-text {\r\n    padding: .5em 10px;\r\n}\r\n\r\n.rounded #sidebar-features .item,\r\n.rounded #sidebar-list .item {\r\n    border-radius: 0 19px 19px 0;\r\n    margin-right: 6px;\r\n    margin-left: 0;\r\n}\r\n\r\n.rounded .item {\r\n    margin: 2px;\r\n}\r\n\r\n.rounded .context-menu .item {\r\n    margin: 2px 4px;\r\n}\r\n\r\n.rounded .context-menu {\r\n    padding: 2px 0;\r\n}\r\n\r\n.rounded #settings-btn {\r\n    width: 46px;\r\n}\r\n\r\n.rounded #login-state {\r\n    height: 46px;\r\n}\r\n\r\n.rounded .sidebar-toggle {\r\n    left: 2px;\r\n    top: 2px;\r\n    width: 46px;\r\n    height: 46px;\r\n    background: none;\r\n}\r\n\r\n.rounded #login-state .user-avatar {\r\n    margin-left: -10px;\r\n}\r\n\r\n.rounded .trackitem {\r\n    margin: 0 2px;\r\n}\r\n\r\n.rounded .trackitem.selected.prev-selected {\r\n    border-top-left-radius: 0;\r\n    border-top-right-radius: 0;\r\n}\r\n\r\n.rounded .trackitem.selected.next-selected {\r\n    border-bottom-left-radius: 0;\r\n    border-bottom-right-radius: 0;\r\n}\r\n\r\n.sidebar-toggle:hover {\r\n    background: var(--color-bg-ee);\r\n}\r\n\r\n.trackitem .name, .trackitem .artist {\r\n    overflow: hidden;\r\n    display: -webkit-box;\r\n    -webkit-line-clamp: 2;\r\n    -webkit-box-orient: vertical;  \r\n}\r\n\r\n.trackitem .duration {\r\n    text-align: center;\r\n}\r\n\r\n.user-info {\r\n    display: flex;\r\n    flex-direction: row;\r\n    align-items: center;\r\n    padding: 8px;\r\n}\r\n\r\n.user-avatar {\r\n    width: 80px;\r\n    height: 80px;\r\n    border-radius: 40px;\r\n    background: var(--color-bg-cc);\r\n    margin-right: 24px;\r\n}\r\n\r\n.user-name {\r\n    font-size: 24px;\r\n}\r\n\r\n.content-header {\r\n    background: none;\r\n}\r\n\r\n#content-outer {\r\n    --color-fg-11: #000000ee;\r\n    --color-fg-22: #000000dd;\r\n    --color-fg-33: #000000cc;\r\n    --color-bg-cc: #00000033;\r\n    --color-bg-dd: #00000022;\r\n    --color-bg-ee: #00000011;\r\n    --color-bg-f8: #00000008;\r\n    --color-bg-transparent: #ffffff33;\r\n    --color-bg-selection: hsl(5, 100%, 50%, .3);\r\n}\r\n\r\n.dark #content-outer {\r\n    --color-fg-11: #ffffffdd;\r\n    --color-fg-22: #ffffffcc;\r\n    --color-fg-33: #ffffffbb;\r\n    --color-bg-f8: #ffffff11;\r\n    --color-bg-ee: #ffffff22;\r\n    --color-bg-dd: #ffffff33;\r\n    --color-bg-cc: #ffffff44;\r\n    --color-bg-transparent: #00000033;\r\n    --color-bg-selection: hsla(5, 100%, 50%, .3);\r\n}\r\n\r\n@media only screen and (max-width: 500px) {\r\n    .dialog {\r\n        height: 100%;\r\n        width: 100% !important;\r\n        left: 0 !important;\r\n        top: 0 !important;\r\n        bottom: 0 !important;\r\n        border-radius: 0 !important;\r\n    }\r\n    .dialog-title {\r\n        padding: 0 .5em;\r\n    }\r\n    .dialog-title .textbtn {\r\n        padding: 1em;\r\n    }\r\n    .dialog-content {\r\n        resize: none;\r\n        padding: 1em;\r\n    }\r\n    .btn-big {\r\n        padding: .5em;\r\n    }\r\n}\r\n\r\n.float-sidebar #content-outer {\r\n    transition: transform .3s;\r\n    will-change: transform;\r\n}\r\n\r\n.float-sidebar #content-outer.sidebar-shown {\r\n    transform: translate(30%, 0);\r\n}\r\n\r\n.dialog h3 {\r\n    margin: 5px 0;\r\n    font-weight: 400;\r\n    font-size: 16px;\r\n    color: var(--color-text-gray);\r\n}\r\n\r\n.social-login-item {\r\n    display: flex;\r\n    justify-content: space-between;\r\n}\r\n\r\n.social-login-item .btn {\r\n    display: inline-block;\r\n    margin: 0;\r\n}\r\n\r\n.bottombar {\r\n    padding-left: 330px;\r\n    zoom: 1.25;\r\n}\r\n\r\n#main-container {\r\n    height: calc(100% - 75px);\r\n}\r\n',{tag:"style#mcloud-injected-style"})}};tt.init(),window.preload.jsOk(),t.app=tt,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=bundle.js.map
